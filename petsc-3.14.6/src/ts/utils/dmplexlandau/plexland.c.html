<center><a href="plexland.c">Actual source code: plexland.c</a></center><br>

<html>
<head> <link rel="canonical" href="http://www.mcs.anl.gov/petsc/petsc-current/src/ts/utils/dmplexlandau/plexland.c.html" />
<title></title>
<meta name="generator" content="c2html 0.9.4">
<meta name="date" content="2021-03-30T16:52:01+00:00">
</head>

<body bgcolor="#FFFFFF">
   <div id="version" align=right><b>petsc-3.14.6 2021-03-30</b></div>
   <div id="bugreport" align=right><a href="mailto:petsc-maint@mcs.anl.gov?subject=Typo or Error in Documentation &body=Please describe the typo or error in the documentation: petsc-3.14.6 v3.14.6 src/ts/utils/dmplexlandau/plexland.c.html "><small>Report Typos and Errors</small></a></div>
<pre width="80">
<a name="line1">  1: </a>#include <A href="../../../../include/petsc/private/dmpleximpl.h.html">&lt;petsc/private/dmpleximpl.h&gt;</A>
<a name="line2">  2: </a>#include <A href="../../../../include/petsclandau.h.html">&lt;petsclandau.h&gt;</A>
<a name="line3">  3: </a>#include <A href="../../../../include/petscts.h.html">&lt;petscts.h&gt;</A>
<a name="line4">  4: </a>#include <A href="../../../../include/petscdmforest.h.html">&lt;petscdmforest.h&gt;</A>

<a name="line6">  6: </a><font color="#B22222">/* Landau collision operator */</font>
<a name="line7">  7: </a><strong><font color="#228B22">#define PETSC_THREAD_SYNC</font></strong>
<a name="line8">  8: </a><strong><font color="#228B22">#define PETSC_DEVICE_FUNC_DECL static</font></strong>
<a name="line9">  9: </a><font color="#A020F0">#include </font><font color="#666666">"land_kernel.h"</font><font color="#A020F0"></font>

<a name="line11"> 11: </a><strong><font color="#228B22">#define LANDAU_VL  1</font></strong>
<a name="line12"> 12: </a><strong><font color="#4169E1"><a name="LandauPointDataCreate"></a>static <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> LandauPointDataCreate(<a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> **IPData, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dim, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> nip, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> Ns)</font></strong>
<a name="line13"> 13: </a>{
<a name="line14"> 14: </a>  <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>  ierr, d, s, jj, nip_pad = LANDAU_VL*(nip/LANDAU_VL + !!(nip%LANDAU_VL)), pnt_sz = (dim + Ns*(1+dim));
<a name="line15"> 15: </a>  <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>       *pdata;
<a name="line17"> 17: </a>  <a href="../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</a>(nip_pad*pnt_sz*<font color="#4169E1">sizeof</font>(<a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>),IPData);
<a name="line18"> 18: </a>  <font color="#B22222">/* pad with zeros in case we vectorize into this */</font>
<a name="line19"> 19: </a>  <font color="#4169E1">for</font> (jj=nip, pdata = *IPData + nip*pnt_sz; jj &lt; nip_pad; jj++, pdata += pnt_sz){
<a name="line20"> 20: </a>    LandauPointData *fplpt = (LandauPointData*)pdata; <font color="#B22222">/* [dim + NS*(1+dim)] */</font>
<a name="line21"> 21: </a>    <font color="#4169E1">for</font> (d=0;d&lt;dim;d++) fplpt-&gt;crd[d] = -1;
<a name="line22"> 22: </a>    <font color="#4169E1">for</font> (s=0;s&lt;Ns;s++) {
<a name="line23"> 23: </a>      fplpt-&gt;fdf[s].f = 0;
<a name="line24"> 24: </a>      <font color="#4169E1">for</font> (d=0;d&lt;dim;d++) fplpt-&gt;fdf[s].df[d] = 0;
<a name="line25"> 25: </a>    }
<a name="line26"> 26: </a>  }
<a name="line27"> 27: </a>  <font color="#4169E1">return</font>(0);
<a name="line28"> 28: </a>}

<a name="line30"> 30: </a><strong><font color="#4169E1"><a name="LandauPointDataDestroy"></a>static <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> LandauPointDataDestroy(<a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> *IPData)</font></strong>
<a name="line31"> 31: </a>{
<a name="line32"> 32: </a>  <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>   ierr;
<a name="line34"> 34: </a>  <a href="../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(IPData);
<a name="line35"> 35: </a>  <font color="#4169E1">return</font>(0);
<a name="line36"> 36: </a>}
<a name="line37"> 37: </a><font color="#B22222">/* ------------------------------------------------------------------- */</font>
<a name="line38"> 38: </a><font color="#B22222">/*</font>
<a name="line39"> 39: </a><font color="#B22222">  LandauFormJacobian_Internal - Evaluates Jacobian matrix.</font>

<a name="line41"> 41: </a><font color="#B22222">  Input Parameters:</font>
<a name="line42"> 42: </a><font color="#B22222">  .  globX - input vector</font>
<a name="line43"> 43: </a><font color="#B22222">  .  actx - optional user-defined context</font>
<a name="line44"> 44: </a><font color="#B22222">  .  dim - dimension</font>

<a name="line46"> 46: </a><font color="#B22222">  Output Parameters:</font>
<a name="line47"> 47: </a><font color="#B22222">  .  J0acP - Jacobian matrix filled, not created</font>
<a name="line48"> 48: </a><font color="#B22222">*/</font>
<a name="line49"> 49: </a><strong><font color="#4169E1"><a name="LandauFormJacobian_Internal"></a><a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> LandauFormJacobian_Internal(<a href="../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a> a_X, <a href="../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> JacP, const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dim, void *a_ctx)</font></strong>
<a name="line50"> 50: </a>{
<a name="line51"> 51: </a>  LandauCtx         *ctx = (LandauCtx*)a_ctx;
<a name="line52"> 52: </a>  <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>    ierr;
<a name="line53"> 53: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>          cStart, cEnd, elemMatSize;
<a name="line54"> 54: </a>  <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a>                plex = NULL;
<a name="line55"> 55: </a>  <a href="../../../docs/manualpages/DM/PetscDS.html#PetscDS">PetscDS</a>           prob;
<a name="line56"> 56: </a>  <a href="../../../docs/manualpages/PetscSection/PetscSection.html#PetscSection">PetscSection</a>      section,globsection;
<a name="line57"> 57: </a>  <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>       *elemMat;
<a name="line58"> 58: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>          numCells,totDim,ej,Nq,*Nbf,*Ncf,Nb,Ncx,Nf,d,f,fieldA,Nip,nip_pad,ipdata_sz;
<a name="line59"> 59: </a>  <a href="../../../docs/manualpages/FE/PetscQuadrature.html#PetscQuadrature">PetscQuadrature</a>   quad;
<a name="line60"> 60: </a>  PetscTabulation   *Tf;
<a name="line61"> 61: </a>  <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>         *wiGlob, nu_alpha[LANDAU_MAX_SPECIES], nu_beta[LANDAU_MAX_SPECIES];
<a name="line62"> 62: </a>  const <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>   *quadWeights;
<a name="line63"> 63: </a>  <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>         *IPData,*invJ,*invJ_a;
<a name="line64"> 64: </a>  <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>         invMass[LANDAU_MAX_SPECIES],Eq_m[LANDAU_MAX_SPECIES],m_0=ctx-&gt;m_0; <font color="#B22222">/* normalize mass -- not needed! */</font>
<a name="line65"> 65: </a>  <a href="../../../docs/manualpages/Sys/PetscLogDouble.html#PetscLogDouble">PetscLogDouble</a>    flops;
<a name="line66"> 66: </a>  <a href="../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a>               locX;


<a name="line73"> 73: </a>  <a href="../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</a>(ctx-&gt;events[1],0,0,0,0);
<a name="line74"> 74: </a>  <a href="../../../docs/manualpages/DM/DMConvert.html#DMConvert">DMConvert</a>(ctx-&gt;dmv, <a href="../../../docs/manualpages/DMPLEX/DMPLEX.html#DMPLEX">DMPLEX</a>, &amp;plex);
<a name="line75"> 75: </a>  <a href="../../../docs/manualpages/DM/DMCreateLocalVector.html#DMCreateLocalVector">DMCreateLocalVector</a>(plex, &amp;locX);
<a name="line76"> 76: </a>  <a href="../../../docs/manualpages/Vec/VecZeroEntries.html#VecZeroEntries">VecZeroEntries</a>(locX); <font color="#B22222">/* zero BCs so don't set */</font>
<a name="line77"> 77: </a>  <a href="../../../docs/manualpages/DM/DMGlobalToLocalBegin.html#DMGlobalToLocalBegin">DMGlobalToLocalBegin</a>(plex, a_X, <a href="../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</a>, locX);
<a name="line78"> 78: </a>  <a href="../../../docs/manualpages/DM/DMGlobalToLocalEnd.html#DMGlobalToLocalEnd">DMGlobalToLocalEnd</a>  (plex, a_X, <a href="../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</a>, locX);
<a name="line79"> 79: </a>  <a href="../../../docs/manualpages/DMPLEX/DMPlexGetHeightStratum.html#DMPlexGetHeightStratum">DMPlexGetHeightStratum</a>(plex, 0, &amp;cStart, &amp;cEnd);
<a name="line80"> 80: </a>  <a href="../../../docs/manualpages/DM/DMGetLocalSection.html#DMGetLocalSection">DMGetLocalSection</a>(plex, &amp;section);
<a name="line81"> 81: </a>  <a href="../../../docs/manualpages/DM/DMGetGlobalSection.html#DMGetGlobalSection">DMGetGlobalSection</a>(plex, &amp;globsection);
<a name="line82"> 82: </a>  <a href="../../../docs/manualpages/DM/DMGetDS.html#DMGetDS">DMGetDS</a>(plex, &amp;prob);
<a name="line83"> 83: </a>  <a href="../../../docs/manualpages/DT/PetscDSGetTabulation.html#PetscDSGetTabulation">PetscDSGetTabulation</a>(prob, &amp;Tf); // Bf, &amp;Df
<a name="line84"> 84: </a>  <a href="../../../docs/manualpages/DT/PetscDSGetDimensions.html#PetscDSGetDimensions">PetscDSGetDimensions</a>(prob, &amp;Nbf); Nb = Nbf[0]; <font color="#B22222">/* number of vertices*S */</font>
<a name="line85"> 85: </a>  <a href="../../../docs/manualpages/PetscSection/PetscSectionGetNumFields.html#PetscSectionGetNumFields">PetscSectionGetNumFields</a>(section, &amp;Nf);         <font color="#4169E1">if</font> (Nf!=ctx-&gt;num_species) <a href="../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_PLIB, <font color="#666666">"Nf %D != S"</font>,Nf);
<a name="line86"> 86: </a>  <a href="../../../docs/manualpages/DT/PetscDSGetComponents.html#PetscDSGetComponents">PetscDSGetComponents</a>(prob, &amp;Ncf); Ncx = Ncf[0]; <font color="#4169E1">if</font> (Ncx!=1) <a href="../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_PLIB, <font color="#666666">"Nc %D != 1"</font>,Ncx);
<a name="line87"> 87: </a>  <font color="#4169E1">for</font> (fieldA=0;fieldA&lt;Nf;fieldA++) {
<a name="line88"> 88: </a>    invMass[fieldA] = m_0/ctx-&gt;masses[fieldA];
<a name="line89"> 89: </a>    Eq_m[fieldA] = -ctx-&gt;Ez * ctx-&gt;t_0 * ctx-&gt;charges[fieldA] / (ctx-&gt;v_0 * ctx-&gt;masses[fieldA]); <font color="#B22222">/* normalize dimensionless */</font>
<a name="line90"> 90: </a>    <font color="#4169E1">if</font> (dim==2) Eq_m[fieldA] *=  2 * PETSC_PI; <font color="#B22222">/* add the 2pi term that is not in Landau */</font>
<a name="line91"> 91: </a>    nu_alpha[fieldA] = <a href="../../../docs/manualpages/Sys/PetscSqr.html#PetscSqr">PetscSqr</a>(ctx-&gt;charges[fieldA]/m_0)*m_0/ctx-&gt;masses[fieldA];
<a name="line92"> 92: </a>    nu_beta[fieldA] = <a href="../../../docs/manualpages/Sys/PetscSqr.html#PetscSqr">PetscSqr</a>(ctx-&gt;charges[fieldA]/ctx-&gt;epsilon0)*ctx-&gt;lnLam / (8*PETSC_PI) * ctx-&gt;t_0*ctx-&gt;n_0/PetscPowReal(ctx-&gt;v_0,3);
<a name="line93"> 93: </a>  }
<a name="line94"> 94: </a>  <a href="../../../docs/manualpages/DT/PetscDSGetTotalDimension.html#PetscDSGetTotalDimension">PetscDSGetTotalDimension</a>(prob, &amp;totDim);
<a name="line95"> 95: </a>  numCells = cEnd - cStart;
<a name="line96"> 96: </a>  <a href="../../../docs/manualpages/FE/PetscFEGetQuadrature.html#PetscFEGetQuadrature">PetscFEGetQuadrature</a>(ctx-&gt;fe[0], &amp;quad);
<a name="line97"> 97: </a>  <a href="../../../docs/manualpages/DT/PetscQuadratureGetData.html#PetscQuadratureGetData">PetscQuadratureGetData</a>(quad, NULL, NULL, &amp;Nq, NULL, &amp;quadWeights);
<a name="line98"> 98: </a>  <font color="#4169E1">if</font> (Nb!=Nq) <a href="../../../docs/manualpages/Sys/SETERRQ4.html#SETERRQ4">SETERRQ4</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_PLIB, <font color="#666666">"Nb!=Nq %D %D over integration or simplices? Tf[0]-&gt;Nb=%D dim=%D"</font>,Nb,Nq,Tf[0]-&gt;Nb,dim);
<a name="line99"> 99: </a>  <font color="#4169E1">if</font> (Nq &gt;LANDAU_MAX_NQ) <a href="../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,PETSC_ERR_ARG_WRONG,<font color="#666666">"Order too high. Nq = %D &gt; LANDAU_MAX_NQ (%D)"</font>,Nq,LANDAU_MAX_NQ);
<a name="line100">100: </a>  Nip = numCells*Nq;
<a name="line101">101: </a>  nip_pad = LANDAU_VL*(Nip/LANDAU_VL + !!(Nip%LANDAU_VL));
<a name="line102">102: </a>  flops = (<a href="../../../docs/manualpages/Sys/PetscLogDouble.html#PetscLogDouble">PetscLogDouble</a>)numCells*(<a href="../../../docs/manualpages/Sys/PetscLogDouble.html#PetscLogDouble">PetscLogDouble</a>)Nq*(<a href="../../../docs/manualpages/Sys/PetscLogDouble.html#PetscLogDouble">PetscLogDouble</a>)(5*dim*dim*Nf*Nf + 165);
<a name="line103">103: </a>  <a href="../../../docs/manualpages/Mat/MatZeroEntries.html#MatZeroEntries">MatZeroEntries</a>(JacP);
<a name="line104">104: </a>  elemMatSize = totDim*totDim;
<a name="line105">105: </a>  {
<a name="line106">106: </a>    static int         cc = 0;
<a name="line107">107: </a>    <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>        uu[LANDAU_MAX_SPECIES],u_x[LANDAU_MAX_SPECIES*LANDAU_DIM];
<a name="line108">108: </a>    <font color="#B22222">/* collect f data */</font>
<a name="line109">109: </a>    <font color="#4169E1">if</font> (ctx-&gt;verbose &gt; 2 || (ctx-&gt;verbose &gt; 0 &amp;&amp; cc++ == 0)) {
<a name="line110">110: </a>      <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> N,Nloc;
<a name="line111">111: </a>      <a href="../../../docs/manualpages/Mat/MatGetSize.html#MatGetSize">MatGetSize</a>(JacP,&amp;N,NULL);
<a name="line112">112: </a>      <a href="../../../docs/manualpages/Vec/VecGetSize.html#VecGetSize">VecGetSize</a>(locX,&amp;Nloc);
<a name="line113">113: </a>      <a href="../../../docs/manualpages/Sys/PetscPrintf.html#PetscPrintf">PetscPrintf</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,<font color="#666666">"[%D]%s: %D IPs, %D cells, %s elements, totDim=%D, Nb=%D, Nq=%D, elemMatSize=%D, dim=%D, Tab: Nb=%D Nf=%D Np=%D cdim=%D N=%D N_loc=%D\n"</font>,
<a name="line114">114: </a>                         0,<font color="#666666">"FormLandau"</font>,Nq*numCells,numCells,ctx-&gt;simplex ? <font color="#666666">"SIMPLEX"</font> : <font color="#666666">"TENSOR"</font>, totDim, Nb, Nq, elemMatSize, dim, Tf[0]-&gt;Nb, Nf, Tf[0]-&gt;Np, Tf[0]-&gt;cdim, N, Nloc);
<a name="line115">115: </a>    }
<a name="line116">116: </a>    LandauPointDataCreate(&amp;IPData, dim, Nq*numCells, Nf);
<a name="line117">117: </a>    ipdata_sz = (dim + Nf*(1+dim));
<a name="line118">118: </a>    <a href="../../../docs/manualpages/Sys/PetscMalloc3.html#PetscMalloc3">PetscMalloc3</a>(elemMatSize,&amp;elemMat,nip_pad,&amp;wiGlob,nip_pad*dim*dim,&amp;invJ_a);
<a name="line119">119: </a>    <font color="#B22222">/* cache geometry and x, f and df/dx at IPs */</font>
<a name="line120">120: </a>    <font color="#4169E1">for</font> (ej = 0, invJ = invJ_a ; ej &lt; numCells; ++ej, invJ += Nq*dim*dim) {
<a name="line121">121: </a>      <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>    vj[LANDAU_MAX_NQ*LANDAU_DIM],detJj[LANDAU_MAX_NQ], Jdummy[LANDAU_MAX_NQ*LANDAU_DIM*LANDAU_DIM];
<a name="line122">122: </a>      <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>     qj,f;
<a name="line123">123: </a>      <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> *coef = NULL;
<a name="line124">124: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexComputeCellGeometryFEM.html#DMPlexComputeCellGeometryFEM">DMPlexComputeCellGeometryFEM</a>(plex, cStart+ej, quad, vj, Jdummy, invJ, detJj);
<a name="line125">125: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexVecGetClosure.html#DMPlexVecGetClosure">DMPlexVecGetClosure</a>(plex, section, locX, cStart+ej, NULL, &amp;coef);
<a name="line126">126: </a>      <font color="#B22222">/* create point data for cell i for Landau tensor: x, f(x), grad f(x) */</font>
<a name="line127">127: </a>      <font color="#4169E1">for</font> (qj = 0; qj &lt; Nq; ++qj) {
<a name="line128">128: </a>        <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       gidx = (ej*Nq + qj);
<a name="line129">129: </a>        LandauPointData  *pnt_data = (LandauPointData*)(IPData + gidx*ipdata_sz);
<a name="line130">130: </a>        <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>    refSpaceDer[LANDAU_DIM];
<a name="line131">131: </a>        <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       dOffset = 0, fOffset = 0;
<a name="line132">132: </a>        <font color="#4169E1">for</font> (d = 0; d &lt; dim; ++d) pnt_data-&gt;crd[d] = vj[qj * dim + d]; <font color="#B22222">/* coordinate */</font>
<a name="line133">133: </a>        wiGlob[gidx] = detJj[qj] * quadWeights[qj];
<a name="line134">134: </a>        <font color="#4169E1">if</font> (dim==2) wiGlob[gidx] *= pnt_data-&gt;crd[0];  <font color="#B22222">/* cylindrical coordinate, w/o 2pi */</font>
<a name="line135">135: </a>        <font color="#B22222">/* get u &amp; du (EvaluateFieldJets) */</font>
<a name="line136">136: </a>        <font color="#4169E1">for</font> (f = 0; f &lt; Nf; ++f) {
<a name="line137">137: </a>          const <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> *Bq = &amp;Tf[f]-&gt;T[0][qj*Nb];
<a name="line138">138: </a>          const <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> *Dq = &amp;Tf[f]-&gt;T[1][qj*Nb*dim];
<a name="line139">139: </a>          <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         b, e;
<a name="line140">140: </a>          uu[fOffset] = 0.0;
<a name="line141">141: </a>          <font color="#4169E1">for</font> (d = 0; d &lt; LANDAU_DIM; ++d) refSpaceDer[d] = 0.0;
<a name="line142">142: </a>          <font color="#4169E1">for</font> (b = 0; b &lt; Nb; ++b) {
<a name="line143">143: </a>            const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>    cidx = b;
<a name="line144">144: </a>            uu[fOffset] += Bq[cidx]*coef[dOffset+cidx];
<a name="line145">145: </a>            <font color="#4169E1">for</font> (d = 0; d &lt; dim; ++d) refSpaceDer[d] += Dq[cidx*dim+d]*coef[dOffset+cidx];
<a name="line146">146: </a>          }
<a name="line147">147: </a>          <font color="#4169E1">for</font> (d = 0; d &lt; dim; ++d) {
<a name="line148">148: </a>            <font color="#4169E1">for</font> (e = 0, u_x[fOffset*dim+d] = 0.0; e &lt; dim; ++e) { // should add directly to point data here!!!
<a name="line149">149: </a>              u_x[fOffset*dim+d] += invJ[qj * dim * dim + e*dim+d]*refSpaceDer[e];
<a name="line150">150: </a>            }
<a name="line151">151: </a>          }
<a name="line152">152: </a>          fOffset += 1;
<a name="line153">153: </a>          dOffset += Nb;
<a name="line154">154: </a>        }
<a name="line155">155: </a>        <font color="#B22222">/* copy to IPDataLocal */</font>
<a name="line156">156: </a>        <font color="#4169E1">for</font> (f=0;f&lt;Nf;f++) {
<a name="line157">157: </a>          pnt_data-&gt;fdf[f].f = <a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(uu[f]);
<a name="line158">158: </a>          <font color="#4169E1">for</font> (d = 0; d &lt; dim; ++d) pnt_data-&gt;fdf[f].df[d] = <a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(u_x[f*dim+d]);
<a name="line159">159: </a>        }
<a name="line160">160: </a>      } <font color="#B22222">/* q */</font>
<a name="line161">161: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexVecRestoreClosure.html#DMPlexVecRestoreClosure">DMPlexVecRestoreClosure</a>(plex, section, locX, cStart+ej, NULL, &amp;coef);
<a name="line162">162: </a>    } <font color="#B22222">/* e */</font>
<a name="line163">163: </a>  }
<a name="line164">164: </a>  <a href="../../../docs/manualpages/DM/DMRestoreLocalVector.html#DMRestoreLocalVector">DMRestoreLocalVector</a>(plex, &amp;locX);
<a name="line165">165: </a>  <a href="../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</a>(ctx-&gt;events[1],0,0,0,0);

<a name="line167">167: </a>  <font color="#B22222">/* outer element loop j is like a regular assembly loop */</font>
<a name="line168">168: </a>  <font color="#4169E1">if</font> (ctx-&gt;deviceType == LANDAU_CUDA) {
<a name="line169">169: </a><font color="#A020F0">#if defined(PETSC_HAVE_CUDA)</font>
<a name="line170">170: </a>    LandauCUDAJacobian(plex,Nq,nu_alpha,nu_beta,invMass,Eq_m,IPData,wiGlob,invJ_a,ctx-&gt;subThreadBlockSize,ctx-&gt;events,ctx-&gt;quarter3DDomain,JacP);
<a name="line171">171: </a><font color="#A020F0">#else</font>
<a name="line172">172: </a>    <a href="../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,PETSC_ERR_ARG_WRONG,<font color="#666666">"-landau_device_type %s not built"</font>,<font color="#666666">"cuda"</font>);
<a name="line173">173: </a><font color="#A020F0">#endif</font>
<a name="line174">174: </a>  } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (ctx-&gt;deviceType == LANDAU_KOKKOS) {
<a name="line175">175: </a><font color="#A020F0">#if defined(PETSC_HAVE_KOKKOS)</font>
<a name="line176">176: </a>    LandauKokkosJacobian(plex,Nq,nu_alpha,nu_beta,invMass,Eq_m,IPData,wiGlob,invJ_a,ctx-&gt;subThreadBlockSize,ctx-&gt;events,ctx-&gt;quarter3DDomain,JacP);
<a name="line177">177: </a><font color="#A020F0">#else</font>
<a name="line178">178: </a>    <a href="../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,PETSC_ERR_ARG_WRONG,<font color="#666666">"-landau_device_type %s not built"</font>,<font color="#666666">"kokkos"</font>);
<a name="line179">179: </a><font color="#A020F0">#endif</font>
<a name="line180">180: </a>  } <font color="#4169E1">else</font> { <font color="#B22222">/* CPU version */</font>
<a name="line181">181: </a>    <font color="#4169E1">for</font> (ej = cStart, invJ = invJ_a; ej &lt; cEnd; ++ej, invJ += Nq*dim*dim) {
<a name="line182">182: </a>      <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>     qj;
<a name="line183">183: </a>      <a href="../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</a>(ctx-&gt;events[3],0,0,0,0);
<a name="line184">184: </a>      <a href="../../../docs/manualpages/Sys/PetscMemzero.html#PetscMemzero">PetscMemzero</a>(elemMat, totDim *totDim * <font color="#4169E1">sizeof</font>(<a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>));
<a name="line185">185: </a>      <a href="../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</a>(ctx-&gt;events[3],0,0,0,0);
<a name="line186">186: </a>      <font color="#4169E1">for</font> (qj = 0; qj &lt; Nq; ++qj) {
<a name="line187">187: </a>        <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>       g2[1][LANDAU_MAX_SUB_THREAD_BLOCKS][LANDAU_MAX_SPECIES][LANDAU_DIM], g3[1][LANDAU_MAX_SUB_THREAD_BLOCKS][LANDAU_MAX_SPECIES][LANDAU_DIM][LANDAU_DIM];
<a name="line188">188: </a>        const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>  nip = numCells*Nq, jpidx = Nq*(ej-cStart) + qj, one = 1, zero = 0; <font color="#B22222">/* length of inner global interation, outer integration point */</font>

<a name="line190">190: </a>        <a href="../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</a>(ctx-&gt;events[4],0,0,0,0);
<a name="line191">191: </a>        <a href="../../../docs/manualpages/Profiling/PetscLogFlops.html#PetscLogFlops">PetscLogFlops</a>(flops);
<a name="line192">192: </a>        landau_inner_integral(zero, one, zero, one, zero, nip, 1, jpidx, Nf, dim, IPData, wiGlob, &amp;invJ[qj*dim*dim], nu_alpha, nu_beta, invMass, Eq_m, ctx-&gt;quarter3DDomain, Nq, Nb, qj, qj+1, Tf[0]-&gt;T[0], Tf[0]-&gt;T[1], elemMat, g2, g3, ej);
<a name="line193">193: </a>        <a href="../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</a>(ctx-&gt;events[4],0,0,0,0);
<a name="line194">194: </a>      } <font color="#B22222">/* qj loop */</font>
<a name="line195">195: </a>      <font color="#B22222">/* assemble matrix */</font>
<a name="line196">196: </a>      <a href="../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</a>(ctx-&gt;events[6],0,0,0,0);
<a name="line197">197: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexMatSetClosure.html#DMPlexMatSetClosure">DMPlexMatSetClosure</a>(plex, section, globsection, JacP, ej, elemMat, <a href="../../../docs/manualpages/Sys/ADD_VALUES.html#ADD_VALUES">ADD_VALUES</a>);
<a name="line198">198: </a>      <a href="../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</a>(ctx-&gt;events[6],0,0,0,0);

<a name="line200">200: </a>      <font color="#4169E1">if</font> (ej==-1) {
<a name="line201">201: </a>        <a href="../../../docs/manualpages/Sys/PetscPrintf.html#PetscPrintf">PetscPrintf</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, <font color="#666666">"CPU Element matrix\n"</font>);
<a name="line202">202: </a>        <font color="#4169E1">for</font> (d = 0; d &lt; totDim; ++d){
<a name="line203">203: </a>          <font color="#4169E1">for</font> (f = 0; f &lt; totDim; ++f) <a href="../../../docs/manualpages/Sys/PetscPrintf.html#PetscPrintf">PetscPrintf</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>,<font color="#666666">" %17.9e"</font>,  <a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(elemMat[d*totDim + f]));
<a name="line204">204: </a>           <a href="../../../docs/manualpages/Sys/PetscPrintf.html#PetscPrintf">PetscPrintf</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>,<font color="#666666">"\n"</font>);
<a name="line205">205: </a>        }
<a name="line206">206: </a>      }
<a name="line207">207: </a>    } <font color="#B22222">/* ej cells loop, not cuda */</font>
<a name="line208">208: </a>  }
<a name="line209">209: </a>  // <a href="../../../docs/manualpages/Sys/PetscSleep.html#PetscSleep">PetscSleep</a>(2); exit(13);

<a name="line211">211: </a>  <font color="#B22222">/* assemble matrix or vector */</font>
<a name="line212">212: </a>  <a href="../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</a>(ctx-&gt;events[7],0,0,0,0);
<a name="line213">213: </a>  <a href="../../../docs/manualpages/Mat/MatAssemblyBegin.html#MatAssemblyBegin">MatAssemblyBegin</a>(JacP, <a href="../../../docs/manualpages/Mat/MatAssemblyType.html#MatAssemblyType">MAT_FINAL_ASSEMBLY</a>);
<a name="line214">214: </a>  <a href="../../../docs/manualpages/Mat/MatAssemblyEnd.html#MatAssemblyEnd">MatAssemblyEnd</a>(JacP, <a href="../../../docs/manualpages/Mat/MatAssemblyType.html#MatAssemblyType">MAT_FINAL_ASSEMBLY</a>);
<a name="line215">215: </a>  <a href="../../../docs/manualpages/Mat/MatScale.html#MatScale">MatScale</a>(JacP, -1.0); <font color="#B22222">/* The code reflect the papers: du/dt = C, whereas PETSc use the form G(u) = du/dt - C(u) = 0 */</font>
<a name="line216">216: </a>  <a href="../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</a>(ctx-&gt;events[7],0,0,0,0);

<a name="line218">218: </a>  <font color="#B22222">/* clean up */</font>
<a name="line219">219: </a>  <a href="../../../docs/manualpages/Sys/PetscFree3.html#PetscFree3">PetscFree3</a>(elemMat,wiGlob,invJ_a);
<a name="line220">220: </a>  <a href="../../../docs/manualpages/DM/DMDestroy.html#DMDestroy">DMDestroy</a>(&amp;plex);
<a name="line221">221: </a>  LandauPointDataDestroy(IPData);
<a name="line222">222: </a>  <font color="#4169E1">return</font>(0);
<a name="line223">223: </a>}

<a name="line225">225: </a><font color="#A020F0">#if defined(LANDAU_ADD_BCS)</font>
<a name="line226">226: </a><strong><font color="#4169E1"><a name="zero_bc"></a>static void zero_bc(<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dim, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> Nf, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> NfAux,</font></strong>
<a name="line227">227: </a><strong><font color="#4169E1">                    const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> uOff[], const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> uOff_x[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_t[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_x[],</font></strong>
<a name="line228">228: </a><strong><font color="#4169E1">                    const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> aOff[], const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> aOff_x[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a_t[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a_x[],</font></strong>
<a name="line229">229: </a><strong><font color="#4169E1">                    <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> t, const <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> x[], <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> numConstants, const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> constants[], <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> uexact[])</font></strong>
<a name="line230">230: </a>{
<a name="line231">231: </a>  uexact[0] = 0;
<a name="line232">232: </a>}
<a name="line233">233: </a><font color="#A020F0">#endif</font>

<a name="line235">235: </a><strong><font color="#228B22">#define MATVEC2(__a,__x,__p) {int i,j; for (i=0.; i&lt;2; i++) {__p[i] = 0; for (j=0.; j&lt;2; j++) __p[i] += __a[i][j]*__x[j]; }}</font></strong>
<a name="line236">236: </a><strong><font color="#4169E1"><a name="CircleInflate"></a>static void CircleInflate(<a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> r1, <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> r2, <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> r0, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> num_sections, <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> x, <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> y,</font></strong>
<a name="line237">237: </a><strong><font color="#4169E1">                          <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> *outX, <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> *outY)</font></strong>
<a name="line238">238: </a>{
<a name="line239">239: </a>  <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> rr = PetscSqrtReal(x*x + y*y), outfact, efact;
<a name="line240">240: </a>  <font color="#4169E1">if</font> (rr &lt; r1 + PETSC_SQRT_MACHINE_EPSILON) {
<a name="line241">241: </a>    *outX = x; *outY = y;
<a name="line242">242: </a>  } <font color="#4169E1">else</font> {
<a name="line243">243: </a>    const <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> xy[2] = {x,y}, sinphi=y/rr, cosphi=x/rr;
<a name="line244">244: </a>    <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>       cth,sth,xyprime[2],Rth[2][2],rotcos,newrr;
<a name="line245">245: </a>    <font color="#4169E1">if</font> (num_sections==2) {
<a name="line246">246: </a>      rotcos = 0.70710678118654;
<a name="line247">247: </a>      outfact = 1.5; efact = 2.5;
<a name="line248">248: </a>      <font color="#B22222">/* rotate normalized vector into [-pi/4,pi/4) */</font>
<a name="line249">249: </a>      <font color="#4169E1">if</font> (sinphi &gt;= 0.) {         <font color="#B22222">/* top cell, -pi/2 */</font>
<a name="line250">250: </a>        cth = 0.707106781186548; sth = -0.707106781186548;
<a name="line251">251: </a>      } <font color="#4169E1">else</font> {                    <font color="#B22222">/* bottom cell -pi/8 */</font>
<a name="line252">252: </a>        cth = 0.707106781186548; sth = .707106781186548;
<a name="line253">253: </a>      }
<a name="line254">254: </a>    } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (num_sections==3) {
<a name="line255">255: </a>      rotcos = 0.86602540378443;
<a name="line256">256: </a>      outfact = 1.5; efact = 2.5;
<a name="line257">257: </a>      <font color="#B22222">/* rotate normalized vector into [-pi/6,pi/6) */</font>
<a name="line258">258: </a>      <font color="#4169E1">if</font> (sinphi &gt;= 0.5) {         <font color="#B22222">/* top cell, -pi/3 */</font>
<a name="line259">259: </a>        cth = 0.5; sth = -0.866025403784439;
<a name="line260">260: </a>      } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (sinphi &gt;= -.5) {  <font color="#B22222">/* mid cell 0 */</font>
<a name="line261">261: </a>        cth = 1.; sth = .0;
<a name="line262">262: </a>      } <font color="#4169E1">else</font> { <font color="#B22222">/* bottom cell +pi/3 */</font>
<a name="line263">263: </a>        cth = 0.5; sth = 0.866025403784439;
<a name="line264">264: </a>      }
<a name="line265">265: </a>    } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (num_sections==4) {
<a name="line266">266: </a>      rotcos = 0.9238795325112;
<a name="line267">267: </a>      outfact = 1.5; efact = 3;
<a name="line268">268: </a>      <font color="#B22222">/* rotate normalized vector into [-pi/8,pi/8) */</font>
<a name="line269">269: </a>      <font color="#4169E1">if</font> (sinphi &gt;= 0.707106781186548) {         <font color="#B22222">/* top cell, -3pi/8 */</font>
<a name="line270">270: </a>        cth = 0.38268343236509; sth = -0.923879532511287;
<a name="line271">271: </a>      } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (sinphi &gt;= 0.) {                 <font color="#B22222">/* mid top cell -pi/8 */</font>
<a name="line272">272: </a>        cth = 0.923879532511287; sth = -.38268343236509;
<a name="line273">273: </a>      } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (sinphi &gt;= -0.707106781186548) { <font color="#B22222">/* mid bottom cell + pi/8 */</font>
<a name="line274">274: </a>        cth = 0.923879532511287; sth = 0.38268343236509;
<a name="line275">275: </a>      } <font color="#4169E1">else</font> {                                   <font color="#B22222">/* bottom cell + 3pi/8 */</font>
<a name="line276">276: </a>        cth = 0.38268343236509; sth = .923879532511287;
<a name="line277">277: </a>      }
<a name="line278">278: </a>    } <font color="#4169E1">else</font> {
<a name="line279">279: </a>      cth = 0.; sth = 0.; rotcos = 0; efact = 0;
<a name="line280">280: </a>    }
<a name="line281">281: </a>    Rth[0][0] = cth; Rth[0][1] =-sth;
<a name="line282">282: </a>    Rth[1][0] = sth; Rth[1][1] = cth;
<a name="line283">283: </a>    MATVEC2(Rth,xy,xyprime);
<a name="line284">284: </a>    <font color="#4169E1">if</font> (num_sections==2) {
<a name="line285">285: </a>      newrr = xyprime[0]/rotcos;
<a name="line286">286: </a>    } <font color="#4169E1">else</font> {
<a name="line287">287: </a>      <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> newcosphi=xyprime[0]/rr, rin = r1, rout = rr - rin;
<a name="line288">288: </a>      <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> routmax = r0*rotcos/newcosphi - rin, nroutmax = r0 - rin, routfrac = rout/routmax;
<a name="line289">289: </a>      newrr = rin + routfrac*nroutmax;
<a name="line290">290: </a>    }
<a name="line291">291: </a>    *outX = cosphi*newrr; *outY = sinphi*newrr;
<a name="line292">292: </a>    <font color="#B22222">/* grade */</font>
<a name="line293">293: </a>    <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> fact,tt,rs,re, rr = PetscSqrtReal(<a href="../../../docs/manualpages/Sys/PetscSqr.html#PetscSqr">PetscSqr</a>(*outX) + <a href="../../../docs/manualpages/Sys/PetscSqr.html#PetscSqr">PetscSqr</a>(*outY));
<a name="line294">294: </a>    <font color="#4169E1">if</font> (rr &gt; r2) { rs = r2; re = r0; fact = outfact;} <font color="#B22222">/* outer zone */</font>
<a name="line295">295: </a>    <font color="#4169E1">else</font> {         rs = r1; re = r2; fact = efact;} <font color="#B22222">/* electron zone */</font>
<a name="line296">296: </a>    tt = (rs + PetscPowReal((rr - rs)/(re - rs),fact) * (re-rs)) / rr;
<a name="line297">297: </a>    *outX *= tt;
<a name="line298">298: </a>    *outY *= tt;
<a name="line299">299: </a>  }
<a name="line300">300: </a>}

<a name="line302">302: </a><strong><font color="#4169E1"><a name="GeometryDMLandau"></a>static <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> GeometryDMLandau(<a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> base, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> point, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dim, const <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> abc[], <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> xyz[], void *a_ctx)</font></strong>
<a name="line303">303: </a>{
<a name="line304">304: </a>  LandauCtx   *ctx = (LandauCtx*)a_ctx;
<a name="line305">305: </a>  <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>   r = abc[0], z = abc[1];
<a name="line306">306: </a>  <font color="#4169E1">if</font> (ctx-&gt;inflate) {
<a name="line307">307: </a>    <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> absR, absZ;
<a name="line308">308: </a>    absR = <a href="../../../docs/manualpages/Sys/PetscAbsReal.html#PetscAbsReal">PetscAbsReal</a>(r);
<a name="line309">309: </a>    absZ = <a href="../../../docs/manualpages/Sys/PetscAbsReal.html#PetscAbsReal">PetscAbsReal</a>(z);
<a name="line310">310: </a>    CircleInflate(ctx-&gt;i_radius,ctx-&gt;e_radius,ctx-&gt;radius,ctx-&gt;num_sections,absR,absZ,&amp;absR,&amp;absZ);
<a name="line311">311: </a>    r = (r &gt; 0) ? absR : -absR;
<a name="line312">312: </a>    z = (z &gt; 0) ? absZ : -absZ;
<a name="line313">313: </a>  }
<a name="line314">314: </a>  xyz[0] = r;
<a name="line315">315: </a>  xyz[1] = z;
<a name="line316">316: </a>  <font color="#4169E1">if</font> (dim==3) xyz[2] = abc[2];

<a name="line318">318: </a>  <font color="#4169E1">return</font>(0);
<a name="line319">319: </a>}

<a name="line321">321: </a><strong><font color="#4169E1"><a name="ErrorIndicator_Simple"></a>static <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> ErrorIndicator_Simple(<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dim, <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> volume, <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> x[], <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> Nc, const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> Nf[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_x[], <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> *error, void *actx)</font></strong>
<a name="line322">322: </a>{
<a name="line323">323: </a>  <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> err = 0.0;
<a name="line324">324: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>  f = *(<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>*)actx, j;
<a name="line326">326: </a>  <font color="#4169E1">for</font> (j = 0; j &lt; dim; ++j) {
<a name="line327">327: </a>    err += <a href="../../../docs/manualpages/Sys/PetscSqr.html#PetscSqr">PetscSqr</a>(<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(u_x[f*dim+j]));
<a name="line328">328: </a>  }
<a name="line329">329: </a>  err = <a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(u[f]); <font color="#B22222">/* just use rho */</font>
<a name="line330">330: </a>  *error = volume * err; <font color="#B22222">/* * (ctx-&gt;axisymmetric ? 2.*PETSC_PI * r : 1); */</font>
<a name="line331">331: </a>  <font color="#4169E1">return</font>(0);
<a name="line332">332: </a>}

<a name="line334">334: </a><strong><font color="#4169E1"><a name="LandauDMCreateVMesh"></a>static <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> LandauDMCreateVMesh(<a href="../../../docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</a> comm, const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dim, const char prefix[], LandauCtx *ctx, <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> *dm)</font></strong>
<a name="line335">335: </a>{
<a name="line337">337: </a>  <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>      radius = ctx-&gt;radius;
<a name="line338">338: </a>  size_t         len;
<a name="line339">339: </a>  char           fname[128] = <font color="#666666">""</font>; <font color="#B22222">/* we can add a file if we want */</font>

<a name="line342">342: </a>  <font color="#B22222">/* create <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> */</font>
<a name="line343">343: </a>  <a href="../../../docs/manualpages/Sys/PetscStrlen.html#PetscStrlen">PetscStrlen</a>(fname, &amp;len);
<a name="line344">344: </a>  <font color="#4169E1">if</font> (len) {
<a name="line345">345: </a>    <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dim2;
<a name="line346">346: </a>    <a href="../../../docs/manualpages/DMPLEX/DMPlexCreateFromFile.html#DMPlexCreateFromFile">DMPlexCreateFromFile</a>(comm, fname, ctx-&gt;interpolate, dm);
<a name="line347">347: </a>    <a href="../../../docs/manualpages/DM/DMGetDimension.html#DMGetDimension">DMGetDimension</a>(*dm, &amp;dim2);
<a name="line348">348: </a>  } <font color="#4169E1">else</font> {    <font color="#B22222">/* p4est, quads */</font>
<a name="line349">349: </a>    <font color="#B22222">/* Create plex mesh of Landau domain */</font>
<a name="line350">350: </a>    <font color="#4169E1">if</font> (!ctx-&gt;sphere) {
<a name="line351">351: </a>      <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       cells[] = {2,2,2};
<a name="line352">352: </a>      <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>      lo[] = {-radius,-radius,-radius}, hi[] = {radius,radius,radius};
<a name="line353">353: </a>      <a href="../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DMBoundaryType</a> periodicity[3] = {<a href="../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_NONE</a>, dim==2 ? <a href="../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_NONE</a> : <a href="../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_NONE</a>, <a href="../../../docs/manualpages/DM/DMBoundaryType.html#DMBoundaryType">DM_BOUNDARY_NONE</a>};
<a name="line354">354: </a>      <font color="#4169E1">if</font> (dim==2) { lo[0] = 0; cells[0] = 1; }
<a name="line355">355: </a>      <font color="#4169E1">else</font> <font color="#4169E1">if</font> (ctx-&gt;quarter3DDomain) { lo[0] = lo[1] = 0; cells[0] = cells[1] = 2; }
<a name="line356">356: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexCreateBoxMesh.html#DMPlexCreateBoxMesh">DMPlexCreateBoxMesh</a>(comm, dim, <a href="../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>, cells, lo, hi, periodicity, <a href="../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>, dm);
<a name="line357">357: </a>      <a href="../../../docs/manualpages/DM/DMLocalizeCoordinates.html#DMLocalizeCoordinates">DMLocalizeCoordinates</a>(*dm); <font color="#B22222">/* needed for periodic */</font>
<a name="line358">358: </a>      <font color="#4169E1">if</font> (dim==3) {<a href="../../../docs/manualpages/Sys/PetscObjectSetName.html#PetscObjectSetName">PetscObjectSetName</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>) *dm, <font color="#666666">"cube"</font>);}
<a name="line359">359: </a>      <font color="#4169E1">else</font> {<a href="../../../docs/manualpages/Sys/PetscObjectSetName.html#PetscObjectSetName">PetscObjectSetName</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>) *dm, <font color="#666666">"half-plane"</font>);}
<a name="line360">360: </a>    } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (dim==2) {
<a name="line361">361: </a>      <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       numCells,cells[16][4],i,j;
<a name="line362">362: </a>      <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       numVerts;
<a name="line363">363: </a>      <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>      inner_radius1 = ctx-&gt;i_radius, inner_radius2 = ctx-&gt;e_radius;
<a name="line364">364: </a>      <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>      *flatCoords = NULL;
<a name="line365">365: </a>      <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       *flatCells = NULL, *pcell;
<a name="line366">366: </a>      <font color="#4169E1">if</font> (ctx-&gt;num_sections==2) {
<a name="line367">367: </a><font color="#A020F0">#if 1</font>
<a name="line368">368: </a>        numCells = 5;
<a name="line369">369: </a>        numVerts = 10;
<a name="line370">370: </a>        int cells2[][4] = { {0,1,4,3},
<a name="line371">371: </a>                            {1,2,5,4},
<a name="line372">372: </a>                            {3,4,7,6},
<a name="line373">373: </a>                            {4,5,8,7},
<a name="line374">374: </a>                            {6,7,8,9} };
<a name="line375">375: </a>        <font color="#4169E1">for</font> (i = 0; i &lt; numCells; i++) <font color="#4169E1">for</font> (j = 0; j &lt; 4; j++) cells[i][j] = cells2[i][j];
<a name="line376">376: </a>        <a href="../../../docs/manualpages/Sys/PetscMalloc2.html#PetscMalloc2">PetscMalloc2</a>(numVerts * 2, &amp;flatCoords, numCells * 4, &amp;flatCells);
<a name="line377">377: </a>        {
<a name="line378">378: </a>          <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> (*coords)[2] = (<a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> (*) [2]) flatCoords;
<a name="line379">379: </a>          <font color="#4169E1">for</font> (j = 0; j &lt; numVerts-1; j++) {
<a name="line380">380: </a>            <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> z, r, theta = -PETSC_PI/2 + (j%3) * PETSC_PI/2;
<a name="line381">381: </a>            <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> rad = (j &gt;= 6) ? inner_radius1 : (j &gt;= 3) ? inner_radius2 : ctx-&gt;radius;
<a name="line382">382: </a>            z = rad * PetscSinReal(theta);
<a name="line383">383: </a>            coords[j][1] = z;
<a name="line384">384: </a>            r = rad * PetscCosReal(theta);
<a name="line385">385: </a>            coords[j][0] = r;
<a name="line386">386: </a>          }
<a name="line387">387: </a>          coords[numVerts-1][0] = coords[numVerts-1][1] = 0;
<a name="line388">388: </a>        }
<a name="line389">389: </a><font color="#A020F0">#else</font>
<a name="line390">390: </a>        numCells = 4;
<a name="line391">391: </a>        numVerts = 8;
<a name="line392">392: </a>        static int     cells2[][4] = {{0,1,2,3},
<a name="line393">393: </a>                                     {4,5,1,0},
<a name="line394">394: </a>                                     {5,6,2,1},
<a name="line395">395: </a>                                     {6,7,3,2}};
<a name="line396">396: </a>        <font color="#4169E1">for</font> (i = 0; i &lt; numCells; i++) <font color="#4169E1">for</font> (j = 0; j &lt; 4; j++) cells[i][j] = cells2[i][j];
<a name="line397">397: </a>        <a href="../../../docs/manualpages/Sys/PetscMalloc2.html#PetscMalloc2">PetscMalloc2</a>(numVerts * 2, &amp;flatCoords, numCells * 4, &amp;flatCells);
<a name="line398">398: </a>        {
<a name="line399">399: </a>          <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> (*coords)[2] = (<a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> (*) [2]) flatCoords;
<a name="line400">400: </a>          <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> j;
<a name="line401">401: </a>          <font color="#4169E1">for</font> (j = 0; j &lt; 8; j++) {
<a name="line402">402: </a>            <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> z, r;
<a name="line403">403: </a>            <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> theta = -PETSC_PI/2 + (j%4) * PETSC_PI/3.;
<a name="line404">404: </a>            <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> rad = ctx-&gt;radius * ((j &lt; 4) ? 0.5 : 1.0);
<a name="line405">405: </a>            z = rad * PetscSinReal(theta);
<a name="line406">406: </a>            coords[j][1] = z;
<a name="line407">407: </a>            r = rad * PetscCosReal(theta);
<a name="line408">408: </a>            coords[j][0] = r;
<a name="line409">409: </a>          }
<a name="line410">410: </a>        }
<a name="line411">411: </a><font color="#A020F0">#endif</font>
<a name="line412">412: </a>      } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (ctx-&gt;num_sections==3) {
<a name="line413">413: </a>        numCells = 7;
<a name="line414">414: </a>        numVerts = 12;
<a name="line415">415: </a>        int cells2[][4] = { {0,1,5,4},
<a name="line416">416: </a>                            {1,2,6,5},
<a name="line417">417: </a>                            {2,3,7,6},
<a name="line418">418: </a>                            {4,5,9,8},
<a name="line419">419: </a>                            {5,6,10,9},
<a name="line420">420: </a>                            {6,7,11,10},
<a name="line421">421: </a>                            {8,9,10,11} };
<a name="line422">422: </a>        <font color="#4169E1">for</font> (i = 0; i &lt; numCells; i++) <font color="#4169E1">for</font> (j = 0; j &lt; 4; j++) cells[i][j] = cells2[i][j];
<a name="line423">423: </a>        <a href="../../../docs/manualpages/Sys/PetscMalloc2.html#PetscMalloc2">PetscMalloc2</a>(numVerts * 2, &amp;flatCoords, numCells * 4, &amp;flatCells);
<a name="line424">424: </a>        {
<a name="line425">425: </a>          <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> (*coords)[2] = (<a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> (*) [2]) flatCoords;
<a name="line426">426: </a>          <font color="#4169E1">for</font> (j = 0; j &lt; numVerts; j++) {
<a name="line427">427: </a>            <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> z, r, theta = -PETSC_PI/2 + (j%4) * PETSC_PI/3;
<a name="line428">428: </a>            <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> rad = (j &gt;= 8) ? inner_radius1 : (j &gt;= 4) ? inner_radius2 : ctx-&gt;radius;
<a name="line429">429: </a>            z = rad * PetscSinReal(theta);
<a name="line430">430: </a>            coords[j][1] = z;
<a name="line431">431: </a>            r = rad * PetscCosReal(theta);
<a name="line432">432: </a>            coords[j][0] = r;
<a name="line433">433: </a>          }
<a name="line434">434: </a>        }
<a name="line435">435: </a>      } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (ctx-&gt;num_sections==4) {
<a name="line436">436: </a>        numCells = 10;
<a name="line437">437: </a>        numVerts = 16;
<a name="line438">438: </a>        int cells2[][4] = { {0,1,6,5},
<a name="line439">439: </a>                            {1,2,7,6},
<a name="line440">440: </a>                            {2,3,8,7},
<a name="line441">441: </a>                            {3,4,9,8},
<a name="line442">442: </a>                            {5,6,11,10},
<a name="line443">443: </a>                            {6,7,12,11},
<a name="line444">444: </a>                            {7,8,13,12},
<a name="line445">445: </a>                            {8,9,14,13},
<a name="line446">446: </a>                            {10,11,12,15},
<a name="line447">447: </a>                            {12,13,14,15}};
<a name="line448">448: </a>        <font color="#4169E1">for</font> (i = 0; i &lt; numCells; i++) <font color="#4169E1">for</font> (j = 0; j &lt; 4; j++) cells[i][j] = cells2[i][j];
<a name="line449">449: </a>        <a href="../../../docs/manualpages/Sys/PetscMalloc2.html#PetscMalloc2">PetscMalloc2</a>(numVerts * 2, &amp;flatCoords, numCells * 4, &amp;flatCells);
<a name="line450">450: </a>        {
<a name="line451">451: </a>          <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> (*coords)[2] = (<a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> (*) [2]) flatCoords;
<a name="line452">452: </a>          <font color="#4169E1">for</font> (j = 0; j &lt; numVerts-1; j++) {
<a name="line453">453: </a>            <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> z, r, theta = -PETSC_PI/2 + (j%5) * PETSC_PI/4;
<a name="line454">454: </a>            <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> rad = (j &gt;= 10) ? inner_radius1 : (j &gt;= 5) ? inner_radius2 : ctx-&gt;radius;
<a name="line455">455: </a>            z = rad * PetscSinReal(theta);
<a name="line456">456: </a>            coords[j][1] = z;
<a name="line457">457: </a>            r = rad * PetscCosReal(theta);
<a name="line458">458: </a>            coords[j][0] = r;
<a name="line459">459: </a>          }
<a name="line460">460: </a>          coords[numVerts-1][0] = coords[numVerts-1][1] = 0;
<a name="line461">461: </a>        }
<a name="line462">462: </a>      } <font color="#4169E1">else</font> {
<a name="line463">463: </a>        numCells = 0;
<a name="line464">464: </a>        numVerts = 0;
<a name="line465">465: </a>      }
<a name="line466">466: </a>      <font color="#4169E1">for</font> (j = 0, pcell = flatCells; j &lt; numCells; j++, pcell += 4) {
<a name="line467">467: </a>        pcell[0] = cells[j][0]; pcell[1] = cells[j][1];
<a name="line468">468: </a>        pcell[2] = cells[j][2]; pcell[3] = cells[j][3];
<a name="line469">469: </a>      }
<a name="line470">470: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexCreateFromCellListPetsc.html#DMPlexCreateFromCellListPetsc">DMPlexCreateFromCellListPetsc</a>(comm,2,numCells,numVerts,4,ctx-&gt;interpolate,flatCells,2,flatCoords,dm);
<a name="line471">471: </a>      <a href="../../../docs/manualpages/Sys/PetscFree2.html#PetscFree2">PetscFree2</a>(flatCoords,flatCells);
<a name="line472">472: </a>      <a href="../../../docs/manualpages/Sys/PetscObjectSetName.html#PetscObjectSetName">PetscObjectSetName</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>) *dm, <font color="#666666">"semi-circle"</font>);
<a name="line473">473: </a>    } <font color="#4169E1">else</font> <a href="../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_PLIB, <font color="#666666">"Velocity space meshes does not support cubed sphere"</font>);
<a name="line474">474: </a>  }
<a name="line475">475: </a>  <a href="../../../docs/manualpages/Sys/PetscObjectSetOptionsPrefix.html#PetscObjectSetOptionsPrefix">PetscObjectSetOptionsPrefix</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)*dm,prefix);

<a name="line477">477: </a>  <a href="../../../docs/manualpages/DM/DMSetFromOptions.html#DMSetFromOptions">DMSetFromOptions</a>(*dm); <font color="#B22222">/* Plex refine */</font>

<a name="line479">479: </a>  { <font color="#B22222">/* p4est? */</font>
<a name="line480">480: </a>    char      convType[256];
<a name="line481">481: </a>    <a href="../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a> flg;
<a name="line482">482: </a>    <a href="../../../docs/manualpages/Sys/PetscOptionsBegin.html#PetscOptionsBegin">PetscOptionsBegin</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>, prefix, <font color="#666666">"Mesh conversion options"</font>, <font color="#666666">"<a href="../../../docs/manualpages/DMPLEX/DMPLEX.html#DMPLEX">DMPLEX</a>"</font>);
<a name="line483">483: </a>    <a href="../../../docs/manualpages/Sys/PetscOptionsFList.html#PetscOptionsFList">PetscOptionsFList</a>(<font color="#666666">"-dm_landau_type"</font>,<font color="#666666">"Convert DMPlex to another format (should not be Plex!)"</font>,<font color="#666666">"ex6f.c"</font>,DMList,<a href="../../../docs/manualpages/DMPLEX/DMPLEX.html#DMPLEX">DMPLEX</a>,convType,256,&amp;flg);
<a name="line484">484: </a>    <a href="../../../docs/manualpages/Sys/PetscOptionsEnd.html#PetscOptionsEnd">PetscOptionsEnd</a>();
<a name="line485">485: </a>    <font color="#4169E1">if</font> (flg) {
<a name="line486">486: </a>      <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> dmforest;
<a name="line487">487: </a>      <a href="../../../docs/manualpages/DM/DMConvert.html#DMConvert">DMConvert</a>(*dm,convType,&amp;dmforest);
<a name="line488">488: </a>      <font color="#4169E1">if</font> (dmforest) {
<a name="line489">489: </a>        <a href="../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a> isForest;
<a name="line490">490: </a>        <a href="../../../docs/manualpages/Sys/PetscObjectSetOptionsPrefix.html#PetscObjectSetOptionsPrefix">PetscObjectSetOptionsPrefix</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)dmforest,prefix);
<a name="line491">491: </a>        <a href="../../../docs/manualpages/DMFOREST/DMIsForest.html#DMIsForest">DMIsForest</a>(dmforest,&amp;isForest);
<a name="line492">492: </a>        <font color="#4169E1">if</font> (isForest) {
<a name="line493">493: </a>          <font color="#4169E1">if</font> (ctx-&gt;sphere &amp;&amp; ctx-&gt;inflate) {
<a name="line494">494: </a>            DMForestSetBaseCoordinateMapping(dmforest,GeometryDMLandau,ctx);
<a name="line495">495: </a>          }
<a name="line496">496: </a>          <a href="../../../docs/manualpages/DM/DMDestroy.html#DMDestroy">DMDestroy</a>(dm);
<a name="line497">497: </a>          *dm = dmforest;
<a name="line498">498: </a>          ctx-&gt;errorIndicator = ErrorIndicator_Simple; <font color="#B22222">/* flag for Forest */</font>
<a name="line499">499: </a>        } <font color="#4169E1">else</font> <a href="../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>, PETSC_ERR_USER, <font color="#666666">"Converted to non Forest?"</font>);
<a name="line500">500: </a>      } <font color="#4169E1">else</font> <a href="../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>, PETSC_ERR_USER, <font color="#666666">"Convert failed?"</font>);
<a name="line501">501: </a>    }
<a name="line502">502: </a>  }
<a name="line503">503: </a>  <a href="../../../docs/manualpages/Sys/PetscObjectSetName.html#PetscObjectSetName">PetscObjectSetName</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>) *dm, <font color="#666666">"Mesh"</font>);
<a name="line504">504: </a>  <font color="#4169E1">return</font>(0);
<a name="line505">505: </a>}

<a name="line507">507: </a><strong><font color="#4169E1"><a name="SetupDS"></a>static <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> SetupDS(<a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> dm, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dim, LandauCtx *ctx)</font></strong>
<a name="line508">508: </a>{
<a name="line509">509: </a>  <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>  ierr;
<a name="line510">510: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>        ii;
<a name="line512">512: </a>  <font color="#4169E1">for</font> (ii=0;ii&lt;ctx-&gt;num_species;ii++) {
<a name="line513">513: </a>    char     buf[256];
<a name="line514">514: </a>    <font color="#4169E1">if</font> (ii==0) <a href="../../../docs/manualpages/Sys/PetscSNPrintf.html#PetscSNPrintf">PetscSNPrintf</a>(buf, 256, <font color="#666666">"e"</font>);
<a name="line515">515: </a>    <font color="#4169E1">else</font> {<a href="../../../docs/manualpages/Sys/PetscSNPrintf.html#PetscSNPrintf">PetscSNPrintf</a>(buf, 256, <font color="#666666">"i%D"</font>, ii);}
<a name="line516">516: </a>    <font color="#B22222">/* Setup Discretization - FEM */</font>
<a name="line517">517: </a>    <a href="../../../docs/manualpages/FE/PetscFECreateDefault.html#PetscFECreateDefault">PetscFECreateDefault</a>(<a href="../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>) dm), dim, 1, ctx-&gt;simplex, NULL, <a href="../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>, &amp;ctx-&gt;fe[ii]);
<a name="line518">518: </a>    <a href="../../../docs/manualpages/Sys/PetscObjectSetName.html#PetscObjectSetName">PetscObjectSetName</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>) ctx-&gt;fe[ii], buf);
<a name="line519">519: </a>    <a href="../../../docs/manualpages/DM/DMSetField.html#DMSetField">DMSetField</a>(dm, ii, NULL, (<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>) ctx-&gt;fe[ii]);
<a name="line520">520: </a>  }
<a name="line521">521: </a>  <a href="../../../docs/manualpages/DM/DMCreateDS.html#DMCreateDS">DMCreateDS</a>(dm);
<a name="line522">522: </a>  <font color="#4169E1">if</font> (1) {
<a name="line523">523: </a>    <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>        ii;
<a name="line524">524: </a>    <a href="../../../docs/manualpages/PetscSection/PetscSection.html#PetscSection">PetscSection</a>    section;
<a name="line525">525: </a>    <a href="../../../docs/manualpages/DM/DMGetSection.html#DMGetSection">DMGetSection</a>(dm, &amp;section);
<a name="line526">526: </a>    <font color="#4169E1">for</font> (ii=0;ii&lt;ctx-&gt;num_species;ii++){
<a name="line527">527: </a>      char buf[256];
<a name="line528">528: </a>      <font color="#4169E1">if</font> (ii==0) <a href="../../../docs/manualpages/Sys/PetscSNPrintf.html#PetscSNPrintf">PetscSNPrintf</a>(buf, 256, <font color="#666666">"se"</font>);
<a name="line529">529: </a>      <font color="#4169E1">else</font> <a href="../../../docs/manualpages/Sys/PetscSNPrintf.html#PetscSNPrintf">PetscSNPrintf</a>(buf, 256, <font color="#666666">"si%D"</font>, ii);
<a name="line530">530: </a>      <a href="../../../docs/manualpages/PetscSection/PetscSectionSetComponentName.html#PetscSectionSetComponentName">PetscSectionSetComponentName</a>(section, ii, 0, buf);
<a name="line531">531: </a>    }
<a name="line532">532: </a>  }
<a name="line533">533: </a>  <font color="#4169E1">return</font>(0);
<a name="line534">534: </a>}

<a name="line536">536: </a><font color="#B22222">/* Define a Maxwellian function for testing out the operator. */</font>

<a name="line538">538: </a> <font color="#B22222">/* Using cartesian velocity space coordinates, the particle */</font>
<a name="line539">539: </a> <font color="#B22222">/* density, [1/m^3], is defined according to */</font>

<a name="line541">541: </a> <font color="#B22222">/* $$ n=\int_{R^3} dv^3 \left(\frac{m}{2\pi T}\right)^{3/2}\exp [- mv^2/(2T)] $$ */</font>

<a name="line543">543: </a> <font color="#B22222">/* Using some constant, c, we normalize the velocity vector into a */</font>
<a name="line544">544: </a> <font color="#B22222">/* dimensionless variable according to v=c*x. Thus the density, $n$, becomes */</font>

<a name="line546">546: </a> <font color="#B22222">/* $$ n=\int_{R^3} dx^3 \left(\frac{mc^2}{2\pi T}\right)^{3/2}\exp [- mc^2/(2T)*x^2] $$ */</font>

<a name="line548">548: </a> <font color="#B22222">/* Defining $\theta=2T/mc^2$, we thus find that the probability density */</font>
<a name="line549">549: </a> <font color="#B22222">/* for finding the particle within the interval in a box dx^3 around x is */</font>

<a name="line551">551: </a> <font color="#B22222">/* f(x;\theta)=\left(\frac{1}{\pi\theta}\right)^{3/2} \exp [ -x^2/\theta ] */</font>

<a name="line553">553: </a><font color="#4169E1">typedef</font> <font color="#4169E1">struct</font> {
<a name="line554">554: </a>  LandauCtx   *ctx;
<a name="line555">555: </a>  <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> kT_m;
<a name="line556">556: </a>  <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> n;
<a name="line557">557: </a>  <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> shift;
<a name="line558">558: </a>} MaxwellianCtx;

<a name="line560">560: </a><strong><font color="#4169E1"><a name="maxwellian"></a>static <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> maxwellian(<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dim, <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> time, const <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> x[], <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> Nf_dummy, <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> *u, void *actx)</font></strong>
<a name="line561">561: </a>{
<a name="line562">562: </a>  MaxwellianCtx *mctx = (MaxwellianCtx*)actx;
<a name="line563">563: </a>  LandauCtx     *ctx = mctx-&gt;ctx;
<a name="line564">564: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>      i;
<a name="line565">565: </a>  <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>     v2 = 0, theta = 2*mctx-&gt;kT_m/(ctx-&gt;v_0*ctx-&gt;v_0); <font color="#B22222">/* theta = 2kT/mc^2 */</font>
<a name="line567">567: </a>  <font color="#B22222">/* compute the exponents, v^2 */</font>
<a name="line568">568: </a>  <font color="#4169E1">for</font> (i = 0; i &lt; dim; ++i) v2 += x[i]*x[i];
<a name="line569">569: </a>  <font color="#B22222">/* evaluate the Maxwellian */</font>
<a name="line570">570: </a>  u[0] = mctx-&gt;n*PetscPowReal(PETSC_PI*theta,-1.5)*(PetscExpReal(-v2/theta));
<a name="line571">571: </a>  <font color="#4169E1">if</font> (mctx-&gt;shift!=0.) {
<a name="line572">572: </a>    v2 = 0;
<a name="line573">573: </a>    <font color="#4169E1">for</font> (i = 0; i &lt; dim-1; ++i) v2 += x[i]*x[i];
<a name="line574">574: </a>    v2 += (x[dim-1]-mctx-&gt;shift)*(x[dim-1]-mctx-&gt;shift);
<a name="line575">575: </a>    <font color="#B22222">/* evaluate the shifted Maxwellian */</font>
<a name="line576">576: </a>    u[0] += mctx-&gt;n*PetscPowReal(PETSC_PI*theta,-1.5)*(PetscExpReal(-v2/theta));
<a name="line577">577: </a>  }
<a name="line578">578: </a>  <font color="#4169E1">return</font>(0);
<a name="line579">579: </a>}

<a name="line581">581: </a><font color="#B22222">/*@</font>
<a name="line582">582: </a><font color="#B22222"> <a href="../../../docs/manualpages/LANDAU/LandauAddMaxwellians.html#LandauAddMaxwellians">LandauAddMaxwellians</a> - Add a Maxwellian distribution to a state</font>

<a name="line584">584: </a><font color="#B22222"> Collective on X</font>

<a name="line586">586: </a><font color="#B22222"> Input Parameters:</font>
<a name="line587">587: </a><font color="#B22222"> .   dm - The mesh</font>
<a name="line588">588: </a><font color="#B22222"> +   time - Current time</font>
<a name="line589">589: </a><font color="#B22222"> -   temps - Temperatures of each species</font>
<a name="line590">590: </a><font color="#B22222"> .   ns - Number density of each species</font>
<a name="line591">591: </a><font color="#B22222"> +   actx - Landau context</font>

<a name="line593">593: </a><font color="#B22222"> Output Parameter:</font>
<a name="line594">594: </a><font color="#B22222"> .   X  - The state</font>

<a name="line596">596: </a><font color="#B22222"> Level: beginner</font>

<a name="line598">598: </a><font color="#B22222">.keywords: mesh</font>
<a name="line599">599: </a><font color="#B22222">.seealso: <a href="../../../docs/manualpages/LANDAU/LandauCreateVelocitySpace.html#LandauCreateVelocitySpace">LandauCreateVelocitySpace</a>()</font>
<a name="line600">600: </a><font color="#B22222">@*/</font>
<a name="line601">601: </a><strong><font color="#4169E1"><a name="LandauAddMaxwellians"></a><a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../docs/manualpages/LANDAU/LandauAddMaxwellians.html#LandauAddMaxwellians">LandauAddMaxwellians</a>(<a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> dm, <a href="../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a> X, <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> time, <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> temps[], <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> ns[], void *actx)</font></strong>
<a name="line602">602: </a>{
<a name="line603">603: </a>  LandauCtx      *ctx = (LandauCtx*)actx;
<a name="line604">604: </a>  <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> (*initu[LANDAU_MAX_SPECIES])(<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>, <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>, const <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> [], <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>, <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> [], void *);
<a name="line605">605: </a>  <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> ierr,ii;
<a name="line606">606: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       dim;
<a name="line607">607: </a>  MaxwellianCtx  *mctxs[LANDAU_MAX_SPECIES], data[LANDAU_MAX_SPECIES];

<a name="line610">610: </a>  <a href="../../../docs/manualpages/DM/DMGetDimension.html#DMGetDimension">DMGetDimension</a>(dm, &amp;dim);
<a name="line611">611: </a>  <font color="#4169E1">if</font> (!ctx) { <a href="../../../docs/manualpages/DM/DMGetApplicationContext.html#DMGetApplicationContext">DMGetApplicationContext</a>(dm, &amp;ctx); }
<a name="line612">612: </a>  <font color="#4169E1">for</font> (ii=0;ii&lt;ctx-&gt;num_species;ii++) {
<a name="line613">613: </a>    mctxs[ii] = &amp;data[ii];
<a name="line614">614: </a>    data[ii].ctx = ctx;
<a name="line615">615: </a>    data[ii].kT_m = ctx-&gt;k*temps[ii]/ctx-&gt;masses[ii]; <font color="#B22222">/* kT/m */</font>
<a name="line616">616: </a>    data[ii].n = ns[ii];
<a name="line617">617: </a>    initu[ii] = maxwellian;
<a name="line618">618: </a>    data[ii].shift = 0;
<a name="line619">619: </a>  }
<a name="line620">620: </a>  data[0].shift = ctx-&gt;electronShift;
<a name="line621">621: </a>  <font color="#B22222">/* need to make <a href="../../../docs/manualpages/Sys/InsertMode.html#InsertMode">ADD_ALL_VALUES</a> work - TODO */</font>
<a name="line622">622: </a>  <a href="../../../docs/manualpages/DM/DMProjectFunction.html#DMProjectFunction">DMProjectFunction</a>(dm, time, initu, (void**)mctxs, <a href="../../../docs/manualpages/Sys/InsertMode.html#InsertMode">INSERT_ALL_VALUES</a>, X);
<a name="line623">623: </a>  <font color="#4169E1">return</font>(0);
<a name="line624">624: </a>}

<a name="line626">626: </a><font color="#B22222">/*</font>
<a name="line627">627: </a><font color="#B22222"> LandauSetInitialCondition - Addes Maxwellians with context</font>

<a name="line629">629: </a><font color="#B22222">Collective on X</font>

<a name="line631">631: </a><font color="#B22222"> Input Parameters:</font>
<a name="line632">632: </a><font color="#B22222"> .   dm - The mesh</font>
<a name="line633">633: </a><font color="#B22222"> +   actx - Landau context with T and n</font>

<a name="line635">635: </a><font color="#B22222"> Output Parameter:</font>
<a name="line636">636: </a><font color="#B22222"> .   X  - The state</font>

<a name="line638">638: </a><font color="#B22222"> Level: beginner</font>

<a name="line640">640: </a><font color="#B22222">.keywords: mesh</font>
<a name="line641">641: </a><font color="#B22222">.seealso: <a href="../../../docs/manualpages/LANDAU/LandauCreateVelocitySpace.html#LandauCreateVelocitySpace">LandauCreateVelocitySpace</a>(), <a href="../../../docs/manualpages/LANDAU/LandauAddMaxwellians.html#LandauAddMaxwellians">LandauAddMaxwellians</a>()</font>
<a name="line642">642: </a><font color="#B22222">*/</font>
<a name="line643">643: </a><strong><font color="#4169E1"><a name="LandauSetInitialCondition"></a>static <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> LandauSetInitialCondition(<a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> dm, <a href="../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a> X, void *actx)</font></strong>
<a name="line644">644: </a>{
<a name="line645">645: </a>  LandauCtx        *ctx = (LandauCtx*)actx;
<a name="line648">648: </a>  <font color="#4169E1">if</font> (!ctx) { <a href="../../../docs/manualpages/DM/DMGetApplicationContext.html#DMGetApplicationContext">DMGetApplicationContext</a>(dm, &amp;ctx); }
<a name="line649">649: </a>  <a href="../../../docs/manualpages/Vec/VecZeroEntries.html#VecZeroEntries">VecZeroEntries</a>(X);
<a name="line650">650: </a>  <a href="../../../docs/manualpages/LANDAU/LandauAddMaxwellians.html#LandauAddMaxwellians">LandauAddMaxwellians</a>(dm, X, 0.0, ctx-&gt;thermal_temps, ctx-&gt;n, ctx);
<a name="line651">651: </a>  <font color="#4169E1">return</font>(0);
<a name="line652">652: </a>}

<a name="line654">654: </a><strong><font color="#4169E1"><a name="adaptToleranceFEM"></a>static <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> adaptToleranceFEM(<a href="../../../docs/manualpages/FE/PetscFE.html#PetscFE">PetscFE</a> fem, <a href="../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a> sol, <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> refineTol[], <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> coarsenTol[], <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> type, LandauCtx *ctx, <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> *newDM)</font></strong>
<a name="line655">655: </a>{
<a name="line656">656: </a>  <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a>               dm, plex, adaptedDM = NULL;
<a name="line657">657: </a>  <a href="../../../docs/manualpages/DM/PetscDS.html#PetscDS">PetscDS</a>          prob;
<a name="line658">658: </a>  <a href="../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>        isForest;
<a name="line659">659: </a>  <a href="../../../docs/manualpages/FE/PetscQuadrature.html#PetscQuadrature">PetscQuadrature</a>  quad;
<a name="line660">660: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>         Nq, *Nb, cStart, cEnd, c, dim, qj, k;
<a name="line661">661: </a>  <a href="../../../docs/manualpages/DM/DMLabel.html#DMLabel">DMLabel</a>          adaptLabel = NULL;
<a name="line662">662: </a>  <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>   ierr;

<a name="line665">665: </a>  <a href="../../../docs/manualpages/DM/VecGetDM.html#VecGetDM">VecGetDM</a>(sol, &amp;dm);
<a name="line666">666: </a>  <a href="../../../docs/manualpages/DM/DMCreateDS.html#DMCreateDS">DMCreateDS</a>(dm);
<a name="line667">667: </a>  <a href="../../../docs/manualpages/DM/DMGetDS.html#DMGetDS">DMGetDS</a>(dm, &amp;prob);
<a name="line668">668: </a>  <a href="../../../docs/manualpages/DM/DMGetDimension.html#DMGetDimension">DMGetDimension</a>(dm, &amp;dim);
<a name="line669">669: </a>  <a href="../../../docs/manualpages/DMFOREST/DMIsForest.html#DMIsForest">DMIsForest</a>(dm, &amp;isForest);
<a name="line670">670: </a>  <a href="../../../docs/manualpages/DM/DMConvert.html#DMConvert">DMConvert</a>(dm, <a href="../../../docs/manualpages/DMPLEX/DMPLEX.html#DMPLEX">DMPLEX</a>, &amp;plex);
<a name="line671">671: </a>  <a href="../../../docs/manualpages/DMPLEX/DMPlexGetHeightStratum.html#DMPlexGetHeightStratum">DMPlexGetHeightStratum</a>(plex,0,&amp;cStart,&amp;cEnd);
<a name="line672">672: </a>  <a href="../../../docs/manualpages/DMLABEL/DMLabelCreate.html#DMLabelCreate">DMLabelCreate</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>,<font color="#666666">"adapt"</font>,&amp;adaptLabel);
<a name="line673">673: </a>  <a href="../../../docs/manualpages/FE/PetscFEGetQuadrature.html#PetscFEGetQuadrature">PetscFEGetQuadrature</a>(fem, &amp;quad);
<a name="line674">674: </a>  <a href="../../../docs/manualpages/DT/PetscQuadratureGetData.html#PetscQuadratureGetData">PetscQuadratureGetData</a>(quad, NULL, NULL, &amp;Nq, NULL, NULL);
<a name="line675">675: </a>  <font color="#4169E1">if</font> (Nq &gt;LANDAU_MAX_NQ) <a href="../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,PETSC_ERR_ARG_WRONG,<font color="#666666">"Order too high. Nq = %D &gt; LANDAU_MAX_NQ (%D)"</font>,Nq,LANDAU_MAX_NQ);
<a name="line676">676: </a>  <a href="../../../docs/manualpages/DT/PetscDSGetDimensions.html#PetscDSGetDimensions">PetscDSGetDimensions</a>(prob, &amp;Nb);
<a name="line677">677: </a>  <font color="#4169E1">if</font> (type==4) {
<a name="line678">678: </a>    <font color="#4169E1">for</font> (c = cStart; c &lt; cEnd; c++) {
<a name="line679">679: </a>      <a href="../../../docs/manualpages/DMLABEL/DMLabelSetValue.html#DMLabelSetValue">DMLabelSetValue</a>(adaptLabel, c, <a href="../../../docs/manualpages/DM/DMAdaptFlag.html#DMAdaptFlag">DM_ADAPT_REFINE</a>);
<a name="line680">680: </a>    }
<a name="line681">681: </a>    PetscInfo1(sol, <font color="#666666">"Phase:%s: Uniform refinement\n"</font>,<font color="#666666">"adaptToleranceFEM"</font>);
<a name="line682">682: </a>  } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (type==2) {
<a name="line683">683: </a>    <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>  rCellIdx[8], eCellIdx[64], iCellIdx[64], eMaxIdx = -1, iMaxIdx = -1, nr = 0, nrmax = (dim==3 &amp;&amp; !ctx-&gt;quarter3DDomain) ? 8 : 2;
<a name="line684">684: </a>    <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> minRad = PETSC_INFINITY, r, eMinRad = PETSC_INFINITY, iMinRad = PETSC_INFINITY;
<a name="line685">685: </a>    <font color="#4169E1">for</font> (c = 0; c &lt; 64; c++) { eCellIdx[c] = iCellIdx[c] = -1; }
<a name="line686">686: </a>    <font color="#4169E1">for</font> (c = cStart; c &lt; cEnd; c++) {
<a name="line687">687: </a>      <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>    tt, v0[LANDAU_MAX_NQ*3], detJ[LANDAU_MAX_NQ];
<a name="line688">688: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexComputeCellGeometryFEM.html#DMPlexComputeCellGeometryFEM">DMPlexComputeCellGeometryFEM</a>(plex, c, quad, v0, NULL, NULL, detJ);
<a name="line689">689: </a>      <font color="#4169E1">for</font> (qj = 0; qj &lt; Nq; ++qj) {
<a name="line690">690: </a>        tt = <a href="../../../docs/manualpages/Sys/PetscSqr.html#PetscSqr">PetscSqr</a>(v0[dim*qj+0]) + <a href="../../../docs/manualpages/Sys/PetscSqr.html#PetscSqr">PetscSqr</a>(v0[dim*qj+1]) + <a href="../../../docs/manualpages/Sys/PetscSqr.html#PetscSqr">PetscSqr</a>(((dim==3) ? v0[dim*qj+2] : 0));
<a name="line691">691: </a>        r = PetscSqrtReal(tt);
<a name="line692">692: </a>        <font color="#4169E1">if</font> (r &lt; minRad - PETSC_SQRT_MACHINE_EPSILON*10.) {
<a name="line693">693: </a>          minRad = r;
<a name="line694">694: </a>          nr = 0;
<a name="line695">695: </a>          rCellIdx[nr++]= c;
<a name="line696">696: </a>          PetscInfo4(sol, <font color="#666666">"\t\tPhase: adaptToleranceFEM Found first inner r=%e, cell %D, qp %D/%D\n"</font>, r, c, qj+1, Nq);
<a name="line697">697: </a>        } <font color="#4169E1">else</font> <font color="#4169E1">if</font> ((r-minRad) &lt; PETSC_SQRT_MACHINE_EPSILON*100. &amp;&amp; nr &lt; nrmax) {
<a name="line698">698: </a>          <font color="#4169E1">for</font> (k=0;k&lt;nr;k++) <font color="#4169E1">if</font> (c == rCellIdx[k]) <font color="#4169E1">break</font>;
<a name="line699">699: </a>          <font color="#4169E1">if</font> (k==nr) {
<a name="line700">700: </a>            rCellIdx[nr++]= c;
<a name="line701">701: </a>            PetscInfo5(sol, <font color="#666666">"\t\t\tPhase: adaptToleranceFEM Found another inner r=%e, cell %D, qp %D/%D, d=%e\n"</font>, r, c, qj+1, Nq, r-minRad);
<a name="line702">702: </a>          }
<a name="line703">703: </a>        }
<a name="line704">704: </a>        <font color="#4169E1">if</font> (ctx-&gt;sphere) {
<a name="line705">705: </a>          <font color="#4169E1">if</font> ((tt=r-ctx-&gt;e_radius) &gt; 0) {
<a name="line706">706: </a>            PetscInfo2(sol, <font color="#666666">"\t\t\t %D cell r=%g\n"</font>,c,tt);
<a name="line707">707: </a>            <font color="#4169E1">if</font> (tt &lt; eMinRad - PETSC_SQRT_MACHINE_EPSILON*100.) {
<a name="line708">708: </a>              eMinRad = tt;
<a name="line709">709: </a>              eMaxIdx = 0;
<a name="line710">710: </a>              eCellIdx[eMaxIdx++] = c;
<a name="line711">711: </a>            } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (eMaxIdx &gt; 0 &amp;&amp; (tt-eMinRad) &lt;= PETSC_SQRT_MACHINE_EPSILON &amp;&amp; c != eCellIdx[eMaxIdx-1]) {
<a name="line712">712: </a>              eCellIdx[eMaxIdx++] = c;
<a name="line713">713: </a>            }
<a name="line714">714: </a>          }
<a name="line715">715: </a>          <font color="#4169E1">if</font> ((tt=r-ctx-&gt;i_radius) &gt; 0) {
<a name="line716">716: </a>            <font color="#4169E1">if</font> (tt &lt; iMinRad - 1.e-5) {
<a name="line717">717: </a>              iMinRad = tt;
<a name="line718">718: </a>              iMaxIdx = 0;
<a name="line719">719: </a>              iCellIdx[iMaxIdx++] = c;
<a name="line720">720: </a>            } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (iMaxIdx &gt; 0 &amp;&amp; (tt-iMinRad) &lt;= PETSC_SQRT_MACHINE_EPSILON &amp;&amp; c != iCellIdx[iMaxIdx-1]) {
<a name="line721">721: </a>              iCellIdx[iMaxIdx++] = c;
<a name="line722">722: </a>            }
<a name="line723">723: </a>          }
<a name="line724">724: </a>        }
<a name="line725">725: </a>      }
<a name="line726">726: </a>    }
<a name="line727">727: </a>    <font color="#4169E1">for</font> (k=0;k&lt;nr;k++) {
<a name="line728">728: </a>      <a href="../../../docs/manualpages/DMLABEL/DMLabelSetValue.html#DMLabelSetValue">DMLabelSetValue</a>(adaptLabel, rCellIdx[k], <a href="../../../docs/manualpages/DM/DMAdaptFlag.html#DMAdaptFlag">DM_ADAPT_REFINE</a>);
<a name="line729">729: </a>    }
<a name="line730">730: </a>    <font color="#4169E1">if</font> (ctx-&gt;sphere) {
<a name="line731">731: </a>      <font color="#4169E1">for</font> (c = 0; c &lt; eMaxIdx; c++) {
<a name="line732">732: </a>        <a href="../../../docs/manualpages/DMLABEL/DMLabelSetValue.html#DMLabelSetValue">DMLabelSetValue</a>(adaptLabel, eCellIdx[c], <a href="../../../docs/manualpages/DM/DMAdaptFlag.html#DMAdaptFlag">DM_ADAPT_REFINE</a>);
<a name="line733">733: </a>        PetscInfo3(sol, <font color="#666666">"\t\tPhase:%s: refine sphere e cell %D r=%g\n"</font>,<font color="#666666">"adaptToleranceFEM"</font>,eCellIdx[c],eMinRad);
<a name="line734">734: </a>      }
<a name="line735">735: </a>      <font color="#4169E1">for</font> (c = 0; c &lt; iMaxIdx; c++) {
<a name="line736">736: </a>        <a href="../../../docs/manualpages/DMLABEL/DMLabelSetValue.html#DMLabelSetValue">DMLabelSetValue</a>(adaptLabel, iCellIdx[c], <a href="../../../docs/manualpages/DM/DMAdaptFlag.html#DMAdaptFlag">DM_ADAPT_REFINE</a>);
<a name="line737">737: </a>        PetscInfo3(sol, <font color="#666666">"\t\tPhase:%s: refine sphere i cell %D r=%g\n"</font>,<font color="#666666">"adaptToleranceFEM"</font>,iCellIdx[c],iMinRad);
<a name="line738">738: </a>      }
<a name="line739">739: </a>    }
<a name="line740">740: </a>    PetscInfo4(sol, <font color="#666666">"Phase:%s: Adaptive refine origin cells %D,%D r=%g\n"</font>,<font color="#666666">"adaptToleranceFEM"</font>,rCellIdx[0],rCellIdx[1],minRad);
<a name="line741">741: </a>  } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (type==0 || type==1 || type==3) { <font color="#B22222">/* refine along r=0 axis */</font>
<a name="line742">742: </a>    <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>  *coef = NULL;
<a name="line743">743: </a>    <a href="../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a>          coords;
<a name="line744">744: </a>    <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>     csize,Nv,d,nz;
<a name="line745">745: </a>    <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a>           cdm;
<a name="line746">746: </a>    <a href="../../../docs/manualpages/PetscSection/PetscSection.html#PetscSection">PetscSection</a> cs;
<a name="line747">747: </a>    <a href="../../../docs/manualpages/DM/DMGetCoordinatesLocal.html#DMGetCoordinatesLocal">DMGetCoordinatesLocal</a>(dm, &amp;coords);
<a name="line748">748: </a>    <a href="../../../docs/manualpages/DM/DMGetCoordinateDM.html#DMGetCoordinateDM">DMGetCoordinateDM</a>(dm, &amp;cdm);
<a name="line749">749: </a>    <a href="../../../docs/manualpages/DM/DMGetLocalSection.html#DMGetLocalSection">DMGetLocalSection</a>(cdm, &amp;cs);
<a name="line750">750: </a>    <font color="#4169E1">for</font> (c = cStart; c &lt; cEnd; c++) {
<a name="line751">751: </a>      <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> doit = 0, outside = 0;
<a name="line752">752: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexVecGetClosure.html#DMPlexVecGetClosure">DMPlexVecGetClosure</a>(cdm, cs, coords, c, &amp;csize, &amp;coef);
<a name="line753">753: </a>      Nv = csize/dim;
<a name="line754">754: </a>      <font color="#4169E1">for</font> (nz = d = 0; d &lt; Nv; d++) {
<a name="line755">755: </a>        <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> z = <a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(coef[d*dim + (dim-1)]), x = <a href="../../../docs/manualpages/Sys/PetscSqr.html#PetscSqr">PetscSqr</a>(<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(coef[d*dim + 0])) + ((dim==3) ? <a href="../../../docs/manualpages/Sys/PetscSqr.html#PetscSqr">PetscSqr</a>(<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(coef[d*dim + 1])) : 0);
<a name="line756">756: </a>        x = PetscSqrtReal(x);
<a name="line757">757: </a>        <font color="#4169E1">if</font> (x &lt; PETSC_MACHINE_EPSILON*10. &amp;&amp; <a href="../../../docs/manualpages/Sys/PetscAbsReal.html#PetscAbsReal">PetscAbsReal</a>(z)&lt;PETSC_MACHINE_EPSILON*10.) doit = 1;             <font color="#B22222">/* refine origin */</font>
<a name="line758">758: </a>        <font color="#4169E1">else</font> <font color="#4169E1">if</font> (type==0 &amp;&amp; (z &lt; -PETSC_MACHINE_EPSILON*10. || z &gt; ctx-&gt;re_radius+PETSC_MACHINE_EPSILON*10.)) outside++;   <font color="#B22222">/* first pass don't refine bottom */</font>
<a name="line759">759: </a>        <font color="#4169E1">else</font> <font color="#4169E1">if</font> (type==1 &amp;&amp; (z &gt; ctx-&gt;vperp0_radius1 || z &lt; -ctx-&gt;vperp0_radius1)) outside++; <font color="#B22222">/* don't refine outside electron refine radius */</font>
<a name="line760">760: </a>        <font color="#4169E1">else</font> <font color="#4169E1">if</font> (type==3 &amp;&amp; (z &gt; ctx-&gt;vperp0_radius2 || z &lt; -ctx-&gt;vperp0_radius2)) outside++; <font color="#B22222">/* don't refine outside ion refine radius */</font>
<a name="line761">761: </a>        <font color="#4169E1">if</font> (x &lt; PETSC_MACHINE_EPSILON*10.) nz++;
<a name="line762">762: </a>      }
<a name="line763">763: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexVecRestoreClosure.html#DMPlexVecRestoreClosure">DMPlexVecRestoreClosure</a>(cdm, cs, coords, c, &amp;csize, &amp;coef);
<a name="line764">764: </a>      <font color="#4169E1">if</font> (doit || (outside&lt;Nv &amp;&amp; nz)) {
<a name="line765">765: </a>        <a href="../../../docs/manualpages/DMLABEL/DMLabelSetValue.html#DMLabelSetValue">DMLabelSetValue</a>(adaptLabel, c, <a href="../../../docs/manualpages/DM/DMAdaptFlag.html#DMAdaptFlag">DM_ADAPT_REFINE</a>);
<a name="line766">766: </a>      }
<a name="line767">767: </a>    }
<a name="line768">768: </a>    PetscInfo1(sol, <font color="#666666">"Phase:%s: RE refinement\n"</font>,<font color="#666666">"adaptToleranceFEM"</font>);
<a name="line769">769: </a>  }
<a name="line770">770: </a>  <font color="#B22222">/* <a href="../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</a>(&amp;locX); */</font>
<a name="line771">771: </a>  <a href="../../../docs/manualpages/DM/DMDestroy.html#DMDestroy">DMDestroy</a>(&amp;plex);
<a name="line772">772: </a>  <a href="../../../docs/manualpages/DM/DMAdaptLabel.html#DMAdaptLabel">DMAdaptLabel</a>(dm, adaptLabel, &amp;adaptedDM);
<a name="line773">773: </a>  <a href="../../../docs/manualpages/DMLABEL/DMLabelDestroy.html#DMLabelDestroy">DMLabelDestroy</a>(&amp;adaptLabel);
<a name="line774">774: </a>  *newDM = adaptedDM;
<a name="line775">775: </a>  <font color="#4169E1">if</font> (adaptedDM) {
<a name="line776">776: </a>    <font color="#4169E1">if</font> (isForest) {
<a name="line777">777: </a>      <a href="../../../docs/manualpages/DMFOREST/DMForestSetAdaptivityForest.html#DMForestSetAdaptivityForest">DMForestSetAdaptivityForest</a>(adaptedDM,NULL);
<a name="line778">778: </a>    }
<a name="line779">779: </a>    <a href="../../../docs/manualpages/DM/DMConvert.html#DMConvert">DMConvert</a>(adaptedDM, <a href="../../../docs/manualpages/DMPLEX/DMPLEX.html#DMPLEX">DMPLEX</a>, &amp;plex);
<a name="line780">780: </a>    <a href="../../../docs/manualpages/DMPLEX/DMPlexGetHeightStratum.html#DMPlexGetHeightStratum">DMPlexGetHeightStratum</a>(plex,0,&amp;cStart,&amp;cEnd);
<a name="line781">781: </a>    PetscInfo2(sol, <font color="#666666">"\tPhase: adaptToleranceFEM: %D cells, %d total quadrature points\n"</font>,cEnd-cStart,Nq*(cEnd-cStart));
<a name="line782">782: </a>    <a href="../../../docs/manualpages/DM/DMDestroy.html#DMDestroy">DMDestroy</a>(&amp;plex);
<a name="line783">783: </a>  }
<a name="line784">784: </a>  <font color="#4169E1">return</font>(0);
<a name="line785">785: </a>}

<a name="line787">787: </a><strong><font color="#4169E1"><a name="adapt"></a>static <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> adapt(<a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> *dm, LandauCtx *ctx, <a href="../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a> *uu)</font></strong>
<a name="line788">788: </a>{
<a name="line789">789: </a>  <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>  ierr;
<a name="line790">790: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>        type, limits[5] = {ctx-&gt;numRERefine,ctx-&gt;nZRefine1,ctx-&gt;maxRefIts,ctx-&gt;nZRefine2,ctx-&gt;postAMRRefine};
<a name="line791">791: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>        adaptIter;

<a name="line794">794: </a>  <font color="#4169E1">for</font> (type=0;type&lt;5;type++) {
<a name="line795">795: </a>    <font color="#4169E1">for</font> (adaptIter = 0; adaptIter&lt;limits[type];adaptIter++) {
<a name="line796">796: </a>      <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a>  dmNew = NULL;
<a name="line797">797: </a>      adaptToleranceFEM(ctx-&gt;fe[0], *uu, ctx-&gt;refineTol, ctx-&gt;coarsenTol, type, ctx, &amp;dmNew);
<a name="line798">798: </a>      <font color="#4169E1">if</font> (!dmNew) {
<a name="line799">799: </a>        exit(113);
<a name="line800">800: </a>        <font color="#4169E1">break</font>;
<a name="line801">801: </a>      } <font color="#4169E1">else</font> {
<a name="line802">802: </a>        <a href="../../../docs/manualpages/DM/DMDestroy.html#DMDestroy">DMDestroy</a>(dm);
<a name="line803">803: </a>        <a href="../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</a>(uu);
<a name="line804">804: </a>        <a href="../../../docs/manualpages/DM/DMCreateGlobalVector.html#DMCreateGlobalVector">DMCreateGlobalVector</a>(dmNew,uu);
<a name="line805">805: </a>        <a href="../../../docs/manualpages/Sys/PetscObjectSetName.html#PetscObjectSetName">PetscObjectSetName</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>) *uu, <font color="#666666">"u"</font>);
<a name="line806">806: </a>        LandauSetInitialCondition(dmNew, *uu, ctx);
<a name="line807">807: </a>        *dm = dmNew;
<a name="line808">808: </a>      }
<a name="line809">809: </a>    }
<a name="line810">810: </a>  }
<a name="line811">811: </a>  <font color="#4169E1">return</font>(0);
<a name="line812">812: </a>}

<a name="line814">814: </a><strong><font color="#4169E1"><a name="ProcessOptions"></a>static <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> ProcessOptions(LandauCtx *ctx, const char prefix[])</font></strong>
<a name="line815">815: </a>{
<a name="line816">816: </a>  <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>    ierr;
<a name="line817">817: </a>  <a href="../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>         flg, sph_flg;
<a name="line818">818: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>          ii,nt,nm,nc;
<a name="line819">819: </a>  <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a>                dummy;

<a name="line822">822: </a>  <a href="../../../docs/manualpages/DM/DMCreate.html#DMCreate">DMCreate</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,&amp;dummy);
<a name="line823">823: </a>  <font color="#B22222">/* get options - initialize context */</font>
<a name="line824">824: </a>  ctx-&gt;normJ = 0;
<a name="line825">825: </a>  ctx-&gt;verbose = 1;
<a name="line826">826: </a>  ctx-&gt;interpolate = <a href="../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>;
<a name="line827">827: </a>  ctx-&gt;simplex = <a href="../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;
<a name="line828">828: </a>  ctx-&gt;sphere = <a href="../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;
<a name="line829">829: </a>  ctx-&gt;inflate = <a href="../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;
<a name="line830">830: </a>  ctx-&gt;electronShift = 0;
<a name="line831">831: </a>  ctx-&gt;errorIndicator = NULL;
<a name="line832">832: </a>  ctx-&gt;radius = 5.; <font color="#B22222">/* electron thermal radius (velocity) */</font>
<a name="line833">833: </a>  ctx-&gt;re_radius = 0.;
<a name="line834">834: </a>  ctx-&gt;vperp0_radius1 = 0;
<a name="line835">835: </a>  ctx-&gt;vperp0_radius2 = 0;
<a name="line836">836: </a>  ctx-&gt;e_radius = .1;
<a name="line837">837: </a>  ctx-&gt;i_radius = .01;
<a name="line838">838: </a>  ctx-&gt;maxRefIts = 5;
<a name="line839">839: </a>  ctx-&gt;postAMRRefine = 0;
<a name="line840">840: </a>  ctx-&gt;nZRefine1 = 0;
<a name="line841">841: </a>  ctx-&gt;nZRefine2 = 0;
<a name="line842">842: </a>  ctx-&gt;numRERefine = 0;
<a name="line843">843: </a>  ctx-&gt;num_sections = 3; <font color="#B22222">/* 2, 3 or 4 */</font>
<a name="line844">844: </a>  <font color="#B22222">/* species - [0] electrons, [1] one ion species eg, duetarium, [2] heavy impurity ion, ... */</font>
<a name="line845">845: </a>  ctx-&gt;charges[0] = -1;  <font color="#B22222">/* electron charge (MKS) */</font>
<a name="line846">846: </a>  ctx-&gt;masses[0] = 1/1835.5; <font color="#B22222">/* temporary value in proton mass */</font>
<a name="line847">847: </a>  ctx-&gt;n[0] = 1;
<a name="line848">848: </a>  ctx-&gt;thermal_temps[0] = 1;
<a name="line849">849: </a>  <font color="#B22222">/* constants, etc. */</font>
<a name="line850">850: </a>  ctx-&gt;epsilon0 = 8.8542e-12; <font color="#B22222">/* permittivity of free space (MKS) F/m */</font>
<a name="line851">851: </a>  ctx-&gt;k = 1.38064852e-23; <font color="#B22222">/* Boltzmann constant (MKS) J/K */</font>
<a name="line852">852: </a>  ctx-&gt;lnLam = 10;         <font color="#B22222">/* cross section ratio large - small angle collisions */</font>
<a name="line853">853: </a>  ctx-&gt;n_0 = 1.e20;        <font color="#B22222">/* typical plasma n, but could set it to 1 */</font>
<a name="line854">854: </a>  ctx-&gt;Ez = 0;
<a name="line855">855: </a>  ctx-&gt;v_0 = 1; <font color="#B22222">/* in electron thermal velocity */</font>
<a name="line856">856: </a>  ctx-&gt;subThreadBlockSize = 1; <font color="#B22222">/* for device and maybe OMP */</font>
<a name="line857">857: </a>  ctx-&gt;quarter3DDomain = <a href="../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;
<a name="line858">858: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsBegin.html#PetscOptionsBegin">PetscOptionsBegin</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>, prefix, <font color="#666666">"Options for Fokker-Plank-Landau collision operator"</font>, <font color="#666666">"none"</font>);
<a name="line859">859: </a>  {
<a name="line860">860: </a>    char opstring[256];
<a name="line861">861: </a><font color="#A020F0">#if defined(PETSC_HAVE_KOKKOS)</font>
<a name="line862">862: </a>    ctx-&gt;deviceType = LANDAU_KOKKOS;
<a name="line863">863: </a>    <a href="../../../docs/manualpages/Sys/PetscStrcpy.html#PetscStrcpy">PetscStrcpy</a>(opstring,<font color="#666666">"kokkos"</font>);
<a name="line864">864: </a><font color="#A020F0">#if !defined(PETSC_HAVE_CUDA)</font>
<a name="line865">865: </a>    ctx-&gt;subThreadBlockSize = 0;
<a name="line866">866: </a><font color="#A020F0">#endif</font>
<a name="line867">867: </a><font color="#A020F0">#elif defined(PETSC_HAVE_CUDA)</font>
<a name="line868">868: </a>    ctx-&gt;deviceType = LANDAU_CUDA;
<a name="line869">869: </a>    <a href="../../../docs/manualpages/Sys/PetscStrcpy.html#PetscStrcpy">PetscStrcpy</a>(opstring,<font color="#666666">"cuda"</font>);
<a name="line870">870: </a><font color="#A020F0">#else</font>
<a name="line871">871: </a>    ctx-&gt;deviceType = LANDAU_CPU;
<a name="line872">872: </a>    <a href="../../../docs/manualpages/Sys/PetscStrcpy.html#PetscStrcpy">PetscStrcpy</a>(opstring,<font color="#666666">"cpu"</font>);
<a name="line873">873: </a>    ctx-&gt;subThreadBlockSize = 0;
<a name="line874">874: </a><font color="#A020F0">#endif</font>
<a name="line875">875: </a>    <a href="../../../docs/manualpages/Sys/PetscOptionsString.html#PetscOptionsString">PetscOptionsString</a>(<font color="#666666">"-dm_landau_device_type"</font>,<font color="#666666">"Use kernels on 'cpu', 'cuda', or 'kokkos'"</font>,<font color="#666666">"plexland.c"</font>,opstring,opstring,256,NULL);
<a name="line876">876: </a>    <a href="../../../docs/manualpages/Sys/PetscStrcmp.html#PetscStrcmp">PetscStrcmp</a>(<font color="#666666">"cpu"</font>,opstring,&amp;flg);
<a name="line877">877: </a>    <font color="#4169E1">if</font> (flg) {
<a name="line878">878: </a>      ctx-&gt;deviceType = LANDAU_CPU;
<a name="line879">879: </a>      ctx-&gt;subThreadBlockSize = 0;
<a name="line880">880: </a>    } <font color="#4169E1">else</font> {
<a name="line881">881: </a>      <a href="../../../docs/manualpages/Sys/PetscStrcmp.html#PetscStrcmp">PetscStrcmp</a>(<font color="#666666">"cuda"</font>,opstring,&amp;flg);
<a name="line882">882: </a>      <font color="#4169E1">if</font> (flg) ctx-&gt;deviceType = LANDAU_CUDA;
<a name="line883">883: </a>      <font color="#4169E1">else</font> {
<a name="line884">884: </a>        <a href="../../../docs/manualpages/Sys/PetscStrcmp.html#PetscStrcmp">PetscStrcmp</a>(<font color="#666666">"kokkos"</font>,opstring,&amp;flg);
<a name="line885">885: </a>        <font color="#4169E1">if</font> (flg) ctx-&gt;deviceType = LANDAU_KOKKOS;
<a name="line886">886: </a>        <font color="#4169E1">else</font> <a href="../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,PETSC_ERR_ARG_WRONG,<font color="#666666">"-dm_landau_device_type %s"</font>,opstring);
<a name="line887">887: </a>      }
<a name="line888">888: </a>    }
<a name="line889">889: </a>  }
<a name="line890">890: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsReal.html#PetscOptionsReal">PetscOptionsReal</a>(<font color="#666666">"-dm_landau_electron_shift"</font>,<font color="#666666">"Shift in thermal velocity of electrons"</font>,<font color="#666666">"none"</font>,ctx-&gt;electronShift,&amp;ctx-&gt;electronShift, NULL);
<a name="line891">891: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsBool.html#PetscOptionsBool">PetscOptionsBool</a>(<font color="#666666">"-dm_landau_sphere"</font>, <font color="#666666">"use sphere/semi-circle domain instead of rectangle"</font>, <font color="#666666">"plexland.c"</font>, ctx-&gt;sphere, &amp;ctx-&gt;sphere, &amp;sph_flg);
<a name="line892">892: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsBool.html#PetscOptionsBool">PetscOptionsBool</a>(<font color="#666666">"-dm_landau_inflate"</font>, <font color="#666666">"With sphere, inflate for curved edges (no AMR)"</font>, <font color="#666666">"plexland.c"</font>, ctx-&gt;inflate, &amp;ctx-&gt;inflate, NULL);
<a name="line893">893: </a>  <font color="#B22222">/* <a href="../../../docs/manualpages/Sys/PetscOptionsBool.html#PetscOptionsBool">PetscOptionsBool</a>("-dm_landau_quarter_3d_domain", "Use symmetry in 3D to model 1/4 of domain", "plexland.c", ctx-&gt;quarter3DDomain, &amp;ctx-&gt;quarter3DDomain, NULL); */</font>
<a name="line894">894: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsInt.html#PetscOptionsInt">PetscOptionsInt</a>(<font color="#666666">"-dm_landau_amr_re_levels"</font>, <font color="#666666">"Number of levels to refine along v_perp=0, z&gt;0"</font>, <font color="#666666">"plexland.c"</font>, ctx-&gt;numRERefine, &amp;ctx-&gt;numRERefine, NULL);
<a name="line895">895: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsInt.html#PetscOptionsInt">PetscOptionsInt</a>(<font color="#666666">"-dm_landau_amr_z_refine1"</font>,  <font color="#666666">"Number of levels to refine along v_perp=0"</font>, <font color="#666666">"plexland.c"</font>, ctx-&gt;nZRefine1, &amp;ctx-&gt;nZRefine1, NULL);
<a name="line896">896: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsInt.html#PetscOptionsInt">PetscOptionsInt</a>(<font color="#666666">"-dm_landau_amr_z_refine2"</font>,  <font color="#666666">"Number of levels to refine along v_perp=0"</font>, <font color="#666666">"plexland.c"</font>, ctx-&gt;nZRefine2, &amp;ctx-&gt;nZRefine2, NULL);
<a name="line897">897: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsInt.html#PetscOptionsInt">PetscOptionsInt</a>(<font color="#666666">"-dm_landau_amr_levels_max"</font>, <font color="#666666">"Number of AMR levels of refinement around origin after r=0 refinements"</font>, <font color="#666666">"plexland.c"</font>, ctx-&gt;maxRefIts, &amp;ctx-&gt;maxRefIts, NULL);
<a name="line898">898: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsInt.html#PetscOptionsInt">PetscOptionsInt</a>(<font color="#666666">"-dm_landau_amr_post_refine"</font>, <font color="#666666">"Number of levels to uniformly refine after AMR"</font>, <font color="#666666">"plexland.c"</font>, ctx-&gt;postAMRRefine, &amp;ctx-&gt;postAMRRefine, NULL);
<a name="line899">899: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsInt.html#PetscOptionsInt">PetscOptionsInt</a>(<font color="#666666">"-dm_landau_verbose"</font>, <font color="#666666">""</font>, <font color="#666666">"plexland.c"</font>, ctx-&gt;verbose, &amp;ctx-&gt;verbose, NULL);
<a name="line900">900: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsReal.html#PetscOptionsReal">PetscOptionsReal</a>(<font color="#666666">"-dm_landau_re_radius"</font>,<font color="#666666">"velocity range to refine on positive (z&gt;0) r=0 axis for runaways"</font>,<font color="#666666">"plexland.c"</font>,ctx-&gt;re_radius,&amp;ctx-&gt;re_radius, &amp;flg);
<a name="line901">901: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsReal.html#PetscOptionsReal">PetscOptionsReal</a>(<font color="#666666">"-dm_landau_z_radius1"</font>,<font color="#666666">"velocity range to refine r=0 axis (for electrons)"</font>,<font color="#666666">"plexland.c"</font>,ctx-&gt;vperp0_radius1,&amp;ctx-&gt;vperp0_radius1, &amp;flg);
<a name="line902">902: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsReal.html#PetscOptionsReal">PetscOptionsReal</a>(<font color="#666666">"-dm_landau_z_radius2"</font>,<font color="#666666">"velocity range to refine r=0 axis (for ions) after origin AMR"</font>,<font color="#666666">"plexland.c"</font>,ctx-&gt;vperp0_radius2,&amp;ctx-&gt;vperp0_radius2, &amp;flg);
<a name="line903">903: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsReal.html#PetscOptionsReal">PetscOptionsReal</a>(<font color="#666666">"-dm_landau_Ez"</font>,<font color="#666666">"Initial parallel electric field in unites of Conner-Hastie criticle field"</font>,<font color="#666666">"plexland.c"</font>,ctx-&gt;Ez,&amp;ctx-&gt;Ez, NULL);
<a name="line904">904: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsReal.html#PetscOptionsReal">PetscOptionsReal</a>(<font color="#666666">"-dm_landau_n_0"</font>,<font color="#666666">"Normalization constant for number density"</font>,<font color="#666666">"plexland.c"</font>,ctx-&gt;n_0,&amp;ctx-&gt;n_0, NULL);
<a name="line905">905: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsReal.html#PetscOptionsReal">PetscOptionsReal</a>(<font color="#666666">"-dm_landau_ln_lambda"</font>,<font color="#666666">"Cross section parameter"</font>,<font color="#666666">"plexland.c"</font>,ctx-&gt;lnLam,&amp;ctx-&gt;lnLam, NULL);
<a name="line906">906: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsInt.html#PetscOptionsInt">PetscOptionsInt</a>(<font color="#666666">"-dm_landau_num_sections"</font>, <font color="#666666">"Number of tangential section in (2D) grid, 2, 3, of 4"</font>, <font color="#666666">"plexland.c"</font>, ctx-&gt;num_sections, &amp;ctx-&gt;num_sections, NULL);
<a name="line907">907: </a>  ctx-&gt;simplex = <a href="../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;
<a name="line908">908: </a>  <font color="#B22222">/* get num species with tempurature*/</font>
<a name="line909">909: </a>  {
<a name="line910">910: </a>    <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> arr[100];
<a name="line911">911: </a>    nt = 100;
<a name="line912">912: </a>    <a href="../../../docs/manualpages/Sys/PetscOptionsRealArray.html#PetscOptionsRealArray">PetscOptionsRealArray</a>(<font color="#666666">"-dm_landau_thermal_temps"</font>, <font color="#666666">"Temperature of each species [e,i_0,i_1,...] in keV"</font>, <font color="#666666">"plexland.c"</font>, arr, &amp;nt, &amp;flg);
<a name="line913">913: </a>    <font color="#4169E1">if</font> (flg &amp;&amp; nt &gt; LANDAU_MAX_SPECIES) <a href="../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,PETSC_ERR_ARG_WRONG,<font color="#666666">"-thermal_temps ,t1,t2,.. number of species %D &gt; MAX %D"</font>,nt,LANDAU_MAX_SPECIES);
<a name="line914">914: </a>  }
<a name="line915">915: </a>  nt = LANDAU_MAX_SPECIES;
<a name="line916">916: </a>  <font color="#4169E1">for</font> (ii=1;ii&lt;LANDAU_MAX_SPECIES;ii++) {
<a name="line917">917: </a>    ctx-&gt;thermal_temps[ii] = 1.;
<a name="line918">918: </a>    ctx-&gt;charges[ii] = 1;
<a name="line919">919: </a>    ctx-&gt;masses[ii] = 1;
<a name="line920">920: </a>    ctx-&gt;n[ii] = (ii==1) ? 1 : 0;
<a name="line921">921: </a>  }
<a name="line922">922: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsRealArray.html#PetscOptionsRealArray">PetscOptionsRealArray</a>(<font color="#666666">"-dm_landau_thermal_temps"</font>, <font color="#666666">"Temperature of each species [e,i_0,i_1,...] in keV (must be set to set number of species)"</font>, <font color="#666666">"plexland.c"</font>, ctx-&gt;thermal_temps, &amp;nt, &amp;flg);
<a name="line923">923: </a>  <font color="#4169E1">if</font> (flg) {
<a name="line924">924: </a>    PetscInfo1(dummy, <font color="#666666">"num_species set to number of thermal temps provided (%D)\n"</font>,nt);
<a name="line925">925: </a>    ctx-&gt;num_species = nt;
<a name="line926">926: </a>  } <font color="#4169E1">else</font> <a href="../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,PETSC_ERR_ARG_WRONG,<font color="#666666">"-dm_landau_thermal_temps ,t1,t2,.. must be provided to set the number of species"</font>);
<a name="line927">927: </a>  <font color="#4169E1">for</font> (ii=0;ii&lt;ctx-&gt;num_species;ii++) ctx-&gt;thermal_temps[ii] *= 1.1604525e7; <font color="#B22222">/* convert to Kelvin */</font>
<a name="line928">928: </a>  nm = LANDAU_MAX_SPECIES-1;
<a name="line929">929: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsRealArray.html#PetscOptionsRealArray">PetscOptionsRealArray</a>(<font color="#666666">"-dm_landau_ion_masses"</font>, <font color="#666666">"Mass of each species in units of proton mass [i_0=2,i_1=40...]"</font>, <font color="#666666">"plexland.c"</font>, &amp;ctx-&gt;masses[1], &amp;nm, &amp;flg);
<a name="line930">930: </a>  <font color="#4169E1">if</font> (flg &amp;&amp; nm != ctx-&gt;num_species-1) {
<a name="line931">931: </a>    <a href="../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,PETSC_ERR_ARG_WRONG,<font color="#666666">"num ion masses %D != num species %D"</font>,nm,ctx-&gt;num_species-1);
<a name="line932">932: </a>  }
<a name="line933">933: </a>  nm = LANDAU_MAX_SPECIES;
<a name="line934">934: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsRealArray.html#PetscOptionsRealArray">PetscOptionsRealArray</a>(<font color="#666666">"-dm_landau_n"</font>, <font color="#666666">"Normalized (by -n_0) number density of each species"</font>, <font color="#666666">"plexland.c"</font>, ctx-&gt;n, &amp;nm, &amp;flg);
<a name="line935">935: </a>  <font color="#4169E1">if</font> (flg &amp;&amp; nm != ctx-&gt;num_species) <a href="../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,PETSC_ERR_ARG_WRONG,<font color="#666666">"wrong num n: %D != num species %D"</font>,nm,ctx-&gt;num_species);
<a name="line936">936: </a>  ctx-&gt;n_0 *= ctx-&gt;n[0]; <font color="#B22222">/* normalized number density */</font>
<a name="line937">937: </a>  <font color="#4169E1">for</font> (ii=1;ii&lt;ctx-&gt;num_species;ii++) ctx-&gt;n[ii] = ctx-&gt;n[ii]/ctx-&gt;n[0];
<a name="line938">938: </a>  ctx-&gt;n[0] = 1;
<a name="line939">939: </a>  <font color="#4169E1">for</font> (ii=0;ii&lt;LANDAU_MAX_SPECIES;ii++) ctx-&gt;masses[ii] *= 1.6720e-27; <font color="#B22222">/* scale by proton mass kg */</font>
<a name="line940">940: </a>  ctx-&gt;masses[0] = 9.10938356e-31; <font color="#B22222">/* electron mass kg (should be about right already) */</font>
<a name="line941">941: </a>  ctx-&gt;m_0 = ctx-&gt;masses[0]; <font color="#B22222">/* arbitrary reference mass, electrons */</font>
<a name="line942">942: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsReal.html#PetscOptionsReal">PetscOptionsReal</a>(<font color="#666666">"-dm_landau_v_0"</font>,<font color="#666666">"Velocity to normalize with in units of initial electrons thermal velocity (not recommended to change default)"</font>,<font color="#666666">"plexland.c"</font>,ctx-&gt;v_0,&amp;ctx-&gt;v_0, NULL);
<a name="line943">943: </a>  ctx-&gt;v_0 *= PetscSqrtReal(ctx-&gt;k*ctx-&gt;thermal_temps[0]/(ctx-&gt;masses[0])); <font color="#B22222">/* electron mean velocity in 1D (need 3D form in computing T from FE integral) */</font>
<a name="line944">944: </a>  nc = LANDAU_MAX_SPECIES-1;
<a name="line945">945: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsRealArray.html#PetscOptionsRealArray">PetscOptionsRealArray</a>(<font color="#666666">"-dm_landau_ion_charges"</font>, <font color="#666666">"Charge of each species in units of proton charge [i_0=2,i_1=18,...]"</font>, <font color="#666666">"plexland.c"</font>, &amp;ctx-&gt;charges[1], &amp;nc, &amp;flg);
<a name="line946">946: </a>  <font color="#4169E1">if</font> (flg &amp;&amp; nc != ctx-&gt;num_species-1) <a href="../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,PETSC_ERR_ARG_WRONG,<font color="#666666">"num charges %D != num species %D"</font>,nc,ctx-&gt;num_species-1);
<a name="line947">947: </a>  <font color="#4169E1">for</font> (ii=0;ii&lt;LANDAU_MAX_SPECIES;ii++) ctx-&gt;charges[ii] *= 1.6022e-19; <font color="#B22222">/* electron/proton charge (MKS) */</font>
<a name="line948">948: </a>  ctx-&gt;t_0 = 8*PETSC_PI*<a href="../../../docs/manualpages/Sys/PetscSqr.html#PetscSqr">PetscSqr</a>(ctx-&gt;epsilon0*ctx-&gt;m_0/<a href="../../../docs/manualpages/Sys/PetscSqr.html#PetscSqr">PetscSqr</a>(ctx-&gt;charges[0]))/ctx-&gt;lnLam/ctx-&gt;n_0*PetscPowReal(ctx-&gt;v_0,3); <font color="#B22222">/* note, this t_0 makes nu[0,0]=1 */</font>
<a name="line949">949: </a>  <font color="#B22222">/* geometry */</font>
<a name="line950">950: </a>  <font color="#4169E1">for</font> (ii=0;ii&lt;ctx-&gt;num_species;ii++) ctx-&gt;refineTol[ii]  = PETSC_MAX_REAL;
<a name="line951">951: </a>  <font color="#4169E1">for</font> (ii=0;ii&lt;ctx-&gt;num_species;ii++) ctx-&gt;coarsenTol[ii] = 0.;
<a name="line952">952: </a>  ii = LANDAU_MAX_SPECIES;
<a name="line953">953: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsRealArray.html#PetscOptionsRealArray">PetscOptionsRealArray</a>(<font color="#666666">"-dm_landau_refine_tol"</font>,<font color="#666666">"tolerance for refining cells in AMR"</font>,<font color="#666666">"plexland.c"</font>,ctx-&gt;refineTol, &amp;ii, &amp;flg);
<a name="line954">954: </a>  <font color="#4169E1">if</font> (flg &amp;&amp; ii != ctx-&gt;num_species) PetscInfo2(dummy, <font color="#666666">"Phase: Warning, #refine_tol %D != num_species %D\n"</font>,ii,ctx-&gt;num_species);
<a name="line955">955: </a>  ii = LANDAU_MAX_SPECIES;
<a name="line956">956: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsRealArray.html#PetscOptionsRealArray">PetscOptionsRealArray</a>(<font color="#666666">"-dm_landau_coarsen_tol"</font>,<font color="#666666">"tolerance for coarsening cells in AMR"</font>,<font color="#666666">"plexland.c"</font>,ctx-&gt;coarsenTol, &amp;ii, &amp;flg);
<a name="line957">957: </a>  <font color="#4169E1">if</font> (flg &amp;&amp; ii != ctx-&gt;num_species) PetscInfo2(dummy, <font color="#666666">"Phase: Warning, #coarsen_tol %D != num_species %D\n"</font>,ii,ctx-&gt;num_species);
<a name="line958">958: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsReal.html#PetscOptionsReal">PetscOptionsReal</a>(<font color="#666666">"-dm_landau_domain_radius"</font>,<font color="#666666">"Phase space size in units of electron thermal velocity"</font>,<font color="#666666">"plexland.c"</font>,ctx-&gt;radius,&amp;ctx-&gt;radius, &amp;flg);
<a name="line959">959: </a>  <font color="#4169E1">if</font> (flg &amp;&amp; ctx-&gt;radius &lt;= 0) { <font color="#B22222">/* negative is ratio of c */</font>
<a name="line960">960: </a>    <font color="#4169E1">if</font> (ctx-&gt;radius == 0) ctx-&gt;radius = 0.75;
<a name="line961">961: </a>    <font color="#4169E1">else</font> ctx-&gt;radius = -ctx-&gt;radius;
<a name="line962">962: </a>    ctx-&gt;radius = ctx-&gt;radius*299792458.0/ctx-&gt;v_0;
<a name="line963">963: </a>    PetscInfo1(dummy, <font color="#666666">"Change domain radius to %e\n"</font>,ctx-&gt;radius);
<a name="line964">964: </a>  }
<a name="line965">965: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsReal.html#PetscOptionsReal">PetscOptionsReal</a>(<font color="#666666">"-dm_landau_i_radius"</font>,<font color="#666666">"Ion thermal velocity, used for circular meshes"</font>,<font color="#666666">"plexland.c"</font>,ctx-&gt;i_radius,&amp;ctx-&gt;i_radius, &amp;flg);
<a name="line966">966: </a>  <font color="#4169E1">if</font> (flg &amp;&amp; !sph_flg) ctx-&gt;sphere = <a href="../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>; <font color="#B22222">/* you gave me an ion radius but did not set sphere, user error really */</font>
<a name="line967">967: </a>  <font color="#4169E1">if</font> (!flg) {
<a name="line968">968: </a>    ctx-&gt;i_radius = 1.5*PetscSqrtReal(8*ctx-&gt;k*ctx-&gt;thermal_temps[1]/ctx-&gt;masses[1]/PETSC_PI)/ctx-&gt;v_0; <font color="#B22222">/* normalized radius with thermal velocity of first ion */</font>
<a name="line969">969: </a>  }
<a name="line970">970: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsReal.html#PetscOptionsReal">PetscOptionsReal</a>(<font color="#666666">"-dm_landau_e_radius"</font>,<font color="#666666">"Electron thermal velocity, used for circular meshes"</font>,<font color="#666666">"plexland.c"</font>,ctx-&gt;e_radius,&amp;ctx-&gt;e_radius, &amp;flg);
<a name="line971">971: </a>  <font color="#4169E1">if</font> (flg &amp;&amp; !sph_flg) ctx-&gt;sphere = <a href="../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>; <font color="#B22222">/* you gave me an e radius but did not set sphere, user error really */</font>
<a name="line972">972: </a>  <font color="#4169E1">if</font> (!flg) {
<a name="line973">973: </a>    ctx-&gt;e_radius = 1.5*PetscSqrtReal(8*ctx-&gt;k*ctx-&gt;thermal_temps[0]/ctx-&gt;masses[0]/PETSC_PI)/ctx-&gt;v_0; <font color="#B22222">/* normalized radius with thermal velocity of electrons */</font>
<a name="line974">974: </a>  }
<a name="line975">975: </a>  <font color="#4169E1">if</font> (ctx-&gt;sphere &amp;&amp; (ctx-&gt;e_radius &lt;= ctx-&gt;i_radius || ctx-&gt;radius &lt;= ctx-&gt;e_radius)) <a href="../../../docs/manualpages/Sys/SETERRQ3.html#SETERRQ3">SETERRQ3</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,PETSC_ERR_ARG_WRONG,<font color="#666666">"bad radii: %g &lt; %g &lt; %g"</font>,ctx-&gt;i_radius,ctx-&gt;e_radius,ctx-&gt;radius);
<a name="line976">976: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsInt.html#PetscOptionsInt">PetscOptionsInt</a>(<font color="#666666">"-dm_landau_sub_thread_block_size"</font>, <font color="#666666">"Number of threads in CUDA integration point subblock"</font>, <font color="#666666">"plexland.c"</font>, ctx-&gt;subThreadBlockSize, &amp;ctx-&gt;subThreadBlockSize, NULL);
<a name="line977">977: </a><font color="#A020F0">#if !defined(PETSC_HAVE_KOKKOS)</font>
<a name="line978">978: </a>  <font color="#4169E1">if</font> (ctx-&gt;subThreadBlockSize &gt; LANDAU_MAX_SUB_THREAD_BLOCKS) <a href="../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,PETSC_ERR_ARG_WRONG,<font color="#666666">"num sub threads %D &gt; MAX %d"</font>,ctx-&gt;subThreadBlockSize,LANDAU_MAX_SUB_THREAD_BLOCKS);
<a name="line979">979: </a><font color="#A020F0">#endif</font>
<a name="line980">980: </a>  <a href="../../../docs/manualpages/Sys/PetscOptionsEnd.html#PetscOptionsEnd">PetscOptionsEnd</a>();
<a name="line981">981: </a>  <font color="#4169E1">for</font> (ii=ctx-&gt;num_species;ii&lt;LANDAU_MAX_SPECIES;ii++) ctx-&gt;masses[ii] = ctx-&gt;thermal_temps[ii]  = ctx-&gt;charges[ii] = 0;
<a name="line982">982: </a>  <font color="#4169E1">if</font> (ctx-&gt;verbose &gt; 0) {
<a name="line983">983: </a>    <a href="../../../docs/manualpages/Sys/PetscPrintf.html#PetscPrintf">PetscPrintf</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>, <font color="#666666">"masses:        e=%10.3e; ions in proton mass units:   %10.3e %10.3e ...\n"</font>,ctx-&gt;masses[0],ctx-&gt;masses[1]/1.6720e-27,ctx-&gt;num_species&gt;2 ? ctx-&gt;masses[2]/1.6720e-27 : 0);
<a name="line984">984: </a>    <a href="../../../docs/manualpages/Sys/PetscPrintf.html#PetscPrintf">PetscPrintf</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>, <font color="#666666">"charges:       e=%10.3e; charges in elementary units: %10.3e %10.3e\n"</font>, ctx-&gt;charges[0],-ctx-&gt;charges[1]/ctx-&gt;charges[0],ctx-&gt;num_species&gt;2 ? -ctx-&gt;charges[2]/ctx-&gt;charges[0] : 0);
<a name="line985">985: </a>    <a href="../../../docs/manualpages/Sys/PetscPrintf.html#PetscPrintf">PetscPrintf</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>, <font color="#666666">"thermal T (K): e=%10.3e i=%10.3e imp=%10.3e. v_0=%10.3e n_0=%10.3e t_0=%10.3e domain=%10.3e\n"</font>,ctx-&gt;thermal_temps[0],ctx-&gt;thermal_temps[1],ctx-&gt;num_species&gt;2 ? ctx-&gt;thermal_temps[2] : 0,ctx-&gt;v_0,ctx-&gt;n_0,ctx-&gt;t_0,ctx-&gt;radius);
<a name="line986">986: </a>  }
<a name="line987">987: </a>  <a href="../../../docs/manualpages/DM/DMDestroy.html#DMDestroy">DMDestroy</a>(&amp;dummy);
<a name="line988">988: </a>  {
<a name="line989">989: </a>    <a href="../../../docs/manualpages/Sys/PetscMPIInt.html#PetscMPIInt">PetscMPIInt</a>    rank;
<a name="line990">990: </a>    <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_rank.html#MPI_Comm_rank">MPI_Comm_rank</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>, &amp;rank);
<a name="line991">991: </a>    <font color="#B22222">/* <a href="../../../docs/manualpages/Profiling/PetscLogStage.html#PetscLogStage">PetscLogStage</a>  setup_stage; */</font>
<a name="line992">992: </a>    <a href="../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"Landau Operator"</font>, DM_CLASSID, &amp;ctx-&gt;events[0]); <font color="#B22222">/* 0 */</font>
<a name="line993">993: </a>    <a href="../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">" Jac-vector"</font>, DM_CLASSID, &amp;ctx-&gt;events[1]); <font color="#B22222">/* 1 */</font>
<a name="line994">994: </a>    <a href="../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">" Jac-kern-init"</font>, DM_CLASSID, &amp;ctx-&gt;events[3]); <font color="#B22222">/* 3 */</font>
<a name="line995">995: </a>    <a href="../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">" Jac-kernel"</font>, DM_CLASSID, &amp;ctx-&gt;events[4]); <font color="#B22222">/* 4 */</font>
<a name="line996">996: </a>    <a href="../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">" Jac-kernel-post"</font>, DM_CLASSID, &amp;ctx-&gt;events[5]); <font color="#B22222">/* 5 */</font>
<a name="line997">997: </a>    <a href="../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">" Jac-assemble"</font>, DM_CLASSID, &amp;ctx-&gt;events[6]); <font color="#B22222">/* 6 */</font>
<a name="line998">998: </a>    <a href="../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">" Jac-end"</font>, DM_CLASSID, &amp;ctx-&gt;events[7]); <font color="#B22222">/* 7 */</font>
<a name="line999">999: </a>    <a href="../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"  Jac-geo-color"</font>, DM_CLASSID, &amp;ctx-&gt;events[8]); <font color="#B22222">/* 8 */</font>
<a name="line1000">1000: </a>    <a href="../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"  Jac-cuda-sum"</font>, DM_CLASSID, &amp;ctx-&gt;events[2]); <font color="#B22222">/* 2 */</font>
<a name="line1001">1001: </a>    <a href="../../../docs/manualpages/Profiling/PetscLogEventRegister.html#PetscLogEventRegister">PetscLogEventRegister</a>(<font color="#666666">"Landau Jacobian"</font>, DM_CLASSID, &amp;ctx-&gt;events[9]); <font color="#B22222">/* 9 */</font>
<a name="line1002">1002: </a>    <font color="#4169E1">if</font> (rank) { <font color="#B22222">/* turn off output stuff for duplicate runs - do we need to add the prefix to all this? */</font>
<a name="line1003">1003: </a>      <a href="../../../docs/manualpages/Sys/PetscOptionsClearValue.html#PetscOptionsClearValue">PetscOptionsClearValue</a>(NULL,<font color="#666666">"-snes_converged_reason"</font>);
<a name="line1004">1004: </a>      <a href="../../../docs/manualpages/Sys/PetscOptionsClearValue.html#PetscOptionsClearValue">PetscOptionsClearValue</a>(NULL,<font color="#666666">"-ksp_converged_reason"</font>);
<a name="line1005">1005: </a>      <a href="../../../docs/manualpages/Sys/PetscOptionsClearValue.html#PetscOptionsClearValue">PetscOptionsClearValue</a>(NULL,<font color="#666666">"-snes_monitor"</font>);
<a name="line1006">1006: </a>      <a href="../../../docs/manualpages/Sys/PetscOptionsClearValue.html#PetscOptionsClearValue">PetscOptionsClearValue</a>(NULL,<font color="#666666">"-ksp_monitor"</font>);
<a name="line1007">1007: </a>      <a href="../../../docs/manualpages/Sys/PetscOptionsClearValue.html#PetscOptionsClearValue">PetscOptionsClearValue</a>(NULL,<font color="#666666">"-ts_monitor"</font>);
<a name="line1008">1008: </a>      <a href="../../../docs/manualpages/Sys/PetscOptionsClearValue.html#PetscOptionsClearValue">PetscOptionsClearValue</a>(NULL,<font color="#666666">"-ts_adapt_monitor"</font>);
<a name="line1009">1009: </a>      <a href="../../../docs/manualpages/Sys/PetscOptionsClearValue.html#PetscOptionsClearValue">PetscOptionsClearValue</a>(NULL,<font color="#666666">"-dm_landau_amr_dm_view"</font>);
<a name="line1010">1010: </a>      <a href="../../../docs/manualpages/Sys/PetscOptionsClearValue.html#PetscOptionsClearValue">PetscOptionsClearValue</a>(NULL,<font color="#666666">"-dm_landau_amr_vec_view"</font>);
<a name="line1011">1011: </a>      <a href="../../../docs/manualpages/Sys/PetscOptionsClearValue.html#PetscOptionsClearValue">PetscOptionsClearValue</a>(NULL,<font color="#666666">"-dm_landau_pre_dm_view"</font>);
<a name="line1012">1012: </a>      <a href="../../../docs/manualpages/Sys/PetscOptionsClearValue.html#PetscOptionsClearValue">PetscOptionsClearValue</a>(NULL,<font color="#666666">"-dm_landau_pre_vec_view"</font>);
<a name="line1013">1013: </a>      <a href="../../../docs/manualpages/Sys/PetscOptionsClearValue.html#PetscOptionsClearValue">PetscOptionsClearValue</a>(NULL,<font color="#666666">"-info"</font>);
<a name="line1014">1014: </a>    }
<a name="line1015">1015: </a>  }
<a name="line1016">1016: </a>  <font color="#4169E1">return</font>(0);
<a name="line1017">1017: </a>}

<a name="line1019">1019: </a><font color="#B22222">/*@C</font>
<a name="line1020">1020: </a><font color="#B22222">  <a href="../../../docs/manualpages/LANDAU/LandauCreateVelocitySpace.html#LandauCreateVelocitySpace">LandauCreateVelocitySpace</a> - Create a DMPlex velocity space mesh</font>

<a name="line1022">1022: </a><font color="#B22222">  Collective on comm</font>

<a name="line1024">1024: </a><font color="#B22222">  Input Parameters:</font>
<a name="line1025">1025: </a><font color="#B22222">+   comm  - The MPI communicator</font>
<a name="line1026">1026: </a><font color="#B22222">.   dim - velocity space dimension (2 for axisymmetric, 3 for full 3X + 3V solver)</font>
<a name="line1027">1027: </a><font color="#B22222">-   prefix - prefix for options</font>

<a name="line1029">1029: </a><font color="#B22222">  Output Parameter:</font>
<a name="line1030">1030: </a><font color="#B22222">.   dm  - The <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> object representing the mesh</font>
<a name="line1031">1031: </a><font color="#B22222">+   X - A vector (user destroys)</font>
<a name="line1032">1032: </a><font color="#B22222">-   J - Optional matrix (object destroys)</font>

<a name="line1034">1034: </a><font color="#B22222">  Level: beginner</font>

<a name="line1036">1036: </a><font color="#B22222">.keywords: mesh</font>
<a name="line1037">1037: </a><font color="#B22222">.seealso: <a href="../../../docs/manualpages/DMPLEX/DMPlexCreate.html#DMPlexCreate">DMPlexCreate</a>(), <a href="../../../docs/manualpages/LANDAU/LandauDestroyVelocitySpace.html#LandauDestroyVelocitySpace">LandauDestroyVelocitySpace</a>()</font>
<a name="line1038">1038: </a><font color="#B22222">@*/</font>
<a name="line1039">1039: </a><strong><font color="#4169E1"><a name="LandauCreateVelocitySpace"></a><a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../docs/manualpages/LANDAU/LandauCreateVelocitySpace.html#LandauCreateVelocitySpace">LandauCreateVelocitySpace</a>(<a href="../../../docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</a> comm, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dim, const char prefix[], <a href="../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a> *X, <a href="../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> *J, <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> *dm)</font></strong>
<a name="line1040">1040: </a>{
<a name="line1041">1041: </a>  <a href="../../../docs/manualpages/Sys/PetscMPIInt.html#PetscMPIInt">PetscMPIInt</a>    size;
<a name="line1043">1043: </a>  LandauCtx      *ctx;

<a name="line1046">1046: </a>  <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_size.html#MPI_Comm_size">MPI_Comm_size</a>(comm, &amp;size);
<a name="line1047">1047: </a>  <font color="#4169E1">if</font> (size!=1) <a href="../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_PLIB, <font color="#666666">"Velocity space meshes should be serial (but should work in parallel)"</font>);
<a name="line1048">1048: </a>  <font color="#4169E1">if</font> (dim!=2 &amp;&amp; dim!=3) <a href="../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_PLIB, <font color="#666666">"Only 2D and 3D supported"</font>);
<a name="line1049">1049: </a>  ctx = (LandauCtx*)malloc(<font color="#4169E1">sizeof</font>(LandauCtx));
<a name="line1050">1050: </a>  <font color="#B22222">/* process options */</font>
<a name="line1051">1051: </a>  ProcessOptions(ctx,prefix);
<a name="line1052">1052: </a>  <font color="#B22222">/* Create Mesh */</font>
<a name="line1053">1053: </a>  LandauDMCreateVMesh(comm, dim, prefix, ctx, dm);
<a name="line1054">1054: </a>  <a href="../../../docs/manualpages/DM/DMViewFromOptions.html#DMViewFromOptions">DMViewFromOptions</a>(*dm,NULL,<font color="#666666">"-dm_landau_pre_dm_view"</font>);
<a name="line1055">1055: </a>  <a href="../../../docs/manualpages/DM/DMSetApplicationContext.html#DMSetApplicationContext">DMSetApplicationContext</a>(*dm, ctx);
<a name="line1056">1056: </a>  <font color="#B22222">/* create FEM */</font>
<a name="line1057">1057: </a>  SetupDS(*dm,dim,ctx);
<a name="line1058">1058: </a>  <font color="#B22222">/* set initial state */</font>
<a name="line1059">1059: </a>  <a href="../../../docs/manualpages/DM/DMCreateGlobalVector.html#DMCreateGlobalVector">DMCreateGlobalVector</a>(*dm,X);
<a name="line1060">1060: </a>  <a href="../../../docs/manualpages/Sys/PetscObjectSetName.html#PetscObjectSetName">PetscObjectSetName</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>) *X, <font color="#666666">"u"</font>);
<a name="line1061">1061: </a>  <font color="#B22222">/* initial static refinement, no solve */</font>
<a name="line1062">1062: </a>  LandauSetInitialCondition(*dm, *X, ctx);
<a name="line1063">1063: </a>  <a href="../../../docs/manualpages/Vec/VecViewFromOptions.html#VecViewFromOptions">VecViewFromOptions</a>(*X, NULL, <font color="#666666">"-dm_landau_pre_vec_view"</font>);
<a name="line1064">1064: </a>  <font color="#B22222">/* forest refinement */</font>
<a name="line1065">1065: </a>  <font color="#4169E1">if</font> (ctx-&gt;errorIndicator) {
<a name="line1066">1066: </a>    <font color="#B22222">/* AMR */</font>
<a name="line1067">1067: </a>    adapt(dm,ctx,X);
<a name="line1068">1068: </a>    <a href="../../../docs/manualpages/DM/DMViewFromOptions.html#DMViewFromOptions">DMViewFromOptions</a>(*dm,NULL,<font color="#666666">"-dm_landau_amr_dm_view"</font>);
<a name="line1069">1069: </a>    <a href="../../../docs/manualpages/Vec/VecViewFromOptions.html#VecViewFromOptions">VecViewFromOptions</a>(*X, NULL, <font color="#666666">"-dm_landau_amr_vec_view"</font>);
<a name="line1070">1070: </a>  }
<a name="line1071">1071: </a>  <a href="../../../docs/manualpages/DM/DMSetApplicationContext.html#DMSetApplicationContext">DMSetApplicationContext</a>(*dm, ctx);
<a name="line1072">1072: </a>  ctx-&gt;dmv = *dm;
<a name="line1073">1073: </a>  <a href="../../../docs/manualpages/DM/DMCreateMatrix.html#DMCreateMatrix">DMCreateMatrix</a>(ctx-&gt;dmv, &amp;ctx-&gt;J);
<a name="line1074">1074: </a>  <font color="#4169E1">if</font> (J) *J = ctx-&gt;J;
<a name="line1075">1075: </a>  <font color="#4169E1">return</font>(0);
<a name="line1076">1076: </a>}

<a name="line1078">1078: </a><font color="#B22222">/*@</font>
<a name="line1079">1079: </a><font color="#B22222">  <a href="../../../docs/manualpages/LANDAU/LandauDestroyVelocitySpace.html#LandauDestroyVelocitySpace">LandauDestroyVelocitySpace</a> - Destroy a DMPlex velocity space mesh</font>

<a name="line1081">1081: </a><font color="#B22222">  Collective on dm</font>

<a name="line1083">1083: </a><font color="#B22222">  Input/Output Parameters:</font>
<a name="line1084">1084: </a><font color="#B22222">  .   dm - the dm to destroy</font>

<a name="line1086">1086: </a><font color="#B22222">  Level: beginner</font>

<a name="line1088">1088: </a><font color="#B22222">.keywords: mesh</font>
<a name="line1089">1089: </a><font color="#B22222">.seealso: <a href="../../../docs/manualpages/LANDAU/LandauCreateVelocitySpace.html#LandauCreateVelocitySpace">LandauCreateVelocitySpace</a>()</font>
<a name="line1090">1090: </a><font color="#B22222">@*/</font>
<a name="line1091">1091: </a><strong><font color="#4169E1"><a name="LandauDestroyVelocitySpace"></a><a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../docs/manualpages/LANDAU/LandauDestroyVelocitySpace.html#LandauDestroyVelocitySpace">LandauDestroyVelocitySpace</a>(<a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> *dm)</font></strong>
<a name="line1092">1092: </a>{
<a name="line1093">1093: </a>  <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> ierr,ii;
<a name="line1094">1094: </a>  LandauCtx        *ctx;
<a name="line1095">1095: </a>  <a href="../../../docs/manualpages/Sys/PetscContainer.html#PetscContainer">PetscContainer</a> container = NULL;
<a name="line1097">1097: </a>  <a href="../../../docs/manualpages/DM/DMGetApplicationContext.html#DMGetApplicationContext">DMGetApplicationContext</a>(*dm, &amp;ctx);
<a name="line1098">1098: </a>  <a href="../../../docs/manualpages/Sys/PetscObjectQuery.html#PetscObjectQuery">PetscObjectQuery</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ctx-&gt;J,<font color="#666666">"coloring"</font>, (<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>*)&amp;container);
<a name="line1099">1099: </a>  <font color="#4169E1">if</font> (container) {
<a name="line1100">1100: </a>    <a href="../../../docs/manualpages/Sys/PetscContainerDestroy.html#PetscContainerDestroy">PetscContainerDestroy</a>(&amp;container);
<a name="line1101">1101: </a>  }
<a name="line1102">1102: </a>  <a href="../../../docs/manualpages/Mat/MatDestroy.html#MatDestroy">MatDestroy</a>(&amp;ctx-&gt;M);
<a name="line1103">1103: </a>  <a href="../../../docs/manualpages/Mat/MatDestroy.html#MatDestroy">MatDestroy</a>(&amp;ctx-&gt;J);
<a name="line1104">1104: </a>  <font color="#4169E1">for</font> (ii=0;ii&lt;ctx-&gt;num_species;ii++) {
<a name="line1105">1105: </a>    <a href="../../../docs/manualpages/FE/PetscFEDestroy.html#PetscFEDestroy">PetscFEDestroy</a>(&amp;ctx-&gt;fe[ii]);
<a name="line1106">1106: </a>  }
<a name="line1107">1107: </a>  free(ctx);
<a name="line1108">1108: </a>  <a href="../../../docs/manualpages/DM/DMDestroy.html#DMDestroy">DMDestroy</a>(dm);
<a name="line1109">1109: </a>  <font color="#4169E1">return</font>(0);
<a name="line1110">1110: </a>}

<a name="line1112">1112: </a><font color="#B22222">/* &lt; v, ru &gt; */</font>
<a name="line1113">1113: </a><strong><font color="#4169E1"><a name="f0_s_den"></a>static void f0_s_den(<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dim, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> Nf, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> NfAux,</font></strong>
<a name="line1114">1114: </a><strong><font color="#4169E1">                     const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> uOff[], const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> uOff_x[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_t[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_x[],</font></strong>
<a name="line1115">1115: </a><strong><font color="#4169E1">                     const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> aOff[], const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> aOff_x[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a_t[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a_x[],</font></strong>
<a name="line1116">1116: </a><strong><font color="#4169E1">                     <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> t, const <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> x[],  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> numConstants, const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> constants[], <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> *f0)</font></strong>
<a name="line1117">1117: </a>{
<a name="line1118">1118: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ii = (<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>)<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(constants[0]);
<a name="line1119">1119: </a>  f0[0] = u[ii];
<a name="line1120">1120: </a>}

<a name="line1122">1122: </a><font color="#B22222">/* &lt; v, ru &gt; */</font>
<a name="line1123">1123: </a><strong><font color="#4169E1"><a name="f0_s_mom"></a>static void f0_s_mom(<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dim, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> Nf, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> NfAux,</font></strong>
<a name="line1124">1124: </a><strong><font color="#4169E1">                    const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> uOff[], const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> uOff_x[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_t[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_x[],</font></strong>
<a name="line1125">1125: </a><strong><font color="#4169E1">                    const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> aOff[], const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> aOff_x[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a_t[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a_x[],</font></strong>
<a name="line1126">1126: </a><strong><font color="#4169E1">                    <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> t, const <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> x[],  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> numConstants, const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> constants[], <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> *f0)</font></strong>
<a name="line1127">1127: </a>{
<a name="line1128">1128: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ii = (<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>)<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(constants[0]), jj = (<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>)<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(constants[1]);
<a name="line1129">1129: </a>  f0[0] = x[jj]*u[ii]; <font color="#B22222">/* x momentum */</font>
<a name="line1130">1130: </a>}

<a name="line1132">1132: </a><strong><font color="#4169E1"><a name="f0_s_v2"></a>static void f0_s_v2(<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dim, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> Nf, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> NfAux,</font></strong>
<a name="line1133">1133: </a><strong><font color="#4169E1">                    const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> uOff[], const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> uOff_x[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_t[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_x[],</font></strong>
<a name="line1134">1134: </a><strong><font color="#4169E1">                    const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> aOff[], const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> aOff_x[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a_t[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a_x[],</font></strong>
<a name="line1135">1135: </a><strong><font color="#4169E1">                    <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> t, const <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> x[],  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> numConstants, const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> constants[], <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> *f0)</font></strong>
<a name="line1136">1136: </a>{
<a name="line1137">1137: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> i, ii = (<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>)<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(constants[0]);
<a name="line1138">1138: </a>  double tmp1 = 0.;
<a name="line1139">1139: </a>  <font color="#4169E1">for</font> (i = 0; i &lt; dim; ++i) tmp1 += x[i]*x[i];
<a name="line1140">1140: </a>  f0[0] = tmp1*u[ii];
<a name="line1141">1141: </a>}

<a name="line1143">1143: </a><font color="#B22222">/* &lt; v, ru &gt; */</font>
<a name="line1144">1144: </a><strong><font color="#4169E1"><a name="f0_s_rden"></a>static void f0_s_rden(<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dim, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> Nf, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> NfAux,</font></strong>
<a name="line1145">1145: </a><strong><font color="#4169E1">                      const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> uOff[], const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> uOff_x[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_t[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_x[],</font></strong>
<a name="line1146">1146: </a><strong><font color="#4169E1">                      const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> aOff[], const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> aOff_x[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a_t[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a_x[],</font></strong>
<a name="line1147">1147: </a><strong><font color="#4169E1">                      <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> t, const <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> x[],  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> numConstants, const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> constants[], <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> *f0)</font></strong>
<a name="line1148">1148: </a>{
<a name="line1149">1149: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ii = (<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>)<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(constants[0]);
<a name="line1150">1150: </a>  f0[0] = 2.*PETSC_PI*x[0]*u[ii];
<a name="line1151">1151: </a>}

<a name="line1153">1153: </a><font color="#B22222">/* &lt; v, ru &gt; */</font>
<a name="line1154">1154: </a><strong><font color="#4169E1"><a name="f0_s_rmom"></a>static void f0_s_rmom(<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dim, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> Nf, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> NfAux,</font></strong>
<a name="line1155">1155: </a><strong><font color="#4169E1">                      const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> uOff[], const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> uOff_x[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_t[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_x[],</font></strong>
<a name="line1156">1156: </a><strong><font color="#4169E1">                      const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> aOff[], const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> aOff_x[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a_t[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a_x[],</font></strong>
<a name="line1157">1157: </a><strong><font color="#4169E1">                      <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> t, const <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> x[],  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> numConstants, const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> constants[], <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> *f0)</font></strong>
<a name="line1158">1158: </a>{
<a name="line1159">1159: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ii = (<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>)<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(constants[0]);
<a name="line1160">1160: </a>  f0[0] = 2.*PETSC_PI*x[0]*x[1]*u[ii];
<a name="line1161">1161: </a>}

<a name="line1163">1163: </a><strong><font color="#4169E1"><a name="f0_s_rv2"></a>static void f0_s_rv2(<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dim, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> Nf, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> NfAux,</font></strong>
<a name="line1164">1164: </a><strong><font color="#4169E1">                     const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> uOff[], const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> uOff_x[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_t[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_x[],</font></strong>
<a name="line1165">1165: </a><strong><font color="#4169E1">                     const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> aOff[], const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> aOff_x[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a_t[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a_x[],</font></strong>
<a name="line1166">1166: </a><strong><font color="#4169E1">                     <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> t, const <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> x[],  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> numConstants, const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> constants[], <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> *f0)</font></strong>
<a name="line1167">1167: </a>{
<a name="line1168">1168: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> ii = (<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>)<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(constants[0]);
<a name="line1169">1169: </a>  f0[0] =  2.*PETSC_PI*x[0]*(x[0]*x[0] + x[1]*x[1])*u[ii];
<a name="line1170">1170: </a>}

<a name="line1172">1172: </a><font color="#B22222">/*@</font>
<a name="line1173">1173: </a><font color="#B22222">  <a href="../../../docs/manualpages/LANDAU/LandauPrintNorms.html#LandauPrintNorms">LandauPrintNorms</a> - collects moments and prints them</font>

<a name="line1175">1175: </a><font color="#B22222">  Collective on dm</font>

<a name="line1177">1177: </a><font color="#B22222">  Input Parameters:</font>
<a name="line1178">1178: </a><font color="#B22222">+   X  - the state</font>
<a name="line1179">1179: </a><font color="#B22222">-   stepi - current step to print</font>

<a name="line1181">1181: </a><font color="#B22222">  Level: beginner</font>

<a name="line1183">1183: </a><font color="#B22222">.keywords: mesh</font>
<a name="line1184">1184: </a><font color="#B22222">.seealso: <a href="../../../docs/manualpages/LANDAU/LandauCreateVelocitySpace.html#LandauCreateVelocitySpace">LandauCreateVelocitySpace</a>()</font>
<a name="line1185">1185: </a><font color="#B22222">@*/</font>
<a name="line1186">1186: </a><strong><font color="#4169E1"><a name="LandauPrintNorms"></a><a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../docs/manualpages/LANDAU/LandauPrintNorms.html#LandauPrintNorms">LandauPrintNorms</a>(<a href="../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a> X, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> stepi)</font></strong>
<a name="line1187">1187: </a>{
<a name="line1189">1189: </a>  LandauCtx      *ctx;
<a name="line1190">1190: </a>  <a href="../../../docs/manualpages/DM/PetscDS.html#PetscDS">PetscDS</a>        prob;
<a name="line1191">1191: </a>  <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a>             plex,dm;
<a name="line1192">1192: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       cStart, cEnd, dim, ii;
<a name="line1193">1193: </a>  <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>    xmomentumtot=0, ymomentumtot=0, zmomentumtot=0, energytot=0, densitytot=0, tt[LANDAU_MAX_SPECIES];
<a name="line1194">1194: </a>  <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>    xmomentum[LANDAU_MAX_SPECIES],  ymomentum[LANDAU_MAX_SPECIES],  zmomentum[LANDAU_MAX_SPECIES], energy[LANDAU_MAX_SPECIES], density[LANDAU_MAX_SPECIES];

<a name="line1197">1197: </a>  <a href="../../../docs/manualpages/DM/VecGetDM.html#VecGetDM">VecGetDM</a>(X, &amp;dm);
<a name="line1198">1198: </a>  <font color="#4169E1">if</font> (!dm) <a href="../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_PLIB, <font color="#666666">"no <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a>"</font>);
<a name="line1199">1199: </a>  <a href="../../../docs/manualpages/DM/DMGetDimension.html#DMGetDimension">DMGetDimension</a>(dm, &amp;dim);
<a name="line1200">1200: </a>  <a href="../../../docs/manualpages/DM/DMGetApplicationContext.html#DMGetApplicationContext">DMGetApplicationContext</a>(dm, &amp;ctx);
<a name="line1201">1201: </a>  <font color="#4169E1">if</font> (!ctx) <a href="../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_PLIB, <font color="#666666">"no context"</font>);
<a name="line1202">1202: </a>  <a href="../../../docs/manualpages/DM/DMConvert.html#DMConvert">DMConvert</a>(ctx-&gt;dmv, <a href="../../../docs/manualpages/DMPLEX/DMPLEX.html#DMPLEX">DMPLEX</a>, &amp;plex);
<a name="line1203">1203: </a>  <a href="../../../docs/manualpages/DM/DMCreateDS.html#DMCreateDS">DMCreateDS</a>(plex);
<a name="line1204">1204: </a>  <a href="../../../docs/manualpages/DM/DMGetDS.html#DMGetDS">DMGetDS</a>(plex, &amp;prob);
<a name="line1205">1205: </a>  <font color="#B22222">/* print momentum and energy */</font>
<a name="line1206">1206: </a>  <font color="#4169E1">for</font> (ii=0;ii&lt;ctx-&gt;num_species;ii++) {
<a name="line1207">1207: </a>    <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> user[2] = { (<a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>)ii, (<a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>)ctx-&gt;charges[ii]};
<a name="line1208">1208: </a>    <a href="../../../docs/manualpages/DT/PetscDSSetConstants.html#PetscDSSetConstants">PetscDSSetConstants</a>(prob, 2, user);
<a name="line1209">1209: </a>    <font color="#4169E1">if</font> (dim==2) { <font color="#B22222">/* 2/3X + 3V (cylindrical coordinates) */</font>
<a name="line1210">1210: </a>      PetscDSSetObjective(prob, 0, &amp;f0_s_rden);
<a name="line1211">1211: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexComputeIntegralFEM.html#DMPlexComputeIntegralFEM">DMPlexComputeIntegralFEM</a>(plex,X,tt,ctx);
<a name="line1212">1212: </a>      density[ii] = tt[0]*ctx-&gt;n_0*ctx-&gt;charges[ii];
<a name="line1213">1213: </a>      PetscDSSetObjective(prob, 0, &amp;f0_s_rmom);
<a name="line1214">1214: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexComputeIntegralFEM.html#DMPlexComputeIntegralFEM">DMPlexComputeIntegralFEM</a>(plex,X,tt,ctx);
<a name="line1215">1215: </a>      zmomentum[ii] = tt[0]*ctx-&gt;n_0*ctx-&gt;v_0*ctx-&gt;masses[ii];
<a name="line1216">1216: </a>      PetscDSSetObjective(prob, 0, &amp;f0_s_rv2);
<a name="line1217">1217: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexComputeIntegralFEM.html#DMPlexComputeIntegralFEM">DMPlexComputeIntegralFEM</a>(plex,X,tt,ctx);
<a name="line1218">1218: </a>      energy[ii] = tt[0]*0.5*ctx-&gt;n_0*ctx-&gt;v_0*ctx-&gt;v_0*ctx-&gt;masses[ii];
<a name="line1219">1219: </a>      zmomentumtot += zmomentum[ii];
<a name="line1220">1220: </a>      energytot  += energy[ii];
<a name="line1221">1221: </a>      densitytot += density[ii];
<a name="line1222">1222: </a>      <a href="../../../docs/manualpages/Sys/PetscPrintf.html#PetscPrintf">PetscPrintf</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>, <font color="#666666">"%3D) species-%D: charge density= %20.13e z-momentum= %20.13e energy= %20.13e"</font>,stepi,ii,<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(density[ii]),<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(zmomentum[ii]),<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(energy[ii]));
<a name="line1223">1223: </a>    } <font color="#4169E1">else</font> { <font color="#B22222">/* 2/3X + 3V */</font>
<a name="line1224">1224: </a>      PetscDSSetObjective(prob, 0, &amp;f0_s_den);
<a name="line1225">1225: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexComputeIntegralFEM.html#DMPlexComputeIntegralFEM">DMPlexComputeIntegralFEM</a>(plex,X,tt,ctx);
<a name="line1226">1226: </a>      density[ii] = tt[0]*ctx-&gt;n_0*ctx-&gt;charges[ii];
<a name="line1227">1227: </a>      PetscDSSetObjective(prob, 0, &amp;f0_s_mom);
<a name="line1228">1228: </a>      user[1] = 0;
<a name="line1229">1229: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexComputeIntegralFEM.html#DMPlexComputeIntegralFEM">DMPlexComputeIntegralFEM</a>(plex,X,tt,ctx);
<a name="line1230">1230: </a>      xmomentum[ii]  = tt[0]*ctx-&gt;n_0*ctx-&gt;v_0*ctx-&gt;masses[ii];
<a name="line1231">1231: </a>      user[1] = 1;
<a name="line1232">1232: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexComputeIntegralFEM.html#DMPlexComputeIntegralFEM">DMPlexComputeIntegralFEM</a>(plex,X,tt,ctx);
<a name="line1233">1233: </a>      ymomentum[ii] = tt[0]*ctx-&gt;n_0*ctx-&gt;v_0*ctx-&gt;masses[ii];
<a name="line1234">1234: </a>      user[1] = 2;
<a name="line1235">1235: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexComputeIntegralFEM.html#DMPlexComputeIntegralFEM">DMPlexComputeIntegralFEM</a>(plex,X,tt,ctx);
<a name="line1236">1236: </a>      zmomentum[ii] = tt[0]*ctx-&gt;n_0*ctx-&gt;v_0*ctx-&gt;masses[ii];
<a name="line1237">1237: </a>      PetscDSSetObjective(prob, 0, &amp;f0_s_v2);
<a name="line1238">1238: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexComputeIntegralFEM.html#DMPlexComputeIntegralFEM">DMPlexComputeIntegralFEM</a>(plex,X,tt,ctx);
<a name="line1239">1239: </a>      energy[ii]    = 0.5*tt[0]*ctx-&gt;n_0*ctx-&gt;v_0*ctx-&gt;v_0*ctx-&gt;masses[ii];
<a name="line1240">1240: </a>      <a href="../../../docs/manualpages/Sys/PetscPrintf.html#PetscPrintf">PetscPrintf</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>, <font color="#666666">"%3D) species %D: density=%20.13e, x-momentum=%20.13e, y-momentum=%20.13e, z-momentum=%20.13e, energy=%21.13e"</font>,
<a name="line1241">1241: </a>                         stepi,ii,<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(density[ii]),<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(xmomentum[ii]),<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(ymomentum[ii]),<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(zmomentum[ii]),<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(energy[ii]));
<a name="line1242">1242: </a>      xmomentumtot += xmomentum[ii];
<a name="line1243">1243: </a>      ymomentumtot += ymomentum[ii];
<a name="line1244">1244: </a>      zmomentumtot += zmomentum[ii];
<a name="line1245">1245: </a>      energytot  += energy[ii];
<a name="line1246">1246: </a>      densitytot += density[ii];
<a name="line1247">1247: </a>    }
<a name="line1248">1248: </a>    <font color="#4169E1">if</font> (ctx-&gt;num_species&gt;1) <a href="../../../docs/manualpages/Sys/PetscPrintf.html#PetscPrintf">PetscPrintf</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>, <font color="#666666">"\n"</font>);
<a name="line1249">1249: </a>  }
<a name="line1250">1250: </a>  <font color="#B22222">/* totals */</font>
<a name="line1251">1251: </a>  <a href="../../../docs/manualpages/DMPLEX/DMPlexGetHeightStratum.html#DMPlexGetHeightStratum">DMPlexGetHeightStratum</a>(plex,0,&amp;cStart,&amp;cEnd);
<a name="line1252">1252: </a>  <a href="../../../docs/manualpages/DM/DMDestroy.html#DMDestroy">DMDestroy</a>(&amp;plex);
<a name="line1253">1253: </a>  <font color="#4169E1">if</font> (ctx-&gt;num_species&gt;1) {
<a name="line1254">1254: </a>    <font color="#4169E1">if</font> (dim==2) {
<a name="line1255">1255: </a>      <a href="../../../docs/manualpages/Sys/PetscPrintf.html#PetscPrintf">PetscPrintf</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>, <font color="#666666">"\t%3D) Total: charge density=%21.13e, momentum=%21.13e, energy=%21.13e (m_i[0]/m_e = %g, %D cells)"</font>,
<a name="line1256">1256: </a>                  stepi,<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(densitytot),<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(zmomentumtot),<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(energytot),ctx-&gt;masses[1]/ctx-&gt;masses[0],cEnd-cStart);
<a name="line1257">1257: </a>    } <font color="#4169E1">else</font> {
<a name="line1258">1258: </a>      <a href="../../../docs/manualpages/Sys/PetscPrintf.html#PetscPrintf">PetscPrintf</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>, <font color="#666666">"\t%3D) Total: charge density=%21.13e, x-momentum=%21.13e, y-momentum=%21.13e, z-momentum=%21.13e, energy=%21.13e (m_i[0]/m_e = %g, %D cells)"</font>,
<a name="line1259">1259: </a>                  stepi,<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(densitytot),<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(xmomentumtot),<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(ymomentumtot),<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(zmomentumtot),<a href="../../../docs/manualpages/Sys/PetscRealPart.html#PetscRealPart">PetscRealPart</a>(energytot),ctx-&gt;masses[1]/ctx-&gt;masses[0],cEnd-cStart);
<a name="line1260">1260: </a>    }
<a name="line1261">1261: </a>  } <font color="#4169E1">else</font> {
<a name="line1262">1262: </a>    <a href="../../../docs/manualpages/Sys/PetscPrintf.html#PetscPrintf">PetscPrintf</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>, <font color="#666666">" -- %D cells"</font>,cEnd-cStart);
<a name="line1263">1263: </a>  }
<a name="line1264">1264: </a>  <font color="#4169E1">if</font> (ctx-&gt;verbose &gt; 1) {<a href="../../../docs/manualpages/Sys/PetscPrintf.html#PetscPrintf">PetscPrintf</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,<font color="#666666">", %D sub (vector) threads\n"</font>,ctx-&gt;subThreadBlockSize);}
<a name="line1265">1265: </a>  <font color="#4169E1">else</font> {<a href="../../../docs/manualpages/Sys/PetscPrintf.html#PetscPrintf">PetscPrintf</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>,<font color="#666666">"\n"</font>);}
<a name="line1266">1266: </a>  <font color="#4169E1">return</font>(0);
<a name="line1267">1267: </a>}

<a name="line1269">1269: </a><strong><font color="#4169E1"><a name="destroy_coloring"></a>static <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> destroy_coloring (void *is)</font></strong>
<a name="line1270">1270: </a>{
<a name="line1271">1271: </a>  <a href="../../../docs/manualpages/IS/ISColoring.html#ISColoring">ISColoring</a> tmp = (<a href="../../../docs/manualpages/IS/ISColoring.html#ISColoring">ISColoring</a>)is;
<a name="line1272">1272: </a>  <font color="#4169E1">return</font> <a href="../../../docs/manualpages/IS/ISColoringDestroy.html#ISColoringDestroy">ISColoringDestroy</a>(&amp;tmp);
<a name="line1273">1273: </a>}

<a name="line1275">1275: </a><font color="#B22222">/*@</font>
<a name="line1276">1276: </a><font color="#B22222">  <a href="../../../docs/manualpages/LANDAU/LandauCreateColoring.html#LandauCreateColoring">LandauCreateColoring</a> - create a coloring and add to matrix (Landau context used just for 'print' flag, should be in DMPlex)</font>

<a name="line1278">1278: </a><font color="#B22222">  Collective on JacP</font>

<a name="line1280">1280: </a><font color="#B22222">  Input Parameters:</font>
<a name="line1281">1281: </a><font color="#B22222">+   JacP  - matrix to add coloring to</font>
<a name="line1282">1282: </a><font color="#B22222">-   plex - The <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a></font>

<a name="line1284">1284: </a><font color="#B22222">  Output Parameter:</font>
<a name="line1285">1285: </a><font color="#B22222">.   container  - Container with coloring</font>

<a name="line1287">1287: </a><font color="#B22222">  Level: beginner</font>

<a name="line1289">1289: </a><font color="#B22222">.keywords: mesh</font>
<a name="line1290">1290: </a><font color="#B22222">.seealso: <a href="../../../docs/manualpages/LANDAU/LandauCreateVelocitySpace.html#LandauCreateVelocitySpace">LandauCreateVelocitySpace</a>()</font>
<a name="line1291">1291: </a><font color="#B22222">@*/</font>
<a name="line1292">1292: </a><strong><font color="#4169E1"><a name="LandauCreateColoring"></a><a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../docs/manualpages/LANDAU/LandauCreateColoring.html#LandauCreateColoring">LandauCreateColoring</a>(<a href="../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> JacP, <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> plex, <a href="../../../docs/manualpages/Sys/PetscContainer.html#PetscContainer">PetscContainer</a> *container)</font></strong>
<a name="line1293">1293: </a>{
<a name="line1294">1294: </a>  <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>  ierr;
<a name="line1295">1295: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>        dim,cell,i,ej,nc,Nv,totDim,numGCells,cStart,cEnd;
<a name="line1296">1296: </a>  <a href="../../../docs/manualpages/IS/ISColoring.html#ISColoring">ISColoring</a>      iscoloring = NULL;
<a name="line1297">1297: </a>  <a href="../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>             G,Q;
<a name="line1298">1298: </a>  <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>     ones[128];
<a name="line1299">1299: </a>  <a href="../../../docs/manualpages/Mat/MatColoring.html#MatColoring">MatColoring</a>     mc;
<a name="line1300">1300: </a>  <a href="../../../docs/manualpages/IS/IS.html#IS">IS</a>             *is;
<a name="line1301">1301: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>        csize,colour,j,k;
<a name="line1302">1302: </a>  const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> *indices;
<a name="line1303">1303: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       numComp[1];
<a name="line1304">1304: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       numDof[4];
<a name="line1305">1305: </a>  <a href="../../../docs/manualpages/FE/PetscFE.html#PetscFE">PetscFE</a>        fe;
<a name="line1306">1306: </a>  <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a>             colordm;
<a name="line1307">1307: </a>  <a href="../../../docs/manualpages/PetscSection/PetscSection.html#PetscSection">PetscSection</a>   csection, section, globalSection;
<a name="line1308">1308: </a>  <a href="../../../docs/manualpages/DM/PetscDS.html#PetscDS">PetscDS</a>        prob;
<a name="line1309">1309: </a>  LandauCtx      *ctx;

<a name="line1312">1312: </a>  <a href="../../../docs/manualpages/DM/DMGetApplicationContext.html#DMGetApplicationContext">DMGetApplicationContext</a>(plex, &amp;ctx);
<a name="line1313">1313: </a>  <a href="../../../docs/manualpages/DM/DMGetLocalSection.html#DMGetLocalSection">DMGetLocalSection</a>(plex, &amp;section);
<a name="line1314">1314: </a>  <a href="../../../docs/manualpages/DM/DMGetGlobalSection.html#DMGetGlobalSection">DMGetGlobalSection</a>(plex, &amp;globalSection);
<a name="line1315">1315: </a>  <a href="../../../docs/manualpages/DM/DMGetDimension.html#DMGetDimension">DMGetDimension</a>(plex, &amp;dim);
<a name="line1316">1316: </a>  <a href="../../../docs/manualpages/DM/DMGetDS.html#DMGetDS">DMGetDS</a>(plex, &amp;prob);
<a name="line1317">1317: </a>  <a href="../../../docs/manualpages/DT/PetscDSGetTotalDimension.html#PetscDSGetTotalDimension">PetscDSGetTotalDimension</a>(prob, &amp;totDim);
<a name="line1318">1318: </a>  <a href="../../../docs/manualpages/DMPLEX/DMPlexGetHeightStratum.html#DMPlexGetHeightStratum">DMPlexGetHeightStratum</a>(plex,0,&amp;cStart,&amp;cEnd);
<a name="line1319">1319: </a>  numGCells = cEnd - cStart;
<a name="line1320">1320: </a>  <font color="#B22222">/* create cell centered <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> */</font>
<a name="line1321">1321: </a>  <a href="../../../docs/manualpages/DM/DMClone.html#DMClone">DMClone</a>(plex, &amp;colordm);
<a name="line1322">1322: </a>  <a href="../../../docs/manualpages/FE/PetscFECreateDefault.html#PetscFECreateDefault">PetscFECreateDefault</a>(<a href="../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>) plex), dim, 1, <a href="../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>, <font color="#666666">"color_"</font>, <a href="../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>, &amp;fe);
<a name="line1323">1323: </a>  <a href="../../../docs/manualpages/Sys/PetscObjectSetName.html#PetscObjectSetName">PetscObjectSetName</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>) fe, <font color="#666666">"color"</font>);
<a name="line1324">1324: </a>  <a href="../../../docs/manualpages/DM/DMSetField.html#DMSetField">DMSetField</a>(colordm, 0, NULL, (<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)fe);
<a name="line1325">1325: </a>  <a href="../../../docs/manualpages/FE/PetscFEDestroy.html#PetscFEDestroy">PetscFEDestroy</a>(&amp;fe);
<a name="line1326">1326: </a>  <font color="#4169E1">for</font> (i = 0; i &lt; (dim+1); ++i) numDof[i] = 0;
<a name="line1327">1327: </a>  numDof[dim] = 1;
<a name="line1328">1328: </a>  numComp[0] = 1;
<a name="line1329">1329: </a>  <a href="../../../docs/manualpages/DMPLEX/DMPlexCreateSection.html#DMPlexCreateSection">DMPlexCreateSection</a>(colordm, NULL, numComp, numDof, 0, NULL, NULL, NULL, NULL, &amp;csection);
<a name="line1330">1330: </a>  <a href="../../../docs/manualpages/PetscSection/PetscSectionSetFieldName.html#PetscSectionSetFieldName">PetscSectionSetFieldName</a>(csection, 0, <font color="#666666">"color"</font>);
<a name="line1331">1331: </a>  <a href="../../../docs/manualpages/DM/DMSetLocalSection.html#DMSetLocalSection">DMSetLocalSection</a>(colordm, csection);
<a name="line1332">1332: </a>  <a href="../../../docs/manualpages/DM/DMViewFromOptions.html#DMViewFromOptions">DMViewFromOptions</a>(colordm,NULL,<font color="#666666">"-color_dm_view"</font>);
<a name="line1333">1333: </a>  <font color="#B22222">/* get vertex to element map Q and colroing graph G */</font>
<a name="line1334">1334: </a>  <a href="../../../docs/manualpages/Mat/MatGetSize.html#MatGetSize">MatGetSize</a>(JacP,NULL,&amp;Nv);
<a name="line1335">1335: </a>  <a href="../../../docs/manualpages/Mat/MatCreateAIJ.html#MatCreateAIJ">MatCreateAIJ</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>,<a href="../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>,<a href="../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>,numGCells,Nv,totDim,NULL,0,NULL,&amp;Q);
<a name="line1336">1336: </a>  <font color="#4169E1">for</font> (i=0;i&lt;128;i++) ones[i] = 1.0;
<a name="line1337">1337: </a>  <font color="#4169E1">for</font> (cell = cStart, ej = 0 ; cell &lt; cEnd; ++cell, ++ej) {
<a name="line1338">1338: </a>    <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> numindices,*indices;
<a name="line1339">1339: </a>    <a href="../../../docs/manualpages/DMPLEX/DMPlexGetClosureIndices.html#DMPlexGetClosureIndices">DMPlexGetClosureIndices</a>(plex, section, globalSection, cell, <a href="../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>, &amp;numindices, &amp;indices, NULL, NULL);
<a name="line1340">1340: </a>    <font color="#4169E1">if</font> (numindices&gt;128) <a href="../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_PLIB, <font color="#666666">"too many indices. %D &gt; %D"</font>,numindices,128);
<a name="line1341">1341: </a>    <a href="../../../docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</a>(Q,1,&amp;ej,numindices,indices,ones,<a href="../../../docs/manualpages/Sys/ADD_VALUES.html#ADD_VALUES">ADD_VALUES</a>);
<a name="line1342">1342: </a>    <a href="../../../docs/manualpages/DMPLEX/DMPlexRestoreClosureIndices.html#DMPlexRestoreClosureIndices">DMPlexRestoreClosureIndices</a>(plex, section, globalSection, cell, <a href="../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>, &amp;numindices, &amp;indices, NULL, NULL);
<a name="line1343">1343: </a>  }
<a name="line1344">1344: </a>  <a href="../../../docs/manualpages/Mat/MatAssemblyBegin.html#MatAssemblyBegin">MatAssemblyBegin</a>(Q, <a href="../../../docs/manualpages/Mat/MatAssemblyType.html#MatAssemblyType">MAT_FINAL_ASSEMBLY</a>);
<a name="line1345">1345: </a>  <a href="../../../docs/manualpages/Mat/MatAssemblyEnd.html#MatAssemblyEnd">MatAssemblyEnd</a>(Q, <a href="../../../docs/manualpages/Mat/MatAssemblyType.html#MatAssemblyType">MAT_FINAL_ASSEMBLY</a>);
<a name="line1346">1346: </a>  <a href="../../../docs/manualpages/Mat/MatMatTransposeMult.html#MatMatTransposeMult">MatMatTransposeMult</a>(Q,Q,<a href="../../../docs/manualpages/Mat/MatReuse.html#MatReuse">MAT_INITIAL_MATRIX</a>,4.0,&amp;G);
<a name="line1347">1347: </a>  <a href="../../../docs/manualpages/Sys/PetscObjectSetName.html#PetscObjectSetName">PetscObjectSetName</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>) Q, <font color="#666666">"Q"</font>);
<a name="line1348">1348: </a>  <a href="../../../docs/manualpages/Sys/PetscObjectSetName.html#PetscObjectSetName">PetscObjectSetName</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>) G, <font color="#666666">"coloring graph"</font>);
<a name="line1349">1349: </a>  <a href="../../../docs/manualpages/Mat/MatViewFromOptions.html#MatViewFromOptions">MatViewFromOptions</a>(G,NULL,<font color="#666666">"-coloring_mat_view"</font>);
<a name="line1350">1350: </a>  <a href="../../../docs/manualpages/Mat/MatViewFromOptions.html#MatViewFromOptions">MatViewFromOptions</a>(Q,NULL,<font color="#666666">"-coloring_mat_view"</font>);
<a name="line1351">1351: </a>  <a href="../../../docs/manualpages/Mat/MatDestroy.html#MatDestroy">MatDestroy</a>(&amp;Q);
<a name="line1352">1352: </a>  <font color="#B22222">/* coloring */</font>
<a name="line1353">1353: </a>  <a href="../../../docs/manualpages/MatOrderings/MatColoringCreate.html#MatColoringCreate">MatColoringCreate</a>(G,&amp;mc);
<a name="line1354">1354: </a>  <a href="../../../docs/manualpages/MatOrderings/MatColoringSetDistance.html#MatColoringSetDistance">MatColoringSetDistance</a>(mc,1);
<a name="line1355">1355: </a>  <a href="../../../docs/manualpages/MatOrderings/MatColoringSetType.html#MatColoringSetType">MatColoringSetType</a>(mc,<a href="../../../docs/manualpages/MatOrderings/MATCOLORINGJP.html#MATCOLORINGJP">MATCOLORINGJP</a>);
<a name="line1356">1356: </a>  <a href="../../../docs/manualpages/MatOrderings/MatColoringSetFromOptions.html#MatColoringSetFromOptions">MatColoringSetFromOptions</a>(mc);
<a name="line1357">1357: </a>  <a href="../../../docs/manualpages/MatOrderings/MatColoringApply.html#MatColoringApply">MatColoringApply</a>(mc,&amp;iscoloring);
<a name="line1358">1358: </a>  <a href="../../../docs/manualpages/MatOrderings/MatColoringDestroy.html#MatColoringDestroy">MatColoringDestroy</a>(&amp;mc);
<a name="line1359">1359: </a>  <font color="#B22222">/* view */</font>
<a name="line1360">1360: </a>  ISColoringViewFromOptions(iscoloring,NULL,<font color="#666666">"-coloring_is_view"</font>);
<a name="line1361">1361: </a>  <a href="../../../docs/manualpages/IS/ISColoringGetIS.html#ISColoringGetIS">ISColoringGetIS</a>(iscoloring,<a href="../../../docs/manualpages/Sys/PetscCopyMode.html#PetscCopyMode">PETSC_USE_POINTER</a>,&amp;nc,&amp;is);
<a name="line1362">1362: </a>  <font color="#4169E1">if</font> (ctx &amp;&amp; ctx-&gt;verbose &gt; 5) {
<a name="line1363">1363: </a>    <a href="../../../docs/manualpages/Viewer/PetscViewer.html#PetscViewer">PetscViewer</a>    viewer;
<a name="line1364">1364: </a>    <a href="../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a>            color_vec, eidx_vec;
<a name="line1365">1365: </a>    <a href="../../../docs/manualpages/DM/DMGetGlobalVector.html#DMGetGlobalVector">DMGetGlobalVector</a>(colordm, &amp;color_vec);
<a name="line1366">1366: </a>    <a href="../../../docs/manualpages/DM/DMGetGlobalVector.html#DMGetGlobalVector">DMGetGlobalVector</a>(colordm, &amp;eidx_vec);
<a name="line1367">1367: </a>    <font color="#4169E1">for</font> (colour=0; colour&lt;nc; colour++) {
<a name="line1368">1368: </a>      <a href="../../../docs/manualpages/IS/ISGetLocalSize.html#ISGetLocalSize">ISGetLocalSize</a>(is[colour],&amp;csize);
<a name="line1369">1369: </a>      <a href="../../../docs/manualpages/IS/ISGetIndices.html#ISGetIndices">ISGetIndices</a>(is[colour],&amp;indices);
<a name="line1370">1370: </a>      <font color="#4169E1">for</font> (j=0; j&lt;csize; j++) {
<a name="line1371">1371: </a>        <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> v = (<a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>)colour;
<a name="line1372">1372: </a>        k = indices[j];
<a name="line1373">1373: </a>        <a href="../../../docs/manualpages/Vec/VecSetValues.html#VecSetValues">VecSetValues</a>(color_vec,1,&amp;k,&amp;v,<a href="../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</a>);
<a name="line1374">1374: </a>        v = (<a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>)k;
<a name="line1375">1375: </a>        <a href="../../../docs/manualpages/Vec/VecSetValues.html#VecSetValues">VecSetValues</a>(eidx_vec,1,&amp;k,&amp;v,<a href="../../../docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</a>);
<a name="line1376">1376: </a>      }
<a name="line1377">1377: </a>      <a href="../../../docs/manualpages/IS/ISRestoreIndices.html#ISRestoreIndices">ISRestoreIndices</a>(is[colour],&amp;indices);
<a name="line1378">1378: </a>    }
<a name="line1379">1379: </a>    <font color="#B22222">/* view */</font>
<a name="line1380">1380: </a>    <a href="../../../docs/manualpages/Viewer/PetscViewerVTKOpen.html#PetscViewerVTKOpen">PetscViewerVTKOpen</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>, <font color="#666666">"color.vtu"</font>, <a href="../../../docs/manualpages/Sys/PetscFileMode.html#PetscFileMode">FILE_MODE_WRITE</a>, &amp;viewer);
<a name="line1381">1381: </a>    <a href="../../../docs/manualpages/Sys/PetscObjectSetName.html#PetscObjectSetName">PetscObjectSetName</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>) color_vec, <font color="#666666">"color"</font>);
<a name="line1382">1382: </a>    <a href="../../../docs/manualpages/Vec/VecView.html#VecView">VecView</a>(color_vec, viewer);
<a name="line1383">1383: </a>    <a href="../../../docs/manualpages/Viewer/PetscViewerDestroy.html#PetscViewerDestroy">PetscViewerDestroy</a>(&amp;viewer);
<a name="line1384">1384: </a>    <a href="../../../docs/manualpages/Viewer/PetscViewerVTKOpen.html#PetscViewerVTKOpen">PetscViewerVTKOpen</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>, <font color="#666666">"eidx.vtu"</font>, <a href="../../../docs/manualpages/Sys/PetscFileMode.html#PetscFileMode">FILE_MODE_WRITE</a>, &amp;viewer);
<a name="line1385">1385: </a>    <a href="../../../docs/manualpages/Sys/PetscObjectSetName.html#PetscObjectSetName">PetscObjectSetName</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>) eidx_vec, <font color="#666666">"element-idx"</font>);
<a name="line1386">1386: </a>    <a href="../../../docs/manualpages/Vec/VecView.html#VecView">VecView</a>(eidx_vec, viewer);
<a name="line1387">1387: </a>    <a href="../../../docs/manualpages/Viewer/PetscViewerDestroy.html#PetscViewerDestroy">PetscViewerDestroy</a>(&amp;viewer);
<a name="line1388">1388: </a>    <a href="../../../docs/manualpages/DM/DMRestoreGlobalVector.html#DMRestoreGlobalVector">DMRestoreGlobalVector</a>(colordm, &amp;color_vec);
<a name="line1389">1389: </a>    <a href="../../../docs/manualpages/DM/DMRestoreGlobalVector.html#DMRestoreGlobalVector">DMRestoreGlobalVector</a>(colordm, &amp;eidx_vec);
<a name="line1390">1390: </a>  }
<a name="line1391">1391: </a>  <a href="../../../docs/manualpages/PetscSection/PetscSectionDestroy.html#PetscSectionDestroy">PetscSectionDestroy</a>(&amp;csection);
<a name="line1392">1392: </a>  <a href="../../../docs/manualpages/DM/DMDestroy.html#DMDestroy">DMDestroy</a>(&amp;colordm);
<a name="line1393">1393: </a>  <a href="../../../docs/manualpages/IS/ISColoringRestoreIS.html#ISColoringRestoreIS">ISColoringRestoreIS</a>(iscoloring,<a href="../../../docs/manualpages/Sys/PetscCopyMode.html#PetscCopyMode">PETSC_USE_POINTER</a>,&amp;is);
<a name="line1394">1394: </a>  <a href="../../../docs/manualpages/Mat/MatDestroy.html#MatDestroy">MatDestroy</a>(&amp;G);
<a name="line1395">1395: </a>  <font color="#B22222">/* stash coloring */</font>
<a name="line1396">1396: </a>  <a href="../../../docs/manualpages/Sys/PetscContainerCreate.html#PetscContainerCreate">PetscContainerCreate</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, container);
<a name="line1397">1397: </a>  <a href="../../../docs/manualpages/Sys/PetscContainerSetPointer.html#PetscContainerSetPointer">PetscContainerSetPointer</a>(*container,(void*)iscoloring);
<a name="line1398">1398: </a>  <a href="../../../docs/manualpages/Sys/PetscContainerSetUserDestroy.html#PetscContainerSetUserDestroy">PetscContainerSetUserDestroy</a>(*container, destroy_coloring);
<a name="line1399">1399: </a>  <a href="../../../docs/manualpages/Sys/PetscObjectCompose.html#PetscObjectCompose">PetscObjectCompose</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)JacP,<font color="#666666">"coloring"</font>,(<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)*container);
<a name="line1400">1400: </a>  <font color="#4169E1">if</font> (ctx &amp;&amp; ctx-&gt;verbose &gt; 0) {
<a name="line1401">1401: </a>    <a href="../../../docs/manualpages/Sys/PetscPrintf.html#PetscPrintf">PetscPrintf</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>, <font color="#666666">"Made coloring with %D colors\n"</font>, nc);
<a name="line1402">1402: </a>  }
<a name="line1403">1403: </a>  <font color="#4169E1">return</font>(0);
<a name="line1404">1404: </a>  }

<a name="line1406">1406: </a><strong><font color="#4169E1"><a name="LandauAssembleOpenMP"></a><a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> LandauAssembleOpenMP(<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> cStart, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> cEnd, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> totDim, <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> plex, <a href="../../../docs/manualpages/PetscSection/PetscSection.html#PetscSection">PetscSection</a> section, <a href="../../../docs/manualpages/PetscSection/PetscSection.html#PetscSection">PetscSection</a> globalSection, <a href="../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> JacP, <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> elemMats[], <a href="../../../docs/manualpages/Sys/PetscContainer.html#PetscContainer">PetscContainer</a> container)</font></strong>
<a name="line1407">1407: </a>{
<a name="line1408">1408: </a>  <a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>  ierr;
<a name="line1409">1409: </a>  <a href="../../../docs/manualpages/IS/IS.html#IS">IS</a>             *is;
<a name="line1410">1410: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>        nc,colour,j;
<a name="line1411">1411: </a>  const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> *clr_idxs;
<a name="line1412">1412: </a>  <a href="../../../docs/manualpages/IS/ISColoring.html#ISColoring">ISColoring</a>      iscoloring;
<a name="line1414">1414: </a>  <a href="../../../docs/manualpages/Sys/PetscContainerGetPointer.html#PetscContainerGetPointer">PetscContainerGetPointer</a>(container,(void**)&amp;iscoloring);
<a name="line1415">1415: </a>  <a href="../../../docs/manualpages/IS/ISColoringGetIS.html#ISColoringGetIS">ISColoringGetIS</a>(iscoloring,<a href="../../../docs/manualpages/Sys/PetscCopyMode.html#PetscCopyMode">PETSC_USE_POINTER</a>,&amp;nc,&amp;is);
<a name="line1416">1416: </a>  <font color="#4169E1">for</font> (colour=0; colour&lt;nc; colour++) {
<a name="line1417">1417: </a>    <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>    *idx_arr[1024]; <font color="#B22222">/* need to make dynamic for general use */</font>
<a name="line1418">1418: </a>    <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> *new_el_mats[1024];
<a name="line1419">1419: </a>    <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>     idx_size[1024],csize;
<a name="line1420">1420: </a>    <a href="../../../docs/manualpages/IS/ISGetLocalSize.html#ISGetLocalSize">ISGetLocalSize</a>(is[colour],&amp;csize);
<a name="line1421">1421: </a>    <font color="#4169E1">if</font> (csize&gt;1024) <a href="../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_PLIB, <font color="#666666">"too many elements in color. %D &gt; %D"</font>,csize,1024);
<a name="line1422">1422: </a>    <a href="../../../docs/manualpages/IS/ISGetIndices.html#ISGetIndices">ISGetIndices</a>(is[colour],&amp;clr_idxs);
<a name="line1423">1423: </a>    <font color="#B22222">/* get indices and mats */</font>
<a name="line1424">1424: </a>    <font color="#4169E1">for</font> (j=0; j&lt;csize; j++) {
<a name="line1425">1425: </a>      <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>    cell = cStart + clr_idxs[j];
<a name="line1426">1426: </a>      <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>    numindices,*indices;
<a name="line1427">1427: </a>      <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> *elMat = &amp;elemMats[clr_idxs[j]*totDim*totDim];
<a name="line1428">1428: </a>      <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> *valuesOrig = elMat;
<a name="line1429">1429: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexGetClosureIndices.html#DMPlexGetClosureIndices">DMPlexGetClosureIndices</a>(plex, section, globalSection, cell, <a href="../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>, &amp;numindices, &amp;indices, NULL, (<a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> **) &amp;elMat);
<a name="line1430">1430: </a>      idx_size[j] = numindices;
<a name="line1431">1431: </a>      <a href="../../../docs/manualpages/Sys/PetscMalloc2.html#PetscMalloc2">PetscMalloc2</a>(numindices,&amp;idx_arr[j],numindices*numindices,&amp;new_el_mats[j]);
<a name="line1432">1432: </a>      <a href="../../../docs/manualpages/Sys/PetscMemcpy.html#PetscMemcpy">PetscMemcpy</a>(idx_arr[j],indices,numindices*<font color="#4169E1">sizeof</font>(<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>));
<a name="line1433">1433: </a>      <a href="../../../docs/manualpages/Sys/PetscMemcpy.html#PetscMemcpy">PetscMemcpy</a>(new_el_mats[j],elMat,numindices*numindices*<font color="#4169E1">sizeof</font>(<a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>));
<a name="line1434">1434: </a>      <a href="../../../docs/manualpages/DMPLEX/DMPlexRestoreClosureIndices.html#DMPlexRestoreClosureIndices">DMPlexRestoreClosureIndices</a>(plex, section, globalSection, cell, <a href="../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>, &amp;numindices, &amp;indices, NULL, (<a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> **) &amp;elMat);
<a name="line1435">1435: </a>      <font color="#4169E1">if</font> (elMat != valuesOrig) {<a href="../../../docs/manualpages/DM/DMRestoreWorkArray.html#DMRestoreWorkArray">DMRestoreWorkArray</a>(plex, numindices*numindices, <a href="../../../docs/manualpages/Sys/MPIU_SCALAR.html#MPIU_SCALAR">MPIU_SCALAR</a>, &amp;elMat);}
<a name="line1436">1436: </a>    }
<a name="line1437">1437: </a>    <font color="#B22222">/* assemble matrix - pragmas break CI ? */</font>
<a name="line1438">1438: </a>    //#pragma omp parallel <font color="#4169E1">default</font>(JacP,idx_size,idx_arr,new_el_mats,colour,clr_idxs)  private(j)
<a name="line1439">1439: </a>    //#pragma omp parallel <font color="#4169E1">for</font> private(j)
<a name="line1440">1440: </a>    <font color="#4169E1">for</font> (j=0; j&lt;csize; j++) {
<a name="line1441">1441: </a>      <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>    numindices = idx_size[j], *indices = idx_arr[j];
<a name="line1442">1442: </a>      <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> *elMat = new_el_mats[j];
<a name="line1443">1443: </a>      <a href="../../../docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</a>(JacP,numindices,indices,numindices,indices,elMat,<a href="../../../docs/manualpages/Sys/ADD_VALUES.html#ADD_VALUES">ADD_VALUES</a>);
<a name="line1444">1444: </a>    }
<a name="line1445">1445: </a>    <font color="#B22222">/* free */</font>
<a name="line1446">1446: </a>    <a href="../../../docs/manualpages/IS/ISRestoreIndices.html#ISRestoreIndices">ISRestoreIndices</a>(is[colour],&amp;clr_idxs);
<a name="line1447">1447: </a>    <font color="#4169E1">for</font> (j=0; j&lt;csize; j++) {
<a name="line1448">1448: </a>      <a href="../../../docs/manualpages/Sys/PetscFree2.html#PetscFree2">PetscFree2</a>(idx_arr[j],new_el_mats[j]);
<a name="line1449">1449: </a>    }
<a name="line1450">1450: </a>  }
<a name="line1451">1451: </a>  <a href="../../../docs/manualpages/IS/ISColoringRestoreIS.html#ISColoringRestoreIS">ISColoringRestoreIS</a>(iscoloring,<a href="../../../docs/manualpages/Sys/PetscCopyMode.html#PetscCopyMode">PETSC_USE_POINTER</a>,&amp;is);
<a name="line1452">1452: </a>  <font color="#4169E1">return</font>(0);
<a name="line1453">1453: </a>}

<a name="line1455">1455: </a><font color="#B22222">/* &lt; v, u &gt; */</font>
<a name="line1456">1456: </a><strong><font color="#4169E1"><a name="g0_1"></a>static void g0_1(<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dim, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> Nf, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> NfAux,</font></strong>
<a name="line1457">1457: </a><strong><font color="#4169E1">                  const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> uOff[], const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> uOff_x[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_t[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_x[],</font></strong>
<a name="line1458">1458: </a><strong><font color="#4169E1">                  const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> aOff[], const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> aOff_x[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a_t[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a_x[],</font></strong>
<a name="line1459">1459: </a><strong><font color="#4169E1">                  <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> t, <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> u_tShift, const <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> x[],  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> numConstants, const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> constants[], <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> g0[])</font></strong>
<a name="line1460">1460: </a>{
<a name="line1461">1461: </a>  g0[0] = 1.;
<a name="line1462">1462: </a>}

<a name="line1464">1464: </a><font color="#B22222">/* &lt; v, u &gt; */</font>
<a name="line1465">1465: </a><strong><font color="#4169E1"><a name="g0_r"></a>static void g0_r(<a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> dim, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> Nf, <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> NfAux,</font></strong>
<a name="line1466">1466: </a><strong><font color="#4169E1">                  const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> uOff[], const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> uOff_x[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_t[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> u_x[],</font></strong>
<a name="line1467">1467: </a><strong><font color="#4169E1">                  const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> aOff[], const <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> aOff_x[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a_t[], const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> a_x[],</font></strong>
<a name="line1468">1468: </a><strong><font color="#4169E1">                  <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> t, <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> u_tShift, const <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> x[],  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> numConstants, const <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> constants[], <a href="../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> g0[])</font></strong>
<a name="line1469">1469: </a>{
<a name="line1470">1470: </a>  g0[0] = 2.*PETSC_PI*x[0];
<a name="line1471">1471: </a>}

<a name="line1473">1473: </a><font color="#B22222">/*@</font>
<a name="line1474">1474: </a><font color="#B22222">  <a href="../../../docs/manualpages/LANDAU/LandauCreateMassMatrix.html#LandauCreateMassMatrix">LandauCreateMassMatrix</a> - Create mass matrix for Landau</font>

<a name="line1476">1476: </a><font color="#B22222">  Collective on dm</font>

<a name="line1478">1478: </a><font color="#B22222">  Input Parameters:</font>
<a name="line1479">1479: </a><font color="#B22222">. dm     - the <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> object</font>

<a name="line1481">1481: </a><font color="#B22222"> Output Parameters:</font>
<a name="line1482">1482: </a><font color="#B22222">. Amat - The mass matrix (optional), mass matrix is added to the <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> context</font>

<a name="line1484">1484: </a><font color="#B22222">  Level: beginner</font>

<a name="line1486">1486: </a><font color="#B22222">.keywords: mesh</font>
<a name="line1487">1487: </a><font color="#B22222">.seealso: <a href="../../../docs/manualpages/LANDAU/LandauCreateVelocitySpace.html#LandauCreateVelocitySpace">LandauCreateVelocitySpace</a>()</font>
<a name="line1488">1488: </a><font color="#B22222">@*/</font>
<a name="line1489">1489: </a><strong><font color="#4169E1"><a name="LandauCreateMassMatrix"></a><a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../docs/manualpages/LANDAU/LandauCreateMassMatrix.html#LandauCreateMassMatrix">LandauCreateMassMatrix</a>(<a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> dm, <a href="../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> *Amat)</font></strong>
<a name="line1490">1490: </a>{
<a name="line1491">1491: </a>  <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a>             massDM;
<a name="line1492">1492: </a>  <a href="../../../docs/manualpages/DM/PetscDS.html#PetscDS">PetscDS</a>        prob;
<a name="line1493">1493: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       ii,dim,N1=1,N2;
<a name="line1495">1495: </a>  LandauCtx      *ctx;
<a name="line1496">1496: </a>  <a href="../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>            M;

<a name="line1501">1501: </a>  <a href="../../../docs/manualpages/DM/DMGetApplicationContext.html#DMGetApplicationContext">DMGetApplicationContext</a>(dm, &amp;ctx);
<a name="line1502">1502: </a>  <font color="#4169E1">if</font> (!ctx) <a href="../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_PLIB, <font color="#666666">"no context"</font>);
<a name="line1503">1503: </a>  <a href="../../../docs/manualpages/DM/DMGetDimension.html#DMGetDimension">DMGetDimension</a>(dm, &amp;dim);
<a name="line1504">1504: </a>  <a href="../../../docs/manualpages/DM/DMClone.html#DMClone">DMClone</a>(dm, &amp;massDM);
<a name="line1505">1505: </a>  <a href="../../../docs/manualpages/DM/DMCopyFields.html#DMCopyFields">DMCopyFields</a>(dm, massDM);
<a name="line1506">1506: </a>  <a href="../../../docs/manualpages/DM/DMCreateDS.html#DMCreateDS">DMCreateDS</a>(massDM);
<a name="line1507">1507: </a>  <a href="../../../docs/manualpages/DM/DMGetDS.html#DMGetDS">DMGetDS</a>(massDM, &amp;prob);
<a name="line1508">1508: </a>  <font color="#4169E1">for</font> (ii=0;ii&lt;ctx-&gt;num_species;ii++) {
<a name="line1509">1509: </a>    <font color="#4169E1">if</font> (dim==3) {<a href="../../../docs/manualpages/DT/PetscDSSetJacobian.html#PetscDSSetJacobian">PetscDSSetJacobian</a>(prob, ii, ii, g0_1, NULL, NULL, NULL);}
<a name="line1510">1510: </a>    <font color="#4169E1">else</font>        {<a href="../../../docs/manualpages/DT/PetscDSSetJacobian.html#PetscDSSetJacobian">PetscDSSetJacobian</a>(prob, ii, ii, g0_r, NULL, NULL, NULL);}
<a name="line1511">1511: </a>  }
<a name="line1512">1512: </a>  <a href="../../../docs/manualpages/DM/DMViewFromOptions.html#DMViewFromOptions">DMViewFromOptions</a>(massDM,NULL,<font color="#666666">"-dm_landau_mass_dm_view"</font>);
<a name="line1513">1513: </a>  <a href="../../../docs/manualpages/DM/DMCreateMatrix.html#DMCreateMatrix">DMCreateMatrix</a>(massDM, &amp;M);
<a name="line1514">1514: </a>  {
<a name="line1515">1515: </a>    <a href="../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a> locX;
<a name="line1516">1516: </a>    <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a>  plex;
<a name="line1517">1517: </a>    <a href="../../../docs/manualpages/DM/DMConvert.html#DMConvert">DMConvert</a>(massDM, <a href="../../../docs/manualpages/DMPLEX/DMPLEX.html#DMPLEX">DMPLEX</a>, &amp;plex);
<a name="line1518">1518: </a>    <a href="../../../docs/manualpages/DM/DMGetLocalVector.html#DMGetLocalVector">DMGetLocalVector</a>(massDM, &amp;locX);
<a name="line1519">1519: </a>    <font color="#B22222">/* Mass matrix is independent of the input, so no need to fill locX */</font>
<a name="line1520">1520: </a>    <a href="../../../docs/manualpages/SNES/DMPlexSNESComputeJacobianFEM.html#DMPlexSNESComputeJacobianFEM">DMPlexSNESComputeJacobianFEM</a>(plex, locX, M, M, ctx);
<a name="line1521">1521: </a>    <a href="../../../docs/manualpages/DM/DMRestoreLocalVector.html#DMRestoreLocalVector">DMRestoreLocalVector</a>(massDM, &amp;locX);
<a name="line1522">1522: </a>    <a href="../../../docs/manualpages/DM/DMDestroy.html#DMDestroy">DMDestroy</a>(&amp;plex);
<a name="line1523">1523: </a>  }
<a name="line1524">1524: </a>  <a href="../../../docs/manualpages/DM/DMDestroy.html#DMDestroy">DMDestroy</a>(&amp;massDM);
<a name="line1525">1525: </a>  <a href="../../../docs/manualpages/Mat/MatGetSize.html#MatGetSize">MatGetSize</a>(ctx-&gt;J, &amp;N1, NULL);
<a name="line1526">1526: </a>  <a href="../../../docs/manualpages/Mat/MatGetSize.html#MatGetSize">MatGetSize</a>(M, &amp;N2, NULL);
<a name="line1527">1527: </a>  <font color="#4169E1">if</font> (N1 != N2) <a href="../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>) dm), PETSC_ERR_PLIB, <font color="#666666">"Incorrect matrix sizes: |Jacobian| = %D, |Mass|=%D"</font>,N1,N2);
<a name="line1528">1528: </a>  <a href="../../../docs/manualpages/Mat/MatViewFromOptions.html#MatViewFromOptions">MatViewFromOptions</a>(M,NULL,<font color="#666666">"-dm_landau_mass_mat_view"</font>);
<a name="line1529">1529: </a>  ctx-&gt;M = M; <font color="#B22222">/* this could be a noop, a = a */</font>
<a name="line1530">1530: </a>  <font color="#4169E1">if</font> (Amat) *Amat = M;
<a name="line1531">1531: </a>  <font color="#4169E1">return</font>(0);
<a name="line1532">1532: </a>}

<a name="line1534">1534: </a><font color="#B22222">/*@</font>
<a name="line1535">1535: </a><font color="#B22222">  <a href="../../../docs/manualpages/LANDAU/LandauIFunction.html#LandauIFunction">LandauIFunction</a> - <a href="../../../docs/manualpages/TS/TS.html#TS">TS</a> residual calculation</font>

<a name="line1537">1537: </a><font color="#B22222">  Collective on ts</font>

<a name="line1539">1539: </a><font color="#B22222">  Input Parameters:</font>
<a name="line1540">1540: </a><font color="#B22222">+   <a href="../../../docs/manualpages/TS/TS.html#TS">TS</a>  - The time stepping context</font>
<a name="line1541">1541: </a><font color="#B22222">.   time_dummy - current time (not used)</font>
<a name="line1542">1542: </a><font color="#B22222">-   X - Current state</font>
<a name="line1543">1543: </a><font color="#B22222">+   X_t - Time derivative of current state</font>
<a name="line1544">1544: </a><font color="#B22222">.   actx - Landau context</font>

<a name="line1546">1546: </a><font color="#B22222">  Output Parameter:</font>
<a name="line1547">1547: </a><font color="#B22222">.   F  - The residual</font>

<a name="line1549">1549: </a><font color="#B22222">  Level: beginner</font>

<a name="line1551">1551: </a><font color="#B22222">.keywords: mesh</font>
<a name="line1552">1552: </a><font color="#B22222">.seealso: <a href="../../../docs/manualpages/LANDAU/LandauCreateVelocitySpace.html#LandauCreateVelocitySpace">LandauCreateVelocitySpace</a>(), <a href="../../../docs/manualpages/LANDAU/LandauIJacobian.html#LandauIJacobian">LandauIJacobian</a>()</font>
<a name="line1553">1553: </a><font color="#B22222">@*/</font>
<a name="line1554">1554: </a><strong><font color="#4169E1"><a name="LandauIFunction"></a><a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../docs/manualpages/LANDAU/LandauIFunction.html#LandauIFunction">LandauIFunction</a>(<a href="../../../docs/manualpages/TS/TS.html#TS">TS</a> ts, <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> time_dummy, <a href="../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a> X, <a href="../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a> X_t, <a href="../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a> F, void *actx)</font></strong>
<a name="line1555">1555: </a>{
<a name="line1557">1557: </a>  LandauCtx      *ctx=(LandauCtx*)actx;
<a name="line1558">1558: </a>  <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>      unorm;
<a name="line1559">1559: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       dim;
<a name="line1560">1560: </a>  <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> dm;

<a name="line1563">1563: </a>  <a href="../../../docs/manualpages/TS/TSGetDM.html#TSGetDM">TSGetDM</a>(ts,&amp;dm);
<a name="line1564">1564: </a>  <a href="../../../docs/manualpages/DM/DMGetApplicationContext.html#DMGetApplicationContext">DMGetApplicationContext</a>(dm, &amp;ctx);
<a name="line1565">1565: </a>  <font color="#4169E1">if</font> (!ctx) <a href="../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_PLIB, <font color="#666666">"no context"</font>);
<a name="line1566">1566: </a>  <a href="../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</a>(X,<a href="../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</a>,&amp;unorm);
<a name="line1567">1567: </a>  <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Barrier.html#MPI_Barrier">MPI_Barrier</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_WORLD.html#PETSC_COMM_WORLD">PETSC_COMM_WORLD</a>); // remove in real application
<a name="line1568">1568: </a>  <a href="../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</a>(ctx-&gt;events[0],0,0,0,0);
<a name="line1569">1569: </a>  <a href="../../../docs/manualpages/DM/DMGetDimension.html#DMGetDimension">DMGetDimension</a>(ctx-&gt;dmv, &amp;dim);
<a name="line1570">1570: </a>  <font color="#4169E1">if</font> (ctx-&gt;normJ != unorm) {
<a name="line1571">1571: </a>    ctx-&gt;normJ = unorm;
<a name="line1572">1572: </a>    PetscInfo1(ts, <font color="#666666">"Create Landau Jacobian t=%g\n"</font>,time_dummy);
<a name="line1573">1573: </a>    LandauFormJacobian_Internal(X,ctx-&gt;J,dim,(void*)ctx);
<a name="line1574">1574: </a>    ctx-&gt;aux_bool = <a href="../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>; <font color="#B22222">/* debug: set flag that we made a new Jacobian */</font>
<a name="line1575">1575: </a>  } <font color="#4169E1">else</font> {
<a name="line1576">1576: </a>    ctx-&gt;aux_bool = <a href="../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;
<a name="line1577">1577: </a>    PetscInfo1(ts, <font color="#666666">"Skip Landau Jacobian t=%g\n"</font>,(double)time_dummy);
<a name="line1578">1578: </a>  }
<a name="line1579">1579: </a>  <font color="#B22222">/* mat vec for op */</font>
<a name="line1580">1580: </a>  <a href="../../../docs/manualpages/Mat/MatMult.html#MatMult">MatMult</a>(ctx-&gt;J,X,F); <font color="#B22222">/* C*f */</font>
<a name="line1581">1581: </a>  <font color="#B22222">/* add time term */</font>
<a name="line1582">1582: </a>  <font color="#4169E1">if</font> (X_t) {
<a name="line1583">1583: </a>    <a href="../../../docs/manualpages/Mat/MatMultAdd.html#MatMultAdd">MatMultAdd</a>(ctx-&gt;M,X_t,F,F);
<a name="line1584">1584: </a>  }
<a name="line1585">1585: </a>  <a href="../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</a>(ctx-&gt;events[0],0,0,0,0);
<a name="line1586">1586: </a>  <font color="#4169E1">return</font>(0);
<a name="line1587">1587: </a>}

<a name="line1589">1589: </a><font color="#B22222">/*@</font>
<a name="line1590">1590: </a><font color="#B22222">  <a href="../../../docs/manualpages/LANDAU/LandauIJacobian.html#LandauIJacobian">LandauIJacobian</a> - <a href="../../../docs/manualpages/TS/TS.html#TS">TS</a> Jacobian construction</font>

<a name="line1592">1592: </a><font color="#B22222">  Collective on ts</font>

<a name="line1594">1594: </a><font color="#B22222">  Input Parameters:</font>
<a name="line1595">1595: </a><font color="#B22222">+   <a href="../../../docs/manualpages/TS/TS.html#TS">TS</a>  - The time stepping context</font>
<a name="line1596">1596: </a><font color="#B22222">.   time_dummy - current time (not used)</font>
<a name="line1597">1597: </a><font color="#B22222">-   X - Current state</font>
<a name="line1598">1598: </a><font color="#B22222">+   U_tdummy - Time derivative of current state (not used)</font>
<a name="line1599">1599: </a><font color="#B22222">.   shift - shift for du/dt term</font>
<a name="line1600">1600: </a><font color="#B22222">-   actx - Landau context</font>

<a name="line1602">1602: </a><font color="#B22222">  Output Parameter:</font>
<a name="line1603">1603: </a><font color="#B22222">.   Amat  - Jacobian</font>
<a name="line1604">1604: </a><font color="#B22222">+   Pmat  - same as Amat</font>

<a name="line1606">1606: </a><font color="#B22222">  Level: beginner</font>

<a name="line1608">1608: </a><font color="#B22222">.keywords: mesh</font>
<a name="line1609">1609: </a><font color="#B22222">.seealso: <a href="../../../docs/manualpages/LANDAU/LandauCreateVelocitySpace.html#LandauCreateVelocitySpace">LandauCreateVelocitySpace</a>(), <a href="../../../docs/manualpages/LANDAU/LandauIFunction.html#LandauIFunction">LandauIFunction</a>()</font>
<a name="line1610">1610: </a><font color="#B22222">@*/</font>
<a name="line1611">1611: </a><strong><font color="#4169E1"><a name="LandauIJacobian"></a><a href="../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../docs/manualpages/LANDAU/LandauIJacobian.html#LandauIJacobian">LandauIJacobian</a>(<a href="../../../docs/manualpages/TS/TS.html#TS">TS</a> ts, <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> time_dummy, <a href="../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a> X, <a href="../../../docs/manualpages/Vec/Vec.html#Vec">Vec</a> U_tdummy, <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a> shift, <a href="../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> Amat, <a href="../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> Pmat, void *actx)</font></strong>
<a name="line1612">1612: </a>{
<a name="line1614">1614: </a>  LandauCtx      *ctx=(LandauCtx*)actx;
<a name="line1615">1615: </a>  <a href="../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>      unorm;
<a name="line1616">1616: </a>  <a href="../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       dim;
<a name="line1617">1617: </a>  <a href="../../../docs/manualpages/DM/DM.html#DM">DM</a> dm;

<a name="line1620">1620: </a>  <a href="../../../docs/manualpages/TS/TSGetDM.html#TSGetDM">TSGetDM</a>(ts,&amp;dm);
<a name="line1621">1621: </a>  <a href="../../../docs/manualpages/DM/DMGetApplicationContext.html#DMGetApplicationContext">DMGetApplicationContext</a>(dm, &amp;ctx);
<a name="line1622">1622: </a>  <font color="#4169E1">if</font> (!ctx) <a href="../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_PLIB, <font color="#666666">"no context"</font>);
<a name="line1623">1623: </a>  <font color="#4169E1">if</font> (Amat!=Pmat || Amat!=ctx-&gt;J) <a href="../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_PLIB, <font color="#666666">"Amat!=Pmat || Amat!=ctx-&gt;J"</font>);
<a name="line1624">1624: </a>  <a href="../../../docs/manualpages/DM/DMGetDimension.html#DMGetDimension">DMGetDimension</a>(ctx-&gt;dmv, &amp;dim);
<a name="line1625">1625: </a>  <font color="#B22222">/* get collision Jacobian into A */</font>
<a name="line1626">1626: </a>  <a href="../../../docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</a>(ctx-&gt;events[9],0,0,0,0);
<a name="line1627">1627: </a>  <a href="../../../docs/manualpages/Vec/VecNorm.html#VecNorm">VecNorm</a>(X,<a href="../../../docs/manualpages/Vec/NORM_2.html#NORM_2">NORM_2</a>,&amp;unorm);
<a name="line1628">1628: </a>  <font color="#4169E1">if</font> (ctx-&gt;normJ!=unorm) {
<a name="line1629">1629: </a>    PetscInfo2(ts, <font color="#666666">"Create Landau Jacobian t=%g, shift=%g\n"</font>,(double)time_dummy,(double)shift);
<a name="line1630">1630: </a>    LandauFormJacobian_Internal(X,ctx-&gt;J,dim,(void*)ctx);
<a name="line1631">1631: </a>    ctx-&gt;normJ = unorm;
<a name="line1632">1632: </a>    ctx-&gt;aux_bool = <a href="../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>; <font color="#B22222">/* debug: set flag that we made a new Jacobian */</font>
<a name="line1633">1633: </a>  } <font color="#4169E1">else</font> {
<a name="line1634">1634: </a>    ctx-&gt;aux_bool = <a href="../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;
<a name="line1635">1635: </a>    PetscInfo3(ts, <font color="#666666">"Skip Landau Jacobian t=%g, shift=%g shift*|u|=%20.12e\n"</font>,(double)time_dummy,(double)shift,(double)shift*unorm);
<a name="line1636">1636: </a>  }
<a name="line1637">1637: </a>  <font color="#B22222">/* add C */</font>
<a name="line1638">1638: </a>  <a href="../../../docs/manualpages/Mat/MatCopy.html#MatCopy">MatCopy</a>(ctx-&gt;J,Pmat,<a href="../../../docs/manualpages/Mat/MatStructure.html#MatStructure">SAME_NONZERO_PATTERN</a>);
<a name="line1639">1639: </a>  <font color="#B22222">/* add mass */</font>
<a name="line1640">1640: </a>  <a href="../../../docs/manualpages/Mat/MatAXPY.html#MatAXPY">MatAXPY</a>(Pmat,shift,ctx-&gt;M,<a href="../../../docs/manualpages/Mat/MatStructure.html#MatStructure">SAME_NONZERO_PATTERN</a>);
<a name="line1641">1641: </a>  <a href="../../../docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</a>(ctx-&gt;events[9],0,0,0,0);
<a name="line1642">1642: </a>  <font color="#4169E1">return</font>(0);
<a name="line1643">1643: </a>}
</pre>
</body>

</html>
