<center><a href="hpddm.cxx">Actual source code: hpddm.cxx</a></center><br>

<html>
<head> <link rel="canonical" href="http://www.mcs.anl.gov/petsc/petsc-current/src/ksp/ksp/impls/hpddm/hpddm.cxx.html" />
<title></title>
<meta name="generator" content="c2html 0.9.4">
<meta name="date" content="2021-03-30T16:51:23+00:00">
</head>

<body bgcolor="#FFFFFF">
   <div id="version" align=right><b>petsc-3.14.6 2021-03-30</b></div>
   <div id="bugreport" align=right><a href="mailto:petsc-maint@mcs.anl.gov?subject=Typo or Error in Documentation &body=Please describe the typo or error in the documentation: petsc-3.14.6 v3.14.6 src/ksp/ksp/impls/hpddm/hpddm.cxx.html "><small>Report Typos and Errors</small></a></div>
<pre width="80">
<a name="line1">  1: </a>#include <A href="../../../../../include/petsc/private/petschpddm.h.html">&lt;petsc/private/petschpddm.h&gt;</A>

<a name="line3">  3: </a><font color="#B22222">/* static array length */</font>
<a name="line4">  4: </a><strong><font color="#228B22">#define ALEN(a) (sizeof(a)/sizeof((a)[0]))</font></strong>

<a name="line6">  6: </a>const char *const KSPHPDDMTypes[]           = { <a href="../../../../../docs/manualpages/KSP/KSPGMRES.html#KSPGMRES">KSPGMRES</a>, <font color="#666666">"bgmres"</font>, <a href="../../../../../docs/manualpages/KSP/KSPCG.html#KSPCG">KSPCG</a>, <font color="#666666">"bcg"</font>, <font color="#666666">"gcrodr"</font>, <font color="#666666">"bgcrodr"</font>, <font color="#666666">"bfbcg"</font>, <a href="../../../../../docs/manualpages/KSP/KSPPREONLY.html#KSPPREONLY">KSPPREONLY</a> };
<a name="line7">  7: </a>static const char *HPDDMOrthogonalization[] = { <font color="#666666">"cgs"</font>, <font color="#666666">"mgs"</font> };
<a name="line8">  8: </a>static const char *HPDDMQR[]                = { <font color="#666666">"cholqr"</font>, <font color="#666666">"cgs"</font>, <font color="#666666">"mgs"</font> };
<a name="line9">  9: </a>static const char *HPDDMVariant[]           = { <font color="#666666">"left"</font>, <font color="#666666">"right"</font>, <font color="#666666">"flexible"</font> };
<a name="line10"> 10: </a>static const char *HPDDMRecycleTarget[]     = { <font color="#666666">"SM"</font>, <font color="#666666">"LM"</font>, <font color="#666666">"SR"</font>, <font color="#666666">"LR"</font>, <font color="#666666">"SI"</font>, <font color="#666666">"LI"</font> };
<a name="line11"> 11: </a>static const char *HPDDMRecycleStrategy[]   = { <font color="#666666">"A"</font>, <font color="#666666">"B"</font> };

<a name="line13"> 13: </a>static <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a> citeKSP = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;
<a name="line14"> 14: </a>static const char hpddmCitationKSP[] = <font color="#666666">"@inproceedings{jolivet2016block,\n\tTitle = {{Block Iterative Methods and Recycling for Improved Scalability of Linear Solvers}},\n\tAuthor = {Jolivet, Pierre and Tournier, Pierre-Henri},\n\tOrganization = {IEEE},\n\tYear = {2016},\n\tSeries = {SC16},\n\tBooktitle = {Proceedings of the 2016 International Conference for High Performance Computing, Networking, Storage and Analysis}\n}\n"</font>;

<a name="line16"> 16: </a><font color="#A020F0">#if defined(PETSC_HAVE_SLEPC) &amp;&amp; defined(PETSC_USE_SHARED_LIBRARIES)</font>
<a name="line17"> 17: </a>static <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a> loadedDL = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;
<a name="line18"> 18: </a><font color="#A020F0">#endif</font>

<a name="line20"> 20: </a><strong><font color="#4169E1"><a name="KSPSetFromOptions_HPDDM"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> KSPSetFromOptions_HPDDM(PetscOptionItems *PetscOptionsObject, <a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp)</font></strong>
<a name="line21"> 21: </a>{
<a name="line22"> 22: </a>  KSP_HPDDM      *data = (KSP_HPDDM*)ksp-&gt;data;
<a name="line23"> 23: </a>  <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       i, j;
<a name="line24"> 24: </a>  <a href="../../../../../docs/manualpages/Sys/PetscMPIInt.html#PetscMPIInt">PetscMPIInt</a>    size;

<a name="line28"> 28: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsHead.html#PetscOptionsHead">PetscOptionsHead</a>(PetscOptionsObject, <font color="#666666">"<a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a> options, cf. https://github.com/hpddm/hpddm"</font>);
<a name="line29"> 29: </a>  i = (data-&gt;cntl[0] == static_cast&lt;char&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>) ? HPDDM_KRYLOV_METHOD_GMRES : data-&gt;cntl[0]);
<a name="line30"> 30: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsEList.html#PetscOptionsEList">PetscOptionsEList</a>(<font color="#666666">"-ksp_hpddm_type"</font>, <font color="#666666">"Type of Krylov method"</font>, <font color="#666666">"<a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a>"</font>, KSPHPDDMTypes, ALEN(KSPHPDDMTypes), KSPHPDDMTypes[HPDDM_KRYLOV_METHOD_GMRES], &amp;i, NULL);
<a name="line31"> 31: </a>  <font color="#4169E1">if</font> (i == ALEN(KSPHPDDMTypes) - 1)
<a name="line32"> 32: </a>    i = HPDDM_KRYLOV_METHOD_NONE; <font color="#B22222">/* need to shift the value since HPDDM_KRYLOV_METHOD_RICHARDSON is not registered in PETSc */</font>
<a name="line33"> 33: </a>  data-&gt;cntl[0] = i;
<a name="line34"> 34: </a>  <font color="#4169E1">if</font> (data-&gt;cntl[0] != HPDDM_KRYLOV_METHOD_NONE) {
<a name="line35"> 35: </a>    <font color="#4169E1">if</font> (data-&gt;cntl[0] != HPDDM_KRYLOV_METHOD_BCG &amp;&amp; data-&gt;cntl[0] != HPDDM_KRYLOV_METHOD_BFBCG) {
<a name="line36"> 36: </a>      i = (data-&gt;cntl[1] == static_cast&lt;char&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>) ? HPDDM_VARIANT_LEFT : data-&gt;cntl[1]);
<a name="line37"> 37: </a>      <font color="#4169E1">if</font> (ksp-&gt;pc_side_set == <a href="../../../../../docs/manualpages/PC/PCSide.html#PCSide">PC_SIDE_DEFAULT</a>) {
<a name="line38"> 38: </a>        <a href="../../../../../docs/manualpages/Sys/PetscOptionsEList.html#PetscOptionsEList">PetscOptionsEList</a>(<font color="#666666">"-ksp_hpddm_variant"</font>, <font color="#666666">"Left, right, or variable preconditioning"</font>, <font color="#666666">"<a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a>"</font>, HPDDMVariant, ALEN(HPDDMVariant), HPDDMVariant[HPDDM_VARIANT_LEFT], &amp;i, NULL);
<a name="line39"> 39: </a>      } <font color="#4169E1">else</font> <font color="#4169E1">if</font> (ksp-&gt;pc_side_set == <a href="../../../../../docs/manualpages/PC/PCSide.html#PCSide">PC_RIGHT</a>) i = HPDDM_VARIANT_RIGHT;
<a name="line40"> 40: </a>      <font color="#4169E1">else</font> <font color="#4169E1">if</font> (ksp-&gt;pc_side_set == <a href="../../../../../docs/manualpages/PC/PCSide.html#PCSide">PC_SYMMETRIC</a>) <a href="../../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_ARG_WRONG, <font color="#666666">"Symmetric preconditioning not implemented"</font>);
<a name="line41"> 41: </a>      data-&gt;cntl[1] = i;
<a name="line42"> 42: </a>      <font color="#4169E1">if</font> (i &gt; 0) {
<a name="line43"> 43: </a>        <a href="../../../../../docs/manualpages/KSP/KSPSetPCSide.html#KSPSetPCSide">KSPSetPCSide</a>(ksp, <a href="../../../../../docs/manualpages/PC/PCSide.html#PCSide">PC_RIGHT</a>);
<a name="line44"> 44: </a>      }
<a name="line45"> 45: </a>    }
<a name="line46"> 46: </a>    <font color="#4169E1">if</font> (data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BGMRES || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BGCRODR || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BFBCG) {
<a name="line47"> 47: </a>      data-&gt;rcntl[0] = (std::abs(data-&gt;rcntl[0] - static_cast&lt;<a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>)) &lt; PETSC_SMALL ? -1.0 : data-&gt;rcntl[0]);
<a name="line48"> 48: </a>      <a href="../../../../../docs/manualpages/Sys/PetscOptionsReal.html#PetscOptionsReal">PetscOptionsReal</a>(<font color="#666666">"-ksp_hpddm_deflation_tol"</font>, <font color="#666666">"Tolerance when deflating right-hand sides inside block methods"</font>, <font color="#666666">"<a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a>"</font>, data-&gt;rcntl[0], data-&gt;rcntl, NULL);
<a name="line49"> 49: </a>      i = (data-&gt;scntl[data-&gt;cntl[0] != HPDDM_KRYLOV_METHOD_BFBCG] == static_cast&lt;unsigned short&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>) ? 1 : <a href="../../../../../docs/manualpages/Sys/PetscMax.html#PetscMax">PetscMax</a>(1, data-&gt;scntl[data-&gt;cntl[0] != HPDDM_KRYLOV_METHOD_BFBCG]));
<a name="line50"> 50: </a>      <a href="../../../../../docs/manualpages/Sys/PetscOptionsRangeInt.html#PetscOptionsRangeInt">PetscOptionsRangeInt</a>(<font color="#666666">"-ksp_hpddm_enlarge_krylov_subspace"</font>, <font color="#666666">"Split the initial right-hand side into multiple vectors"</font>, <font color="#666666">"<a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a>"</font>, i, &amp;i, NULL, 1, std::numeric_limits&lt;unsigned short&gt;::max() - 1);
<a name="line51"> 51: </a>      data-&gt;scntl[data-&gt;cntl[0] != HPDDM_KRYLOV_METHOD_BFBCG] = i;
<a name="line52"> 52: </a>    } <font color="#4169E1">else</font> data-&gt;scntl[data-&gt;cntl[0] != HPDDM_KRYLOV_METHOD_BCG] = 0;
<a name="line53"> 53: </a>    <font color="#4169E1">if</font> (data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_GMRES || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BGMRES || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_GCRODR || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BGCRODR) {
<a name="line54"> 54: </a>      i = (data-&gt;cntl[2] == static_cast&lt;char&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>) ? HPDDM_ORTHOGONALIZATION_CGS : data-&gt;cntl[2] &amp; 3);
<a name="line55"> 55: </a>      <a href="../../../../../docs/manualpages/Sys/PetscOptionsEList.html#PetscOptionsEList">PetscOptionsEList</a>(<font color="#666666">"-ksp_hpddm_orthogonalization"</font>, <font color="#666666">"Classical (faster) or Modified (more robust) Gram--Schmidt process"</font>, <font color="#666666">"<a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a>"</font>, HPDDMOrthogonalization, ALEN(HPDDMOrthogonalization), HPDDMOrthogonalization[HPDDM_ORTHOGONALIZATION_CGS], &amp;i, NULL);
<a name="line56"> 56: </a>      j = (data-&gt;cntl[2] == static_cast&lt;char&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>) ? HPDDM_QR_CHOLQR : ((data-&gt;cntl[2] &gt;&gt; 2) &amp; 7));
<a name="line57"> 57: </a>      <a href="../../../../../docs/manualpages/Sys/PetscOptionsEList.html#PetscOptionsEList">PetscOptionsEList</a>(<font color="#666666">"-ksp_hpddm_qr"</font>, <font color="#666666">"Distributed QR factorizations computed with Cholesky QR, Classical or Modified Gram--Schmidt process"</font>, <font color="#666666">"<a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a>"</font>, HPDDMQR, ALEN(HPDDMQR), HPDDMQR[HPDDM_QR_CHOLQR], &amp;j, NULL);
<a name="line58"> 58: </a>      data-&gt;cntl[2] = static_cast&lt;char&gt;(i) + (static_cast&lt;char&gt;(j) &lt;&lt; 2);
<a name="line59"> 59: </a>      i = (data-&gt;scntl[0] == static_cast&lt;unsigned short&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>) ? <a href="../../../../../docs/manualpages/Sys/PetscMin.html#PetscMin">PetscMin</a>(30, ksp-&gt;max_it) : data-&gt;scntl[0]);
<a name="line60"> 60: </a>      <a href="../../../../../docs/manualpages/Sys/PetscOptionsRangeInt.html#PetscOptionsRangeInt">PetscOptionsRangeInt</a>(<font color="#666666">"-ksp_gmres_restart"</font>, <font color="#666666">"Maximum number of Arnoldi vectors generated per cycle"</font>, <font color="#666666">"<a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a>"</font>, i, &amp;i, NULL, <a href="../../../../../docs/manualpages/Sys/PetscMin.html#PetscMin">PetscMin</a>(1, ksp-&gt;max_it), <a href="../../../../../docs/manualpages/Sys/PetscMin.html#PetscMin">PetscMin</a>(ksp-&gt;max_it, std::numeric_limits&lt;unsigned short&gt;::max() - 1));
<a name="line61"> 61: </a>      data-&gt;scntl[0] = i;
<a name="line62"> 62: </a>    }
<a name="line63"> 63: </a>    <font color="#4169E1">if</font> (data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BCG || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BFBCG) {
<a name="line64"> 64: </a>      j = (data-&gt;cntl[1] == static_cast&lt;char&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>) ? HPDDM_QR_CHOLQR : data-&gt;cntl[1]);
<a name="line65"> 65: </a>      <a href="../../../../../docs/manualpages/Sys/PetscOptionsEList.html#PetscOptionsEList">PetscOptionsEList</a>(<font color="#666666">"-ksp_hpddm_qr"</font>, <font color="#666666">"Distributed QR factorizations computed with Cholesky QR, Classical or Modified Gram--Schmidt process"</font>, <font color="#666666">"<a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a>"</font>, HPDDMQR, ALEN(HPDDMQR), HPDDMQR[HPDDM_QR_CHOLQR], &amp;j, NULL);
<a name="line66"> 66: </a>      data-&gt;cntl[1] = j;
<a name="line67"> 67: </a>    }
<a name="line68"> 68: </a>    <font color="#4169E1">if</font> (data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_GCRODR || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BGCRODR) {
<a name="line69"> 69: </a>      i = (data-&gt;icntl[0] == static_cast&lt;int&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>) ? <a href="../../../../../docs/manualpages/Sys/PetscMin.html#PetscMin">PetscMin</a>(20, data-&gt;scntl[0] - 1) : data-&gt;icntl[0]);
<a name="line70"> 70: </a>      <a href="../../../../../docs/manualpages/Sys/PetscOptionsRangeInt.html#PetscOptionsRangeInt">PetscOptionsRangeInt</a>(<font color="#666666">"-ksp_hpddm_recycle"</font>, <font color="#666666">"Number of harmonic Ritz vectors to compute"</font>, <font color="#666666">"<a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a>"</font>, i, &amp;i, NULL, 1, data-&gt;scntl[0] - 1);
<a name="line71"> 71: </a>      data-&gt;icntl[0] = i;
<a name="line72"> 72: </a>      <font color="#4169E1">if</font> (!<a href="../../../../../docs/manualpages/Sys/PetscDefined.html#PetscDefined">PetscDefined</a>(HAVE_SLEPC) || !<a href="../../../../../docs/manualpages/Sys/PetscDefined.html#PetscDefined">PetscDefined</a>(USE_SHARED_LIBRARIES) || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_GCRODR) {
<a name="line73"> 73: </a>        i = (data-&gt;cntl[3] == static_cast&lt;char&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>) ? HPDDM_RECYCLE_TARGET_SM : data-&gt;cntl[3]);
<a name="line74"> 74: </a>        <a href="../../../../../docs/manualpages/Sys/PetscOptionsEList.html#PetscOptionsEList">PetscOptionsEList</a>(<font color="#666666">"-ksp_hpddm_recycle_target"</font>, <font color="#666666">"Criterion to select harmonic Ritz vectors"</font>, <font color="#666666">"<a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a>"</font>, HPDDMRecycleTarget, ALEN(HPDDMRecycleTarget), HPDDMRecycleTarget[HPDDM_RECYCLE_TARGET_SM], &amp;i, NULL);
<a name="line75"> 75: </a>        data-&gt;cntl[3] = i;
<a name="line76"> 76: </a>      } <font color="#4169E1">else</font> {
<a name="line77"> 77: </a>        <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_size.html#MPI_Comm_size">MPI_Comm_size</a>(<a href="../../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp), &amp;size);
<a name="line78"> 78: </a>        i = (data-&gt;cntl[3] == static_cast&lt;char&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>) ? 1 : data-&gt;cntl[3]);
<a name="line79"> 79: </a>        <a href="../../../../../docs/manualpages/Sys/PetscOptionsRangeInt.html#PetscOptionsRangeInt">PetscOptionsRangeInt</a>(<font color="#666666">"-ksp_hpddm_recycle_redistribute"</font>, <font color="#666666">"Number of processes used to solve eigenvalue problems when recycling in BGCRODR"</font>, <font color="#666666">"<a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a>"</font>, i, &amp;i, NULL, 1, <a href="../../../../../docs/manualpages/Sys/PetscMin.html#PetscMin">PetscMin</a>(size, 192));
<a name="line80"> 80: </a>        data-&gt;cntl[3] = i;
<a name="line81"> 81: </a>      }
<a name="line82"> 82: </a>      i = (data-&gt;cntl[4] == static_cast&lt;char&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>) ? HPDDM_RECYCLE_STRATEGY_A : data-&gt;cntl[4]);
<a name="line83"> 83: </a>      <a href="../../../../../docs/manualpages/Sys/PetscOptionsEList.html#PetscOptionsEList">PetscOptionsEList</a>(<font color="#666666">"-ksp_hpddm_recycle_strategy"</font>, <font color="#666666">"Generalized eigenvalue problem to solve for recycling"</font>, <font color="#666666">"<a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a>"</font>, HPDDMRecycleStrategy, ALEN(HPDDMRecycleStrategy), HPDDMRecycleStrategy[HPDDM_RECYCLE_STRATEGY_A], &amp;i, NULL);
<a name="line84"> 84: </a>      data-&gt;cntl[4] = i;
<a name="line85"> 85: </a>    }
<a name="line86"> 86: </a>  } <font color="#4169E1">else</font> {
<a name="line87"> 87: </a>    data-&gt;cntl[0] = HPDDM_KRYLOV_METHOD_NONE;
<a name="line88"> 88: </a>    data-&gt;scntl[1] = 1;
<a name="line89"> 89: </a>  }
<a name="line90"> 90: </a>  <a href="../../../../../docs/manualpages/Sys/PetscOptionsTail.html#PetscOptionsTail">PetscOptionsTail</a>();
<a name="line91"> 91: </a>  <font color="#4169E1">return</font>(0);
<a name="line92"> 92: </a>}

<a name="line94"> 94: </a><strong><font color="#4169E1"><a name="KSPView_HPDDM"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> KSPView_HPDDM(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp, <a href="../../../../../docs/manualpages/Viewer/PetscViewer.html#PetscViewer">PetscViewer</a> viewer)</font></strong>
<a name="line95"> 95: </a>{
<a name="line96"> 96: </a>  KSP_HPDDM            *data = (KSP_HPDDM*)ksp-&gt;data;
<a name="line97"> 97: </a><strong><font color="#FF0000">  HPDDM:</font></strong>:PETScOperator *op = data-&gt;op;
<a name="line98"> 98: </a>  const <a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>    *array = op ? op-&gt;storage() : NULL;
<a name="line99"> 99: </a>  <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>            ascii;
<a name="line100">100: </a>  <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>       ierr;

<a name="line103">103: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectTypeCompare.html#PetscObjectTypeCompare">PetscObjectTypeCompare</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)viewer, <a href="../../../../../docs/manualpages/Viewer/PETSCVIEWERASCII.html#PETSCVIEWERASCII">PETSCVIEWERASCII</a>, &amp;ascii);
<a name="line104">104: </a>  <font color="#4169E1">if</font> (op &amp;&amp; ascii) {
<a name="line105">105: </a>    <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</a>(viewer, <font color="#666666">"HPDDM type: %s\n"</font>, KSPHPDDMTypes[std::min(static_cast&lt;<a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>&gt;(data-&gt;cntl[0]), static_cast&lt;<a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>&gt;(ALEN(KSPHPDDMTypes) - 1))]);
<a name="line106">106: </a>    <font color="#4169E1">if</font> (data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BGMRES || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BGCRODR || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BFBCG) {
<a name="line107">107: </a>      <font color="#4169E1">if</font> (std::abs(data-&gt;rcntl[0] - static_cast&lt;<a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>)) &lt; PETSC_SMALL) {
<a name="line108">108: </a>        <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</a>(viewer, <font color="#666666">"no deflation at restarts\n"</font>, PetscBools[array ? <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a> : <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>]);
<a name="line109">109: </a>      } <font color="#4169E1">else</font> {
<a name="line110">110: </a>        <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</a>(viewer, <font color="#666666">"deflation tolerance: %g\n"</font>, data-&gt;rcntl[0]);
<a name="line111">111: </a>      }
<a name="line112">112: </a>    }
<a name="line113">113: </a>    <font color="#4169E1">if</font> (data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_GCRODR || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BGCRODR) {
<a name="line114">114: </a>      <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</a>(viewer, <font color="#666666">"deflation subspace attached? %s\n"</font>, PetscBools[array ? <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a> : <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>]);
<a name="line115">115: </a>      <font color="#4169E1">if</font> (!<a href="../../../../../docs/manualpages/Sys/PetscDefined.html#PetscDefined">PetscDefined</a>(HAVE_SLEPC) || !<a href="../../../../../docs/manualpages/Sys/PetscDefined.html#PetscDefined">PetscDefined</a>(USE_SHARED_LIBRARIES) || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_GCRODR) {
<a name="line116">116: </a>        <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</a>(viewer, <font color="#666666">"deflation target: %s\n"</font>, HPDDMRecycleTarget[static_cast&lt;<a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>&gt;(data-&gt;cntl[3])]);
<a name="line117">117: </a>      } <font color="#4169E1">else</font> {
<a name="line118">118: </a>        <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</a>(viewer, <font color="#666666">"redistribution size: %D\n"</font>, static_cast&lt;<a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>&gt;(data-&gt;cntl[3]));
<a name="line119">119: </a>      }
<a name="line120">120: </a>    }
<a name="line121">121: </a>    <font color="#4169E1">if</font> (data-&gt;icntl[1] != static_cast&lt;int&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>)) {
<a name="line122">122: </a>      <a href="../../../../../docs/manualpages/Viewer/PetscViewerASCIIPrintf.html#PetscViewerASCIIPrintf">PetscViewerASCIIPrintf</a>(viewer, <font color="#666666">"  block size is %d\n"</font>, data-&gt;icntl[1]);
<a name="line123">123: </a>    }
<a name="line124">124: </a>  }
<a name="line125">125: </a>  <font color="#4169E1">return</font>(0);
<a name="line126">126: </a>}

<a name="line128">128: </a><strong><font color="#4169E1"><a name="KSPSetUp_HPDDM"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> KSPSetUp_HPDDM(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp)</font></strong>
<a name="line129">129: </a>{
<a name="line130">130: </a>  KSP_HPDDM      *data = (KSP_HPDDM*)ksp-&gt;data;
<a name="line131">131: </a>  <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>            A;
<a name="line132">132: </a>  <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       n, bs;
<a name="line133">133: </a>  <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>      match;

<a name="line137">137: </a>  <a href="../../../../../docs/manualpages/KSP/KSPGetOperators.html#KSPGetOperators">KSPGetOperators</a>(ksp, &amp;A, NULL);
<a name="line138">138: </a>  <a href="../../../../../docs/manualpages/Mat/MatGetLocalSize.html#MatGetLocalSize">MatGetLocalSize</a>(A, &amp;n, NULL);
<a name="line139">139: </a>  <a href="../../../../../docs/manualpages/Mat/MatGetBlockSize.html#MatGetBlockSize">MatGetBlockSize</a>(A, &amp;bs);
<a name="line140">140: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectTypeCompareAny.html#PetscObjectTypeCompareAny">PetscObjectTypeCompareAny</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)A, &amp;match, MATSEQKAIJ, MATMPIKAIJ, <font color="#666666">""</font>);
<a name="line141">141: </a>  <font color="#4169E1">if</font> (match) n /= bs;
<a name="line142">142: </a><font color="#A020F0">#if defined(PETSC_PKG_HPDDM_VERSION_MAJOR)</font>
<a name="line143">143: </a><font color="#A020F0">#if PETSC_PKG_HPDDM_VERSION_LT(2, 0, 4)</font>
<a name="line144">144: </a>  data-&gt;op = new HPDDM::PETScOperator(ksp, n, 1);
<a name="line145">145: </a><font color="#A020F0">#else</font>
<a name="line146">146: </a>  data-&gt;op = new HPDDM::PETScOperator(ksp, n);
<a name="line147">147: </a><font color="#A020F0">#endif</font>
<a name="line148">148: </a><font color="#A020F0">#else</font>
<a name="line149">149: </a>  data-&gt;op = new HPDDM::PETScOperator(ksp, n, 1);
<a name="line150">150: </a><font color="#A020F0">#endif</font>
<a name="line151">151: </a>  <font color="#4169E1">if</font> (<a href="../../../../../docs/manualpages/Sys/PetscUnlikely.html#PetscUnlikely">PetscUnlikely</a>(!ksp-&gt;setfromoptionscalled || data-&gt;cntl[0] == static_cast&lt;char&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>))) { <font color="#B22222">/* what follows is basically a copy/paste of KSPSetFromOptions_HPDDM, with no call to PetscOptions() */</font>
<a name="line152">152: </a>    <a href="../../../../../docs/manualpages/Profiling/PetscInfo.html#PetscInfo">PetscInfo</a>(ksp, <font color="#666666">"<a href="../../../../../docs/manualpages/KSP/KSPSetFromOptions.html#KSPSetFromOptions">KSPSetFromOptions</a>() not called or uninitialized internal structure, hardwiring default <a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a> options\n"</font>);
<a name="line153">153: </a>    <font color="#4169E1">if</font> (data-&gt;cntl[0] == static_cast&lt;char&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>))
<a name="line154">154: </a>      data-&gt;cntl[0] = 0; <font color="#B22222">/* GMRES by default */</font>
<a name="line155">155: </a>    <font color="#4169E1">if</font> (data-&gt;cntl[0] != HPDDM_KRYLOV_METHOD_NONE) { <font color="#B22222">/* following options do not matter with PREONLY */</font>
<a name="line156">156: </a>      <font color="#4169E1">if</font> (data-&gt;cntl[0] != HPDDM_KRYLOV_METHOD_BCG &amp;&amp; data-&gt;cntl[0] != HPDDM_KRYLOV_METHOD_BFBCG) {
<a name="line157">157: </a>        data-&gt;cntl[1] = HPDDM_VARIANT_LEFT; <font color="#B22222">/* left preconditioning by default */</font>
<a name="line158">158: </a>        <font color="#4169E1">if</font> (ksp-&gt;pc_side_set == <a href="../../../../../docs/manualpages/PC/PCSide.html#PCSide">PC_RIGHT</a>) data-&gt;cntl[1] = HPDDM_VARIANT_RIGHT;
<a name="line159">159: </a>        <font color="#4169E1">else</font> <font color="#4169E1">if</font> (ksp-&gt;pc_side_set == <a href="../../../../../docs/manualpages/PC/PCSide.html#PCSide">PC_SYMMETRIC</a>) <a href="../../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_ARG_WRONG, <font color="#666666">"Symmetric preconditioning not implemented"</font>);
<a name="line160">160: </a>        <font color="#4169E1">if</font> (data-&gt;cntl[1] &gt; 0) {
<a name="line161">161: </a>          <a href="../../../../../docs/manualpages/KSP/KSPSetPCSide.html#KSPSetPCSide">KSPSetPCSide</a>(ksp, <a href="../../../../../docs/manualpages/PC/PCSide.html#PCSide">PC_RIGHT</a>);
<a name="line162">162: </a>        }
<a name="line163">163: </a>      }
<a name="line164">164: </a>      <font color="#4169E1">if</font> (data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BGMRES || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BGCRODR || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BFBCG) {
<a name="line165">165: </a>        data-&gt;rcntl[0] = -1.0; <font color="#B22222">/* no deflation by default */</font>
<a name="line166">166: </a>        data-&gt;scntl[data-&gt;cntl[0] != HPDDM_KRYLOV_METHOD_BFBCG] = 1; <font color="#B22222">/* Krylov subspace not enlarged by default */</font>
<a name="line167">167: </a>      } <font color="#4169E1">else</font> data-&gt;scntl[data-&gt;cntl[0] != HPDDM_KRYLOV_METHOD_BCG] = 0;
<a name="line168">168: </a>      <font color="#4169E1">if</font> (data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_GMRES || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BGMRES || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_GCRODR || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BGCRODR) {
<a name="line169">169: </a>        data-&gt;cntl[2] = static_cast&lt;char&gt;(HPDDM_ORTHOGONALIZATION_CGS) + (static_cast&lt;char&gt;(HPDDM_QR_CHOLQR) &lt;&lt; 2); <font color="#B22222">/* CGS and CholQR by default */</font>
<a name="line170">170: </a>        data-&gt;scntl[0] = <a href="../../../../../docs/manualpages/Sys/PetscMin.html#PetscMin">PetscMin</a>(30, ksp-&gt;max_it); <font color="#B22222">/* restart parameter of 30 by default */</font>
<a name="line171">171: </a>      }
<a name="line172">172: </a>      <font color="#4169E1">if</font> (data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BCG || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BFBCG) {
<a name="line173">173: </a>        data-&gt;cntl[1] = HPDDM_QR_CHOLQR; <font color="#B22222">/* CholQR by default */</font>
<a name="line174">174: </a>      }
<a name="line175">175: </a>      <font color="#4169E1">if</font> (data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_GCRODR || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BGCRODR) {
<a name="line176">176: </a>        data-&gt;icntl[0] = <a href="../../../../../docs/manualpages/Sys/PetscMin.html#PetscMin">PetscMin</a>(20, data-&gt;scntl[0] - 1); <font color="#B22222">/* recycled subspace of size 20 by default */</font>
<a name="line177">177: </a>        <font color="#4169E1">if</font> (!<a href="../../../../../docs/manualpages/Sys/PetscDefined.html#PetscDefined">PetscDefined</a>(HAVE_SLEPC) || !<a href="../../../../../docs/manualpages/Sys/PetscDefined.html#PetscDefined">PetscDefined</a>(USE_SHARED_LIBRARIES) || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_GCRODR) {
<a name="line178">178: </a>          data-&gt;cntl[3] = HPDDM_RECYCLE_TARGET_SM; <font color="#B22222">/* default recycling target */</font>
<a name="line179">179: </a>        } <font color="#4169E1">else</font> {
<a name="line180">180: </a>          data-&gt;cntl[3] = 1; <font color="#B22222">/* redistribution parameter of 1 by default */</font>
<a name="line181">181: </a>        }
<a name="line182">182: </a>        data-&gt;cntl[4] = HPDDM_RECYCLE_STRATEGY_A; <font color="#B22222">/* default recycling strategy */</font>
<a name="line183">183: </a>      }
<a name="line184">184: </a>    } <font color="#4169E1">else</font> data-&gt;scntl[1] = 1;
<a name="line185">185: </a>  }
<a name="line186">186: </a>  <font color="#4169E1">return</font>(0);
<a name="line187">187: </a>}

<a name="line189">189: </a><strong><font color="#4169E1"><a name="KSPHPDDMReset_Private"></a>PETSC_STATIC_INLINE <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> KSPHPDDMReset_Private(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp)</font></strong>
<a name="line190">190: </a>{
<a name="line191">191: </a>  KSP_HPDDM *data = (KSP_HPDDM*)ksp-&gt;data;

<a name="line194">194: </a>  <font color="#B22222">/* cast <a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a> into the appropriate types to avoid compiler warnings */</font>
<a name="line195">195: </a><strong><font color="#FF0000">  std:</font></strong>:fill_n(data-&gt;rcntl, ALEN(data-&gt;rcntl), static_cast&lt;<a href="../../../../../docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a>&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>));
<a name="line196">196: </a><strong><font color="#FF0000">  std:</font></strong>:fill_n(data-&gt;icntl, ALEN(data-&gt;icntl), static_cast&lt;int&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>));
<a name="line197">197: </a><strong><font color="#FF0000">  std:</font></strong>:fill_n(data-&gt;scntl, ALEN(data-&gt;scntl), static_cast&lt;unsigned short&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>));
<a name="line198">198: </a><strong><font color="#FF0000">  std:</font></strong>:fill_n(data-&gt;cntl , ALEN(data-&gt;cntl) , static_cast&lt;char&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>));
<a name="line199">199: </a>  <font color="#4169E1">return</font>(0);
<a name="line200">200: </a>}

<a name="line202">202: </a><strong><font color="#4169E1"><a name="KSPReset_HPDDM"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> KSPReset_HPDDM(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp)</font></strong>
<a name="line203">203: </a>{
<a name="line204">204: </a>  KSP_HPDDM      *data = (KSP_HPDDM*)ksp-&gt;data;

<a name="line208">208: </a>  <font color="#4169E1">if</font> (data-&gt;op) {
<a name="line209">209: </a>    delete data-&gt;op;
<a name="line210">210: </a>    data-&gt;op = NULL;
<a name="line211">211: </a>  }
<a name="line212">212: </a>  KSPHPDDMReset_Private(ksp);
<a name="line213">213: </a>  <font color="#4169E1">return</font>(0);
<a name="line214">214: </a>}

<a name="line216">216: </a><strong><font color="#4169E1"><a name="KSPDestroy_HPDDM"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> KSPDestroy_HPDDM(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp)</font></strong>
<a name="line217">217: </a>{

<a name="line221">221: </a>  KSPReset_HPDDM(ksp);
<a name="line222">222: </a>  KSPDestroyDefault(ksp);
<a name="line223">223: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp, <font color="#666666">"KSPHPDDMSetDeflationSpace_C"</font>, NULL);
<a name="line224">224: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp, <font color="#666666">"KSPHPDDMGetDeflationSpace_C"</font>, NULL);
<a name="line225">225: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp, <font color="#666666">"KSPSetMatSolveBlockSize_C"</font>, NULL);
<a name="line226">226: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp, <font color="#666666">"KSPGetMatSolveBlockSize_C"</font>, NULL);
<a name="line227">227: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp, <font color="#666666">"KSPHPDDMSetType_C"</font>, NULL);
<a name="line228">228: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp, <font color="#666666">"KSPHPDDMGetType_C"</font>, NULL);
<a name="line229">229: </a>  <font color="#4169E1">return</font>(0);
<a name="line230">230: </a>}

<a name="line232">232: </a><strong><font color="#4169E1"><a name="KSPSolve_HPDDM_Private"></a>PETSC_STATIC_INLINE <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> KSPSolve_HPDDM_Private(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp, const <a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> *b, <a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> *x, <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> n)</font></strong>
<a name="line233">233: </a>{
<a name="line234">234: </a>  KSP_HPDDM              *data = (KSP_HPDDM*)ksp-&gt;data;
<a name="line235">235: </a>  KSPConvergedDefaultCtx *ctx = (KSPConvergedDefaultCtx*)ksp-&gt;cnvP;
<a name="line236">236: </a>  <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>              scale;
<a name="line237">237: </a>  <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>         ierr;

<a name="line240">240: </a>  <a href="../../../../../docs/manualpages/PC/PCGetDiagonalScale.html#PCGetDiagonalScale">PCGetDiagonalScale</a>(ksp-&gt;pc, &amp;scale);
<a name="line241">241: </a>  <font color="#4169E1">if</font> (scale) <a href="../../../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp), PETSC_ERR_SUP, <font color="#666666">"Krylov method %s does not support diagonal scaling"</font>, ((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp)-&gt;type_name);
<a name="line242">242: </a>  <font color="#4169E1">if</font> (n &gt; 1) {
<a name="line243">243: </a>    <font color="#4169E1">if</font> (ksp-&gt;converged == <a href="../../../../../docs/manualpages/KSP/KSPConvergedDefault.html#KSPConvergedDefault">KSPConvergedDefault</a>) {
<a name="line244">244: </a>      <font color="#4169E1">if</font> (ctx-&gt;mininitialrtol) <a href="../../../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp), PETSC_ERR_SUP, <font color="#666666">"Krylov method %s does not support <a href="../../../../../docs/manualpages/KSP/KSPConvergedDefaultSetUMIRNorm.html#KSPConvergedDefaultSetUMIRNorm">KSPConvergedDefaultSetUMIRNorm</a>()"</font>, ((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp)-&gt;type_name);
<a name="line245">245: </a>      <font color="#4169E1">if</font> (!ctx-&gt;initialrtol) {
<a name="line246">246: </a>        <a href="../../../../../docs/manualpages/Profiling/PetscInfo.html#PetscInfo">PetscInfo</a>(ksp, <font color="#666666">"Forcing <a href="../../../../../docs/manualpages/KSP/KSPConvergedDefaultSetUIRNorm.html#KSPConvergedDefaultSetUIRNorm">KSPConvergedDefaultSetUIRNorm</a>() since <a href="../../../../../docs/manualpages/KSP/KSPConvergedDefault.html#KSPConvergedDefault">KSPConvergedDefault</a>() cannot handle multiple norms\n"</font>);
<a name="line247">247: </a>        ctx-&gt;initialrtol = <a href="../../../../../docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a>;
<a name="line248">248: </a>      }
<a name="line249">249: </a>    } <font color="#4169E1">else</font> {
<a name="line250">250: </a>      <a href="../../../../../docs/manualpages/Profiling/PetscInfo.html#PetscInfo">PetscInfo</a>(ksp, <font color="#666666">"Using a special \"converged\" callback, be careful, it is used in <a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a> to track blocks of residuals\n"</font>);
<a name="line251">251: </a>    }
<a name="line252">252: </a>  }
<a name="line253">253: </a>  <font color="#B22222">/* initial guess is always nonzero with recycling methods if there is a deflation subspace available */</font>
<a name="line254">254: </a>  <font color="#4169E1">if</font> ((data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_GCRODR || data-&gt;cntl[0] == HPDDM_KRYLOV_METHOD_BGCRODR) &amp;&amp; data-&gt;op-&gt;storage()) ksp-&gt;guess_zero = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;
<a name="line255">255: </a>  ksp-&gt;its = 0;
<a name="line256">256: </a>  ksp-&gt;reason = <a href="../../../../../docs/manualpages/KSP/KSP_CONVERGED_ITERATING.html#KSP_CONVERGED_ITERATING">KSP_CONVERGED_ITERATING</a>;
<a name="line257">257: </a>  static_cast&lt;<a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>&gt;(HPDDM::IterativeMethod::solve(*data-&gt;op, b, x, n, <a href="../../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp)));
<a name="line258">258: </a>  <font color="#4169E1">if</font> (!ksp-&gt;reason) { <font color="#B22222">/* <a href="../../../../../docs/manualpages/KSP/KSPConvergedDefault.html#KSPConvergedDefault">KSPConvergedDefault</a>() is still returning 0 (= <a href="../../../../../docs/manualpages/KSP/KSP_CONVERGED_ITERATING.html#KSP_CONVERGED_ITERATING">KSP_CONVERGED_ITERATING</a>) */</font>
<a name="line259">259: </a>    <font color="#4169E1">if</font> (ksp-&gt;its &gt;= ksp-&gt;max_it) ksp-&gt;reason = <a href="../../../../../docs/manualpages/KSP/KSP_DIVERGED_ITS.html#KSP_DIVERGED_ITS">KSP_DIVERGED_ITS</a>;
<a name="line260">260: </a>    <font color="#4169E1">else</font> ksp-&gt;reason = <a href="../../../../../docs/manualpages/KSP/KSP_CONVERGED_RTOL.html#KSP_CONVERGED_RTOL">KSP_CONVERGED_RTOL</a>; <font color="#B22222">/* early exit by HPDDM, which only happens on breakdowns or convergence */</font>
<a name="line261">261: </a>  }
<a name="line262">262: </a>  ksp-&gt;its = <a href="../../../../../docs/manualpages/Sys/PetscMin.html#PetscMin">PetscMin</a>(ksp-&gt;its, ksp-&gt;max_it);
<a name="line263">263: </a>  <font color="#4169E1">return</font>(0);
<a name="line264">264: </a>}

<a name="line266">266: </a><strong><font color="#4169E1"><a name="KSPSolve_HPDDM"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> KSPSolve_HPDDM(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp)</font></strong>
<a name="line267">267: </a>{
<a name="line268">268: </a>  KSP_HPDDM         *data = (KSP_HPDDM*)ksp-&gt;data;
<a name="line269">269: </a>  <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>               A, B;
<a name="line270">270: </a>  <a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>       *x, *bt = NULL, **ptr;
<a name="line271">271: </a>  const <a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a> *b;
<a name="line272">272: </a>  <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>          i, j, n;
<a name="line273">273: </a>  <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>         flg;
<a name="line274">274: </a>  <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>    ierr;

<a name="line277">277: </a>  <a href="../../../../../docs/manualpages/Sys/PetscCitationsRegister.html#PetscCitationsRegister">PetscCitationsRegister</a>(hpddmCitationKSP, &amp;citeKSP);
<a name="line278">278: </a>  <a href="../../../../../docs/manualpages/KSP/KSPGetOperators.html#KSPGetOperators">KSPGetOperators</a>(ksp, &amp;A, NULL);
<a name="line279">279: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectTypeCompareAny.html#PetscObjectTypeCompareAny">PetscObjectTypeCompareAny</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)A, &amp;flg, MATSEQKAIJ, MATMPIKAIJ, <font color="#666666">""</font>);
<a name="line280">280: </a>  <a href="../../../../../docs/manualpages/Vec/VecGetArray.html#VecGetArray">VecGetArray</a>(ksp-&gt;vec_sol, &amp;x);
<a name="line281">281: </a>  <a href="../../../../../docs/manualpages/Vec/VecGetArrayRead.html#VecGetArrayRead">VecGetArrayRead</a>(ksp-&gt;vec_rhs, &amp;b);
<a name="line282">282: </a>  <font color="#4169E1">if</font> (!flg) {
<a name="line283">283: </a>    KSPSolve_HPDDM_Private(ksp, b, x, 1);
<a name="line284">284: </a>  } <font color="#4169E1">else</font> {
<a name="line285">285: </a>    <a href="../../../../../docs/manualpages/Mat/MatKAIJGetScaledIdentity.html#MatKAIJGetScaledIdentity">MatKAIJGetScaledIdentity</a>(A, &amp;flg);
<a name="line286">286: </a>    <a href="../../../../../docs/manualpages/Mat/MatKAIJGetAIJ.html#MatKAIJGetAIJ">MatKAIJGetAIJ</a>(A, &amp;B);
<a name="line287">287: </a>    <a href="../../../../../docs/manualpages/Mat/MatGetBlockSize.html#MatGetBlockSize">MatGetBlockSize</a>(A, &amp;n);
<a name="line288">288: </a>    <a href="../../../../../docs/manualpages/Mat/MatGetLocalSize.html#MatGetLocalSize">MatGetLocalSize</a>(B, &amp;i, NULL);
<a name="line289">289: </a>    j = data-&gt;op-&gt;getDof();
<a name="line290">290: </a>    <font color="#4169E1">if</font> (!flg) i *= n; <font color="#B22222">/* S and T are not scaled identities, cannot use block methods */</font>
<a name="line291">291: </a>    <font color="#4169E1">if</font> (i != j) { <font color="#B22222">/* switching between block and standard methods */</font>
<a name="line292">292: </a>      delete data-&gt;op;
<a name="line293">293: </a><font color="#A020F0">#if defined(PETSC_PKG_HPDDM_VERSION_MAJOR)</font>
<a name="line294">294: </a><font color="#A020F0">#if PETSC_PKG_HPDDM_VERSION_LT(2, 0, 4)</font>
<a name="line295">295: </a>      data-&gt;op = new HPDDM::PETScOperator(ksp, i, 1);
<a name="line296">296: </a><font color="#A020F0">#else</font>
<a name="line297">297: </a>      data-&gt;op = new HPDDM::PETScOperator(ksp, i);
<a name="line298">298: </a><font color="#A020F0">#endif</font>
<a name="line299">299: </a><font color="#A020F0">#else</font>
<a name="line300">300: </a>      data-&gt;op = new HPDDM::PETScOperator(ksp, i, 1);
<a name="line301">301: </a><font color="#A020F0">#endif</font>
<a name="line302">302: </a>    }
<a name="line303">303: </a>    <font color="#4169E1">if</font> (flg &amp;&amp; n &gt; 1) {
<a name="line304">304: </a>      <a href="../../../../../docs/manualpages/Sys/PetscMalloc1.html#PetscMalloc1">PetscMalloc1</a>(i * n, &amp;bt);
<a name="line305">305: </a>      <font color="#B22222">/* from row- to column-major to be consistent with HPDDM */</font>
<a name="line306">306: </a><strong><font color="#FF0000">      HPDDM:</font></strong>:Wrapper&lt;<a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>&gt;::omatcopy&lt;'T'&gt;(i, n, b, n, bt, i);
<a name="line307">307: </a>      ptr = const_cast&lt;<a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>**&gt;(&amp;b);
<a name="line308">308: </a><strong><font color="#FF0000">      std:</font></strong>:swap(*ptr, bt);
<a name="line309">309: </a><strong><font color="#FF0000">      HPDDM:</font></strong>:Wrapper&lt;<a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>&gt;::imatcopy&lt;'T'&gt;(i, n, x, n, i);
<a name="line310">310: </a>    }
<a name="line311">311: </a>    KSPSolve_HPDDM_Private(ksp, b, x, flg ? n : 1);
<a name="line312">312: </a>    <font color="#4169E1">if</font> (flg &amp;&amp; n &gt; 1) {
<a name="line313">313: </a><strong><font color="#FF0000">      std:</font></strong>:swap(*ptr, bt);
<a name="line314">314: </a>      <a href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(bt);
<a name="line315">315: </a>      <font color="#B22222">/* from column- to row-major to be consistent with MatKAIJ format */</font>
<a name="line316">316: </a><strong><font color="#FF0000">      HPDDM:</font></strong>:Wrapper&lt;<a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>&gt;::imatcopy&lt;'T'&gt;(n, i, x, i, n);
<a name="line317">317: </a>    }
<a name="line318">318: </a>  }
<a name="line319">319: </a>  <a href="../../../../../docs/manualpages/Vec/VecRestoreArrayRead.html#VecRestoreArrayRead">VecRestoreArrayRead</a>(ksp-&gt;vec_rhs, &amp;b);
<a name="line320">320: </a>  <a href="../../../../../docs/manualpages/Vec/VecRestoreArray.html#VecRestoreArray">VecRestoreArray</a>(ksp-&gt;vec_sol, &amp;x);
<a name="line321">321: </a>  <font color="#4169E1">return</font>(0);
<a name="line322">322: </a>}

<a name="line324">324: </a><font color="#B22222">/*@</font>
<a name="line325">325: </a><font color="#B22222">     <a href="../../../../../docs/manualpages/KSP/KSPHPDDMSetDeflationSpace.html#KSPHPDDMSetDeflationSpace">KSPHPDDMSetDeflationSpace</a> - Sets the deflation space used by Krylov methods with recycling. This space is viewed as a set of vectors stored in a <a href="../../../../../docs/manualpages/Mat/MATDENSE.html#MATDENSE">MATDENSE</a> (column major).</font>

<a name="line327">327: </a><font color="#B22222">   Input Parameters:</font>
<a name="line328">328: </a><font color="#B22222">+     ksp - iterative context</font>
<a name="line329">329: </a><font color="#B22222">-     U - deflation space to be used during <a href="../../../../../docs/manualpages/KSP/KSPSolve.html#KSPSolve">KSPSolve</a>()</font>

<a name="line331">331: </a><font color="#B22222">   Level: intermediate</font>

<a name="line333">333: </a><font color="#B22222">.seealso:  <a href="../../../../../docs/manualpages/KSP/KSPCreate.html#KSPCreate">KSPCreate</a>(), <a href="../../../../../docs/manualpages/KSP/KSPType.html#KSPType">KSPType</a> (for list of available types), <a href="../../../../../docs/manualpages/KSP/KSPHPDDMGetDeflationSpace.html#KSPHPDDMGetDeflationSpace">KSPHPDDMGetDeflationSpace</a>()</font>
<a name="line334">334: </a><font color="#B22222">@*/</font>
<a name="line335">335: </a><strong><font color="#4169E1"><a name="KSPHPDDMSetDeflationSpace"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/KSP/KSPHPDDMSetDeflationSpace.html#KSPHPDDMSetDeflationSpace">KSPHPDDMSetDeflationSpace</a>(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp, <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> U)</font></strong>
<a name="line336">336: </a>{

<a name="line343">343: </a>  PetscUseMethod(ksp, <font color="#666666">"KSPHPDDMSetDeflationSpace_C"</font>, (<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a>, <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>), (ksp, U));
<a name="line344">344: </a>  <font color="#4169E1">return</font>(0);
<a name="line345">345: </a>}

<a name="line347">347: </a><font color="#B22222">/*@</font>
<a name="line348">348: </a><font color="#B22222">     <a href="../../../../../docs/manualpages/KSP/KSPHPDDMGetDeflationSpace.html#KSPHPDDMGetDeflationSpace">KSPHPDDMGetDeflationSpace</a> - Gets the deflation space computed by Krylov methods with recycling or NULL if <a href="../../../../../docs/manualpages/KSP/KSPSolve.html#KSPSolve">KSPSolve</a>() has not been called yet. This space is viewed as a set of vectors stored in a <a href="../../../../../docs/manualpages/Mat/MATDENSE.html#MATDENSE">MATDENSE</a> (column major). It is the responsibility of the user to free the returned <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>.</font>

<a name="line350">350: </a><font color="#B22222">   Input Parameter:</font>
<a name="line351">351: </a><font color="#B22222">.     ksp - iterative context</font>

<a name="line353">353: </a><font color="#B22222">   Output Parameter:</font>
<a name="line354">354: </a><font color="#B22222">.     U - deflation space generated during <a href="../../../../../docs/manualpages/KSP/KSPSolve.html#KSPSolve">KSPSolve</a>()</font>

<a name="line356">356: </a><font color="#B22222">   Level: intermediate</font>

<a name="line358">358: </a><font color="#B22222">.seealso:  <a href="../../../../../docs/manualpages/KSP/KSPCreate.html#KSPCreate">KSPCreate</a>(), <a href="../../../../../docs/manualpages/KSP/KSPType.html#KSPType">KSPType</a> (for list of available types), <a href="../../../../../docs/manualpages/KSP/KSPHPDDMSetDeflationSpace.html#KSPHPDDMSetDeflationSpace">KSPHPDDMSetDeflationSpace</a>()</font>
<a name="line359">359: </a><font color="#B22222">@*/</font>
<a name="line360">360: </a><strong><font color="#4169E1"><a name="KSPHPDDMGetDeflationSpace"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/KSP/KSPHPDDMGetDeflationSpace.html#KSPHPDDMGetDeflationSpace">KSPHPDDMGetDeflationSpace</a>(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp, <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> *U)</font></strong>
<a name="line361">361: </a>{

<a name="line366">366: </a>  PetscUseMethod(ksp, <font color="#666666">"KSPHPDDMGetDeflationSpace_C"</font>, (<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a>, <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>*), (ksp, U));
<a name="line367">367: </a>  <font color="#4169E1">return</font>(0);
<a name="line368">368: </a>}

<a name="line370">370: </a><strong><font color="#4169E1"><a name="KSPHPDDMSetDeflationSpace_HPDDM"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> KSPHPDDMSetDeflationSpace_HPDDM(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp, <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> U)</font></strong>
<a name="line371">371: </a>{
<a name="line372">372: </a>  KSP_HPDDM            *data = (KSP_HPDDM*)ksp-&gt;data;
<a name="line373">373: </a><strong><font color="#FF0000">  HPDDM:</font></strong>:PETScOperator *op = data-&gt;op;
<a name="line374">374: </a>  <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>                  A;
<a name="line375">375: </a>  const <a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>    *array;
<a name="line376">376: </a>  <a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>          *copy;
<a name="line377">377: </a>  <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>             m1, M1, m2, M2, n2, N2, ldu;
<a name="line378">378: </a>  <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>            match;
<a name="line379">379: </a>  <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>       ierr;

<a name="line382">382: </a>  <font color="#4169E1">if</font> (!op) {
<a name="line383">383: </a>    <a href="../../../../../docs/manualpages/KSP/KSPSetUp.html#KSPSetUp">KSPSetUp</a>(ksp);
<a name="line384">384: </a>    op = data-&gt;op;
<a name="line385">385: </a>  }
<a name="line386">386: </a>  <a href="../../../../../docs/manualpages/KSP/KSPGetOperators.html#KSPGetOperators">KSPGetOperators</a>(ksp, &amp;A, NULL);
<a name="line387">387: </a>  <a href="../../../../../docs/manualpages/Mat/MatGetLocalSize.html#MatGetLocalSize">MatGetLocalSize</a>(A, &amp;m1, NULL);
<a name="line388">388: </a>  <a href="../../../../../docs/manualpages/Mat/MatGetLocalSize.html#MatGetLocalSize">MatGetLocalSize</a>(U, &amp;m2, &amp;n2);
<a name="line389">389: </a>  <a href="../../../../../docs/manualpages/Mat/MatGetSize.html#MatGetSize">MatGetSize</a>(A, &amp;M1, NULL);
<a name="line390">390: </a>  <a href="../../../../../docs/manualpages/Mat/MatGetSize.html#MatGetSize">MatGetSize</a>(U, &amp;M2, &amp;N2);
<a name="line391">391: </a>  <font color="#4169E1">if</font> (m1 != m2 || M1 != M2) <a href="../../../../../docs/manualpages/Sys/SETERRQ4.html#SETERRQ4">SETERRQ4</a>(<a href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_ARG_SIZ, <font color="#666666">"Cannot use a deflation space with (m2,M2) = (%D,%D) for a linear system with (m1,M1) = (%D,%D)"</font>, m2, M2, m1, M1);
<a name="line392">392: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectTypeCompareAny.html#PetscObjectTypeCompareAny">PetscObjectTypeCompareAny</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)U, &amp;match, <a href="../../../../../docs/manualpages/Mat/MATSEQDENSE.html#MATSEQDENSE">MATSEQDENSE</a>, <a href="../../../../../docs/manualpages/Mat/MATMPIDENSE.html#MATMPIDENSE">MATMPIDENSE</a>, <font color="#666666">""</font>);
<a name="line393">393: </a>  <font color="#4169E1">if</font> (!match) <a href="../../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_ARG_WRONG, <font color="#666666">"Provided deflation space not stored in a dense <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>"</font>);
<a name="line394">394: </a>  <a href="../../../../../docs/manualpages/Mat/MatDenseGetArrayRead.html#MatDenseGetArrayRead">MatDenseGetArrayRead</a>(U, &amp;array);
<a name="line395">395: </a>  copy = op-&gt;allocate(m2, 1, N2);
<a name="line396">396: </a>  <font color="#4169E1">if</font> (!copy) <a href="../../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_POINTER, <font color="#666666">"Memory allocation error"</font>);
<a name="line397">397: </a>  <a href="../../../../../docs/manualpages/Mat/MatDenseGetLDA.html#MatDenseGetLDA">MatDenseGetLDA</a>(U, &amp;ldu);
<a name="line398">398: </a><strong><font color="#FF0000">  HPDDM:</font></strong>:Wrapper&lt;<a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>&gt;::omatcopy&lt;'N'&gt;(N2, m2, array, ldu, copy, m2);
<a name="line399">399: </a>  <a href="../../../../../docs/manualpages/Mat/MatDenseRestoreArrayRead.html#MatDenseRestoreArrayRead">MatDenseRestoreArrayRead</a>(U, &amp;array);
<a name="line400">400: </a>  <font color="#4169E1">return</font>(0);
<a name="line401">401: </a>}

<a name="line403">403: </a><strong><font color="#4169E1"><a name="KSPHPDDMGetDeflationSpace_HPDDM"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> KSPHPDDMGetDeflationSpace_HPDDM(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp, <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> *U)</font></strong>
<a name="line404">404: </a>{
<a name="line405">405: </a>  KSP_HPDDM            *data = (KSP_HPDDM*)ksp-&gt;data;
<a name="line406">406: </a><strong><font color="#FF0000">  HPDDM:</font></strong>:PETScOperator *op = data-&gt;op;
<a name="line407">407: </a>  <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>                  A;
<a name="line408">408: </a>  const <a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>    *array;
<a name="line409">409: </a>  <a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>          *copy;
<a name="line410">410: </a>  <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>             m1, M1, N2;
<a name="line411">411: </a>  <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>       ierr;

<a name="line414">414: </a>  <font color="#4169E1">if</font> (!op) {
<a name="line415">415: </a>    <a href="../../../../../docs/manualpages/KSP/KSPSetUp.html#KSPSetUp">KSPSetUp</a>(ksp);
<a name="line416">416: </a>    op = data-&gt;op;
<a name="line417">417: </a>  }
<a name="line418">418: </a>  array = op-&gt;storage();
<a name="line419">419: </a>  N2 = op-&gt;k().first * op-&gt;k().second;
<a name="line420">420: </a>  <font color="#4169E1">if</font> (!array) *U = NULL;
<a name="line421">421: </a>  <font color="#4169E1">else</font> {
<a name="line422">422: </a>    <a href="../../../../../docs/manualpages/KSP/KSPGetOperators.html#KSPGetOperators">KSPGetOperators</a>(ksp, &amp;A, NULL);
<a name="line423">423: </a>    <a href="../../../../../docs/manualpages/Mat/MatGetLocalSize.html#MatGetLocalSize">MatGetLocalSize</a>(A, &amp;m1, NULL);
<a name="line424">424: </a>    <a href="../../../../../docs/manualpages/Mat/MatGetSize.html#MatGetSize">MatGetSize</a>(A, &amp;M1, NULL);
<a name="line425">425: </a>    <a href="../../../../../docs/manualpages/Mat/MatCreateDense.html#MatCreateDense">MatCreateDense</a>(<a href="../../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp), m1, <a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>, M1, N2, NULL, U);
<a name="line426">426: </a>    <a href="../../../../../docs/manualpages/Mat/MatDenseGetArrayWrite.html#MatDenseGetArrayWrite">MatDenseGetArrayWrite</a>(*U, &amp;copy);
<a name="line427">427: </a>    <a href="../../../../../docs/manualpages/Sys/PetscArraycpy.html#PetscArraycpy">PetscArraycpy</a>(copy, array, m1 * N2);
<a name="line428">428: </a>    <a href="../../../../../docs/manualpages/Mat/MatDenseRestoreArrayWrite.html#MatDenseRestoreArrayWrite">MatDenseRestoreArrayWrite</a>(*U, &amp;copy);
<a name="line429">429: </a>  }
<a name="line430">430: </a>  <font color="#4169E1">return</font>(0);
<a name="line431">431: </a>}

<a name="line433">433: </a><strong><font color="#4169E1"><a name="KSPMatSolve_HPDDM"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> KSPMatSolve_HPDDM(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp, <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> B, <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a> X)</font></strong>
<a name="line434">434: </a>{
<a name="line435">435: </a>  KSP_HPDDM            *data = (KSP_HPDDM*)ksp-&gt;data;
<a name="line436">436: </a><strong><font color="#FF0000">  HPDDM:</font></strong>:PETScOperator *op = data-&gt;op;
<a name="line437">437: </a>  <a href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</a>                  A;
<a name="line438">438: </a>  const <a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>    *b;
<a name="line439">439: </a>  <a href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a>          *x;
<a name="line440">440: </a>  <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>             n, lda;
<a name="line441">441: </a>  <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a>       ierr;

<a name="line444">444: </a>  <font color="#4169E1">if</font> (!op) {
<a name="line445">445: </a>    <a href="../../../../../docs/manualpages/KSP/KSPSetUp.html#KSPSetUp">KSPSetUp</a>(ksp);
<a name="line446">446: </a>    op = data-&gt;op;
<a name="line447">447: </a>  }
<a name="line448">448: </a>  <a href="../../../../../docs/manualpages/KSP/KSPGetOperators.html#KSPGetOperators">KSPGetOperators</a>(ksp, &amp;A, NULL);
<a name="line449">449: </a>  <a href="../../../../../docs/manualpages/Mat/MatGetLocalSize.html#MatGetLocalSize">MatGetLocalSize</a>(B, &amp;n, NULL);
<a name="line450">450: </a>  <a href="../../../../../docs/manualpages/Mat/MatDenseGetLDA.html#MatDenseGetLDA">MatDenseGetLDA</a>(B, &amp;lda);
<a name="line451">451: </a>  <font color="#4169E1">if</font> (n != lda) <a href="../../../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_ARG_SIZ, <font color="#666666">"Unhandled leading dimension lda = %D with n = %D"</font>, lda, n);
<a name="line452">452: </a>  <a href="../../../../../docs/manualpages/Mat/MatGetLocalSize.html#MatGetLocalSize">MatGetLocalSize</a>(A, &amp;n, NULL);
<a name="line453">453: </a>  <a href="../../../../../docs/manualpages/Mat/MatDenseGetLDA.html#MatDenseGetLDA">MatDenseGetLDA</a>(X, &amp;lda);
<a name="line454">454: </a>  <font color="#4169E1">if</font> (n != lda) <a href="../../../../../docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>(<a href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_ARG_SIZ, <font color="#666666">"Unhandled leading dimension lda = %D with n = %D"</font>, lda, n);
<a name="line455">455: </a>  <a href="../../../../../docs/manualpages/Mat/MatDenseGetArrayRead.html#MatDenseGetArrayRead">MatDenseGetArrayRead</a>(B, &amp;b);
<a name="line456">456: </a>  <a href="../../../../../docs/manualpages/Mat/MatDenseGetArrayWrite.html#MatDenseGetArrayWrite">MatDenseGetArrayWrite</a>(X, &amp;x);
<a name="line457">457: </a>  <a href="../../../../../docs/manualpages/Mat/MatGetSize.html#MatGetSize">MatGetSize</a>(X, NULL, &amp;n);
<a name="line458">458: </a>  KSPSolve_HPDDM_Private(ksp, b, x, n);
<a name="line459">459: </a>  <a href="../../../../../docs/manualpages/Mat/MatDenseRestoreArrayWrite.html#MatDenseRestoreArrayWrite">MatDenseRestoreArrayWrite</a>(X, &amp;x);
<a name="line460">460: </a>  <a href="../../../../../docs/manualpages/Mat/MatDenseRestoreArrayRead.html#MatDenseRestoreArrayRead">MatDenseRestoreArrayRead</a>(B, &amp;b);
<a name="line461">461: </a>  <font color="#4169E1">return</font>(0);
<a name="line462">462: </a>}

<a name="line464">464: </a><strong><font color="#4169E1"><a name="KSPSetMatSolveBlockSize_HPDDM"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> KSPSetMatSolveBlockSize_HPDDM(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp, <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> bs)</font></strong>
<a name="line465">465: </a>{
<a name="line466">466: </a>  KSP_HPDDM *data = (KSP_HPDDM*)ksp-&gt;data;

<a name="line469">469: </a>  <font color="#4169E1">if</font> (bs &gt; std::numeric_limits&lt;int&gt;::max() || bs &lt; std::numeric_limits&lt;int&gt;::min()) <a href="../../../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp), PETSC_ERR_ARG_OUTOFRANGE, <font color="#666666">"<a href="../../../../../docs/manualpages/KSP/KSPMatSolve.html#KSPMatSolve">KSPMatSolve</a>() block size %D not representable by an integer"</font>, bs);
<a name="line470">470: </a>  <font color="#4169E1">else</font> data-&gt;icntl[1] = static_cast&lt;int&gt;(bs);
<a name="line471">471: </a>  <font color="#4169E1">return</font>(0);
<a name="line472">472: </a>}

<a name="line474">474: </a><strong><font color="#4169E1"><a name="KSPGetMatSolveBlockSize_HPDDM"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> KSPGetMatSolveBlockSize_HPDDM(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp, <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a> *bs)</font></strong>
<a name="line475">475: </a>{
<a name="line476">476: </a>  KSP_HPDDM *data = (KSP_HPDDM*)ksp-&gt;data;

<a name="line479">479: </a>  *bs = static_cast&lt;<a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>&gt;(data-&gt;icntl[1]);
<a name="line480">480: </a>  <font color="#4169E1">return</font>(0);
<a name="line481">481: </a>}

<a name="line483">483: </a><font color="#B22222">/*@</font>
<a name="line484">484: </a><font color="#B22222">     <a href="../../../../../docs/manualpages/KSP/KSPHPDDMSetType.html#KSPHPDDMSetType">KSPHPDDMSetType</a> - Sets the type of Krylov method used in <a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a>.</font>

<a name="line486">486: </a><font color="#B22222">   Input Parameters:</font>
<a name="line487">487: </a><font color="#B22222">+     ksp - iterative context</font>
<a name="line488">488: </a><font color="#B22222">-     type - any of gmres, bgmres, cg, bcg, gcrodr, bgcrodr, bfbcg, or preonly</font>

<a name="line490">490: </a><font color="#B22222">   Level: intermediate</font>

<a name="line492">492: </a><font color="#B22222">   Notes:</font>
<a name="line493">493: </a><font color="#B22222">     Unlike <a href="../../../../../docs/manualpages/KSP/KSPReset.html#KSPReset">KSPReset</a>(), this function does not destroy any deflation space attached to the <a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a>.</font>
<a name="line494">494: </a><font color="#B22222">     As an example, in the following sequence: <a href="../../../../../docs/manualpages/KSP/KSPHPDDMSetType.html#KSPHPDDMSetType">KSPHPDDMSetType</a>(ksp, KSPGCRODR); <a href="../../../../../docs/manualpages/KSP/KSPSolve.html#KSPSolve">KSPSolve</a>(ksp, b, x); <a href="../../../../../docs/manualpages/KSP/KSPHPDDMSetType.html#KSPHPDDMSetType">KSPHPDDMSetType</a>(ksp, <a href="../../../../../docs/manualpages/KSP/KSPGMRES.html#KSPGMRES">KSPGMRES</a>); <a href="../../../../../docs/manualpages/KSP/KSPHPDDMSetType.html#KSPHPDDMSetType">KSPHPDDMSetType</a>(ksp, KSPGCRODR); <a href="../../../../../docs/manualpages/KSP/KSPSolve.html#KSPSolve">KSPSolve</a>(ksp, b, x); the recycled space is reused in the second <a href="../../../../../docs/manualpages/KSP/KSPSolve.html#KSPSolve">KSPSolve</a>().</font>

<a name="line496">496: </a><font color="#B22222">.seealso:  <a href="../../../../../docs/manualpages/KSP/KSPCreate.html#KSPCreate">KSPCreate</a>(), <a href="../../../../../docs/manualpages/KSP/KSPType.html#KSPType">KSPType</a> (for list of available types), <a href="../../../../../docs/manualpages/KSP/KSPHPDDMType.html#KSPHPDDMType">KSPHPDDMType</a>, <a href="../../../../../docs/manualpages/KSP/KSPHPDDMGetType.html#KSPHPDDMGetType">KSPHPDDMGetType</a>()</font>
<a name="line497">497: </a><font color="#B22222">@*/</font>
<a name="line498">498: </a><strong><font color="#4169E1"><a name="KSPHPDDMSetType"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/KSP/KSPHPDDMSetType.html#KSPHPDDMSetType">KSPHPDDMSetType</a>(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp, <a href="../../../../../docs/manualpages/KSP/KSPHPDDMType.html#KSPHPDDMType">KSPHPDDMType</a> type)</font></strong>
<a name="line499">499: </a>{

<a name="line504">504: </a>  PetscUseMethod(ksp, <font color="#666666">"KSPHPDDMSetType_C"</font>, (<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a>, <a href="../../../../../docs/manualpages/KSP/KSPHPDDMType.html#KSPHPDDMType">KSPHPDDMType</a>), (ksp, type));
<a name="line505">505: </a>  <font color="#4169E1">return</font>(0);
<a name="line506">506: </a>}

<a name="line508">508: </a><font color="#B22222">/*@</font>
<a name="line509">509: </a><font color="#B22222">     <a href="../../../../../docs/manualpages/KSP/KSPHPDDMGetType.html#KSPHPDDMGetType">KSPHPDDMGetType</a> - Gets the type of Krylov method used in <a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a>.</font>

<a name="line511">511: </a><font color="#B22222">   Input Parameter:</font>
<a name="line512">512: </a><font color="#B22222">.     ksp - iterative context</font>

<a name="line514">514: </a><font color="#B22222">   Output Parameter:</font>
<a name="line515">515: </a><font color="#B22222">.     type - any of gmres, bgmres, cg, bcg, gcrodr, bgcrodr, bfbcg, or preonly</font>

<a name="line517">517: </a><font color="#B22222">   Level: intermediate</font>

<a name="line519">519: </a><font color="#B22222">.seealso:  <a href="../../../../../docs/manualpages/KSP/KSPCreate.html#KSPCreate">KSPCreate</a>(), <a href="../../../../../docs/manualpages/KSP/KSPType.html#KSPType">KSPType</a> (for list of available types), <a href="../../../../../docs/manualpages/KSP/KSPHPDDMType.html#KSPHPDDMType">KSPHPDDMType</a>, <a href="../../../../../docs/manualpages/KSP/KSPHPDDMSetType.html#KSPHPDDMSetType">KSPHPDDMSetType</a>()</font>
<a name="line520">520: </a><font color="#B22222">@*/</font>
<a name="line521">521: </a><strong><font color="#4169E1"><a name="KSPHPDDMGetType"></a><a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> <a href="../../../../../docs/manualpages/KSP/KSPHPDDMGetType.html#KSPHPDDMGetType">KSPHPDDMGetType</a>(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp, <a href="../../../../../docs/manualpages/KSP/KSPHPDDMType.html#KSPHPDDMType">KSPHPDDMType</a> *type)</font></strong>
<a name="line522">522: </a>{

<a name="line528">528: </a>  PetscUseMethod(ksp, <font color="#666666">"KSPHPDDMGetType_C"</font>, (<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a>, <a href="../../../../../docs/manualpages/KSP/KSPHPDDMType.html#KSPHPDDMType">KSPHPDDMType</a>*), (ksp, type));
<a name="line529">529: </a>  <font color="#4169E1">return</font>(0);
<a name="line530">530: </a>}

<a name="line532">532: </a><strong><font color="#4169E1"><a name="KSPHPDDMSetType_HPDDM"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> KSPHPDDMSetType_HPDDM(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp, <a href="../../../../../docs/manualpages/KSP/KSPHPDDMType.html#KSPHPDDMType">KSPHPDDMType</a> type)</font></strong>
<a name="line533">533: </a>{
<a name="line534">534: </a>  KSP_HPDDM      *data = (KSP_HPDDM*)ksp-&gt;data;
<a name="line535">535: </a>  <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       i;
<a name="line536">536: </a>  <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>      flg = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;

<a name="line540">540: </a>  <font color="#4169E1">for</font> (i = 0; i &lt; static_cast&lt;<a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>&gt;(ALEN(KSPHPDDMTypes)); ++i) {
<a name="line541">541: </a>    <a href="../../../../../docs/manualpages/Sys/PetscStrcmp.html#PetscStrcmp">PetscStrcmp</a>(KSPHPDDMTypes[type], KSPHPDDMTypes[i], &amp;flg);
<a name="line542">542: </a>    <font color="#4169E1">if</font> (flg) <font color="#4169E1">break</font>;
<a name="line543">543: </a>  }
<a name="line544">544: </a>  <font color="#4169E1">if</font> (i == ALEN(KSPHPDDMTypes)) <a href="../../../../../docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>(<a href="../../../../../docs/manualpages/Sys/PetscObjectComm.html#PetscObjectComm">PetscObjectComm</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp), PETSC_ERR_ARG_UNKNOWN_TYPE, <font color="#666666">"Unknown <a href="../../../../../docs/manualpages/KSP/KSPHPDDMType.html#KSPHPDDMType">KSPHPDDMType</a> %s"</font>, type);
<a name="line545">545: </a>  <font color="#4169E1">if</font> (data-&gt;cntl[0] != static_cast&lt;char&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>) &amp;&amp; data-&gt;cntl[0] != i) {
<a name="line546">546: </a>    KSPHPDDMReset_Private(ksp);
<a name="line547">547: </a>  }
<a name="line548">548: </a>  data-&gt;cntl[0] = i;
<a name="line549">549: </a>  <font color="#4169E1">return</font>(0);
<a name="line550">550: </a>}

<a name="line552">552: </a><strong><font color="#4169E1"><a name="KSPHPDDMGetType_HPDDM"></a>static <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> KSPHPDDMGetType_HPDDM(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp, <a href="../../../../../docs/manualpages/KSP/KSPHPDDMType.html#KSPHPDDMType">KSPHPDDMType</a> *type)</font></strong>
<a name="line553">553: </a>{
<a name="line554">554: </a>  KSP_HPDDM *data = (KSP_HPDDM*)ksp-&gt;data;

<a name="line557">557: </a>  <font color="#4169E1">if</font> (data-&gt;cntl[0] == static_cast&lt;char&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>)) <a href="../../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(<a href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>, PETSC_ERR_ORDER, <font color="#666666">"<a href="../../../../../docs/manualpages/KSP/KSPHPDDMType.html#KSPHPDDMType">KSPHPDDMType</a> not set yet"</font>);
<a name="line558">558: </a>  <font color="#B22222">/* need to shift by -1 for HPDDM_KRYLOV_METHOD_NONE */</font>
<a name="line559">559: </a>  *type = static_cast&lt;<a href="../../../../../docs/manualpages/KSP/KSPHPDDMType.html#KSPHPDDMType">KSPHPDDMType</a>&gt;(<a href="../../../../../docs/manualpages/Sys/PetscMin.html#PetscMin">PetscMin</a>(data-&gt;cntl[0], static_cast&lt;char&gt;(ALEN(KSPHPDDMTypes) - 1)));
<a name="line560">560: </a>  <font color="#4169E1">return</font>(0);
<a name="line561">561: </a>}

<a name="line563">563: </a><font color="#B22222">/*MC</font>
<a name="line564">564: </a><font color="#B22222">     <a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a> - Interface with the HPDDM library.</font>

<a name="line566">566: </a><font color="#B22222">   This <a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> may be used to further select methods that are currently not implemented natively in PETSc, e.g., GCRODR [2006], a recycled Krylov method which is similar to <a href="../../../../../docs/manualpages/KSP/KSPLGMRES.html#KSPLGMRES">KSPLGMRES</a>, see [2016] for a comparison. ex75.c shows how to reproduce the results from the aforementioned paper [2006]. A chronological bibliography of relevant publications linked with <a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> available in HPDDM through <a href="../../../../../docs/manualpages/KSP/KSPHPDDM.html#KSPHPDDM">KSPHPDDM</a>, and not available directly in PETSc, may be found below.</font>

<a name="line568">568: </a><font color="#B22222">   Options Database Keys:</font>
<a name="line569">569: </a><font color="#B22222">+   -ksp_gmres_restart &lt;restart, default=30&gt; - see <a href="../../../../../docs/manualpages/KSP/KSPGMRES.html#KSPGMRES">KSPGMRES</a></font>
<a name="line570">570: </a><font color="#B22222">.   -ksp_hpddm_type &lt;type, default=gmres&gt; - any of gmres, bgmres, cg, bcg, gcrodr, bgcrodr, bfbcg, or preonly, see <a href="../../../../../docs/manualpages/KSP/KSPHPDDMType.html#KSPHPDDMType">KSPHPDDMType</a></font>
<a name="line571">571: </a><font color="#B22222">.   -ksp_hpddm_deflation_tol &lt;eps, default=\-1.0&gt; - tolerance when deflating right-hand sides inside block methods (no deflation by default, only relevant with block methods)</font>
<a name="line572">572: </a><font color="#B22222">.   -ksp_hpddm_enlarge_krylov_subspace &lt;p, default=1&gt; - split the initial right-hand side into multiple vectors (only relevant with nonblock methods)</font>
<a name="line573">573: </a><font color="#B22222">.   -ksp_hpddm_orthogonalization &lt;type, default=cgs&gt; - any of cgs or mgs, see <a href="../../../../../docs/manualpages/KSP/KSPGMRES.html#KSPGMRES">KSPGMRES</a></font>
<a name="line574">574: </a><font color="#B22222">.   -ksp_hpddm_qr &lt;type, default=cholqr&gt; - distributed QR factorizations with any of cholqr, cgs, or mgs (only relevant with block methods)</font>
<a name="line575">575: </a><font color="#B22222">.   -ksp_hpddm_variant &lt;type, default=left&gt; - any of left, right, or flexible (this option is superseded by <a href="../../../../../docs/manualpages/KSP/KSPSetPCSide.html#KSPSetPCSide">KSPSetPCSide</a>())</font>
<a name="line576">576: </a><font color="#B22222">.   -ksp_hpddm_recycle &lt;n, default=0&gt; - number of harmonic Ritz vectors to compute (only relevant with GCRODR or BGCRODR)</font>
<a name="line577">577: </a><font color="#B22222">.   -ksp_hpddm_recycle_target &lt;type, default=SM&gt; - criterion to select harmonic Ritz vectors using either SM, LM, SR, LR, SI, or LI (only relevant with GCRODR or BGCRODR). For BGCRODR, if PETSc is compiled with SLEPc, this option is not relevant, since SLEPc is used instead. Options are set with the prefix -ksp_hpddm_recycle_eps_</font>
<a name="line578">578: </a><font color="#B22222">.   -ksp_hpddm_recycle_strategy &lt;type, default=A&gt; - generalized eigenvalue problem A or B to solve for recycling (only relevant with flexible GCRODR or BGCRODR)</font>
<a name="line579">579: </a><font color="#B22222">-   -ksp_hpddm_recycle_symmetric &lt;true, default=false&gt; - symmetric generalized eigenproblems in BGCRODR, useful to switch to distributed solvers like EPSELEMENTAL (only relevant when PETSc is compiled with SLEPc)</font>

<a name="line581">581: </a><font color="#B22222">   References:</font>
<a name="line582">582: </a><font color="#B22222">+   1980 - The Block Conjugate Gradient Algorithm and Related Methods. O'Leary. Linear Algebra and its Applications.</font>
<a name="line583">583: </a><font color="#B22222">.   2006 - Recycling Krylov Subspaces for Sequences of Linear Systems. Parks, de Sturler, Mackey, Johnson, and Maiti. SIAM Journal on Scientific Computing</font>
<a name="line584">584: </a><font color="#B22222">.   2013 - A Modified Block Flexible GMRES Method with Deflation at Each Iteration for the Solution of Non-Hermitian Linear Systems with Multiple Right-Hand Sides. Calandra, Gratton, Lago, Vasseur, and Carvalho. SIAM Journal on Scientific Computing.</font>
<a name="line585">585: </a><font color="#B22222">.   2016 - Block Iterative Methods and Recycling for Improved Scalability of Linear Solvers. Jolivet and Tournier. SC16.</font>
<a name="line586">586: </a><font color="#B22222">-   2017 - A breakdown-free block conjugate gradient method. Ji and Li. BIT Numerical Mathematics.</font>

<a name="line588">588: </a><font color="#B22222">   Level: intermediate</font>

<a name="line590">590: </a><font color="#B22222">.seealso:  <a href="../../../../../docs/manualpages/KSP/KSPCreate.html#KSPCreate">KSPCreate</a>(), <a href="../../../../../docs/manualpages/KSP/KSPSetType.html#KSPSetType">KSPSetType</a>(), <a href="../../../../../docs/manualpages/KSP/KSPType.html#KSPType">KSPType</a> (for list of available types), <a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a>, <a href="../../../../../docs/manualpages/KSP/KSPGMRES.html#KSPGMRES">KSPGMRES</a>, <a href="../../../../../docs/manualpages/KSP/KSPCG.html#KSPCG">KSPCG</a>, <a href="../../../../../docs/manualpages/KSP/KSPLGMRES.html#KSPLGMRES">KSPLGMRES</a>, <a href="../../../../../docs/manualpages/KSP/KSPDGMRES.html#KSPDGMRES">KSPDGMRES</a></font>
<a name="line591">591: </a><font color="#B22222">M*/</font>
<a name="line592">592: </a><strong><font color="#4169E1"><a name="KSPCreate_HPDDM"></a>PETSC_EXTERN <a href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> KSPCreate_HPDDM(<a href="../../../../../docs/manualpages/KSP/KSP.html#KSP">KSP</a> ksp)</font></strong>
<a name="line593">593: </a>{
<a name="line594">594: </a>  KSP_HPDDM      *data;
<a name="line595">595: </a>  <a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>       i;
<a name="line596">596: </a>  const char     *common[] = { <a href="../../../../../docs/manualpages/KSP/KSPGMRES.html#KSPGMRES">KSPGMRES</a>, <a href="../../../../../docs/manualpages/KSP/KSPCG.html#KSPCG">KSPCG</a>, <a href="../../../../../docs/manualpages/KSP/KSPPREONLY.html#KSPPREONLY">KSPPREONLY</a> };
<a name="line597">597: </a>  <a href="../../../../../docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a>      flg = <a href="../../../../../docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>;

<a name="line601">601: </a>  <a href="../../../../../docs/manualpages/Sys/PetscNewLog.html#PetscNewLog">PetscNewLog</a>(ksp, &amp;data);
<a name="line602">602: </a>  ksp-&gt;data = (void*)data;
<a name="line603">603: </a>  <a href="../../../../../docs/manualpages/KSP/KSPSetSupportedNorm.html#KSPSetSupportedNorm">KSPSetSupportedNorm</a>(ksp, <a href="../../../../../docs/manualpages/KSP/KSP_NORM_PRECONDITIONED.html#KSP_NORM_PRECONDITIONED">KSP_NORM_PRECONDITIONED</a>, <a href="../../../../../docs/manualpages/PC/PCSide.html#PCSide">PC_LEFT</a>, 2);
<a name="line604">604: </a>  <a href="../../../../../docs/manualpages/KSP/KSPSetSupportedNorm.html#KSPSetSupportedNorm">KSPSetSupportedNorm</a>(ksp, <a href="../../../../../docs/manualpages/KSP/KSP_NORM_UNPRECONDITIONED.html#KSP_NORM_UNPRECONDITIONED">KSP_NORM_UNPRECONDITIONED</a>, <a href="../../../../../docs/manualpages/PC/PCSide.html#PCSide">PC_RIGHT</a>, 1);
<a name="line605">605: </a>  ksp-&gt;ops-&gt;solve          = KSPSolve_HPDDM;
<a name="line606">606: </a>  ksp-&gt;ops-&gt;matsolve       = KSPMatSolve_HPDDM;
<a name="line607">607: </a>  ksp-&gt;ops-&gt;setup          = KSPSetUp_HPDDM;
<a name="line608">608: </a>  ksp-&gt;ops-&gt;setfromoptions = KSPSetFromOptions_HPDDM;
<a name="line609">609: </a>  ksp-&gt;ops-&gt;destroy        = KSPDestroy_HPDDM;
<a name="line610">610: </a>  ksp-&gt;ops-&gt;view           = KSPView_HPDDM;
<a name="line611">611: </a>  ksp-&gt;ops-&gt;reset          = KSPReset_HPDDM;
<a name="line612">612: </a>  KSPHPDDMReset_Private(ksp);
<a name="line613">613: </a>  <font color="#4169E1">for</font> (i = 0; i &lt; static_cast&lt;<a href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a>&gt;(ALEN(common)); ++i) {
<a name="line614">614: </a>    <a href="../../../../../docs/manualpages/Sys/PetscStrcmp.html#PetscStrcmp">PetscStrcmp</a>(((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp)-&gt;type_name, common[i], &amp;flg);
<a name="line615">615: </a>    <font color="#4169E1">if</font> (flg) <font color="#4169E1">break</font>;
<a name="line616">616: </a>  }
<a name="line617">617: </a>  <font color="#4169E1">if</font> (!i) data-&gt;cntl[0] = HPDDM_KRYLOV_METHOD_GMRES;
<a name="line618">618: </a>  <font color="#4169E1">else</font> <font color="#4169E1">if</font> (i == 1) data-&gt;cntl[0] = HPDDM_KRYLOV_METHOD_CG;
<a name="line619">619: </a>  <font color="#4169E1">else</font> <font color="#4169E1">if</font> (i == 2) data-&gt;cntl[0] = HPDDM_KRYLOV_METHOD_NONE;
<a name="line620">620: </a>  <font color="#4169E1">if</font> (data-&gt;cntl[0] != static_cast&lt;char&gt;(<a href="../../../../../docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a>)) {
<a name="line621">621: </a>    PetscInfo1(ksp, <font color="#666666">"Using the previously set <a href="../../../../../docs/manualpages/KSP/KSPType.html#KSPType">KSPType</a> %s\n"</font>, common[i]);
<a name="line622">622: </a>  }
<a name="line623">623: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp, <font color="#666666">"KSPHPDDMSetDeflationSpace_C"</font>, KSPHPDDMSetDeflationSpace_HPDDM);
<a name="line624">624: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp, <font color="#666666">"KSPHPDDMGetDeflationSpace_C"</font>, KSPHPDDMGetDeflationSpace_HPDDM);
<a name="line625">625: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp, <font color="#666666">"KSPSetMatSolveBlockSize_C"</font>, KSPSetMatSolveBlockSize_HPDDM);
<a name="line626">626: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp, <font color="#666666">"KSPGetMatSolveBlockSize_C"</font>, KSPGetMatSolveBlockSize_HPDDM);
<a name="line627">627: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp, <font color="#666666">"KSPHPDDMSetType_C"</font>, KSPHPDDMSetType_HPDDM);
<a name="line628">628: </a>  <a href="../../../../../docs/manualpages/Sys/PetscObjectComposeFunction.html#PetscObjectComposeFunction">PetscObjectComposeFunction</a>((<a href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a>)ksp, <font color="#666666">"KSPHPDDMGetType_C"</font>, KSPHPDDMGetType_HPDDM);
<a name="line629">629: </a><font color="#A020F0">#if defined(PETSC_HAVE_SLEPC) &amp;&amp; defined(PETSC_USE_SHARED_LIBRARIES)</font>
<a name="line630">630: </a>  <font color="#4169E1">if</font> (!loadedDL) {
<a name="line631">631: </a>    HPDDMLoadDL_Private(&amp;loadedDL);
<a name="line632">632: </a>  }
<a name="line633">633: </a><font color="#A020F0">#endif</font>
<a name="line634">634: </a>  <font color="#4169E1">return</font>(0);
<a name="line635">635: </a>}
</pre>
</body>

</html>
