
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head> <link rel="canonical" href="http://www.mcs.anl.gov/petsc/petsc-current/docs/sphinx_docs/html/developers/kernel.html" />
    <meta charset="utf-8" />
    <title>The PETSc Kernel &#8212; PETSc 3.14.6 documentation</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/katex-math.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"></script>
    <script src="../_static/katex_autorenderer.js"></script>
    <link rel="shortcut icon" href="../_static/PETSc_RGB-logo.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Basic Object Design and Implementation" href="objects.html" />
    <link rel="prev" title="The Design of PETSc" href="design.html" /> 
  </head><body>
   <div id="version" align=right><b>petsc-3.14.6 2021-03-30</b></div>
   <div id="bugreport" align=right><a href="mailto:petsc-maint@mcs.anl.gov?subject=Typo or Error in Documentation &body=Please describe the typo or error in the documentation: petsc-3.14.6 v3.14.6 docs/sphinx_docs/html/developers/kernel.html "><small>Report Typos and Errors</small></a></div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="objects.html" title="Basic Object Design and Implementation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="design.html" title="The Design of PETSc"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">PETSc 3.14.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >PETSc Developer’s Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="design.html" accesskey="U">The Design of PETSc</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/PETSc-TAO_RGB.svg" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The PETSc Kernel</a><ul>
<li><a class="reference internal" href="#petsc-types">PETSc Types</a></li>
<li><a class="reference internal" href="#implementation-of-error-handling">Implementation of Error Handling</a><ul>
<li><a class="reference internal" href="#simplified-interface">Simplified Interface</a></li>
<li><a class="reference internal" href="#error-handlers">Error Handlers</a></li>
<li><a class="reference internal" href="#error-codes">Error Codes</a></li>
<li><a class="reference internal" href="#detailed-error-messages">Detailed Error Messages</a></li>
</ul>
</li>
<li><a class="reference internal" href="#memory-management">Memory Management</a></li>
<li><a class="reference internal" href="#implementation-of-profiling">Implementation of Profiling</a><ul>
<li><a class="reference internal" href="#profiling-object-creation-and-destruction">Profiling Object Creation and Destruction</a></li>
<li><a class="reference internal" href="#profiling-events">Profiling Events</a></li>
<li><a class="reference internal" href="#controlling-profiling">Controlling Profiling</a></li>
</ul>
</li>
<li><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="design.html"
                        title="previous chapter">The Design of PETSc</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="objects.html"
                        title="next chapter">Basic Object Design and Implementation</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/developers/kernel.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-petsc-kernel">
<h1>The PETSc Kernel<a class="headerlink" href="#the-petsc-kernel" title="Permalink to this headline">¶</a></h1>
<p>PETSc provides a variety of basic services for writing scalable,
component-based libraries; these are referred to as the PETSc kernel <span id="id1">[<a class="reference internal" href="#id1924">BGMS98</a>]</span>.
The source code for the kernel is in <code class="docutils literal notranslate"><span class="pre">src/sys</span></code>. It contains systematic
support for</p>
<ul class="simple">
<li><p>managing PETSc types,</p></li>
<li><p>error handling,</p></li>
<li><p>memory management,</p></li>
<li><p>profiling,</p></li>
<li><p>object management,</p></li>
<li><p>Fortran interfaces (see <span id="id2">[<a class="reference internal" href="#id2059">BBK+15</a>]</span>)</p></li>
<li><p>mechanism for generating appropriate citations for algorithms and software used in PETSc (see <span id="id3">[<a class="reference internal" href="#id2061">KBMS13</a>]</span>)</p></li>
<li><p>file I/O,</p></li>
<li><p>an options database, and</p></li>
<li><p>objects and code for viewing, drawing, and displaying data and solver objects.</p></li>
</ul>
<p>Each of these is discussed in a section below.</p>
<div class="section" id="petsc-types">
<h2>PETSc Types<a class="headerlink" href="#petsc-types" title="Permalink to this headline">¶</a></h2>
<p>For maximum flexibility, the basic data types <code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">double</span></code>, and
so on are not used in PETSc source code. Rather, it has</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a></span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscMPIInt.html#PetscMPIInt">PetscMPIInt</a></span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscBLASInt.html#PetscBLASInt">PetscBLASInt</a></span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a></span></code>, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscBT.html#PetscBT">PetscBT</a></span></code> - bit storage of logical true and false.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span></code> can be set using <code class="docutils literal notranslate"><span class="pre">./configure</span></code> to be either <code class="docutils literal notranslate"><span class="pre">int</span></code> (32
bit, the default) or <code class="docutils literal notranslate"><span class="pre">long</span> <span class="pre">long</span></code> (64 bit, with
<code class="docutils literal notranslate"><span class="pre">configure</span> <span class="pre">–with-64-bit-indices</span></code>) to allow indexing into very large
arrays. <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscMPIInt.html#PetscMPIInt">PetscMPIInt</a></span></code> is used for integers passed to MPI as counts and
sizes. These are always <code class="docutils literal notranslate"><span class="pre">int</span></code> since that is what the MPI standard
uses. Similarly, <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscBLASInt.html#PetscBLASInt">PetscBLASInt</a></span></code> is for counts, and so on passed to
BLAS and LAPACK routines. These are almost always <code class="docutils literal notranslate"><span class="pre">int</span></code> unless one is
using a special “64-bit integer” BLAS/LAPACK (this is available, for
example, with Intel’s MKL and OpenBLAS).</p>
<p>In addition, there are special types:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscClassId.html#PetscClassId">PetscClassId</a></span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a></span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Profiling/PetscLogEvent.html#PetscLogEvent">PetscLogEvent</a></span></code></p></li>
</ul>
<p>These are currently always <code class="docutils literal notranslate"><span class="pre">int</span></code>, but their use clarifies the code.</p>
</div>
<div class="section" id="implementation-of-error-handling">
<h2>Implementation of Error Handling<a class="headerlink" href="#implementation-of-error-handling" title="Permalink to this headline">¶</a></h2>
<p>PETSc uses a “call error handler; then (depending on result) return
error code” model when problems are detected in the running code. The
public include file for error handling is
<a class="reference external" href="https://www.mcs.anl.gov/petsc/petsc-master/include/petscerror.h.html">include/petscerror.h</a>,
and the source code for the PETSc error handling is in
<code class="docutils literal notranslate"><span class="pre">src/sys/error/</span></code>.</p>
<div class="section" id="simplified-interface">
<h3>Simplified Interface<a class="headerlink" href="#simplified-interface" title="Permalink to this headline">¶</a></h3>
<p>The simplified macro-based interface consists of the following two
calls:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(comm,error</span> <span class="pre">code,Error</span> <span class="pre">message);</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/CHKERRQ.html#CHKERRQ">CHKERRQ</a>(ierr);</span></code></p></li>
</ul>
<p>The macro <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>()</span></code> is given by</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define <a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>(comm,ierr,s) return <a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscError.html#PetscError">PetscError</a>(comm,__LINE__,PETSC_FUNCTION_NAME,__FILE__,ierr,<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscErrorType.html#PetscErrorType">PETSC_ERROR_INITIAL</a>,s)</span>
</pre></div>
</div>
<p>It calls the error handler with the current function name and location:
line number, and file, plus an error code and an error message. Normally
<code class="docutils literal notranslate"><span class="pre">comm</span></code> is <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a></span></code>; it can be another communicator only if
one is absolutely sure the same error will be generated on all processes
in the communicator. This feature is to prevent the same error message
from being printed by many processes.</p>
<p>The macro <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/CHKERRQ.html#CHKERRQ">CHKERRQ</a>()</span></code> is defined by</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define <a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/CHKERRQ.html#CHKERRQ">CHKERRQ</a>(ierr)          do {<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a> ierr__ = (ierr); if (<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscUnlikely.html#PetscUnlikely">PetscUnlikely</a>(ierr__)) return <a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscError.html#PetscError">PetscError</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a>,__LINE__,PETSC_FUNCTION_NAME,__FILE__,ierr__,<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscErrorType.html#PetscErrorType">PETSC_ERROR_REPEAT</a>,&quot; &quot;);} while (0)</span>
</pre></div>
</div>
<p>In addition to <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</a>()</span></code>, the macros <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a>()</span></code>, <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a>()</span></code>,
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/SETERRQ3.html#SETERRQ3">SETERRQ3</a>()</span></code>, and <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/SETERRQ4.html#SETERRQ4">SETERRQ4</a>()</span></code> allow one to provide additional
arguments to a formatted message string, for example,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/SETERRQ2.html#SETERRQ2">SETERRQ2</a></span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="n">PETSC_ERR</span><span class="p">,</span><span class="s">&quot;Iteration overflow: its %D norm %g&quot;</span><span class="p">,</span><span class="n">its</span><span class="p">,(</span><span class="kt">double</span><span class="p">)</span><span class="n">norm</span><span class="p">);</span>
</pre></div>
</div>
<p>The reason for the numbered format is that C89 CPP macros cannot handle
a variable number of arguments.</p>
</div>
<div class="section" id="error-handlers">
<h3>Error Handlers<a class="headerlink" href="#error-handlers" title="Permalink to this headline">¶</a></h3>
<p>The error-handling function <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscError.html#PetscError">PetscError</a>()</span></code> calls the “current” error
handler with the code</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a></span> <span class="nf"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscError.html#PetscError">PetscError</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</a></span> <span class="n">comm</span><span class="p">,</span><span class="kt">int</span> <span class="n">line</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a></span> <span class="n">n</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscErrorType.html#PetscErrorType">PetscErrorType</a></span> <span class="n">p</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mess</span><span class="p">,...)</span>
<span class="p">{</span>
  <span class="kt">va_list</span>        <span class="n">Argp</span><span class="p">;</span>
  <span class="kt">size_t</span>         <span class="n">fullLength</span><span class="p">;</span>
  <span class="kt">char</span>           <span class="n">buf</span><span class="p">[</span><span class="mi">2048</span><span class="p">],</span><span class="o">*</span><span class="n">lbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a></span>      <span class="n">ismain</span><span class="p">;</span>
  <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a></span> <span class="n">ierr</span><span class="p">;</span>

  <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscFunctionBegin.html#PetscFunctionBegin">PetscFunctionBegin</a></span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">func</span><span class="p">)</span> <span class="n">func</span> <span class="o">=</span> <span class="s">&quot;User provided function&quot;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span> <span class="n">file</span> <span class="o">=</span> <span class="s">&quot;User file&quot;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">comm</span> <span class="o">==</span> <span class="n">MPI_COMM_NULL</span><span class="p">)</span> <span class="n">comm</span> <span class="o">=</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a></span><span class="p">;</span>

  <span class="cm">/* Compose the message evaluating the print format */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">mess</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">va_start</span><span class="p">(</span><span class="n">Argp</span><span class="p">,</span><span class="n">mess</span><span class="p">);</span>
    <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscVSNPrintf.html#PetscVSNPrintf">PetscVSNPrintf</a></span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mi">2048</span><span class="p">,</span><span class="n">mess</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fullLength</span><span class="p">,</span><span class="n">Argp</span><span class="p">);</span>
    <span class="n">va_end</span><span class="p">(</span><span class="n">Argp</span><span class="p">);</span>
    <span class="n">lbuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscErrorType.html#PetscErrorType">PETSC_ERROR_INITIAL</a></span><span class="p">)</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscStrncpy.html#PetscStrncpy">PetscStrncpy</a></span><span class="p">(</span><span class="n">PetscErrorBaseMessage</span><span class="p">,</span><span class="n">lbuf</span><span class="p">,</span><span class="mi">1023</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscErrorType.html#PetscErrorType">PETSC_ERROR_INITIAL</a></span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">!=</span> <span class="n">PETSC_ERR_MEMC</span><span class="p">)</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscMallocValidate.html#PetscMallocValidate">PetscMallocValidate</a></span><span class="p">(</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">PETSC_FUNCTION_NAME</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eh</span><span class="p">)</span> <span class="n">ierr</span> <span class="o">=</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscTraceBackErrorHandler.html#PetscTraceBackErrorHandler">PetscTraceBackErrorHandler</a></span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="n">func</span><span class="p">,</span><span class="n">file</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">lbuf</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
  <span class="k">else</span>     <span class="n">ierr</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)(</span><span class="n">comm</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="n">func</span><span class="p">,</span><span class="n">file</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">lbuf</span><span class="p">,</span><span class="n">eh</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">      If this is called from the main() routine we call <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Abort.html#MPI_Abort">MPI_Abort</a>() instead of</span>
<span class="cm">    return to allow the parallel program to be properly shutdown.</span>

<span class="cm">    Does not call <a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSCABORT.html#PETSCABORT">PETSCABORT</a>() since that would provide the wrong source file and line number information</span>
<span class="cm">  */</span>
  <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscStrncmp.html#PetscStrncmp">PetscStrncmp</a></span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="s">&quot;main&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ismain</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ismain</span><span class="p">)</span> <span class="p">{</span>
    <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscMPIInt.html#PetscMPIInt">PetscMPIInt</a></span> <span class="n">errcode</span><span class="p">;</span>
    <span class="n">errcode</span> <span class="o">=</span> <span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscMPIInt.html#PetscMPIInt">PetscMPIInt</a></span><span class="p">)(</span><span class="mi">0</span> <span class="o">+</span> <span class="n">line</span><span class="o">*</span><span class="mi">1000</span> <span class="o">+</span> <span class="n">ierr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">petscwaitonerrorflg</span><span class="p">)</span> <span class="p">{</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscSleep.html#PetscSleep">PetscSleep</a></span><span class="p">(</span><span class="mi">1000</span><span class="p">);}</span>
    <span class="n"><a href="http://www.mpich.org/static/docs/latest/www3/MPI_Abort.html#MPI_Abort">MPI_Abort</a></span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="n">errcode</span><span class="p">);</span>
  <span class="p">}</span>

<span class="cp">#if defined(PETSC_CLANGUAGE_CXX)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscErrorType.html#PetscErrorType">PETSC_ERROR_IN_CXX</a></span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PetscCxxErrorThrow</span><span class="p">();</span>
  <span class="p">}</span>
<span class="cp">#endif</span>
  <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscFunctionReturn.html#PetscFunctionReturn">PetscFunctionReturn</a></span><span class="p">(</span><span class="n">ierr</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can set a new error handler with the command
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscPushErrorHandler.html#PetscPushErrorHandler">PetscPushErrorHandler</a>()</span></code>, which maintains a linked list of error
handlers. The most recent error handler is removed via
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscPopErrorHandler.html#PetscPopErrorHandler">PetscPopErrorHandler</a>()</span></code>.</p>
<p>PETSc provides several default error handlers:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscTraceBackErrorHandler.html#PetscTraceBackErrorHandler">PetscTraceBackErrorHandler</a>()</span></code>, the default;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscAbortErrorHandler.html#PetscAbortErrorHandler">PetscAbortErrorHandler</a>()</span></code>, called with <code class="docutils literal notranslate"><span class="pre">-onerrorabort</span></code>, useful when running in the debugger;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscReturnErrorHandler.html#PetscReturnErrorHandler">PetscReturnErrorHandler</a>()</span></code>, which returns up the stack without printing error messages;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscEmacsClientErrorHandler.html#PetscEmacsClientErrorHandler">PetscEmacsClientErrorHandler</a>()</span></code>;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscMPIAbortErrorHandler.html#PetscMPIAbortErrorHandler">PetscMPIAbortErrorHandler</a>()</span></code>, which calls <code class="docutils literal notranslate"><span class="pre">MPIAbort()</span></code> after printing the error message; and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscAttachDebuggerErrorHandler.html#PetscAttachDebuggerErrorHandler">PetscAttachDebuggerErrorHandler</a>()</span></code>, called with <code class="docutils literal notranslate"><span class="pre">-onerrorattachdebugger</span></code>.</p></li>
</ul>
</div>
<div class="section" id="error-codes">
<h3>Error Codes<a class="headerlink" href="#error-codes" title="Permalink to this headline">¶</a></h3>
<p>The PETSc error handler takes an error code. The generic error codes are
defined in
<a class="reference external" href="https://www.mcs.anl.gov/petsc/petsc-master/include/petscerror.h.html">include/petscerror.h</a>.
The same error code is used many times in the libraries. For example,
the error code <code class="docutils literal notranslate"><span class="pre">PETSCERRMEM</span></code> is used whenever a requested memory
allocation is not available.</p>
</div>
<div class="section" id="detailed-error-messages">
<h3>Detailed Error Messages<a class="headerlink" href="#detailed-error-messages" title="Permalink to this headline">¶</a></h3>
<p>In a modern parallel component-oriented application code, it does not
always make sense to simply print error messages to the terminal (and
more than likely there is no “terminal”, for example, with Microsoft
Windows or Apple iPad applications). PETSc provides the replaceable
function pointer</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscErrorPrintf.html#PetscErrorPrintf">PetscErrorPrintf</a></span><span class="p">)(</span><span class="s">&quot;Format&quot;</span><span class="p">,...);</span>
</pre></div>
</div>
<p>which, by default, prints to standard out. Thus, error messages should
not be printed with <code class="docutils literal notranslate"><span class="pre">printf()</span></code> or <code class="docutils literal notranslate"><span class="pre">fprintf()</span></code>. Rather, they should
be printed with <code class="docutils literal notranslate"><span class="pre">(*<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscErrorPrintf.html#PetscErrorPrintf">PetscErrorPrintf</a>)()</span></code>. You can direct all error
messages to <code class="docutils literal notranslate"><span class="pre">stderr</span></code>, instead of the default <code class="docutils literal notranslate"><span class="pre">stdout</span></code>, with the
command line option <code class="docutils literal notranslate"><span class="pre">-erroroutputstderr</span></code>.</p>
</div>
</div>
<div class="section" id="memory-management">
<h2>Memory Management<a class="headerlink" href="#memory-management" title="Permalink to this headline">¶</a></h2>
<p>PETSc provides simple wrappers for the system <code class="docutils literal notranslate"><span class="pre">malloc(),</span> <span class="pre">calloc()</span></code>,
and <code class="docutils literal notranslate"><span class="pre">free()</span></code> routines. The public interface for these is provided in
<code class="docutils literal notranslate"><span class="pre">petscsys.h</span></code>, while the implementation code is in <code class="docutils literal notranslate"><span class="pre">src/sys/memory</span></code>.
The most basic interfaces are</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define <a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</a>(a,b)  ((*PetscTrMalloc)((a),<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>,__LINE__,PETSC_FUNCTION_NAME,__FILE__,(void**)(b)))</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define <a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(a)   ((*PetscTrFree)((void*)(a),__LINE__,PETSC_FUNCTION_NAME,__FILE__) || ((a) = NULL,0))</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a></span> <span class="nf"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscMallocA.html#PetscMallocA">PetscMallocA</a></span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a></span> <span class="n">clear</span><span class="p">,</span><span class="kt">int</span> <span class="n">lineno</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">bytes0</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr0</span><span class="p">,...)</span>
<span class="p">{</span>
  <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a></span> <span class="n">ierr</span><span class="p">;</span>
  <span class="kt">va_list</span>        <span class="n">Argp</span><span class="p">;</span>
  <span class="kt">size_t</span>         <span class="n">bytes</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">sumbytes</span><span class="p">;</span>
  <span class="kt">void</span>           <span class="o">**</span><span class="n">ptr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
  <span class="kt">int</span>            <span class="n">i</span><span class="p">;</span>

  <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscFunctionBegin.html#PetscFunctionBegin">PetscFunctionBegin</a></span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="n">PETSC_ERR_ARG_OUTOFRANGE</span><span class="p">,</span><span class="s">&quot;Attempt to allocate %d objects but only 8 supported&quot;</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
  <span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bytes0</span><span class="p">;</span>
  <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="n">ptr0</span><span class="p">;</span>
  <span class="n">sumbytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">bytes0</span> <span class="o">+</span> <span class="n">PETSC_MEMALIGN</span><span class="mi">-1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PETSC_MEMALIGN</span><span class="mi">-1</span><span class="p">);</span>
  <span class="n">va_start</span><span class="p">(</span><span class="n">Argp</span><span class="p">,</span><span class="n">ptr0</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">Argp</span><span class="p">,</span><span class="kt">size_t</span><span class="p">);</span>
    <span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">Argp</span><span class="p">,</span><span class="kt">void</span><span class="o">**</span><span class="p">);</span>
    <span class="n">sumbytes</span> <span class="o">+=</span> <span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">PETSC_MEMALIGN</span><span class="mi">-1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PETSC_MEMALIGN</span><span class="mi">-1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">va_end</span><span class="p">(</span><span class="n">Argp</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">petscmalloccoalesce</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="n">ierr</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">PetscTrMalloc</span><span class="p">)(</span><span class="n">sumbytes</span><span class="p">,</span><span class="n">clear</span><span class="p">,</span><span class="n">lineno</span><span class="p">,</span><span class="n">function</span><span class="p">,</span><span class="n">filename</span><span class="p">,(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">);</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/CHKERRQ.html#CHKERRQ">CHKERRQ</a></span><span class="p">(</span><span class="n">ierr</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">*</span><span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="nl">p</span> <span class="p">:</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscAddrAlign.html#PetscAddrAlign">PetscAddrAlign</a></span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ierr</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">PetscTrMalloc</span><span class="p">)(</span><span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">clear</span><span class="p">,</span><span class="n">lineno</span><span class="p">,</span><span class="n">function</span><span class="p">,</span><span class="n">filename</span><span class="p">,(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/CHKERRQ.html#CHKERRQ">CHKERRQ</a></span><span class="p">(</span><span class="n">ierr</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscFunctionReturn.html#PetscFunctionReturn">PetscFunctionReturn</a></span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a></span> <span class="nf"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscFreeA.html#PetscFreeA">PetscFreeA</a></span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span><span class="kt">int</span> <span class="n">lineno</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr0</span><span class="p">,...)</span>
<span class="p">{</span>
  <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a></span> <span class="n">ierr</span><span class="p">;</span>
  <span class="kt">va_list</span>        <span class="n">Argp</span><span class="p">;</span>
  <span class="kt">void</span>           <span class="o">**</span><span class="n">ptr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
  <span class="kt">int</span>            <span class="n">i</span><span class="p">;</span>

  <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscFunctionBegin.html#PetscFunctionBegin">PetscFunctionBegin</a></span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/SETERRQ1.html#SETERRQ1">SETERRQ1</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="n">PETSC_ERR_ARG_OUTOFRANGE</span><span class="p">,</span><span class="s">&quot;Attempt to allocate %d objects but only up to 8 supported&quot;</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
  <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="n">ptr0</span><span class="p">;</span>
  <span class="n">va_start</span><span class="p">(</span><span class="n">Argp</span><span class="p">,</span><span class="n">ptr0</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">Argp</span><span class="p">,</span><span class="kt">void</span><span class="o">**</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">va_end</span><span class="p">(</span><span class="n">Argp</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">petscmalloccoalesce</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>       <span class="cm">/* Find first nonempty allocation */</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">*</span><span class="n">ptr</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ierr</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">PetscTrFree</span><span class="p">)(</span><span class="o">*</span><span class="n">ptr</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">lineno</span><span class="p">,</span><span class="n">function</span><span class="p">,</span><span class="n">filename</span><span class="p">);</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/CHKERRQ.html#CHKERRQ">CHKERRQ</a></span><span class="p">(</span><span class="n">ierr</span><span class="p">);</span>
    <span class="o">*</span><span class="n">ptr</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ierr</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">PetscTrFree</span><span class="p">)(</span><span class="o">*</span><span class="n">ptr</span><span class="p">[</span><span class="n">n</span><span class="p">],</span><span class="n">lineno</span><span class="p">,</span><span class="n">function</span><span class="p">,</span><span class="n">filename</span><span class="p">);</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/CHKERRQ.html#CHKERRQ">CHKERRQ</a></span><span class="p">(</span><span class="n">ierr</span><span class="p">);</span>
      <span class="o">*</span><span class="n">ptr</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscFunctionReturn.html#PetscFunctionReturn">PetscFunctionReturn</a></span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>which allow the use of any number of profiling and error-checking
wrappers for <code class="docutils literal notranslate"><span class="pre">malloc(),</span> <span class="pre">calloc()</span></code>, and <code class="docutils literal notranslate"><span class="pre">free()</span></code>. Both
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscMallocA.html#PetscMallocA">PetscMallocA</a>()</span></code> and <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscFreeA.html#PetscFreeA">PetscFreeA</a>()</span></code> call the function pointer values
<code class="docutils literal notranslate"><span class="pre">(*PetscTrMalloc)</span></code> and <code class="docutils literal notranslate"><span class="pre">(*PetscTrFree)</span></code>. <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscMallocSet.html#PetscMallocSet">PetscMallocSet</a>()</span></code> is
used to set these function pointers. The functions are guaranteed to
support requests for zero bytes of memory correctly. Freeing memory
locations also sets the pointer value to zero, preventing later code
from accidently using memory that has been freed. All PETSc memory
allocation calls are memory aligned on at least double-precision
boundaries; the macro generated by configure <code class="docutils literal notranslate"><span class="pre">PETSCMEMALIGN</span></code> indicates
in bytes what alignment all allocations have. This can be controlled at
configure time with the option <code class="docutils literal notranslate"><span class="pre">-with-memalign=&lt;4,8,16,32,64&gt;</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscMallocA.html#PetscMallocA">PetscMallocA</a>()</span></code> supports a request for up to 7 distinct memory
locations of possibly different types. This serves two purposes: it
reduces the number of system <code class="docutils literal notranslate"><span class="pre">malloc()</span></code> calls, thus potentially
increasing performance, and it clarifies in the code related memory
allocations that should be freed together.</p>
<p>The following macros are the preferred way to obtain and release memory
in the PETSc source code. They automatically manage calling
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscMallocA.html#PetscMallocA">PetscMallocA</a>()</span></code> and <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscFreeA.html#PetscFreeA">PetscFreeA</a>()</span></code> with the appropriate location
information.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define <a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscMalloc1.html#PetscMalloc1">PetscMalloc1</a>(m1,r1) <a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscMallocA.html#PetscMallocA">PetscMallocA</a>(1,<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>,__LINE__,PETSC_FUNCTION_NAME,__FILE__,(size_t)(m1)*sizeof(**(r1)),(r1))</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define <a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscMalloc2.html#PetscMalloc2">PetscMalloc2</a>(m1,r1,m2,r2) <a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscMallocA.html#PetscMallocA">PetscMallocA</a>(2,<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>,__LINE__,PETSC_FUNCTION_NAME,__FILE__,(size_t)(m1)*sizeof(**(r1)),(r1),(size_t)(m2)*sizeof(**(r2)),(r2))</span>
</pre></div>
</div>
<p>…</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define <a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscMalloc7.html#PetscMalloc7">PetscMalloc7</a>(m1,r1,m2,r2,m3,r3,m4,r4,m5,r5,m6,r6,m7,r7) <a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscMallocA.html#PetscMallocA">PetscMallocA</a>(7,<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a>,__LINE__,PETSC_FUNCTION_NAME,__FILE__,(size_t)(m1)*sizeof(**(r1)),(r1),(size_t)(m2)*sizeof(**(r2)),(r2),(size_t)(m3)*sizeof(**(r3)),(r3),(size_t)(m4)*sizeof(**(r4)),(r4),(size_t)(m5)*sizeof(**(r5)),(r5),(size_t)(m6)*sizeof(**(r6)),(r6),(size_t)(m7)*sizeof(**(r7)),(r7))</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define <a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</a>(a)   ((*PetscTrFree)((void*)(a),__LINE__,PETSC_FUNCTION_NAME,__FILE__) || ((a) = NULL,0))</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define <a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscFree2.html#PetscFree2">PetscFree2</a>(m1,m2)   <a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscFreeA.html#PetscFreeA">PetscFreeA</a>(2,__LINE__,PETSC_FUNCTION_NAME,__FILE__,&amp;(m1),&amp;(m2))</span>
</pre></div>
</div>
<p>…</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define <a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscFree7.html#PetscFree7">PetscFree7</a>(m1,m2,m3,m4,m5,m6,m7)   <a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscFreeA.html#PetscFreeA">PetscFreeA</a>(7,__LINE__,PETSC_FUNCTION_NAME,__FILE__,&amp;(m1),&amp;(m2),&amp;(m3),&amp;(m4),&amp;(m5),&amp;(m6),&amp;(m7))</span>
</pre></div>
</div>
<p>Similar routines, <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscCalloc1.html#PetscCalloc1">PetscCalloc1</a>()</span></code> to <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscCalloc7.html#PetscCalloc7">PetscCalloc7</a>()</span></code>, provide
memory initialized to zero. The size requests for these macros are in
number of data items requested, not in bytes. This decreases the number
of errors in the code since the compiler determines their sizes from the
object type instead of requiring the user to provide the correct value
with <code class="docutils literal notranslate"><span class="pre">sizeof()</span></code>.</p>
<p>The routines <code class="docutils literal notranslate"><span class="pre">PetscTrMallocDefault()</span></code> and <code class="docutils literal notranslate"><span class="pre">PetscTrFreeDefault()</span></code>,
which are set with the routine <code class="docutils literal notranslate"><span class="pre">PetscSetUseTrMallocPrivate()</span></code> (and are
used by default for the debug version of PETSc), provide simple logging
and error checking versions of memory allocation.</p>
</div>
<div class="section" id="implementation-of-profiling">
<h2>Implementation of Profiling<a class="headerlink" href="#implementation-of-profiling" title="Permalink to this headline">¶</a></h2>
<p>This section provides details about the implementation of event logging
and profiling within the PETSc kernel. The interface for profiling in
PETSc is contained in the file
<a class="reference external" href="https://www.mcs.anl.gov/petsc/petsc-master/include/petsclog.h.html">include/petsclog.h</a>.
The source code for the profile logging is in <code class="docutils literal notranslate"><span class="pre">src/sys/plog/</span></code>.</p>
<div class="section" id="profiling-object-creation-and-destruction">
<h3>Profiling Object Creation and Destruction<a class="headerlink" href="#profiling-object-creation-and-destruction" title="Permalink to this headline">¶</a></h3>
<p>The creation of objects is profiled with the command
<code class="docutils literal notranslate"><span class="pre">PetscLogObjectCreate()</span></code></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PetscLogObjectCreate</span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a></span> <span class="n">h</span><span class="p">);</span>
</pre></div>
</div>
<p>which logs the creation of any PETSc object. Just before an object is
destroyed, it should be logged with <code class="docutils literal notranslate"><span class="pre">PetscLogObjectDestroy()</span></code></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PetscLogObjectDestroy</span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a></span> <span class="n">h</span><span class="p">);</span>
</pre></div>
</div>
<p>These are called automatically by <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscHeaderCreate.html#PetscHeaderCreate">PetscHeaderCreate</a>()</span></code> and
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscHeaderDestroy.html#PetscHeaderDestroy">PetscHeaderDestroy</a>()</span></code>, which are used in creating all objects
inherited from the basic object. Thus, these logging routines need never
be called directly.</p>
<p>If an object has a clearly defined parent object (for instance, when a
work vector is generated for use in a Krylov solver), this information
is logged with the command <code class="docutils literal notranslate"><span class="pre">PetscLogObjectParent()</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PetscLogObjectParent</span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a></span> <span class="n">parent</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a></span> <span class="n">child</span><span class="p">);</span>
</pre></div>
</div>
<p>It is also useful to log information about the state of an object, as
can be done with the command</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PetscLogObjectState</span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</a></span> <span class="n">h</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,...);</span>
</pre></div>
</div>
<p>For example, for sparse matrices we usually log the matrix dimensions
and number of nonzeros.</p>
</div>
<div class="section" id="profiling-events">
<h3>Profiling Events<a class="headerlink" href="#profiling-events" title="Permalink to this headline">¶</a></h3>
<p>Events are logged by using the pair <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Profiling/PetscLogEventBegin.html#PetscLogEventBegin">PetscLogEventBegin</a>()</span></code> and <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Profiling/PetscLogEventEnd.html#PetscLogEventEnd">PetscLogEventEnd</a>()</span></code>.</p>
<p>This logging is usually done in the abstract interface file for the
operations, for example,
<a class="reference external" href="https://www.mcs.anl.gov/petsc/petsc-master/src/mat/interface/matrix.c.html">src/mat/interface/matrix.c</a>.</p>
</div>
<div class="section" id="controlling-profiling">
<h3>Controlling Profiling<a class="headerlink" href="#controlling-profiling" title="Permalink to this headline">¶</a></h3>
<p>Routines that control the default profiling available in PETSc include
the following</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Profiling/PetscLogDefaultBegin.html#PetscLogDefaultBegin">PetscLogDefaultBegin</a>();</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Profiling/PetscLogAllBegin.html#PetscLogAllBegin">PetscLogAllBegin</a>();</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Profiling/PetscLogDump.html#PetscLogDump">PetscLogDump</a>(const</span> <span class="pre">char</span> <span class="pre">*filename);</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Profiling/PetscLogView.html#PetscLogView">PetscLogView</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Viewer/PetscViewer.html#PetscViewer">PetscViewer</a>);</span></code></p></li>
</ul>
<p>These routines are normally called by the <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInitialize.html#PetscInitialize">PetscInitialize</a>()</span></code> and
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscFinalize.html#PetscFinalize">PetscFinalize</a>()</span></code> routines when the option <code class="docutils literal notranslate"><span class="pre">-logview</span></code> is given.</p>
</div>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<span class="target" id="id4"></span><p id="id1254"><dl class="citation">
<dt class="label" id="id2059"><span class="brackets"><a class="fn-backref" href="#id2">BBK+15</a></span></dt>
<dd><p>Satish Balay, Jed Brown, Matthew G. Knepley, Lois McInnes, and Barry Smith. <em>Software Engineering for Science</em>, chapter Providing Mixed Language and Legacy Support within a Library. Taylor &amp; Francis, 2015.</p>
</dd>
<dt class="label" id="id1924"><span class="brackets"><a class="fn-backref" href="#id1">BGMS98</a></span></dt>
<dd><p>Satish Balay, William D. Gropp, Lois Curfman McInnes, and Barry F. Smith. A microkernel design for component-based parallel numerical software systems. In <em>Proceedings of the SIAM Workshop on Object Oriented Methods for Inter-operable Scientific and Engineering Computing</em>, 58–67. SIAM, 1998. URL: <a class="reference external" href="ftp://info.mcs.anl.gov/pub/tech_reports/reports/P727.ps.Z">ftp://info.mcs.anl.gov/pub/tech_reports/reports/P727.ps.Z</a>.</p>
</dd>
<dt class="label" id="id2061"><span class="brackets"><a class="fn-backref" href="#id3">KBMS13</a></span></dt>
<dd><p>Matthew G. Knepley, Jed Brown, Lois Curfman McInnes, and Barry F. Smith. Accurately citing software and algorithms used in publications. In <em>First Workshop on Sustainable Software for Science: Practice and Experiences (WSSSPE), held at SC13</em>. 2013. <a class="reference external" href="https://doi.org/10.6084/m9.figshare.785731">doi:10.6084/m9.figshare.785731</a>.</p>
</dd>
</dl>
</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="objects.html" title="Basic Object Design and Implementation"
             >next</a> |</li>
        <li class="right" >
          <a href="design.html" title="The Design of PETSc"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">PETSc 3.14.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >PETSc Developer’s Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="design.html" >The Design of PETSc</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 1991-2021, UChicago Argonne, LLC and the PETSc Development Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.4.
    </div>
  </body>
</html>