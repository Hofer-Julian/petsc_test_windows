
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head> <link rel="canonical" href="http://www.mcs.anl.gov/petsc/petsc-current/docs/sphinx_docs/html/manual/mat.html" />
    <meta charset="utf-8" />
    <title>Matrices &#8212; PETSc 3.14.6 documentation</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/katex-math.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"></script>
    <script src="../_static/katex_autorenderer.js"></script>
    <link rel="shortcut icon" href="../_static/PETSc_RGB-logo.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="KSP: Linear System Solvers" href="ksp.html" />
    <link rel="prev" title="Vectors and Parallel Data" href="vec.html" /> 
  </head><body>
   <div id="version" align=right><b>petsc-3.14.6 2021-03-30</b></div>
   <div id="bugreport" align=right><a href="mailto:petsc-maint@mcs.anl.gov?subject=Typo or Error in Documentation &body=Please describe the typo or error in the documentation: petsc-3.14.6 v3.14.6 docs/sphinx_docs/html/manual/mat.html "><small>Report Typos and Errors</small></a></div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ksp.html" title="KSP: Linear System Solvers"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="vec.html" title="Vectors and Parallel Data"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">PETSc 3.14.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >PETSc Users Manual</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="programming.html" accesskey="U">Programming with PETSc</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/PETSc-TAO_RGB.svg" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Matrices</a><ul>
<li><a class="reference internal" href="#creating-and-assembling-matrices">Creating and Assembling Matrices</a><ul>
<li><a class="reference internal" href="#sparse-matrices">Sparse Matrices</a><ul>
<li><a class="reference internal" href="#sequential-aij-sparse-matrices">Sequential AIJ Sparse Matrices</a></li>
<li><a class="reference internal" href="#preallocation-of-memory-for-sequential-aij-sparse-matrices">Preallocation of Memory for Sequential AIJ Sparse Matrices</a></li>
<li><a class="reference internal" href="#parallel-aij-sparse-matrices">Parallel AIJ Sparse Matrices</a></li>
<li><a class="reference internal" href="#preallocation-of-memory-for-parallel-aij-sparse-matrices">Preallocation of Memory for Parallel AIJ Sparse Matrices</a></li>
<li><a class="reference internal" href="#limited-memory-variable-metric-lmvm-matrices">Limited-Memory Variable Metric (LMVM) Matrices</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dense-matrices">Dense Matrices</a></li>
<li><a class="reference internal" href="#block-matrices">Block Matrices</a></li>
</ul>
</li>
<li><a class="reference internal" href="#basic-matrix-operations">Basic Matrix Operations</a></li>
<li><a class="reference internal" href="#matrix-free-matrices">Matrix-Free Matrices</a></li>
<li><a class="reference internal" href="#other-matrix-operations">Other Matrix Operations</a></li>
<li><a class="reference internal" href="#partitioning">Partitioning</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="vec.html"
                        title="previous chapter">Vectors and Parallel Data</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="ksp.html"
                        title="next chapter">KSP: Linear System Solvers</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/manual/mat.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="matrices">
<span id="chapter-matrices"></span><h1>Matrices<a class="headerlink" href="#matrices" title="Permalink to this headline">¶</a></h1>
<p>PETSc provides a variety of matrix implementations because no single
matrix format is appropriate for all problems. Currently, we support
dense storage and compressed sparse row storage (both sequential and
parallel versions), as well as several specialized formats. Additional
formats can be added.</p>
<p>This chapter describes the basics of using PETSc matrices in general
(regardless of the particular format chosen) and discusses tips for
efficient use of the several simple uniprocess and parallel matrix
types. The use of PETSc matrices involves the following actions: create
a particular type of matrix, insert values into it, process the matrix,
use the matrix for various computations, and finally destroy the matrix.
The application code does not need to know or care about the particular
storage formats of the matrices.</p>
<div class="section" id="creating-and-assembling-matrices">
<span id="sec-matcreate"></span><h2>Creating and Assembling Matrices<a class="headerlink" href="#creating-and-assembling-matrices" title="Permalink to this headline">¶</a></h2>
<p>The simplest routine for forming a PETSc matrix, <code class="docutils literal notranslate"><span class="pre">A</span></code>, is followed by</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatCreate.html#MatCreate">MatCreate</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</a></span> <span class="n">comm</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="o">*</span><span class="n">A</span><span class="p">)</span>
<span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetSizes.html#MatSetSizes">MatSetSizes</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">m</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">n</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">M</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
<p>This routine generates a sequential matrix when running one process and
a parallel matrix for two or more processes; the particular matrix
format is set by the user via options database commands. The user
specifies either the global matrix dimensions, given by <code class="docutils literal notranslate"><span class="pre">M</span></code> and <code class="docutils literal notranslate"><span class="pre">N</span></code>
or the local dimensions, given by <code class="docutils literal notranslate"><span class="pre">m</span></code> and <code class="docutils literal notranslate"><span class="pre">n</span></code> while PETSc completely
controls memory allocation. This routine facilitates switching among
various matrix types, for example, to determine the format that is most
efficient for a certain application. By default, <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatCreate.html#MatCreate">MatCreate</a>()</span></code> employs
the sparse AIJ format, which is discussed in detail
<a class="reference internal" href="#sec-matsparse"><span class="std std-ref">Sparse Matrices</span></a>. See the manual pages for further
information about available matrix formats.</p>
<p>To insert or add entries to a matrix, one can call a variant of
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</a>()</span></code>, either</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">m</span><span class="p">,</span><span class="k">const</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">idxm</span><span class="p">[],</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">n</span><span class="p">,</span><span class="k">const</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">idxn</span><span class="p">[],</span><span class="k">const</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a></span> <span class="n">values</span><span class="p">[],</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</a></span><span class="p">);</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">m</span><span class="p">,</span><span class="k">const</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">idxm</span><span class="p">[],</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">n</span><span class="p">,</span><span class="k">const</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">idxn</span><span class="p">[],</span><span class="k">const</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a></span> <span class="n">values</span><span class="p">[],</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/ADD_VALUES.html#ADD_VALUES">ADD_VALUES</a></span><span class="p">);</span>
</pre></div>
</div>
<p>This routine inserts or adds a logically dense subblock of dimension
<code class="docutils literal notranslate"><span class="pre">m*n</span></code> into the matrix. The integer indices <code class="docutils literal notranslate"><span class="pre">idxm</span></code> and <code class="docutils literal notranslate"><span class="pre">idxn</span></code>,
respectively, indicate the global row and column numbers to be inserted.
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</a>()</span></code> uses the standard C convention, where the row and
column matrix indices begin with zero <em>regardless of the storage format
employed</em>. The array <code class="docutils literal notranslate"><span class="pre">values</span></code> is logically two-dimensional, containing
the values that are to be inserted. By default the values are given in
row major order, which is the opposite of the Fortran convention,
meaning that the value to be put in row <code class="docutils literal notranslate"><span class="pre">idxm[i]</span></code> and column
<code class="docutils literal notranslate"><span class="pre">idxn[j]</span></code> is located in <code class="docutils literal notranslate"><span class="pre">values[i*n+j]</span></code>. To allow the insertion of
values in column major order, one can call the command</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetOption.html#MatSetOption">MatSetOption</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatOption.html#MatOption">MAT_ROW_ORIENTED</a></span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a></span><span class="p">);</span>
</pre></div>
</div>
<p><em>Warning</em>: Several of the sparse implementations do <em>not</em> currently
support the column-oriented option.</p>
<p>This notation should not be a mystery to anyone. For example, to insert
one matrix into another when using MATLAB, one uses the command
<code class="docutils literal notranslate"><span class="pre">A(im,in)</span> <span class="pre">=</span> <span class="pre">B;</span></code> where <code class="docutils literal notranslate"><span class="pre">im</span></code> and <code class="docutils literal notranslate"><span class="pre">in</span></code> contain the indices for the
rows and columns. This action is identical to the calls above to
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</a>()</span></code>.</p>
<p>When using the block compressed sparse row matrix format (<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MATSEQBAIJ.html#MATSEQBAIJ">MATSEQBAIJ</a></span></code>
or <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MATMPIBAIJ.html#MATMPIBAIJ">MATMPIBAIJ</a></span></code>), one can insert elements more efficiently using the
block variant, <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetValuesBlocked.html#MatSetValuesBlocked">MatSetValuesBlocked</a>()</span></code> or
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetValuesBlockedLocal.html#MatSetValuesBlockedLocal">MatSetValuesBlockedLocal</a>()</span></code>.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetOption.html#MatSetOption">MatSetOption</a>()</span></code> accepts several other inputs; see the
manual page for details.</p>
<p>After the matrix elements have been inserted or added into the matrix,
they must be processed (also called “assembled”) before they can be
used. The routines for matrix processing are</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatAssemblyBegin.html#MatAssemblyBegin">MatAssemblyBegin</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatAssemblyType.html#MatAssemblyType">MAT_FINAL_ASSEMBLY</a></span><span class="p">);</span>
<span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatAssemblyEnd.html#MatAssemblyEnd">MatAssemblyEnd</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatAssemblyType.html#MatAssemblyType">MAT_FINAL_ASSEMBLY</a></span><span class="p">);</span>
</pre></div>
</div>
<p>By placing other code between these two calls, the user can perform
computations while messages are in transit. Calls to <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</a>()</span></code>
with the <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/INSERT_VALUES.html#INSERT_VALUES">INSERT_VALUES</a></span></code> and <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/ADD_VALUES.html#ADD_VALUES">ADD_VALUES</a></span></code> options <em>cannot</em> be mixed
without intervening calls to the assembly routines. For such
intermediate assembly calls the second routine argument typically should
be <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatAssemblyType.html#MatAssemblyType">MAT_FLUSH_ASSEMBLY</a></span></code>, which omits some of the work of the full
assembly process. <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatAssemblyType.html#MatAssemblyType">MAT_FINAL_ASSEMBLY</a></span></code> is required only in the last
matrix assembly before a matrix is used.</p>
<p>Even though one may insert values into PETSc matrices without regard to
which process eventually stores them, for efficiency reasons we usually
recommend generating most entries on the process where they are destined
to be stored. To help the application programmer with this task for
matrices that are distributed across the processes by ranges, the
routine</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatGetOwnershipRange.html#MatGetOwnershipRange">MatGetOwnershipRange</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="o">*</span><span class="n">first_row</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="o">*</span><span class="n">last_row</span><span class="p">);</span>
</pre></div>
</div>
<p>informs the user that all rows from <code class="docutils literal notranslate"><span class="pre">first_row</span></code> to <code class="docutils literal notranslate"><span class="pre">last_row-1</span></code>
(since the value returned in <code class="docutils literal notranslate"><span class="pre">last_row</span></code> is one more than the global
index of the last local row) will be stored on the local process.</p>
<p>In the sparse matrix implementations, once the assembly routines have
been called, the matrices are compressed and can be used for
matrix-vector multiplication, etc. Any space for preallocated nonzeros
that was not filled by a call to <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</a>()</span></code> or a related routine
is compressed out by assembling with <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatAssemblyType.html#MatAssemblyType">MAT_FINAL_ASSEMBLY</a></span></code>. If you
intend to use that extra space later, be sure to insert explicit zeros
before assembling with <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatAssemblyType.html#MatAssemblyType">MAT_FINAL_ASSEMBLY</a></span></code> so the space will not be
compressed out. Once the matrix has been assembled, inserting new values
will be expensive since it will require copies and possible memory
allocation.</p>
<p>One may repeatedly assemble matrices that retain the same
nonzero pattern (such as within a nonlinear or time-dependent problem).
Where possible, data structures and communication
information will be reused (instead of regenerated) during successive
steps, thereby increasing efficiency. See
<a class="reference external" href="https://www.mcs.anl.gov/petsc/petsc-current/src/ksp/ksp/tutorials/ex5.c.html">KSP Tutorial ex5</a>
for a simple example of solving two linear systems that use the same
matrix data structure.</p>
<div class="section" id="sparse-matrices">
<span id="sec-matsparse"></span><h3>Sparse Matrices<a class="headerlink" href="#sparse-matrices" title="Permalink to this headline">¶</a></h3>
<p>The default matrix representation within PETSc is the general sparse AIJ
format (also called the Yale sparse matrix format or compressed sparse
row format, CSR). This section discusses tips for <em>efficiently</em> using
this matrix format for large-scale applications. Additional formats
(such as block compressed row and block diagonal storage, which are
generally much more efficient for problems with multiple degrees of
freedom per node) are discussed below. Beginning users need not concern
themselves initially with such details and may wish to proceed directly
to <a class="reference internal" href="#sec-matoptions"><span class="std std-ref">Basic Matrix Operations</span></a>. However, when an application code
progresses to the point of tuning for efficiency and/or generating
timing results, it is <em>crucial</em> to read this information.</p>
<div class="section" id="sequential-aij-sparse-matrices">
<h4>Sequential AIJ Sparse Matrices<a class="headerlink" href="#sequential-aij-sparse-matrices" title="Permalink to this headline">¶</a></h4>
<p>In the PETSc AIJ matrix formats, we store the nonzero elements by rows,
along with an array of corresponding column numbers and an array of
pointers to the beginning of each row. Note that the diagonal matrix
entries are stored with the rest of the nonzeros (not separately).</p>
<p>To create a sequential AIJ sparse matrix, <code class="docutils literal notranslate"><span class="pre">A</span></code>, with <code class="docutils literal notranslate"><span class="pre">m</span></code> rows and
<code class="docutils literal notranslate"><span class="pre">n</span></code> columns, one uses the command</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatCreateSeqAIJ.html#MatCreateSeqAIJ">MatCreateSeqAIJ</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">m</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">n</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">nz</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="o">*</span><span class="n">nnz</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="o">*</span><span class="n">A</span><span class="p">);</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">nz</span></code> or <code class="docutils literal notranslate"><span class="pre">nnz</span></code> can be used to preallocate matrix memory, as
discussed below. The user can set <code class="docutils literal notranslate"><span class="pre">nz=0</span></code> and <code class="docutils literal notranslate"><span class="pre">nnz=NULL</span></code> for PETSc to
control all matrix memory allocation.</p>
<p>The sequential and parallel AIJ matrix storage formats by default employ
<em>i-nodes</em> (identical nodes) when possible. We search for consecutive
rows with the same nonzero structure, thereby reusing matrix information
for increased efficiency. Related options database keys are
<code class="docutils literal notranslate"><span class="pre">-mat_no_inode</span></code> (do not use inodes) and <code class="docutils literal notranslate"><span class="pre">-mat_inode_limit</span> <span class="pre">&lt;limit&gt;</span></code>
(set inode limit (max limit=5)). Note that problems with a single degree
of freedom per grid node will automatically not use I-nodes.</p>
<p>The internal data representation for the AIJ formats employs zero-based
indexing.</p>
</div>
<div class="section" id="preallocation-of-memory-for-sequential-aij-sparse-matrices">
<h4>Preallocation of Memory for Sequential AIJ Sparse Matrices<a class="headerlink" href="#preallocation-of-memory-for-sequential-aij-sparse-matrices" title="Permalink to this headline">¶</a></h4>
<p>The dynamic process of allocating new memory and copying from the old
storage to the new is <em>intrinsically very expensive</em>. Thus, to obtain
good performance when assembling an AIJ matrix, it is crucial to
preallocate the memory needed for the sparse matrix. The user has two
choices for preallocating matrix memory via <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatCreateSeqAIJ.html#MatCreateSeqAIJ">MatCreateSeqAIJ</a>()</span></code>.</p>
<p>One can use the scalar <code class="docutils literal notranslate"><span class="pre">nz</span></code> to specify the expected number of nonzeros
for each row. This is generally fine if the number of nonzeros per row
is roughly the same throughout the matrix (or as a quick and easy first
step for preallocation). If one underestimates the actual number of
nonzeros in a given row, then during the assembly process PETSc will
automatically allocate additional needed space. However, this extra
memory allocation can slow the computation,</p>
<p>If different rows have very different numbers of nonzeros, one should
attempt to indicate (nearly) the exact number of elements intended for
the various rows with the optional array, <code class="docutils literal notranslate"><span class="pre">nnz</span></code> of length <code class="docutils literal notranslate"><span class="pre">m</span></code>, where
<code class="docutils literal notranslate"><span class="pre">m</span></code> is the number of rows, for example</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">nnz</span><span class="p">[</span><span class="n">m</span><span class="p">];</span>
<span class="n">nnz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">nonzeros</span> <span class="n">in</span> <span class="n">row</span> <span class="mi">0</span><span class="o">&gt;</span>
<span class="n">nnz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">nonzeros</span> <span class="n">in</span> <span class="n">row</span> <span class="mi">1</span><span class="o">&gt;</span>
<span class="p">....</span>
<span class="n">nnz</span><span class="p">[</span><span class="n">m</span><span class="mi">-1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">nonzeros</span> <span class="n">in</span> <span class="n">row</span> <span class="n">m</span><span class="mi">-1</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>In this case, the assembly process will require no additional memory
allocations if the <code class="docutils literal notranslate"><span class="pre">nnz</span></code> estimates are correct. If, however, the
<code class="docutils literal notranslate"><span class="pre">nnz</span></code> estimates are incorrect, PETSc will automatically obtain the
additional needed space, at a slight loss of efficiency.</p>
<p>Using the array <code class="docutils literal notranslate"><span class="pre">nnz</span></code> to preallocate memory is especially important
for efficient matrix assembly if the number of nonzeros varies
considerably among the rows. One can generally set <code class="docutils literal notranslate"><span class="pre">nnz</span></code> either by
knowing in advance the problem structure (e.g., the stencil for finite
difference problems on a structured grid) or by precomputing the
information by using a segment of code similar to that for the regular
matrix assembly. The overhead of determining the <code class="docutils literal notranslate"><span class="pre">nnz</span></code> array will be
quite small compared with the overhead of the inherently expensive
<code class="docutils literal notranslate"><span class="pre">malloc</span></code>s and moves of data that are needed for dynamic allocation
during matrix assembly. Always guess high if an exact value is not known
(extra space is cheaper than too little).</p>
<p>Thus, when assembling a sparse matrix with very different numbers of
nonzeros in various rows, one could proceed as follows for finite
difference methods:</p>
<ol class="arabic simple">
<li><p>Allocate integer array <code class="docutils literal notranslate"><span class="pre">nnz</span></code>.</p></li>
<li><p>Loop over grid, counting the expected number of nonzeros for the
row(s) associated with the various grid points.</p></li>
<li><p>Create the sparse matrix via <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatCreateSeqAIJ.html#MatCreateSeqAIJ">MatCreateSeqAIJ</a>()</span></code> or alternative.</p></li>
<li><p>Loop over the grid, generating matrix entries and inserting in matrix
via <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</a>()</span></code>.</p></li>
</ol>
<p>For (vertex-based) finite element type calculations, an analogous
procedure is as follows:</p>
<ol class="arabic simple">
<li><p>Allocate integer array <code class="docutils literal notranslate"><span class="pre">nnz</span></code>.</p></li>
<li><p>Loop over vertices, computing the number of neighbor vertices, which
determines the number of nonzeros for the corresponding matrix
row(s).</p></li>
<li><p>Create the sparse matrix via <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatCreateSeqAIJ.html#MatCreateSeqAIJ">MatCreateSeqAIJ</a>()</span></code> or alternative.</p></li>
<li><p>Loop over elements, generating matrix entries and inserting in matrix
via <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</a>()</span></code>.</p></li>
</ol>
<p>The <code class="docutils literal notranslate"><span class="pre">-info</span></code> option causes the routines <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatAssemblyBegin.html#MatAssemblyBegin">MatAssemblyBegin</a>()</span></code> and
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatAssemblyEnd.html#MatAssemblyEnd">MatAssemblyEnd</a>()</span></code> to print information about the success of the
preallocation. Consider the following example for the <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MATSEQAIJ.html#MATSEQAIJ">MATSEQAIJ</a></span></code>
matrix format:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="nl">MatAssemblyEnd_SeqAIJ</span><span class="p">:</span><span class="n">Matrix</span> <span class="n">size</span> <span class="mi">10</span> <span class="n">X</span> <span class="mi">10</span><span class="p">;</span> <span class="n">storage</span> <span class="nl">space</span><span class="p">:</span><span class="mi">20</span> <span class="n">unneeded</span><span class="p">,</span> <span class="mi">100</span> <span class="n">used</span>
<span class="nl">MatAssemblyEnd_SeqAIJ</span><span class="p">:</span><span class="n">Number</span> <span class="n">of</span> <span class="n">mallocs</span> <span class="n">during</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</a></span> <span class="n">is</span> <span class="mi">0</span>
</pre></div>
</div>
<p>The first line indicates that the user preallocated 120 spaces but only
100 were used. The second line indicates that the user preallocated
enough space so that PETSc did not have to internally allocate
additional space (an expensive operation). In the next example the user
did not preallocate sufficient space, as indicated by the fact that the
number of mallocs is very large (bad for efficiency):</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="nl">MatAssemblyEnd_SeqAIJ</span><span class="p">:</span><span class="n">Matrix</span> <span class="n">size</span> <span class="mi">10</span> <span class="n">X</span> <span class="mi">10</span><span class="p">;</span> <span class="n">storage</span> <span class="nl">space</span><span class="p">:</span><span class="mi">47</span> <span class="n">unneeded</span><span class="p">,</span> <span class="mi">1000</span> <span class="n">used</span>
<span class="nl">MatAssemblyEnd_SeqAIJ</span><span class="p">:</span><span class="n">Number</span> <span class="n">of</span> <span class="n">mallocs</span> <span class="n">during</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</a></span> <span class="n">is</span> <span class="mi">40000</span>
</pre></div>
</div>
<p>Although at first glance such procedures for determining the matrix
structure in advance may seem unusual, they are actually very efficient
because they alleviate the need for dynamic construction of the matrix
data structure, which can be very expensive.</p>
</div>
<div class="section" id="parallel-aij-sparse-matrices">
<h4>Parallel AIJ Sparse Matrices<a class="headerlink" href="#parallel-aij-sparse-matrices" title="Permalink to this headline">¶</a></h4>
<p>Parallel sparse matrices with the AIJ format can be created with the
command</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatCreateAIJ.html#MatCreateAIJ">MatCreateAIJ</a></span><span class="o">=</span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</a></span> <span class="n">comm</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">m</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">n</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">M</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">N</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">d_nz</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="o">*</span><span class="n">d_nnz</span><span class="p">,</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">o_nz</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="o">*</span><span class="n">o_nnz</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="o">*</span><span class="n">A</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">A</span></code> is the newly created matrix, while the arguments <code class="docutils literal notranslate"><span class="pre">m</span></code>, <code class="docutils literal notranslate"><span class="pre">M</span></code>, and
<code class="docutils literal notranslate"><span class="pre">N</span></code>, indicate the number of local rows and the number of global rows
and columns, respectively. In the PETSc partitioning scheme, all the
matrix columns are local and <code class="docutils literal notranslate"><span class="pre">n</span></code> is the number of columns
corresponding to local part of a parallel vector. Either the local or
global parameters can be replaced with <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a></span></code>, so that PETSc
will determine them. The matrix is stored with a fixed number of rows on
each process, given by <code class="docutils literal notranslate"><span class="pre">m</span></code>, or determined by PETSc if <code class="docutils literal notranslate"><span class="pre">m</span></code> is
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a></span></code>.</p>
<p>If <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a></span></code> is not used for the arguments <code class="docutils literal notranslate"><span class="pre">m</span></code> and <code class="docutils literal notranslate"><span class="pre">n</span></code>, then
the user must ensure that they are chosen to be compatible with the
vectors. To do this, one first considers the matrix-vector product
<span class="math">\(y = A x\)</span>. The <code class="docutils literal notranslate"><span class="pre">m</span></code> that is used in the matrix creation routine
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatCreateAIJ.html#MatCreateAIJ">MatCreateAIJ</a>()</span></code> must match the local size used in the vector creation
routine <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/VecCreateMPI.html#VecCreateMPI">VecCreateMPI</a>()</span></code> for <code class="docutils literal notranslate"><span class="pre">y</span></code>. Likewise, the <code class="docutils literal notranslate"><span class="pre">n</span></code> used must
match that used as the local size in <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/VecCreateMPI.html#VecCreateMPI">VecCreateMPI</a>()</span></code> for <code class="docutils literal notranslate"><span class="pre">x</span></code>.</p>
<p>The user must set <code class="docutils literal notranslate"><span class="pre">d_nz=0</span></code>, <code class="docutils literal notranslate"><span class="pre">o_nz=0</span></code>, <code class="docutils literal notranslate"><span class="pre">d_nnz=</span></code>NULL, and
<code class="docutils literal notranslate"><span class="pre">o_nnz=NULL</span></code> for PETSc to control dynamic allocation of matrix memory
space. Analogous to <code class="docutils literal notranslate"><span class="pre">nz</span></code> and <code class="docutils literal notranslate"><span class="pre">nnz</span></code> for the routine
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatCreateSeqAIJ.html#MatCreateSeqAIJ">MatCreateSeqAIJ</a>()</span></code>, these arguments optionally specify nonzero
information for the diagonal (<code class="docutils literal notranslate"><span class="pre">d_nz</span></code> and <code class="docutils literal notranslate"><span class="pre">d_nnz</span></code>) and off-diagonal
(<code class="docutils literal notranslate"><span class="pre">o_nz</span></code> and <code class="docutils literal notranslate"><span class="pre">o_nnz</span></code>) parts of the matrix. For a square global
matrix, we define each process’s diagonal portion to be its local rows
and the corresponding columns (a square submatrix); each process’s
off-diagonal portion encompasses the remainder of the local matrix (a
rectangular submatrix). The rank in the MPI communicator determines the
absolute ordering of the blocks. That is, the process with rank 0 in the
communicator given to <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatCreateAIJ.html#MatCreateAIJ">MatCreateAIJ</a>()</span></code> contains the top rows of the
matrix; the i<span class="math">\(^{th}\)</span> process in that communicator contains the
i<span class="math">\(^{th}\)</span> block of the matrix.</p>
</div>
<div class="section" id="preallocation-of-memory-for-parallel-aij-sparse-matrices">
<h4>Preallocation of Memory for Parallel AIJ Sparse Matrices<a class="headerlink" href="#preallocation-of-memory-for-parallel-aij-sparse-matrices" title="Permalink to this headline">¶</a></h4>
<p>As discussed above, preallocation of memory is critical for achieving
good performance during matrix assembly, as this reduces the number of
allocations and copies required. We present an example for three
processes to indicate how this may be done for the <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MATMPIAIJ.html#MATMPIAIJ">MATMPIAIJ</a></span></code> matrix
format. Consider the 8 by 8 matrix, which is partitioned by default with
three rows on the first process, three on the second and two on the
third.</p>
<div class="math">
\[\left( \begin{array}{cccccccccc}
1  & 2  & 0  & | & 0  & 3  & 0  & |  & 0  & 4  \\
0  & 5  & 6  & | & 7  & 0  & 0  & |  & 8  & 0 \\
9  & 0  & 10 & | & 11 & 0  & 0  & |  & 12 & 0  \\
\hline \\
13 & 0  & 14 & | & 15 & 16 & 17 & |  & 0  & 0  \\
0  & 18 & 0  & | & 19 & 20 & 21 & |  & 0  & 0 \\
0  & 0  & 0  & | & 22 & 23 & 0  & |  & 24 & 0 \\
\hline \\
25 & 26 & 27 & | & 0  & 0  & 28 & |  & 29 & 0 \\
30 & 0  & 0  & | & 31 & 32 & 33 & |  & 0  &34
\end{array} \right)\]</div>
<p>The “diagonal” submatrix, <code class="docutils literal notranslate"><span class="pre">d</span></code>, on the first process is given by</p>
<div class="math">
\[\left( \begin{array}{ccc}
1  & 2  & 0  \\
0  & 5  & 6  \\
9  & 0  & 10
\end{array} \right),\]</div>
<p>while the “off-diagonal” submatrix, <code class="docutils literal notranslate"><span class="pre">o</span></code>, matrix is given by</p>
<div class="math">
\[\left( \begin{array}{ccccc}
 0  & 3  & 0   & 0  & 4  \\
 7  & 0  & 0   & 8  & 0  \\
 11 & 0  & 0   & 12 & 0  \\
\end{array} \right).\]</div>
<p>For the first process one could set <code class="docutils literal notranslate"><span class="pre">d_nz</span></code> to 2 (since each row has 2
nonzeros) or, alternatively, set <code class="docutils literal notranslate"><span class="pre">d_nnz</span></code> to <span class="math">\(\{2,2,2\}.\)</span> The
<code class="docutils literal notranslate"><span class="pre">o_nz</span></code> could be set to 2 since each row of the <code class="docutils literal notranslate"><span class="pre">o</span></code> matrix has 2
nonzeros, or <code class="docutils literal notranslate"><span class="pre">o_nnz</span></code> could be set to <span class="math">\(\{2,2,2\}\)</span>.</p>
<p>For the second process the <code class="docutils literal notranslate"><span class="pre">d</span></code> submatrix is given by</p>
<div class="math">
\[\left( \begin{array}{cccccccccc}
 15 & 16 & 17 \\
 19 & 20 & 21 \\
 22 & 23 & 0
\end{array} \right) .\]</div>
<p>Thus, one could set <code class="docutils literal notranslate"><span class="pre">d_nz</span></code> to 3, since the maximum number of nonzeros
in each row is 3, or alternatively one could set <code class="docutils literal notranslate"><span class="pre">d_nnz</span></code> to
<span class="math">\(\{3,3,2\}\)</span>, thereby indicating that the first two rows will have
3 nonzeros while the third has 2. The corresponding <code class="docutils literal notranslate"><span class="pre">o</span></code> submatrix for
the second process is</p>
<div class="math">
\[\left( \begin{array}{cccccccccc}
13 & 0  & 14 &  0  & 0  \\
0  & 18 & 0  &  0  & 0 \\
0  & 0  & 0  &  24 & 0 \\
\end{array} \right)\]</div>
<p>so that one could set <code class="docutils literal notranslate"><span class="pre">o_nz</span></code> to 2 or <code class="docutils literal notranslate"><span class="pre">o_nnz</span></code> to {2,1,1}.</p>
<p>Note that the user never directly works with the <code class="docutils literal notranslate"><span class="pre">d</span></code> and <code class="docutils literal notranslate"><span class="pre">o</span></code>
submatrices, except when preallocating storage space as indicated above.
Also, the user need not preallocate exactly the correct amount of space;
as long as a sufficiently close estimate is given, the high efficiency
for matrix assembly will remain.</p>
<p>As described above, the option <code class="docutils literal notranslate"><span class="pre">-info</span></code> will print information about
the success of preallocation during matrix assembly. For the
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MATMPIAIJ.html#MATMPIAIJ">MATMPIAIJ</a></span></code> and <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MATMPIBAIJ.html#MATMPIBAIJ">MATMPIBAIJ</a></span></code> formats, PETSc will also list the
number of elements owned by on each process that were generated on a
different process. For example, the statements</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="nl">MatAssemblyBegin_MPIAIJ</span><span class="p">:</span><span class="n">Stash</span> <span class="n">has</span> <span class="mi">10</span> <span class="n">entries</span><span class="p">,</span> <span class="n">uses</span> <span class="mi">0</span> <span class="n">mallocs</span>
<span class="nl">MatAssemblyBegin_MPIAIJ</span><span class="p">:</span><span class="n">Stash</span> <span class="n">has</span> <span class="mi">3</span> <span class="n">entries</span><span class="p">,</span> <span class="n">uses</span> <span class="mi">0</span> <span class="n">mallocs</span>
<span class="nl">MatAssemblyBegin_MPIAIJ</span><span class="p">:</span><span class="n">Stash</span> <span class="n">has</span> <span class="mi">5</span> <span class="n">entries</span><span class="p">,</span> <span class="n">uses</span> <span class="mi">0</span> <span class="n">mallocs</span>
</pre></div>
</div>
<p>indicate that very few values have been generated on different
processes. On the other hand, the statements</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="nl">MatAssemblyBegin_MPIAIJ</span><span class="p">:</span><span class="n">Stash</span> <span class="n">has</span> <span class="mi">100000</span> <span class="n">entries</span><span class="p">,</span> <span class="n">uses</span> <span class="mi">100</span> <span class="n">mallocs</span>
<span class="nl">MatAssemblyBegin_MPIAIJ</span><span class="p">:</span><span class="n">Stash</span> <span class="n">has</span> <span class="mi">77777</span> <span class="n">entries</span><span class="p">,</span> <span class="n">uses</span> <span class="mi">70</span> <span class="n">mallocs</span>
</pre></div>
</div>
<p>indicate that many values have been generated on the “wrong” processes.
This situation can be very inefficient, since the transfer of values to
the “correct” process is generally expensive. By using the command
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatGetOwnershipRange.html#MatGetOwnershipRange">MatGetOwnershipRange</a>()</span></code> in application codes, the user should be able
to generate most entries on the owning process.</p>
<p><em>Note</em>: It is fine to generate some entries on the “wrong” process.
Often this can lead to cleaner, simpler, less buggy codes. One should
never make code overly complicated in order to generate all values
locally. Rather, one should organize the code in such a way that <em>most</em>
values are generated locally.</p>
</div>
<div class="section" id="limited-memory-variable-metric-lmvm-matrices">
<h4>Limited-Memory Variable Metric (LMVM) Matrices<a class="headerlink" href="#limited-memory-variable-metric-lmvm-matrices" title="Permalink to this headline">¶</a></h4>
<p>Variable metric methods, also known as quasi-Newton methods, are
frequently used for root finding problems and approximate Jacobian
matrices or their inverses via sequential nonlinear updates based on the
secant condition. The limited-memory variants do not store the full
explicit Jacobian, and instead compute forward products and inverse
applications based on a fixed number of stored update vectors.</p>
<table class="docutils align-default" id="tab-matlmvmimpl">
<caption><span class="caption-number">Table 2 </span><span class="caption-text">PETSc LMVM matrix implementations.</span><a class="headerlink" href="#tab-matlmvmimpl" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Method</p></th>
<th class="head"><p>PETSc Type</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Property</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>“Good” Broyden   <span id="id1">[<a class="reference internal" href="#id1242">Gri12</a>]</span></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">MATLMVMBrdn</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">lmvmbrdn</span></code></p></td>
<td><p>Square</p></td>
</tr>
<tr class="row-odd"><td><p>“Bad” Broyden <span id="id2">[<a class="reference internal" href="#id1242">Gri12</a>]</span></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">MATLMVMBadBrdn</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">lmvmbadbrdn</span></code></p></td>
<td><p>Square</p></td>
</tr>
<tr class="row-even"><td><p>Symmetric Rank-1 <span id="id3">[<a class="reference internal" href="#id377">NW99</a>]</span></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">MATLMVMSR1</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">lmvmsr1</span></code></p></td>
<td><p>Symmetric</p></td>
</tr>
<tr class="row-odd"><td><p>Davidon-Fletcher-Powell (DFP) <span id="id4">[<a class="reference internal" href="#id377">NW99</a>]</span></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">MATLMVMDFP</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">lmvmdfp</span></code></p></td>
<td><p>SPD</p></td>
</tr>
<tr class="row-even"><td><dl class="simple">
<dt>Broyden-Fletcher-Goldfarb-Shanno (BFGS)</dt><dd><p><span id="id5">[<a class="reference internal" href="#id377">NW99</a>]</span></p>
</dd>
</dl>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">MATLMVMBFGS</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">lmvmbfgs</span></code></p></td>
<td><p>SPD</p></td>
</tr>
<tr class="row-odd"><td><p>Restricted Broyden Family <span id="id6">[<a class="reference internal" href="#id1241">EM17</a>]</span></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">MATLMVMSymBrdn</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">lmvmsymbrdn</span></code></p></td>
<td><p>SPD</p></td>
</tr>
<tr class="row-even"><td><p>Restricted Broyden Family (full-memory diagonal)</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">MATLMVMDiagBrdn</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">lmvmdiagbrdn</span></code></p></td>
<td><p>SPD</p></td>
</tr>
</tbody>
</table>
<p>PETSc implements seven different LMVM matrices listed in the
table above. They can be created using the
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatCreate.html#MatCreate">MatCreate</a>()</span></code> and <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetType.html#MatSetType">MatSetType</a>()</span></code> workflow, and share a number of
common interface functions. We will review the most important ones
below:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/KSP/MatLMVMAllocate.html#MatLMVMAllocate">MatLMVMAllocate</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">B,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="pre">X,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="pre">F)</span></code> – Creates the internal data
structures necessary to store nonlinear updates and compute
forward/inverse applications. The <code class="docutils literal notranslate"><span class="pre">X</span></code> vector defines the solution
space while the <code class="docutils literal notranslate"><span class="pre">F</span></code> defines the function space for the history of
updates.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/KSP/MatLMVMUpdate.html#MatLMVMUpdate">MatLMVMUpdate</a>(MatB,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="pre">X,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="pre">F)</span></code> – Applies a nonlinear update to
the approximate Jacobian such that <span class="math">\(s_k = x_k - x_{k-1}\)</span> and
<span class="math">\(y_k = f(x_k) - f(x_{k-1})\)</span>, where <span class="math">\(k\)</span> is the index for
the update.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/KSP/MatLMVMReset.html#MatLMVMReset">MatLMVMReset</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">B,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscBool.html#PetscBool">PetscBool</a></span> <span class="pre">destructive)</span></code> – Flushes the
accumulated nonlinear updates and resets the matrix to the initial
state. If <code class="docutils literal notranslate"><span class="pre">destructive</span> <span class="pre">=</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_TRUE.html#PETSC_TRUE">PETSC_TRUE</a></span></code>, the reset also destroys the
internal data structures and necessitates another allocation call
before the matrix can be updated and used for products and solves.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/KSP/MatLMVMSetJ0.html#MatLMVMSetJ0">MatLMVMSetJ0</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">B,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">J0)</span></code> – Defines the initial Jacobian to
apply the updates to. If no initial Jacobian is provided, the updates
are applied to an identity matrix.</p></li>
</ul>
<p>LMVM matrices can be applied to vectors in forward mode via
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatMult.html#MatMult">MatMult</a>()</span></code> or <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatMultAdd.html#MatMultAdd">MatMultAdd</a>()</span></code>, and in inverse mode via
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSolve.html#MatSolve">MatSolve</a>()</span></code>. They also support <code class="docutils literal notranslate"><span class="pre">MatGetVecs()</span></code>, <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatDuplicate.html#MatDuplicate">MatDuplicate</a>()</span></code>
and <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatCopy.html#MatCopy">MatCopy</a>()</span></code> operations. The maximum number of <span class="math">\(s_k\)</span> and
<span class="math">\(y_k\)</span> update vectors stored can be changed via
<code class="docutils literal notranslate"><span class="pre">-mat_lmvm_num_vecs</span></code> option.</p>
<p>Restricted Broyden Family, DFP and BFGS methods additionally implement
special Jacobian initialization and scaling options available via
<code class="docutils literal notranslate"><span class="pre">-mat_lmvm_scale_type</span> <span class="pre">&lt;none,scalar,diagonal&gt;</span></code>. We describe these
choices below:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">none</span></code> – Sets the initial Jacobian to be equal to the identity
matrix. No extra computations are required when obtaining the search
direction or updating the approximation. However, the number of
function evaluations required to converge the Newton solution is
typically much larger than what is required when using other
initializations.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scalar</span></code> – Defines the initial Jacobian as a scalar multiple of the
identity matrix. The scalar value <span class="math">\(\sigma\)</span> is chosen by solving
the one dimensional optimization problem</p>
<div class="math">
\[\min_\sigma \|\sigma^\alpha Y - \sigma^{\alpha - 1} S\|_F^2,

\]</div>
<p>where <span class="math">\(S\)</span> and <span class="math">\(Y\)</span> are the matrices whose columns contain
a subset of update vectors <span class="math">\(s_k\)</span> and <span class="math">\(y_k\)</span>, and
<span class="math">\(\alpha \in [0, 1]\)</span> is defined by the user via
<code class="docutils literal notranslate"><span class="pre">-mat_lmvm_alpha</span></code> and has a different default value for each LMVM
implementation (e.g.: default <span class="math">\(\alpha = 1\)</span> for BFGS produces
the well-known <span class="math">\(y_k^T s_k / y_k^T y_k\)</span> scalar initialization).
The number of updates to be used in the <span class="math">\(S\)</span> and <span class="math">\(Y\)</span>
matrices is 1 by default (i.e.: the latest update only) and can be
changed via <code class="docutils literal notranslate"><span class="pre">-mat_lmvm_scalar_hist</span></code>. This technique is inspired by
Gilbert and Lemarechal <span id="id7">[<a class="reference internal" href="#id1243">GL89</a>]</span>.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">diagonal</span></code> – Uses a full-memory restricted Broyden update formula
to construct a diagonal matrix for the Jacobian initialization.
Although the full-memory formula is utilized, the actual memory
footprint is restricted to only the vector representing the diagonal
and some additional work vectors used in its construction. The
diagonal terms are also re-scaled with every update as suggested in
<span id="id8">[<a class="reference internal" href="#id1243">GL89</a>]</span>. This initialization requires
the most computational effort of the available choices but typically
results in a significant reduction in the number of function
evaluations taken to compute a solution.</p></li>
</ul>
<p>Note that the user-provided initial Jacobian via <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/KSP/MatLMVMSetJ0.html#MatLMVMSetJ0">MatLMVMSetJ0</a>()</span></code>
overrides and disables all built-in initialization methods.</p>
</div>
</div>
<div class="section" id="dense-matrices">
<span id="sec-matdense"></span><h3>Dense Matrices<a class="headerlink" href="#dense-matrices" title="Permalink to this headline">¶</a></h3>
<p>PETSc provides both sequential and parallel dense matrix formats, where
each process stores its entries in a column-major array in the usual
Fortran style. To create a sequential, dense PETSc matrix, <code class="docutils literal notranslate"><span class="pre">A</span></code> of
dimensions <code class="docutils literal notranslate"><span class="pre">m</span></code> by <code class="docutils literal notranslate"><span class="pre">n</span></code>, the user should call</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatCreateSeqDense.html#MatCreateSeqDense">MatCreateSeqDense</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a></span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">m</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">n</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a></span> <span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="o">*</span><span class="n">A</span><span class="p">);</span>
</pre></div>
</div>
<p>The variable <code class="docutils literal notranslate"><span class="pre">data</span></code> enables the user to optionally provide the
location of the data for matrix storage (intended for Fortran users who
wish to allocate their own storage space). Most users should merely set
<code class="docutils literal notranslate"><span class="pre">data</span></code> to <code class="docutils literal notranslate"><span class="pre">NULL</span></code> for PETSc to control matrix memory allocation. To
create a parallel, dense matrix, <code class="docutils literal notranslate"><span class="pre">A</span></code>, the user should call</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatCreateDense.html#MatCreateDense">MatCreateDense</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</a></span> <span class="n">comm</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">m</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">n</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">M</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">N</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a></span> <span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="o">*</span><span class="n">A</span><span class="p">)</span>
</pre></div>
</div>
<p>The arguments <code class="docutils literal notranslate"><span class="pre">m</span></code>, <code class="docutils literal notranslate"><span class="pre">n</span></code>, <code class="docutils literal notranslate"><span class="pre">M</span></code>, and <code class="docutils literal notranslate"><span class="pre">N</span></code>, indicate the number of
local rows and columns and the number of global rows and columns,
respectively. Either the local or global parameters can be replaced with
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a></span></code>, so that PETSc will determine them. The matrix is
stored with a fixed number of rows on each process, given by <code class="docutils literal notranslate"><span class="pre">m</span></code>, or
determined by PETSc if <code class="docutils literal notranslate"><span class="pre">m</span></code> is <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a></span></code>.</p>
<p>PETSc does not provide parallel dense direct solvers, instead
interfacing to external packages that provide these solvers. Our focus
is on sparse iterative solvers.</p>
</div>
<div class="section" id="block-matrices">
<span id="sec-matnest"></span><h3>Block Matrices<a class="headerlink" href="#block-matrices" title="Permalink to this headline">¶</a></h3>
<p>Block matrices arise when coupling variables with different meaning,
especially when solving problems with constraints (e.g. incompressible
flow) and “multi-physics” problems. Usually the number of blocks is
small and each block is partitioned in parallel. We illustrate for a
<span class="math">\(3\times 3\)</span> system with components labeled <span class="math">\(a,b,c\)</span>. With
some numbering of unknowns, the matrix could be written as</p>
<div class="math">
\[\left( \begin{array}{ccc}
    A_{aa} & A_{ab} & A_{ac} \\
    A_{ba} & A_{bb} & A_{bc} \\
    A_{ca} & A_{cb} & A_{cc}
  \end{array} \right) .\]</div>
<p>There are two fundamentally different ways that this matrix could be
stored, as a single assembled sparse matrix where entries from all
blocks are merged together (“monolithic”), or as separate assembled
matrices for each block (“nested”). These formats have different
performance characteristics depending on the operation being performed.
In particular, many preconditioners require a monolithic format, but
some that are very effective for solving block systems (see
<a class="reference internal" href="ksp.html#sec-block-matrices"><span class="std std-ref">Solving Block Matrices</span></a>) are more efficient when a nested
format is used. In order to stay flexible, we would like to be able to
use the same code to assemble block matrices in both monolithic and
nested formats. Additionally, for software maintainability and testing,
especially in a multi-physics context where different groups might be
responsible for assembling each of the blocks, it is desirable to be
able to use exactly the same code to assemble a single block
independently as to assemble it as part of a larger system. To do this,
we introduce the four spaces shown in <a class="reference internal" href="#fig-localspaces"><span class="std std-numref">Fig. 4</span></a>.</p>
<ul class="simple">
<li><p>The monolithic global space is the space in which the Krylov and
Newton solvers operate, with collective semantics across the entire
block system.</p></li>
<li><p>The split global space splits the blocks apart, but each split still
has collective semantics.</p></li>
<li><p>The split local space adds ghost points and separates the blocks.
Operations in this space can be performed with no parallel
communication. This is often the most natural, and certainly the most
powerful, space for matrix assembly code.</p></li>
<li><p>The monolithic local space can be thought of as adding ghost points
to the monolithic global space, but it is often more natural to use
it simply as a concatenation of split local spaces on each process.
It is not common to explicitly manipulate vectors or matrices in this
space (at least not during assembly), but it is a useful for
declaring which part of a matrix is being assembled.</p></li>
</ul>
<div class="figure align-default" id="fig-localspaces">
<img alt="The relationship between spaces used for coupled assembly." src="../_images/localspaces.svg" /><p class="caption"><span class="caption-number">Fig. 4 </span><span class="caption-text">The relationship between spaces used for coupled assembly.</span><a class="headerlink" href="#fig-localspaces" title="Permalink to this image">¶</a></p>
</div>
<p>The key to format-independent assembly is the function</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatGetLocalSubMatrix.html#MatGetLocalSubMatrix">MatGetLocalSubMatrix</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/IS/IS.html#IS">IS</a></span> <span class="n">isrow</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/IS/IS.html#IS">IS</a></span> <span class="n">iscol</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="o">*</span><span class="n">submat</span><span class="p">);</span>
</pre></div>
</div>
<p>which provides a “view” <code class="docutils literal notranslate"><span class="pre">submat</span></code> into a matrix <code class="docutils literal notranslate"><span class="pre">A</span></code> that operates in
the monolithic global space. The <code class="docutils literal notranslate"><span class="pre">submat</span></code> transforms from the split
local space defined by <code class="docutils literal notranslate"><span class="pre">iscol</span></code> to the split local space defined by
<code class="docutils literal notranslate"><span class="pre">isrow</span></code>. The index sets specify the parts of the monolithic local
space that <code class="docutils literal notranslate"><span class="pre">submat</span></code> should operate in. If a nested matrix format is
used, then <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatGetLocalSubMatrix.html#MatGetLocalSubMatrix">MatGetLocalSubMatrix</a>()</span></code> finds the nested block and returns
it without making any copies. In this case, <code class="docutils literal notranslate"><span class="pre">submat</span></code> is fully
functional and has a parallel communicator. If a monolithic matrix
format is used, then <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatGetLocalSubMatrix.html#MatGetLocalSubMatrix">MatGetLocalSubMatrix</a>()</span></code> returns a proxy matrix
on <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</a></span></code> that does not provide values or implement
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatMult.html#MatMult">MatMult</a>()</span></code>, but does implement <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetValuesLocal.html#MatSetValuesLocal">MatSetValuesLocal</a>()</span></code> and, if
<code class="docutils literal notranslate"><span class="pre">isrow,iscol</span></code> have a constant block size,
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetValuesBlockedLocal.html#MatSetValuesBlockedLocal">MatSetValuesBlockedLocal</a>()</span></code>. Note that although <code class="docutils literal notranslate"><span class="pre">submat</span></code> may not be
a fully functional matrix and the caller does not even know a priori
which communicator it will reside on, it always implements the local
assembly functions (which are not collective). The index sets
<code class="docutils literal notranslate"><span class="pre">isrow,iscol</span></code> can be obtained using <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/DM/DMCompositeGetLocalISs.html#DMCompositeGetLocalISs">DMCompositeGetLocalISs</a>()</span></code> if
<code class="docutils literal notranslate"><span class="pre">DMComposite</span></code> is being used. DMComposite can also be used to create
matrices, in which case the MATNEST format can be specified using
<code class="docutils literal notranslate"><span class="pre">-prefix_dm_mat_type</span> <span class="pre">nest</span></code> and MATAIJ can be specified using
<code class="docutils literal notranslate"><span class="pre">-prefix_dm_mat_type</span> <span class="pre">aij</span></code>. See
<a class="reference external" href="https://www.mcs.anl.gov/petsc/petsc-current/src/snes/tutorials/ex28.c.html">SNES Tutorail ex28</a>
for a simple example using this interface.</p>
</div>
</div>
<div class="section" id="basic-matrix-operations">
<span id="sec-matoptions"></span><h2>Basic Matrix Operations<a class="headerlink" href="#basic-matrix-operations" title="Permalink to this headline">¶</a></h2>
<p>Table <a class="reference external" href="#fig_matrixops">2.2</a> summarizes basic PETSc matrix operations.
We briefly discuss a few of these routines in more detail below.</p>
<p>The parallel matrix can multiply a vector with <code class="docutils literal notranslate"><span class="pre">n</span></code> local entries,
returning a vector with <code class="docutils literal notranslate"><span class="pre">m</span></code> local entries. That is, to form the
product</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatMult.html#MatMult">MatMult</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">x</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">y</span><span class="p">);</span>
</pre></div>
</div>
<p>the vectors <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> should be generated with</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/VecCreateMPI.html#VecCreateMPI">VecCreateMPI</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</a></span> <span class="n">comm</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span>
<span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/VecCreateMPI.html#VecCreateMPI">VecCreateMPI</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</a></span> <span class="n">comm</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="o">&amp;</span><span class="n">y</span><span class="p">);</span>
</pre></div>
</div>
<p>By default, if the user lets PETSc decide the number of components to be
stored locally (by passing in <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_DECIDE.html#PETSC_DECIDE">PETSC_DECIDE</a></span></code> as the second argument to
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/VecCreateMPI.html#VecCreateMPI">VecCreateMPI</a>()</span></code> or using <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/VecCreate.html#VecCreate">VecCreate</a>()</span></code>), vectors and matrices of
the same dimension are automatically compatible for parallel
matrix-vector operations.</p>
<p>Along with the matrix-vector multiplication routine, there is a version
for the transpose of the matrix,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatMultTranspose.html#MatMultTranspose">MatMultTranspose</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">x</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">y</span><span class="p">);</span>
</pre></div>
</div>
<p>There are also versions that add the result to another vector:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatMultAdd.html#MatMultAdd">MatMultAdd</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">x</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">y</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">w</span><span class="p">);</span>
<span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatMultTransposeAdd.html#MatMultTransposeAdd">MatMultTransposeAdd</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">x</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">y</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">w</span><span class="p">);</span>
</pre></div>
</div>
<p>These routines, respectively, produce <span class="math">\(w = A*x + y\)</span> and
<span class="math">\(w = A^{T}*x + y\)</span> . In C it is legal for the vectors <code class="docutils literal notranslate"><span class="pre">y</span></code> and
<code class="docutils literal notranslate"><span class="pre">w</span></code> to be identical. In Fortran, this situation is forbidden by the
language standard, but we allow it anyway.</p>
<p>One can print a matrix (sequential or parallel) to the screen with the
command</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatView.html#MatView">MatView</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">mat</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Viewer/PETSC_VIEWER_STDOUT_WORLD.html#PETSC_VIEWER_STDOUT_WORLD">PETSC_VIEWER_STDOUT_WORLD</a></span><span class="p">);</span>
</pre></div>
</div>
<p>Other viewers can be used as well. For instance, one can draw the
nonzero structure of the matrix into the default X-window with the
command</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatView.html#MatView">MatView</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">mat</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Viewer/PETSC_VIEWER_DRAW_WORLD.html#PETSC_VIEWER_DRAW_WORLD">PETSC_VIEWER_DRAW_WORLD</a></span><span class="p">);</span>
</pre></div>
</div>
<p>Also one can use</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatView.html#MatView">MatView</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">mat</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Viewer/PetscViewer.html#PetscViewer">PetscViewer</a></span> <span class="n">viewer</span><span class="p">);</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">viewer</span></code> was obtained with <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Viewer/PetscViewerDrawOpen.html#PetscViewerDrawOpen">PetscViewerDrawOpen</a>()</span></code>. Additional
viewers and options are given in the <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatView.html#MatView">MatView</a>()</span></code> man page and
<a class="reference internal" href="other.html#sec-viewers"><span class="std std-ref">Viewers: Looking at PETSc Objects</span></a>.</p>
<table class="docutils align-default" id="fig-matrixops">
<caption><span class="caption-number">Table 3 </span><span class="caption-text">PETSc Matrix Operations</span><a class="headerlink" href="#fig-matrixops" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Function Name</p></th>
<th class="head"><p>Operation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatAXPY.html#MatAXPY">MatAXPY</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">Y,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a></span> <span class="pre">a,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">X,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatStructure.html#MatStructure">MatStructure</a></span> <span class="pre">s);</span></code></p></td>
<td><p><span class="math">\(Y = Y + a*X\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatMult.html#MatMult">MatMult</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">A,<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="pre">x,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="pre">y);</span></code></p></td>
<td><p><span class="math">\(y = A*x\)</span></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatMultAdd.html#MatMultAdd">MatMultAdd</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">A,<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="pre">x,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="pre">y,<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="pre">z);</span></code></p></td>
<td><p><span class="math">\(z = y + A*x\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatMultTranspose.html#MatMultTranspose">MatMultTranspose</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">A,<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="pre">x,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="pre">y);</span></code></p></td>
<td><p><span class="math">\(y = A^{T}*x\)</span></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatMultTransposeAdd.html#MatMultTransposeAdd">MatMultTransposeAdd</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">A,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="pre">x,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="pre">y,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="pre">z);</span></code></p></td>
<td><p><span class="math">\(z = y + A^{T}*x\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatNorm.html#MatNorm">MatNorm</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">A,<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/NormType.html#NormType">NormType</a></span> <span class="pre">type,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscReal.html#PetscReal">PetscReal</a></span> <span class="pre">*r);</span></code></p></td>
<td><p><span class="math">\(r = A_{type}\)</span></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatDiagonalScale.html#MatDiagonalScale">MatDiagonalScale</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">A,<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="pre">l,<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="pre">r);</span></code></p></td>
<td><p><span class="math">\(A = \text{diag}(l)*A*\text{diag}(r)\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatScale.html#MatScale">MatScale</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">A,<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a></span> <span class="pre">a);</span></code></p></td>
<td><p><span class="math">\(A = a*A\)</span></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatConvert.html#MatConvert">MatConvert</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">A,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatType.html#MatType">MatType</a></span> <span class="pre">type,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">*B);</span></code></p></td>
<td><p><span class="math">\(B = A\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatCopy.html#MatCopy">MatCopy</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">A,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">B,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatStructure.html#MatStructure">MatStructure</a></span> <span class="pre">s);</span></code></p></td>
<td><p><span class="math">\(B = A\)</span></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatGetDiagonal.html#MatGetDiagonal">MatGetDiagonal</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">A,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="pre">x);</span></code></p></td>
<td><p><span class="math">\(x = \text{diag}(A)\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatTranspose.html#MatTranspose">MatTranspose</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">A,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatReuse.html#MatReuse">MatReuse</a>,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a>*</span> <span class="pre">B);</span></code></p></td>
<td><p><span class="math">\(B = A^{T}\)</span></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatZeroEntries.html#MatZeroEntries">MatZeroEntries</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">A);</span></code></p></td>
<td><p><span class="math">\(A = 0\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatShift.html#MatShift">MatShift</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="pre">Y,</span> <span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a></span> <span class="pre">a);</span></code></p></td>
<td><p><span class="math">\(Y =  Y + a*I\)</span></p></td>
</tr>
</tbody>
</table>
<p>The <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/NormType.html#NormType">NormType</a></span></code> argument to <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatNorm.html#MatNorm">MatNorm</a>()</span></code> is one of <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/NORM_1.html#NORM_1">NORM_1</a></span></code>,
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/NORM_INFINITY.html#NORM_INFINITY">NORM_INFINITY</a></span></code>, and <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/NORM_FROBENIUS.html#NORM_FROBENIUS">NORM_FROBENIUS</a></span></code>.</p>
</div>
<div class="section" id="matrix-free-matrices">
<span id="sec-matrixfree"></span><h2>Matrix-Free Matrices<a class="headerlink" href="#matrix-free-matrices" title="Permalink to this headline">¶</a></h2>
<p>Some people like to use matrix-free methods, which do
not require explicit storage of the matrix, for the numerical solution
of partial differential equations. To support matrix-free methods in
PETSc, one can use the following command to create a <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span></code> structure
without ever actually generating the matrix:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatCreateShell.html#MatCreateShell">MatCreateShell</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</a></span> <span class="n">comm</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">m</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">n</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">M</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">N</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="o">*</span><span class="n">mat</span><span class="p">);</span>
</pre></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">M</span></code> and <code class="docutils literal notranslate"><span class="pre">N</span></code> are the global matrix dimensions (rows and
columns), <code class="docutils literal notranslate"><span class="pre">m</span></code> and <code class="docutils literal notranslate"><span class="pre">n</span></code> are the local matrix dimensions, and <code class="docutils literal notranslate"><span class="pre">ctx</span></code>
is a pointer to data needed by any user-defined shell matrix operations;
the manual page has additional details about these parameters. Most
matrix-free algorithms require only the application of the linear
operator to a vector. To provide this action, the user must write a
routine with the calling sequence</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">UserMult</span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">mat</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">x</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">y</span><span class="p">);</span>
</pre></div>
</div>
<p>and then associate it with the matrix, <code class="docutils literal notranslate"><span class="pre">mat</span></code>, by using the command</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatShellSetOperation.html#MatShellSetOperation">MatShellSetOperation</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">mat</span><span class="p">,</span><span class="n">MatOperation</span> <span class="n">MATOP_MULT</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</a></span> <span class="p">(</span><span class="o">*</span><span class="n">UserMult</span><span class="p">)(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span><span class="p">));</span>
</pre></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">MATOP_MULT</span></code> is the name of the operation for matrix-vector
multiplication. Within each user-defined routine (such as
<code class="docutils literal notranslate"><span class="pre">UserMult()</span></code>), the user should call <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatShellGetContext.html#MatShellGetContext">MatShellGetContext</a>()</span></code> to obtain
the user-defined context, <code class="docutils literal notranslate"><span class="pre">ctx</span></code>, that was set by <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatCreateShell.html#MatCreateShell">MatCreateShell</a>()</span></code>.
This shell matrix can be used with the iterative linear equation solvers
discussed in the following chapters.</p>
<p>The routine <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatShellSetOperation.html#MatShellSetOperation">MatShellSetOperation</a>()</span></code> can be used to set any other
matrix operations as well. The file
<code class="docutils literal notranslate"><span class="pre">$PETSC_DIR/include/petscmat.h</span></code> (<a class="reference external" href="https://www.mcs.anl.gov/petsc/petsc-current/include/petscmat.h.html">source</a>).
provides a complete list of matrix operations, which have the form
<code class="docutils literal notranslate"><span class="pre">MATOP_&lt;OPERATION&gt;</span></code>, where <code class="docutils literal notranslate"><span class="pre">&lt;OPERATION&gt;</span></code> is the name (in all capital
letters) of the user interface routine (for example, <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatMult.html#MatMult">MatMult</a>()</span></code>
<span class="math">\(\to\)</span> <code class="docutils literal notranslate"><span class="pre">MATOP_MULT</span></code>). All user-provided functions have the same
calling sequence as the usual matrix interface routines, since the
user-defined functions are intended to be accessed through the same
interface, e.g., <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatMult.html#MatMult">MatMult</a>(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a>,<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a>,<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a>)</span></code> <span class="math">\(\to\)</span>
<code class="docutils literal notranslate"><span class="pre">UserMult(<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a>,<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a>,<a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a>)</span></code>. The final argument for
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatShellSetOperation.html#MatShellSetOperation">MatShellSetOperation</a>()</span></code> needs to be cast to a <code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">*</span></code>, since the
final argument could (depending on the MatOperation) be a variety of
different functions.</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatShellSetOperation.html#MatShellSetOperation">MatShellSetOperation</a>()</span></code> can also be used as a “backdoor”
means of introducing user-defined changes in matrix operations for other
storage formats (for example, to override the default LU factorization
routine supplied within PETSc for the <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MATSEQAIJ.html#MATSEQAIJ">MATSEQAIJ</a></span></code> format). However, we
urge anyone who introduces such changes to use caution, since it would
be very easy to accidentally create a bug in the new routine that could
affect other routines as well.</p>
<p>See also <a class="reference internal" href="snes.html#sec-nlmatrixfree"><span class="std std-ref">Matrix-Free Methods</span></a> for details on one set of
helpful utilities for using the matrix-free approach for nonlinear
solvers.</p>
</div>
<div class="section" id="other-matrix-operations">
<span id="sec-othermat"></span><h2>Other Matrix Operations<a class="headerlink" href="#other-matrix-operations" title="Permalink to this headline">¶</a></h2>
<p>In many iterative calculations (for instance, in a nonlinear equations
solver), it is important for efficiency purposes to reuse the nonzero
structure of a matrix, rather than determining it anew every time the
matrix is generated. To retain a given matrix but reinitialize its
contents, one can employ</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatZeroEntries.html#MatZeroEntries">MatZeroEntries</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">);</span>
</pre></div>
</div>
<p>This routine will zero the matrix entries in the data structure but keep
all the data that indicates where the nonzeros are located. In this way
a new matrix assembly will be much less expensive, since no memory
allocations or copies will be needed. Of course, one can also explicitly
set selected matrix elements to zero by calling <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</a>()</span></code>.</p>
<p>By default, if new entries are made in locations where no nonzeros
previously existed, space will be allocated for the new entries. To
prevent the allocation of additional memory and simply discard those new
entries, one can use the option</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetOption.html#MatSetOption">MatSetOption</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatOption.html#MatOption">MAT_NEW_NONZERO_LOCATIONS</a></span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a></span><span class="p">);</span>
</pre></div>
</div>
<p>Once the matrix has been assembled, one can factor it numerically
without repeating the ordering or the symbolic factorization. This
option can save some computational time, although it does require that
the factorization is not done in-place.</p>
<p>In the numerical solution of elliptic partial differential equations, it
can be cumbersome to deal with Dirichlet boundary conditions. In
particular, one would like to assemble the matrix without regard to
boundary conditions and then at the end apply the Dirichlet boundary
conditions. In numerical analysis classes this process is usually
presented as moving the known boundary conditions to the right-hand side
and then solving a smaller linear system for the interior unknowns.
Unfortunately, implementing this requires extracting a large submatrix
from the original matrix and creating its corresponding data structures.
This process can be expensive in terms of both time and memory.</p>
<p>One simple way to deal with this difficulty is to replace those rows in
the matrix associated with known boundary conditions, by rows of the
identity matrix (or some scaling of it). This action can be done with
the command</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatZeroRows.html#MatZeroRows">MatZeroRows</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">numRows</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">rows</span><span class="p">[],</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a></span> <span class="n">diag_value</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">x</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">b</span><span class="p">),</span>
</pre></div>
</div>
<p>or equivalently,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatZeroRowsIS.html#MatZeroRowsIS">MatZeroRowsIS</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/IS/IS.html#IS">IS</a></span> <span class="n">rows</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a></span> <span class="n">diag_value</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">x</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">b</span><span class="p">);</span>
</pre></div>
</div>
<p>For sparse matrices this removes the data structures for certain rows of
the matrix. If the pointer <code class="docutils literal notranslate"><span class="pre">diag_value</span></code> is <code class="docutils literal notranslate"><span class="pre">NULL</span></code>, it even removes
the diagonal entry. If the pointer is not null, it uses that given value
at the pointer location in the diagonal entry of the eliminated rows.</p>
<p>One nice feature of this approach is that when solving a nonlinear
problem such that at each iteration the Dirichlet boundary conditions
are in the same positions and the matrix retains the same nonzero
structure, the user can call <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatZeroRows.html#MatZeroRows">MatZeroRows</a>()</span></code> in the first iteration.
Then, before generating the matrix in the second iteration the user
should call</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetOption.html#MatSetOption">MatSetOption</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatOption.html#MatOption">MAT_NEW_NONZERO_LOCATIONS</a></span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PETSC_FALSE.html#PETSC_FALSE">PETSC_FALSE</a></span><span class="p">);</span>
</pre></div>
</div>
<p>From that point, no new values will be inserted into those (boundary)
rows of the matrix.</p>
<p>The functions <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatZeroRowsLocal.html#MatZeroRowsLocal">MatZeroRowsLocal</a>()</span></code> and <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatZeroRowsLocalIS.html#MatZeroRowsLocalIS">MatZeroRowsLocalIS</a>()</span></code> can
also be used if for each process one provides the Dirichlet locations in
the local numbering of the matrix. A drawback of <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatZeroRows.html#MatZeroRows">MatZeroRows</a>()</span></code> is
that it destroys the symmetry of a matrix. Thus one can use</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatZeroRowsColumns.html#MatZeroRowsColumns">MatZeroRowsColumns</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">numRows</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">rows</span><span class="p">[],</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a></span> <span class="n">diag_value</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">x</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">b</span><span class="p">),</span>
</pre></div>
</div>
<p>or equivalently,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatZeroRowsColumnsIS.html#MatZeroRowsColumnsIS">MatZeroRowsColumnsIS</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/IS/IS.html#IS">IS</a></span> <span class="n">rows</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a></span> <span class="n">diag_value</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">x</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Vec/Vec.html#Vec">Vec</a></span> <span class="n">b</span><span class="p">);</span>
</pre></div>
</div>
<p>Note that with all of these for a given assembled matrix it can be only
called once to update the x and b vector. It cannot be used if one
wishes to solve multiple right hand side problems for the same matrix
since the matrix entries needed for updating the b vector are removed in
its first use.</p>
<p>Once the zeroed rows are removed the new matrix has possibly many rows
with only a diagonal entry affecting the parallel load balancing. The
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/PC/PCREDISTRIBUTE.html#PCREDISTRIBUTE">PCREDISTRIBUTE</a></span></code> preconditioner removes all the zeroed rows (and
associated columns and adjusts the right hand side based on the removed
columns) and then rebalances the resulting rows of smaller matrix across
the processes. Thus one can use <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatZeroRows.html#MatZeroRows">MatZeroRows</a>()</span></code> to set the Dirichlet
points and then solve with the preconditioner <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/PC/PCREDISTRIBUTE.html#PCREDISTRIBUTE">PCREDISTRIBUTE</a></span></code>. Note
if the original matrix was symmetric the smaller solved matrix will also
be symmetric.</p>
<p>Another matrix routine of interest is</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatConvert.html#MatConvert">MatConvert</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">mat</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatType.html#MatType">MatType</a></span> <span class="n">newtype</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="o">*</span><span class="n">M</span><span class="p">)</span>
</pre></div>
</div>
<p>which converts the matrix <code class="docutils literal notranslate"><span class="pre">mat</span></code> to new matrix, <code class="docutils literal notranslate"><span class="pre">M</span></code>, that has either
the same or different format. Set <code class="docutils literal notranslate"><span class="pre">newtype</span></code> to <code class="docutils literal notranslate"><span class="pre">MATSAME</span></code> to copy the
matrix, keeping the same matrix format. See
<code class="docutils literal notranslate"><span class="pre">$PETSC_DIR/include/petscmat.h</span></code> (<a class="reference external" href="https://www.mcs.anl.gov/petsc/petsc-current/include/petscmat.h.html">source</a>)
for other available matrix types; standard ones are <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MATSEQDENSE.html#MATSEQDENSE">MATSEQDENSE</a></span></code>,
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MATSEQAIJ.html#MATSEQAIJ">MATSEQAIJ</a></span></code>, <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MATMPIAIJ.html#MATMPIAIJ">MATMPIAIJ</a></span></code>, <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MATSEQBAIJ.html#MATSEQBAIJ">MATSEQBAIJ</a></span></code> and <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MATMPIBAIJ.html#MATMPIBAIJ">MATMPIBAIJ</a></span></code>.</p>
<p>In certain applications it may be necessary for application codes to
directly access elements of a matrix. This may be done by using the the
command (for local rows only)</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatGetRow.html#MatGetRow">MatGetRow</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">row</span><span class="p">,</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="k">const</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="p">(</span><span class="o">*</span><span class="n">cols</span><span class="p">)[],</span><span class="k">const</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a></span> <span class="p">(</span><span class="o">*</span><span class="n">vals</span><span class="p">)[]);</span>
</pre></div>
</div>
<p>The argument <code class="docutils literal notranslate"><span class="pre">ncols</span></code> returns the number of nonzeros in that row, while
<code class="docutils literal notranslate"><span class="pre">cols</span></code> and <code class="docutils literal notranslate"><span class="pre">vals</span></code> returns the column indices (with indices starting
at zero) and values in the row. If only the column indices are needed
(and not the corresponding matrix elements), one can use <code class="docutils literal notranslate"><span class="pre">NULL</span></code> for
the <code class="docutils literal notranslate"><span class="pre">vals</span></code> argument. Similarly, one can use <code class="docutils literal notranslate"><span class="pre">NULL</span></code> for the <code class="docutils literal notranslate"><span class="pre">cols</span></code>
argument. The user can only examine the values extracted with
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatGetRow.html#MatGetRow">MatGetRow</a>()</span></code>; the values <em>cannot</em> be altered. To change the matrix
entries, one must use <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatSetValues.html#MatSetValues">MatSetValues</a>()</span></code>.</p>
<p>Once the user has finished using a row, he or she <em>must</em> call</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatRestoreRow.html#MatRestoreRow">MatRestoreRow</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">A</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">row</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="o">**</span><span class="n">cols</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</a></span> <span class="o">**</span><span class="n">vals</span><span class="p">);</span>
</pre></div>
</div>
<p>to free any space that was allocated during the call to <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatGetRow.html#MatGetRow">MatGetRow</a>()</span></code>.</p>
</div>
<div class="section" id="partitioning">
<span id="sec-partitioning"></span><h2>Partitioning<a class="headerlink" href="#partitioning" title="Permalink to this headline">¶</a></h2>
<p>For almost all unstructured grid computation, the distribution of
portions of the grid across the process’s work load and memory can have
a very large impact on performance. In most PDE calculations the grid
partitioning and distribution across the processes can (and should) be
done in a “pre-processing” step before the numerical computations.
However, this does not mean it need be done in a separate, sequential
program; rather, it should be done before one sets up the parallel grid
data structures in the actual program. PETSc provides an interface to
the ParMETIS (developed by George Karypis; see
<a class="reference external" href="https://www.mcs.anl.gov/petsc/documentation/installation.html">the PETSc installation instructions</a>.
for directions on installing PETSc to use ParMETIS) to allow the
partitioning to be done in parallel. PETSc does not currently provide
directly support for dynamic repartitioning, load balancing by migrating
matrix entries between processes, etc. For problems that require mesh
refinement, PETSc uses the “rebuild the data structure” approach, as
opposed to the “maintain dynamic data structures that support the
insertion/deletion of additional vector and matrix rows and columns
entries” approach.</p>
<p>Partitioning in PETSc is organized around the <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatPartitioning.html#MatPartitioning">MatPartitioning</a></span></code>
object. One first creates a parallel matrix that contains the
connectivity information about the grid (or other graph-type object)
that is to be partitioned. This is done with the command</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatCreateMPIAdj.html#MatCreateMPIAdj">MatCreateMPIAdj</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</a></span> <span class="n">comm</span><span class="p">,</span><span class="kt">int</span> <span class="n">mlocal</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">n</span><span class="p">,</span><span class="k">const</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">ia</span><span class="p">[],</span><span class="k">const</span> <span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="n">ja</span><span class="p">[],</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</a></span> <span class="o">*</span><span class="n">weights</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="o">*</span><span class="n">Adj</span><span class="p">);</span>
</pre></div>
</div>
<p>The argument <code class="docutils literal notranslate"><span class="pre">mlocal</span></code> indicates the number of rows of the graph being
provided by the given process, <code class="docutils literal notranslate"><span class="pre">n</span></code> is the total number of columns;
equal to the sum of all the <code class="docutils literal notranslate"><span class="pre">mlocal</span></code>. The arguments <code class="docutils literal notranslate"><span class="pre">ia</span></code> and <code class="docutils literal notranslate"><span class="pre">ja</span></code>
are the row pointers and column pointers for the given rows; these are
the usual format for parallel compressed sparse row storage, using
indices starting at 0, <em>not</em> 1.</p>
<div class="figure align-default" id="fig-usg">
<img alt="Numbering on Simple Unstructured Grid" src="../_images/usg.png" />
<p class="caption"><span class="caption-number">Fig. 5 </span><span class="caption-text">Numbering on Simple Unstructured Grid</span><a class="headerlink" href="#fig-usg" title="Permalink to this image">¶</a></p>
</div>
<p>This, of course, assumes that one has already distributed the grid
(graph) information among the processes. The details of this initial
distribution is not important; it could be simply determined by
assigning to the first process the first <span class="math">\(n_0\)</span> nodes from a file,
the second process the next <span class="math">\(n_1\)</span> nodes, etc.</p>
<p>For example, we demonstrate the form of the <code class="docutils literal notranslate"><span class="pre">ia</span></code> and <code class="docutils literal notranslate"><span class="pre">ja</span></code> for a
triangular grid where we</p>
<ol class="arabic simple">
<li><p>partition by element (triangle)</p></li>
</ol>
<ul class="simple">
<li><p>Process 0: <code class="docutils literal notranslate"><span class="pre">mlocal</span> <span class="pre">=</span> <span class="pre">2</span></code>, <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">=</span> <span class="pre">4</span></code>, <code class="docutils literal notranslate"><span class="pre">ja</span> <span class="pre">=</span></code><code class="docutils literal notranslate"><span class="pre">{2,3,</span> <span class="pre">3}</span></code>,
<code class="docutils literal notranslate"><span class="pre">ia</span> <span class="pre">=</span></code> <code class="docutils literal notranslate"><span class="pre">{0,2,3}</span></code></p></li>
<li><p>Process 1: <code class="docutils literal notranslate"><span class="pre">mlocal</span> <span class="pre">=</span> <span class="pre">2</span></code>, <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">=</span> <span class="pre">4</span></code>, <code class="docutils literal notranslate"><span class="pre">ja</span> <span class="pre">=</span></code><code class="docutils literal notranslate"><span class="pre">{0,</span> <span class="pre">0,1}</span></code>,
<code class="docutils literal notranslate"><span class="pre">ia</span> <span class="pre">=</span></code><code class="docutils literal notranslate"><span class="pre">{0,1,3}</span></code></p></li>
</ul>
<p>Note that elements are not connected to themselves and we only indicate
edge connections (in some contexts single vertex connections between
elements may also be included). We use a space above to denote the
transition between rows in the matrix.</p>
<p>and (2) partition by vertex.</p>
<ul class="simple">
<li><p>Process 0: <code class="docutils literal notranslate"><span class="pre">mlocal</span> <span class="pre">=</span> <span class="pre">3</span></code>, <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">=</span> <span class="pre">6</span></code>,
<code class="docutils literal notranslate"><span class="pre">ja</span> <span class="pre">=</span></code><code class="docutils literal notranslate"><span class="pre">{3,4,</span> <span class="pre">4,5,</span> <span class="pre">3,4,5}</span></code>, <code class="docutils literal notranslate"><span class="pre">ia</span> <span class="pre">=</span></code><code class="docutils literal notranslate"><span class="pre">{0,</span> <span class="pre">2,</span> <span class="pre">4,</span> <span class="pre">7}</span></code></p></li>
<li><p>Process 1: <code class="docutils literal notranslate"><span class="pre">mlocal</span> <span class="pre">=</span> <span class="pre">3</span></code>, <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">=</span> <span class="pre">6</span></code>,
<code class="docutils literal notranslate"><span class="pre">ja</span> <span class="pre">=</span></code><code class="docutils literal notranslate"><span class="pre">{0,2,</span> <span class="pre">4,</span> <span class="pre">0,1,2,3,5,</span> <span class="pre">1,2,4}</span></code>,
<code class="docutils literal notranslate"><span class="pre">ia</span> <span class="pre">=</span></code><code class="docutils literal notranslate"><span class="pre">{0,</span> <span class="pre">3,</span> <span class="pre">8,</span> <span class="pre">11}</span></code>.</p></li>
</ul>
<p>Once the connectivity matrix has been created the following code will
generate the renumbering required for the new partition</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/MatOrderings/MatPartitioningCreate.html#MatPartitioningCreate">MatPartitioningCreate</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</a></span> <span class="n">comm</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatPartitioning.html#MatPartitioning">MatPartitioning</a></span> <span class="o">*</span><span class="n">part</span><span class="p">);</span>
<span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/MatOrderings/MatPartitioningSetAdjacency.html#MatPartitioningSetAdjacency">MatPartitioningSetAdjacency</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatPartitioning.html#MatPartitioning">MatPartitioning</a></span> <span class="n">part</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="n">Adj</span><span class="p">);</span>
<span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/MatOrderings/MatPartitioningSetFromOptions.html#MatPartitioningSetFromOptions">MatPartitioningSetFromOptions</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatPartitioning.html#MatPartitioning">MatPartitioning</a></span> <span class="n">part</span><span class="p">);</span>
<span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/MatOrderings/MatPartitioningApply.html#MatPartitioningApply">MatPartitioningApply</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatPartitioning.html#MatPartitioning">MatPartitioning</a></span> <span class="n">part</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/IS/IS.html#IS">IS</a></span> <span class="o">*</span><span class="n">is</span><span class="p">);</span>
<span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/MatOrderings/MatPartitioningDestroy.html#MatPartitioningDestroy">MatPartitioningDestroy</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatPartitioning.html#MatPartitioning">MatPartitioning</a></span> <span class="o">*</span><span class="n">part</span><span class="p">);</span>
<span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/MatDestroy.html#MatDestroy">MatDestroy</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/Mat/Mat.html#Mat">Mat</a></span> <span class="o">*</span><span class="n">Adj</span><span class="p">);</span>
<span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/IS/ISPartitioningToNumbering.html#ISPartitioningToNumbering">ISPartitioningToNumbering</a></span><span class="p">(</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/IS/IS.html#IS">IS</a></span> <span class="n">is</span><span class="p">,</span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/IS/IS.html#IS">IS</a></span> <span class="o">*</span><span class="n">isg</span><span class="p">);</span>
</pre></div>
</div>
<p>The resulting <code class="docutils literal notranslate"><span class="pre">isg</span></code> contains for each local node the new global number
of that node. The resulting <code class="docutils literal notranslate"><span class="pre">is</span></code> contains the new process number that
each local node has been assigned to.</p>
<p>Now that a new numbering of the nodes has been determined, one must
renumber all the nodes and migrate the grid information to the correct
process. The command</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/AO/AOCreateBasicIS.html#AOCreateBasicIS">AOCreateBasicIS</a></span><span class="p">(</span><span class="n">isg</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ao</span><span class="p">);</span>
</pre></div>
</div>
<p>generates, see <a class="reference internal" href="vec.html#sec-ao"><span class="std std-ref">Application Orderings</span></a>, an AO object that can be
used in conjunction with the <code class="docutils literal notranslate"><span class="pre">is</span></code> and <code class="docutils literal notranslate"><span class="pre">isg</span></code> to move the relevant
grid information to the correct process and renumber the nodes etc. In
this context, the new ordering is the “application” ordering so
<code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/AO/AOPetscToApplication.html#AOPetscToApplication">AOPetscToApplication</a>()</span></code> converts old global indices to new global
indices and <code class="docutils literal notranslate"><span class="pre"><a href="https://www.mcs.anl.gov/petsc/petsc-current/docs/manualpages/AO/AOApplicationToPetsc.html#AOApplicationToPetsc">AOApplicationToPetsc</a>()</span></code> converts new global indices back
to old global indices.</p>
<p>PETSc does not currently provide tools that completely manage the
migration and node renumbering, since it will be dependent on the
particular data structure you use to store the grid information and the
type of grid information that you need for your application. We do plan
to include more support for this in the future, but designing the
appropriate general user interface and providing a scalable
implementation that can be used for a wide variety of different grids
requires a great deal of time.</p>
<hr><p id="id9"><dl class="citation">
<dt class="label" id="id1241"><span class="brackets"><a class="fn-backref" href="#id6">EM17</a></span></dt>
<dd><p>Jennifer B Erway and Roummel F Marcia. On solving large-scale limited-memory quasi-newton equations. <em>Linear Algebra and its Applications</em>, 515:196–225, 2017.</p>
</dd>
<dt class="label" id="id1243"><span class="brackets">GL89</span><span class="fn-backref">(<a href="#id7">1</a>,<a href="#id8">2</a>)</span></dt>
<dd><p>J. C. Gilbert and C. Lemarechal. Some numerical experiments with variable-storage Quasi-Newton algorithms. <em>Mathematical Programming</em>, 45:407–434, 1989.</p>
</dd>
<dt class="label" id="id1242"><span class="brackets">Gri12</span><span class="fn-backref">(<a href="#id1">1</a>,<a href="#id2">2</a>)</span></dt>
<dd><p>Andreas Griewank. Broyden updating, the good and the bad! <em>Optimization Stories, Documenta Mathematica. Extra Volume: Optimization Stories</em>, pages 301–315, 2012.</p>
</dd>
<dt class="label" id="id377"><span class="brackets">NW99</span><span class="fn-backref">(<a href="#id3">1</a>,<a href="#id4">2</a>,<a href="#id5">3</a>)</span></dt>
<dd><p>Jorge Nocedal and Stephen J. Wright. <em>Numerical Optimization</em>. Springer-Verlag, New York, 1999.</p>
</dd>
</dl>
</p>
<span class="target" id="id1259"></span></div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ksp.html" title="KSP: Linear System Solvers"
             >next</a> |</li>
        <li class="right" >
          <a href="vec.html" title="Vectors and Parallel Data"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">PETSc 3.14.6 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >PETSc Users Manual</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="programming.html" >Programming with PETSc</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 1991-2021, UChicago Argonne, LLC and the PETSc Development Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.4.
    </div>
  </body>
</html>